// Security-hardened helper functions for equipment-catalog-integration.html
// Replace vulnerable innerHTML patterns with these safe alternatives

/**
 * HTML escape function - prevents XSS by escaping special characters
 */
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') {
        unsafe = String(unsafe);
    }
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

/**
 * SECURE: Create equipment item card element
 * Replaces lines 453-468 vulnerable template literal
 */
function createEquipmentItemElement(item) {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'equipment-item';

    // Content container
    const contentDiv = document.createElement('div');

    // Name section with optional manufacturer badge
    const nameDiv = document.createElement('div');
    nameDiv.className = 'equipment-item-name';
    nameDiv.textContent = item.name; // Safe: textContent auto-escapes

    if (item.manufacturer) {
        const badge = document.createElement('span');
        badge.className = 'manufacturer-badge';
        badge.textContent = item.manufacturer; // Safe: textContent
        nameDiv.appendChild(badge);
    }

    contentDiv.appendChild(nameDiv);

    // Applications/meta section
    if (item.applications && item.applications.length > 0) {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'equipment-item-meta';

        // Only show first 2 applications
        item.applications.slice(0, 2).forEach(app => {
            const appTag = document.createElement('span');
            appTag.className = 'application-tag';
            appTag.textContent = app; // Safe: textContent
            metaDiv.appendChild(appTag);
        });

        contentDiv.appendChild(metaDiv);
    }

    itemDiv.appendChild(contentDiv);

    // Add button
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add-equipment';
    addBtn.textContent = 'Add';
    addBtn.onclick = () => addEquipmentToBuilderDirect(item);

    itemDiv.appendChild(addBtn);

    return itemDiv;
}

/**
 * SECURE: Render equipment catalog
 * Replaces vulnerable renderEquipmentCatalog() function
 */
function renderEquipmentCatalog() {
    const grid = document.getElementById('equipment-catalog-grid');

    // Clear existing content (textContent is safe for clearing)
    grid.textContent = '';

    Object.keys(equipmentCatalog).forEach(categoryKey => {
        const category = equipmentCatalog[categoryKey];

        // Filter items
        const filteredItems = category.items.filter(item => {
            // Category filter
            if (currentEquipmentFilter !== 'all' && item.category !== currentEquipmentFilter) {
                return false;
            }

            // Search filter
            if (equipmentSearchQuery) {
                const searchLower = equipmentSearchQuery.toLowerCase();
                return (
                    item.name.toLowerCase().includes(searchLower) ||
                    item.category.toLowerCase().includes(searchLower) ||
                    (item.manufacturer && item.manufacturer.toLowerCase().includes(searchLower)) ||
                    (item.applications && item.applications.some(app => app.toLowerCase().includes(searchLower)))
                );
            }

            return true;
        });

        // Skip category if no items match filters
        if (filteredItems.length === 0) return;

        // Create category card
        const card = document.createElement('div');
        card.className = 'equipment-category-card';

        // Category title
        const title = document.createElement('h4');
        title.className = 'text-lg font-bold mb-4 text-cyan-400';
        title.textContent = category.name; // Safe: textContent
        card.appendChild(title);

        // Category description
        const desc = document.createElement('p');
        desc.className = 'text-sm text-gray-400 mb-4';
        desc.textContent = category.description; // Safe: textContent
        card.appendChild(desc);

        // Items container
        const itemsContainer = document.createElement('div');

        // Add each filtered item
        filteredItems.forEach(item => {
            const itemElement = createEquipmentItemElement(item);
            itemsContainer.appendChild(itemElement);
        });

        card.appendChild(itemsContainer);
        grid.appendChild(card);
    });
}

/**
 * SECURE: Handle load error
 * Replaces vulnerable error message at lines 384-385
 */
function displayEquipmentLoadError() {
    const grid = document.getElementById('equipment-catalog-grid');
    grid.textContent = ''; // Clear existing content

    const errorMsg = document.createElement('p');
    errorMsg.className = 'text-red-500';
    errorMsg.textContent = 'Failed to load equipment catalog. Please check that equipment-catalog.json exists.';

    grid.appendChild(errorMsg);
}

/**
 * SECURE: Load equipment catalog
 * Replaces original loadEquipmentCatalog() with secure error handling
 */
async function loadEquipmentCatalog() {
    try {
        const response = await fetch('equipment-catalog.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        equipmentCatalog = await response.json();
        renderEquipmentCatalog();
        populateEquipmentSelector();
    } catch (error) {
        console.error('Failed to load equipment catalog:', error);
        displayEquipmentLoadError();
    }
}

/**
 * SECURE: Populate equipment selector
 * Already mostly safe, but improved for consistency
 */
function populateEquipmentSelector() {
    const selector = document.getElementById('equipment-selector');

    // Clear existing options (textContent is safe)
    selector.textContent = '';

    // Add default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '-- Choose equipment --';
    selector.appendChild(defaultOption);

    Object.keys(equipmentCatalog).forEach(categoryKey => {
        const category = equipmentCatalog[categoryKey];
        const optgroup = document.createElement('optgroup');
        optgroup.label = category.name; // Safe: label is an attribute, not innerHTML

        category.items.forEach(item => {
            const option = document.createElement('option');
            option.value = JSON.stringify(item);
            option.textContent = `${item.name}${item.manufacturer ? ' (' + item.manufacturer + ')' : ''}`;
            optgroup.appendChild(option);
        });

        selector.appendChild(optgroup);
    });
}

// ====================
// INSTRUCTIONS FOR INTEGRATION
// ====================

/*
TO APPLY THESE FIXES TO equipment-catalog-integration.html:

1. Replace the renderEquipmentCatalog() function (lines ~423-481) with the secure version above

2. Replace the loadEquipmentCatalog() function (lines ~375-387) with:
   - The secure loadEquipmentCatalog() function
   - Add the displayEquipmentLoadError() helper

3. Add the escapeHtml() function at the top of the <script> section

4. Add the createEquipmentItemElement() helper function

5. Optionally replace populateEquipmentSelector() for consistency (lines ~489-508)

TESTING:
- Test with normal equipment data
- Test with malicious data containing <script> tags
- Verify all equipment displays correctly
- Verify search and filters still work
- Verify "Add" buttons still work

BEFORE deploying, test with this malicious payload:
{
    "name": "<img src=x onerror=alert('XSS')>",
    "manufacturer": "<script>alert('XSS')</script>",
    "applications": ["<b>onload=alert('XSS')</b>"]
}

With the secure code, these should display as plain text, not execute.
*/
