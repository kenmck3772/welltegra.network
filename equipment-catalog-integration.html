<!-- =================================================================
     EQUIPMENT CATALOG & TOOL STRING BUILDER INTEGRATION

     This file contains the HTML/CSS/JS for adding Equipment Catalog
     and Tool String Builder features to Well-Tegra v23.

     INTEGRATION INSTRUCTIONS:
     1. Add the CSS section to the <style> block in index.html
     2. Add the HTML sections within the planner-view Step 2
     3. Add the JavaScript at the end of the <script> section
     4. Load equipment-catalog.json via fetch

     Author: Claude Code
     Date: 2025-10-22
     ================================================================= -->

<!-- ========================= CSS STYLES ========================= -->
<style id="equipment-catalog-styles">
/* Equipment Catalog & Tool String Builder Styles */
.equipment-tabs {
    display: flex;
    gap: 8px;
    border-bottom: 2px solid #334155;
    margin-bottom: 1.5rem;
}

.equipment-tab {
    padding: 12px 24px;
    font-weight: 700;
    font-size: 1rem;
    color: #94a3b8;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
}

.equipment-tab:hover {
    color: #14b8a6;
}

.equipment-tab.active {
    color: #14b8a6;
    border-bottom-color: #14b8a6;
}

.equipment-category-card {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.8));
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.equipment-category-card:hover {
    border-color: #14b8a6;
    box-shadow: 0 4px 20px rgba(20, 184, 166, 0.2);
    transform: translateY(-2px);
}

.equipment-item {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid #475569;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
}

.equipment-item:hover {
    border-color: #14b8a6;
    background: rgba(20, 184, 166, 0.1);
}

.equipment-item-name {
    font-weight: 600;
    color: #e2e8f0;
    font-size: 0.95rem;
}

.equipment-item-meta {
    font-size: 0.75rem;
    color: #94a3b8;
    margin-top: 4px;
}

.tool-string-card {
    background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(59, 130, 246, 0.05));
    border: 2px solid #14b8a6;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
}

.tool-string-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.tool-string-name {
    font-size: 1.25rem;
    font-weight: 800;
    color: #14b8a6;
}

.tool-string-components {
    list-style: none;
    padding-left: 1rem;
    margin: 0;
}

.tool-string-component {
    padding: 6px 0;
    color: #cbd5e1;
    font-size: 0.9rem;
    border-left: 3px solid #475569;
    padding-left: 12px;
    margin-bottom: 6px;
}

.tool-string-component:hover {
    border-left-color: #14b8a6;
    color: #14b8a6;
}

.btn-add-equipment {
    background: #14b8a6;
    color: #0b1220;
    padding: 6px 14px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-add-equipment:hover {
    background: #0ea5e9;
    transform: scale(1.05);
}

.btn-secondary {
    background: #475569;
    color: #e2e8f0;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background: #64748b;
}

.btn-danger {
    background: #ef4444;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-danger:hover {
    background: #dc2626;
}

.search-box {
    width: 100%;
    padding: 12px;
    background: rgba(15, 23, 42, 0.8);
    border: 1px solid #475569;
    border-radius: 8px;
    color: #e2e8f0;
    font-size: 1rem;
    margin-bottom: 1.5rem;
}

.search-box:focus {
    outline: none;
    border-color: #14b8a6;
    box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
}

.manufacturer-badge {
    display: inline-block;
    padding: 4px 10px;
    background: rgba(234, 179, 8, 0.2);
    border: 1px solid #eab308;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #fbbf24;
    margin-left: 8px;
}

.application-tag {
    display: inline-block;
    padding: 3px 8px;
    background: rgba(59, 130, 246, 0.2);
    border-radius: 4px;
    font-size: 0.7rem;
    color: #93c5fd;
    margin-right: 6px;
    margin-bottom: 6px;
}

.service-line-badge {
    display: inline-block;
    padding: 6px 12px;
    background: linear-gradient(135deg, #14b8a6, #0ea5e9);
    color: #0b1220;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 800;
    margin-left: 12px;
}

.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: #94a3b8;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state-text {
    font-size: 1.125rem;
    font-weight: 600;
}
</style>

<!-- ========================= HTML STRUCTURE ========================= -->
<!-- Add this section within Step 2 of the planner-view, after the objective selection -->

<div id="equipment-tools-section" class="mt-12 max-w-7xl mx-auto">
    <div class="light-card rounded-lg p-6 shadow-xl border-2 border-cyan-500/30">
        <h3 class="text-2xl font-bold mb-6">üõ†Ô∏è Equipment Catalog & Tool Strings</h3>

        <!-- Tabs -->
        <div class="equipment-tabs">
            <button class="equipment-tab active" data-tab="catalog" onclick="switchEquipmentTab('catalog')">
                Equipment Catalog
            </button>
            <button class="equipment-tab" data-tab="toolstrings" onclick="switchEquipmentTab('toolstrings')">
                My Tool Strings
            </button>
            <button class="equipment-tab" data-tab="builder" onclick="switchEquipmentTab('builder')">
                Build New String
            </button>
            <button class="equipment-tab" data-tab="templates" onclick="switchEquipmentTab('templates')">
                Service Templates
            </button>
        </div>

        <!-- Tab Content: Equipment Catalog -->
        <div id="tab-catalog" class="equipment-tab-content">
            <input type="text" id="equipment-search" class="search-box" placeholder="Search equipment by name, manufacturer, or application...">

            <div class="mb-4 flex gap-3 flex-wrap">
                <button class="btn-secondary" onclick="filterEquipmentCategory('all')">All</button>
                <button class="btn-secondary" onclick="filterEquipmentCategory('fishing')">Fishing</button>
                <button class="btn-secondary" onclick="filterEquipmentCategory('running')">Running Tools</button>
                <button class="btn-secondary" onclick="filterEquipmentCategory('wireline')">Wireline</button>
                <button class="btn-secondary" onclick="filterEquipmentCategory('completion')">Completion</button>
                <button class="btn-secondary" onclick="filterEquipmentCategory('gaslift')">Gas Lift</button>
            </div>

            <div id="equipment-catalog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Equipment items will be rendered here -->
            </div>
        </div>

        <!-- Tab Content: My Tool Strings -->
        <div id="tab-toolstrings" class="equipment-tab-content hidden">
            <div id="saved-toolstrings-list">
                <!-- Saved tool strings will be rendered here -->
            </div>
            <div id="empty-toolstrings" class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <div class="empty-state-text">No tool strings saved yet</div>
                <p class="mt-2">Use the Builder tab to create your first reusable tool string assembly.</p>
            </div>
        </div>

        <!-- Tab Content: Build New String -->
        <div id="tab-builder" class="equipment-tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left: Builder Form -->
                <div>
                    <h4 class="text-xl font-bold mb-4">Create New Tool String</h4>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Assembly Name</label>
                        <input type="text" id="new-toolstring-name" class="search-box" placeholder="e.g., Standard Fishing Assembly">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Service Line</label>
                        <select id="new-toolstring-service" class="search-box">
                            <option value="CT">Coiled Tubing</option>
                            <option value="ELS">E-Line Services</option>
                            <option value="SLK">Slickline</option>
                            <option value="WHM">Wireline/Hydraulics</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Select Equipment</label>
                        <select id="equipment-selector" class="search-box">
                            <option value="">-- Choose equipment --</option>
                        </select>
                        <button class="btn-add-equipment mt-2" onclick="addEquipmentToBuilder()">Add to String</button>
                    </div>

                    <button class="btn-add-equipment mt-4 w-full py-3 text-lg" onclick="saveToolString()">
                        üíæ Save Tool String
                    </button>
                </div>

                <!-- Right: Preview -->
                <div>
                    <h4 class="text-xl font-bold mb-4">Assembly Preview</h4>
                    <div id="builder-preview" class="tool-string-card">
                        <div class="tool-string-header">
                            <span class="tool-string-name" id="preview-name">Untitled Assembly</span>
                        </div>
                        <ul id="builder-components-list" class="tool-string-components">
                            <li class="text-gray-500 italic">No components added yet</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Service Templates -->
        <div id="tab-templates" class="equipment-tab-content hidden">
            <h4 class="text-xl font-bold mb-4">Pre-Configured Service Line Templates</h4>
            <p class="text-gray-400 mb-6">Quick-start templates for common intervention scenarios</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="service-templates-grid">
                <!-- Templates will be rendered here -->
            </div>
        </div>
    </div>
</div>

<!-- ========================= JAVASCRIPT ========================= -->
<script id="equipment-catalog-script">
// Equipment Catalog & Tool String Builder

// ========================= SECURITY HELPERS =========================
/**
 * HTML escape function to prevent XSS attacks
 * Escapes special HTML characters in user-provided strings
 */
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') {
        unsafe = String(unsafe);
    }
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

let equipmentCatalog = {};
let savedToolStrings = [];
let builderComponents = [];
let currentEquipmentFilter = 'all';
let equipmentSearchQuery = '';

// Load equipment catalog from JSON
async function loadEquipmentCatalog() {
    try {
        const response = await fetch('equipment-catalog.json');
        equipmentCatalog = await response.json();
        console.log('Equipment catalog loaded:', Object.keys(equipmentCatalog).length, 'categories');
        renderEquipmentCatalog();
        populateEquipmentSelector();
    } catch (error) {
        console.error('Failed to load equipment catalog:', error);
        // SECURITY: Use safe DOM methods instead of innerHTML
        const grid = document.getElementById('equipment-catalog-grid');
        grid.textContent = ''; // Clear existing content safely
        const errorMsg = document.createElement('p');
        errorMsg.className = 'text-red-500';
        errorMsg.textContent = 'Failed to load equipment catalog. Please check that equipment-catalog.json exists.';
        grid.appendChild(errorMsg);
    }
}

// Load saved tool strings from localStorage
function loadSavedToolStrings() {
    const saved = localStorage.getItem('welltegra_toolstrings');
    savedToolStrings = saved ? JSON.parse(saved) : [];
    renderSavedToolStrings();
}

// Save tool strings to localStorage
function saveToolStringsToStorage() {
    localStorage.setItem('welltegra_toolstrings', JSON.stringify(savedToolStrings));
}

// Switch between tabs
function switchEquipmentTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.equipment-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
    });

    // Update tab content
    document.querySelectorAll('.equipment-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`tab-${tabName}`).classList.remove('hidden');

    // Refresh content if needed
    if (tabName === 'toolstrings') {
        renderSavedToolStrings();
    } else if (tabName === 'templates') {
        renderServiceTemplates();
    }
}

// SECURITY: Helper function to create equipment item element
function createEquipmentItemElement(item) {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'equipment-item';

    // Content container
    const contentDiv = document.createElement('div');

    // Name section with optional manufacturer badge
    const nameDiv = document.createElement('div');
    nameDiv.className = 'equipment-item-name';
    nameDiv.textContent = item.name; // Safe: textContent auto-escapes

    if (item.manufacturer) {
        const badge = document.createElement('span');
        badge.className = 'manufacturer-badge';
        badge.textContent = item.manufacturer; // Safe: textContent
        nameDiv.appendChild(badge);
    }

    contentDiv.appendChild(nameDiv);

    // Applications/meta section
    if (item.applications && item.applications.length > 0) {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'equipment-item-meta';

        // Only show first 2 applications
        item.applications.slice(0, 2).forEach(app => {
            const appTag = document.createElement('span');
            appTag.className = 'application-tag';
            appTag.textContent = app; // Safe: textContent
            metaDiv.appendChild(appTag);
        });

        contentDiv.appendChild(metaDiv);
    }

    itemDiv.appendChild(contentDiv);

    // Add button
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add-equipment';
    addBtn.textContent = 'Add';
    addBtn.onclick = () => addEquipmentToBuilderDirect(item);

    itemDiv.appendChild(addBtn);

    return itemDiv;
}

// Render equipment catalog - SECURITY HARDENED
function renderEquipmentCatalog() {
    const grid = document.getElementById('equipment-catalog-grid');
    grid.textContent = ''; // Safe clearing

    Object.keys(equipmentCatalog).forEach(categoryKey => {
        const category = equipmentCatalog[categoryKey];

        // Filter items
        const filteredItems = category.items.filter(item => {
            // Category filter
            if (currentEquipmentFilter !== 'all' && item.category !== currentEquipmentFilter) {
                return false;
            }

            // Search filter
            if (equipmentSearchQuery) {
                const searchLower = equipmentSearchQuery.toLowerCase();
                return (
                    item.name.toLowerCase().includes(searchLower) ||
                    item.category.toLowerCase().includes(searchLower) ||
                    (item.manufacturer && item.manufacturer.toLowerCase().includes(searchLower)) ||
                    (item.applications && item.applications.some(app => app.toLowerCase().includes(searchLower)))
                );
            }

            return true;
        });

        // Skip category if no items match filters
        if (filteredItems.length === 0) return;

        // Create category card
        const card = document.createElement('div');
        card.className = 'equipment-category-card';

        // Category title
        const title = document.createElement('h4');
        title.className = 'text-lg font-bold mb-4 text-cyan-400';
        title.textContent = category.name; // Safe: textContent
        card.appendChild(title);

        // Category description
        const desc = document.createElement('p');
        desc.className = 'text-sm text-gray-400 mb-4';
        desc.textContent = category.description; // Safe: textContent
        card.appendChild(desc);

        // Items container
        const itemsContainer = document.createElement('div');

        // Add each filtered item
        filteredItems.forEach(item => {
            const itemElement = createEquipmentItemElement(item);
            itemsContainer.appendChild(itemElement);
        });

        card.appendChild(itemsContainer);
        grid.appendChild(card);
    });
}

// Filter equipment by category
function filterEquipmentCategory(category) {
    currentEquipmentFilter = category;
    renderEquipmentCatalog();
}

// Populate equipment selector dropdown - SECURITY HARDENED
function populateEquipmentSelector() {
    const selector = document.getElementById('equipment-selector');

    // Clear existing options safely
    selector.textContent = '';

    // Add default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '-- Choose equipment --';
    selector.appendChild(defaultOption);

    Object.keys(equipmentCatalog).forEach(categoryKey => {
        const category = equipmentCatalog[categoryKey];
        const optgroup = document.createElement('optgroup');
        optgroup.label = category.name; // Safe: label is an attribute

        category.items.forEach(item => {
            const option = document.createElement('option');
            option.value = JSON.stringify(item);
            option.textContent = `${item.name}${item.manufacturer ? ' (' + item.manufacturer + ')' : ''}`;
            optgroup.appendChild(option);
        });

        selector.appendChild(optgroup);
    });
}

// Add equipment to builder from dropdown
function addEquipmentToBuilder() {
    const selector = document.getElementById('equipment-selector');
    if (!selector.value) {
        alert('Please select equipment from the dropdown');
        return;
    }

    const item = JSON.parse(selector.value);
    builderComponents.push(item);
    updateBuilderPreview();
    selector.value = '';
}

// Add equipment to builder directly (from catalog)
function addEquipmentToBuilderDirect(item) {
    // Switch to builder tab
    switchEquipmentTab('builder');

    // Add to builder
    builderComponents.push(item);
    updateBuilderPreview();

    // Show toast notification
    showToast(`Added ${item.name} to builder`);
}

// Update builder preview
function updateBuilderPreview() {
    const nameInput = document.getElementById('new-toolstring-name');
    const previewName = document.getElementById('preview-name');
    const componentsList = document.getElementById('builder-components-list');

    previewName.textContent = nameInput.value || 'Untitled Assembly';

    // SECURITY: Use safe DOM methods instead of innerHTML
    componentsList.textContent = ''; // Clear existing

    if (builderComponents.length === 0) {
        const emptyMsg = document.createElement('li');
        emptyMsg.className = 'text-gray-500 italic';
        emptyMsg.textContent = 'No components added yet';
        componentsList.appendChild(emptyMsg);
    } else {
        builderComponents.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'tool-string-component';

            // Component number and name
            const text = document.createTextNode(`${index + 1}. ${item.name}`);
            li.appendChild(text);

            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn-danger ml-2';
            removeBtn.style.cssText = 'padding: 2px 8px; font-size: 0.7rem;';
            removeBtn.textContent = '‚úï';
            removeBtn.onclick = () => removeBuilderComponent(index);
            li.appendChild(removeBtn);

            componentsList.appendChild(li);
        });
    }
}

// Remove component from builder
function removeBuilderComponent(index) {
    builderComponents.splice(index, 1);
    updateBuilderPreview();
}

// Save tool string
function saveToolString() {
    const nameInput = document.getElementById('new-toolstring-name');
    const serviceSelect = document.getElementById('new-toolstring-service');

    if (!nameInput.value.trim()) {
        alert('Please enter a name for the tool string');
        return;
    }

    if (builderComponents.length === 0) {
        alert('Please add at least one component to the tool string');
        return;
    }

    const newToolString = {
        id: Date.now().toString(),
        name: nameInput.value.trim(),
        serviceLine: serviceSelect.value,
        components: builderComponents.map(item => ({...item})),
        createdAt: new Date().toISOString()
    };

    savedToolStrings.push(newToolString);
    saveToolStringsToStorage();

    // Reset builder
    nameInput.value = '';
    builderComponents = [];
    updateBuilderPreview();

    // Switch to tool strings tab
    switchEquipmentTab('toolstrings');

    showToast(`Tool string "${newToolString.name}" saved successfully!`);
}

// Render saved tool strings - SECURITY HARDENED
function renderSavedToolStrings() {
    const list = document.getElementById('saved-toolstrings-list');
    const empty = document.getElementById('empty-toolstrings');

    if (savedToolStrings.length === 0) {
        list.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
    }

    list.classList.remove('hidden');
    empty.classList.add('hidden');

    // SECURITY: Use safe DOM methods instead of innerHTML
    list.textContent = ''; // Clear existing

    savedToolStrings.forEach((toolString, index) => {
        // Create card container
        const card = document.createElement('div');
        card.className = 'tool-string-card';

        // Create header
        const header = document.createElement('div');
        header.className = 'tool-string-header';

        // Left side: name and service line badge
        const leftDiv = document.createElement('div');

        const nameSpan = document.createElement('span');
        nameSpan.className = 'tool-string-name';
        nameSpan.textContent = toolString.name; // Safe: textContent
        leftDiv.appendChild(nameSpan);

        const serviceSpan = document.createElement('span');
        serviceSpan.className = 'service-line-badge';
        serviceSpan.textContent = toolString.serviceLine; // Safe: textContent
        leftDiv.appendChild(serviceSpan);

        header.appendChild(leftDiv);

        // Right side: action buttons
        const rightDiv = document.createElement('div');

        const useBtn = document.createElement('button');
        useBtn.className = 'btn-add-equipment';
        useBtn.textContent = 'Use This String';
        useBtn.onclick = () => useToolString(index);
        rightDiv.appendChild(useBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-danger ml-2';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteToolString(index);
        rightDiv.appendChild(deleteBtn);

        header.appendChild(rightDiv);
        card.appendChild(header);

        // Components list
        const componentsList = document.createElement('ul');
        componentsList.className = 'tool-string-components';

        toolString.components.forEach((item, i) => {
            const li = document.createElement('li');
            li.className = 'tool-string-component';
            li.textContent = `${i + 1}. ${item.name}`; // Safe: textContent
            componentsList.appendChild(li);
        });

        card.appendChild(componentsList);

        // Created date
        const dateDiv = document.createElement('div');
        dateDiv.className = 'text-xs text-gray-500 mt-3';
        dateDiv.textContent = `Created: ${new Date(toolString.createdAt).toLocaleDateString()}`;
        card.appendChild(dateDiv);

        list.appendChild(card);
    });
}

// Use a tool string (add to current plan)
function useToolString(index) {
    const toolString = savedToolStrings[index];

    // Store the tool string for the current plan
    const planToolString = {
        id: toolString.id || `ts-${Date.now()}`,
        name: toolString.name,
        components: toolString.components,
        addedAt: new Date().toISOString(),
        serviceLine: toolString.serviceLine || 'General'
    };

    // Save to localStorage for integration with main planner
    const currentPlanTools = JSON.parse(localStorage.getItem('welltegra_current_plan_tools') || '[]');
    currentPlanTools.push(planToolString);
    localStorage.setItem('welltegra_current_plan_tools', JSON.stringify(currentPlanTools));

    // If main app's appState exists, integrate directly
    if (window.appState && window.appState.generatedPlan) {
        // Add to the generated plan's equipment list
        if (!window.appState.generatedPlan.equipment) {
            window.appState.generatedPlan.equipment = [];
        }
        window.appState.generatedPlan.equipment.push(...toolString.components);

        showToast(`Tool string "${toolString.name}" added to ${window.appState.generatedPlan.name}!`);
        console.log('[Equipment] Tool string added to active plan:', planToolString);
    } else {
        // Store for later integration
        showToast(`Tool string "${toolString.name}" saved to plan! Open the planner to view.`);
        console.log('[Equipment] Tool string queued for plan integration:', planToolString);
    }

    // Dispatch event for other modules to listen
    window.dispatchEvent(new CustomEvent('toolstring:added', {
        detail: planToolString
    }));
}

// Delete a tool string
function deleteToolString(index) {
    const toolString = savedToolStrings[index];
    if (confirm(`Are you sure you want to delete "${toolString.name}"?`)) {
        savedToolStrings.splice(index, 1);
        saveToolStringsToStorage();
        renderSavedToolStrings();
        showToast(`Tool string "${toolString.name}" deleted`);
    }
}

// Render service templates
function renderServiceTemplates() {
    const templates = {
        ct: {
            name: 'Coiled Tubing Standard Package',
            description: 'Standard CT package for wellbore cleanout and circulation',
            serviceLine: 'CT',
            components: ['CT Reel', 'Injector Head', 'BHA Assembly', 'Jetting Tools']
        },
        els_fishing: {
            name: 'E-Line Fishing Assembly',
            description: 'Complete fishing assembly for wireline operations',
            serviceLine: 'ELS',
            components: ['Rope Socket', 'Power Jar', 'Internal Spear', 'Pressure Gauge']
        },
        slk_gaslift: {
            name: 'Slickline Gas Lift Service',
            description: 'Standard slickline setup for gas lift valve operations',
            serviceLine: 'SLK',
            components: ['Running Tool', 'Gas Lift Valve', 'Lock Mandrel', 'Equalizing Prong']
        },
        whm_completion: {
            name: 'WHM Completion Assembly',
            description: 'Wireline completion tools package',
            serviceLine: 'WHM',
            components: ['Setting Tool', 'Plug Assembly', 'Bridge Plug', 'Tubing Cutter']
        }
    };

    const grid = document.getElementById('service-templates-grid');
    grid.textContent = ''; // Clear existing content safely

    Object.keys(templates).forEach(key => {
        const template = templates[key];

        // Create card container
        const card = document.createElement('div');
        card.className = 'tool-string-card cursor-pointer';
        card.onclick = () => loadTemplate(key);

        // Create header structure
        const header = document.createElement('div');
        header.className = 'tool-string-header';

        const headerInner = document.createElement('div');

        const nameDiv = document.createElement('div');
        nameDiv.className = 'tool-string-name';
        nameDiv.textContent = template.name; // Safe: auto-escapes

        const badge = document.createElement('span');
        badge.className = 'service-line-badge';
        badge.textContent = template.serviceLine; // Safe: auto-escapes

        headerInner.appendChild(nameDiv);
        headerInner.appendChild(badge);
        header.appendChild(headerInner);
        card.appendChild(header);

        // Create description
        const description = document.createElement('p');
        description.className = 'text-sm text-gray-400 mb-3';
        description.textContent = template.description; // Safe: auto-escapes
        card.appendChild(description);

        // Create components list
        const componentsList = document.createElement('ul');
        componentsList.className = 'tool-string-components';

        template.components.forEach((comp, i) => {
            const li = document.createElement('li');
            li.className = 'tool-string-component';
            li.textContent = `${i + 1}. ${comp}`; // Safe: auto-escapes
            componentsList.appendChild(li);
        });
        card.appendChild(componentsList);

        // Create load button
        const button = document.createElement('button');
        button.className = 'btn-add-equipment mt-3 w-full';
        button.textContent = 'Load Template';
        button.onclick = (event) => {
            event.stopPropagation();
            loadTemplate(key);
        };
        card.appendChild(button);

        grid.appendChild(card);
    });
}

// Load a template into builder
function loadTemplate(templateKey) {
    const templates = {
        ct: {
            name: 'Coiled Tubing Standard Package',
            description: 'Standard CT package for wellbore cleanout and circulation',
            serviceLine: 'CT',
            components: ['CT Reel', 'Injector Head', 'BHA Assembly', 'Jetting Tools']
        },
        els_fishing: {
            name: 'E-Line Fishing Assembly',
            description: 'Complete fishing assembly for wireline operations',
            serviceLine: 'ELS',
            components: ['Rope Socket', 'Power Jar', 'Internal Spear', 'Pressure Gauge']
        },
        slk_gaslift: {
            name: 'Slickline Gas Lift Service',
            description: 'Standard slickline setup for gas lift valve operations',
            serviceLine: 'SLK',
            components: ['Running Tool', 'Gas Lift Valve', 'Lock Mandrel', 'Equalizing Prong']
        },
        whm_completion: {
            name: 'WHM Completion Assembly',
            description: 'Wireline completion tools package',
            serviceLine: 'WHM',
            components: ['Setting Tool', 'Plug Assembly', 'Bridge Plug', 'Tubing Cutter']
        }
    };

    const template = templates[templateKey];
    if (!template) {
        showToast('Template not found', 'error');
        return;
    }

    // Clear existing builder components
    builderComponents = [];

    // Add template components to builder
    template.components.forEach(componentName => {
        builderComponents.push({
            id: `template-${Date.now()}-${Math.random()}`,
            name: componentName,
            category: template.serviceLine,
            manufacturer: 'Template',
            applications: [template.description]
        });
    });

    // Set the tool string name
    const nameInput = document.getElementById('new-toolstring-name');
    if (nameInput) {
        nameInput.value = template.name;
    }

    // Switch to builder tab and update preview
    switchEquipmentTab('builder');
    updateBuilderPreview();

    showToast(`Loaded template: ${template.name}`);
}

// Equipment search
document.addEventListener('DOMContentLoaded', () => {
    const searchBox = document.getElementById('equipment-search');
    if (searchBox) {
        searchBox.addEventListener('input', (e) => {
            equipmentSearchQuery = e.target.value.trim();
            renderEquipmentCatalog();
        });
    }

    // Update builder preview when name changes
    const nameInput = document.getElementById('new-toolstring-name');
    if (nameInput) {
        nameInput.addEventListener('input', updateBuilderPreview);
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    loadEquipmentCatalog();
    loadSavedToolStrings();
});
</script>
