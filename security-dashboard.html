<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security & Analytics Dashboard - WellTegra</title>
    <meta name="description" content="Security monitoring and user analytics dashboard for WellTegra dual-access architecture">

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="assets/css/tailwind.css">

    <style>
        .stat-card {
            @apply bg-white rounded-lg shadow-md p-6 border-l-4;
        }
        .stat-card.blue { border-left-color: #3b82f6; }
        .stat-card.green { border-left-color: #10b981; }
        .stat-card.yellow { border-left-color: #f59e0b; }
        .stat-card.red { border-left-color: #ef4444; }

        .activity-item {
            @apply flex items-center justify-between p-4 border-b hover:bg-gray-50;
        }

        .badge {
            @apply px-3 py-1 rounded-full text-xs font-semibold;
        }
        .badge-success { @apply bg-green-100 text-green-800; }
        .badge-warning { @apply bg-yellow-100 text-yellow-800; }
        .badge-danger { @apply bg-red-100 text-red-800; }
        .badge-info { @apply bg-blue-100 text-blue-800; }

        .chart-container {
            @apply bg-white rounded-lg shadow p-6 mb-6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold">üîê WellTegra Security Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="currentUser" class="text-sm">Admin User</span>
                    <span id="accessTier" class="badge badge-info"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        <!-- Overview Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card blue">
                <div class="text-gray-600 text-sm font-semibold">Total Users</div>
                <div id="stat-total-users" class="text-3xl font-bold text-gray-900 mt-2">0</div>
                <div class="text-xs text-gray-500 mt-1">Active sessions: <span id="stat-active-sessions">0</span></div>
            </div>

            <div class="stat-card green">
                <div class="text-gray-600 text-sm font-semibold">Playground Access</div>
                <div id="stat-playground-users" class="text-3xl font-bold text-gray-900 mt-2">0</div>
                <div class="text-xs text-gray-500 mt-1">Conversion rate: <span id="stat-conversion-rate">0%</span></div>
            </div>

            <div class="stat-card yellow">
                <div class="text-gray-600 text-sm font-semibold">Feature Usage</div>
                <div id="stat-feature-usage" class="text-3xl font-bold text-gray-900 mt-2">0</div>
                <div class="text-xs text-gray-500 mt-1">Today's executions</div>
            </div>

            <div class="stat-card red">
                <div class="text-gray-600 text-sm font-semibold">Security Events</div>
                <div id="stat-security-events" class="text-3xl font-bold text-gray-900 mt-2">0</div>
                <div class="text-xs text-gray-500 mt-1">Last 24 hours</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6" aria-label="Tabs">
                    <button class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="overview">
                        Overview
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="users">
                        User Analytics
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="features">
                        Feature Usage
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="audit">
                        Audit Log
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="zkp">
                        ZKP Verifications
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Contents -->
        <div id="tab-content">
            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-panel">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Recent Activity -->
                    <div class="chart-container">
                        <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                        <div id="recent-activity" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </div>

                    <!-- Top Features -->
                    <div class="chart-container">
                        <h3 class="text-lg font-semibold mb-4">Top Features</h3>
                        <div id="top-features" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Session Activity -->
                <div class="chart-container mt-6">
                    <h3 class="text-lg font-semibold mb-4">Active Sessions</h3>
                    <div id="active-sessions" class="space-y-2"></div>
                </div>
            </div>

            <!-- User Analytics Tab -->
            <div id="users-tab" class="tab-panel hidden">
                <div class="chart-container">
                    <h3 class="text-lg font-semibold mb-4">User Interest Profiles</h3>
                    <div id="user-interests" class="space-y-4"></div>
                </div>
            </div>

            <!-- Feature Usage Tab -->
            <div id="features-tab" class="tab-panel hidden">
                <div class="chart-container">
                    <h3 class="text-lg font-semibold mb-4">Feature Access Statistics</h3>
                    <div id="feature-stats" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Feature</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Access Level</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Access</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Granted</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Denied</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unique Users</th>
                                </tr>
                            </thead>
                            <tbody id="feature-stats-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Audit Log Tab -->
            <div id="audit-tab" class="tab-panel hidden">
                <div class="chart-container">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Audit Log</h3>
                        <div class="flex space-x-2">
                            <select id="audit-category-filter" class="border rounded px-3 py-2 text-sm">
                                <option value="">All Categories</option>
                                <option value="auth">Authentication</option>
                                <option value="access">Access Control</option>
                                <option value="data">Data Operations</option>
                                <option value="computation">Computations</option>
                                <option value="security">Security</option>
                            </select>
                            <button id="export-audit-log" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                                Export Log
                            </button>
                        </div>
                    </div>
                    <div id="audit-log-entries" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <!-- ZKP Verifications Tab -->
            <div id="zkp-tab" class="tab-panel hidden">
                <div class="chart-container">
                    <h3 class="text-lg font-semibold mb-4">Zero-Knowledge Proof Verifications</h3>
                    <div id="zkp-verifications" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules -->
    <script type="module">
        import { playgroundGateway } from './assets/js/playground-gateway.js';
        import { auditLogger } from './assets/js/audit-logger.js';
        import { zkpVerification } from './assets/js/zkp-verification.js';

        // Initialize dashboard
        class SecurityDashboard {
            constructor() {
                this.gateway = playgroundGateway;
                this.auditLogger = auditLogger;
                this.zkpVerification = zkpVerification;
                this.refreshInterval = null;

                this.init();
            }

            init() {
                // Setup tab switching
                this.setupTabs();

                // Load initial data
                this.refreshDashboard();

                // Auto-refresh every 10 seconds
                this.refreshInterval = setInterval(() => {
                    this.refreshDashboard();
                }, 10000);

                // Setup event listeners
                this.setupEventListeners();
            }

            setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabPanels = document.querySelectorAll('.tab-panel');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetTab = button.dataset.tab;

                        // Update button states
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                            btn.classList.add('border-transparent', 'text-gray-500');
                        });
                        button.classList.add('active', 'border-blue-500', 'text-blue-600');
                        button.classList.remove('border-transparent', 'text-gray-500');

                        // Update panel visibility
                        tabPanels.forEach(panel => {
                            panel.classList.add('hidden');
                        });
                        document.getElementById(`${targetTab}-tab`).classList.remove('hidden');
                    });
                });
            }

            setupEventListeners() {
                // Audit log category filter
                document.getElementById('audit-category-filter').addEventListener('change', (e) => {
                    this.filterAuditLog(e.target.value);
                });

                // Export audit log
                document.getElementById('export-audit-log').addEventListener('click', () => {
                    this.exportAuditLog();
                });
            }

            async refreshDashboard() {
                // Get analytics data
                const analytics = this.gateway.getAnalyticsDashboard();

                // Update overview stats
                this.updateOverviewStats(analytics);

                // Update recent activity
                this.updateRecentActivity();

                // Update top features
                this.updateTopFeatures(analytics);

                // Update active sessions
                this.updateActiveSessions();

                // Update user interests
                this.updateUserInterests(analytics);

                // Update feature stats
                this.updateFeatureStats(analytics);

                // Update audit log
                this.updateAuditLog();

                // Update ZKP verifications
                this.updateZKPVerifications();
            }

            updateOverviewStats(analytics) {
                document.getElementById('stat-total-users').textContent = analytics.overview.totalUsers;
                document.getElementById('stat-active-sessions').textContent = analytics.overview.totalSessions;

                const playgroundUsers = analytics.userInterests.filter(u => u.engagementScore > 50).length;
                document.getElementById('stat-playground-users').textContent = playgroundUsers;

                const conversionRate = analytics.overview.totalUsers > 0 ?
                    ((playgroundUsers / analytics.overview.totalUsers) * 100).toFixed(1) : 0;
                document.getElementById('stat-conversion-rate').textContent = conversionRate + '%';

                const totalFeatureUsage = analytics.featureUsage.reduce((sum, f) => sum + f.totalAccesses, 0);
                document.getElementById('stat-feature-usage').textContent = totalFeatureUsage;

                // Count security events from last 24 hours
                const securityEvents = this.auditLogger.queryAuditLog({
                    category: 'security',
                    startTime: Date.now() - 86400000
                });
                document.getElementById('stat-security-events').textContent = securityEvents.length;
            }

            updateRecentActivity() {
                const recentEvents = this.auditLogger.getRecentEvents(10);
                const container = document.getElementById('recent-activity');

                container.innerHTML = recentEvents.reverse().map(event => `
                    <div class="activity-item">
                        <div class="flex-1">
                            <div class="text-sm font-medium">${this.formatEventType(event.type)}</div>
                            <div class="text-xs text-gray-500">${new Date(event.timestamp).toLocaleString()}</div>
                        </div>
                        <span class="badge ${this.getEventBadgeClass(event.category)}">${event.category}</span>
                    </div>
                `).join('');
            }

            updateTopFeatures(analytics) {
                const topFeatures = analytics.featureUsage
                    .sort((a, b) => b.totalAccesses - a.totalAccesses)
                    .slice(0, 5);

                const container = document.getElementById('top-features');

                container.innerHTML = topFeatures.map((feature, index) => `
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-semibold text-sm">
                            ${index + 1}
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="text-sm font-medium">${feature.featureId}</div>
                            <div class="text-xs text-gray-500">${feature.totalAccesses} accesses</div>
                        </div>
                        <div class="text-sm text-gray-600">${feature.uniqueUsers} users</div>
                    </div>
                `).join('');
            }

            updateActiveSessions() {
                const sessions = this.auditLogger.getAllSessionActivities();
                const container = document.getElementById('active-sessions');

                if (sessions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No active sessions</p>';
                    return;
                }

                container.innerHTML = sessions.map(session => {
                    const duration = Math.floor((Date.now() - session.startTime) / 1000 / 60);
                    return `
                        <div class="activity-item">
                            <div class="flex-1">
                                <div class="text-sm font-medium">Session: ${session.sessionId.substring(0, 20)}...</div>
                                <div class="text-xs text-gray-500">${session.eventCount} events ‚Ä¢ ${duration} min ago</div>
                            </div>
                            <span class="badge badge-success">Active</span>
                        </div>
                    `;
                }).join('');
            }

            updateUserInterests(analytics) {
                const container = document.getElementById('user-interests');

                if (analytics.userInterests.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No user data available</p>';
                    return;
                }

                container.innerHTML = analytics.userInterests.map(user => `
                    <div class="border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="font-semibold">${user.userId}</div>
                                <div class="text-xs text-gray-500">${user.totalInteractions} interactions</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-blue-600">Engagement: ${user.engagementScore}/100</div>
                                <div class="w-32 h-2 bg-gray-200 rounded-full mt-1">
                                    <div class="h-2 bg-blue-600 rounded-full" style="width: ${user.engagementScore}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="text-xs text-gray-500">Features</div>
                                <div class="font-semibold">${user.featuresExplored}</div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="text-xs text-gray-500">Categories</div>
                                <div class="font-semibold">${user.categoriesExplored}</div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="text-xs text-gray-500">Top Interest</div>
                                <div class="font-semibold text-xs">${user.topCategory}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateFeatureStats(analytics) {
                const tbody = document.getElementById('feature-stats-body');

                tbody.innerHTML = analytics.featureUsage.map(feature => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${feature.featureId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="badge badge-info">Playground</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${feature.totalAccesses}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${feature.grantedAccesses}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${feature.deniedAccesses}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${feature.uniqueUsers}</td>
                    </tr>
                `).join('');
            }

            updateAuditLog() {
                const events = this.auditLogger.getRecentEvents(50);
                const container = document.getElementById('audit-log-entries');

                container.innerHTML = events.reverse().map(event => `
                    <div class="border-l-4 ${this.getEventBorderClass(event.severity)} bg-white p-4 rounded shadow-sm">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <span class="badge ${this.getEventBadgeClass(event.category)}">${event.category}</span>
                                    <span class="text-sm font-medium">${event.type}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">${event.eventId}</div>
                                ${event.action ? `<div class="text-sm mt-2">Action: ${event.action}</div>` : ''}
                                ${event.userId ? `<div class="text-xs text-gray-600 mt-1">User: ${event.userId}</div>` : ''}
                            </div>
                            <div class="text-xs text-gray-500 text-right">
                                ${new Date(event.timestamp).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateZKPVerifications() {
                const verifiedProofs = this.zkpVerification.getVerifiedProofs();
                const container = document.getElementById('zkp-verifications');

                if (verifiedProofs.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No ZKP verifications yet</p>';
                    return;
                }

                container.innerHTML = verifiedProofs.map(proof => `
                    <div class="border rounded-lg p-4 bg-green-50">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold">Proof: ${proof.proofId}</div>
                            <span class="badge badge-success">Verified ‚úì</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-600">Type:</span> ${proof.type}
                            </div>
                            <div>
                                <span class="text-gray-600">Timestamp:</span> ${new Date(proof.timestamp).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            filterAuditLog(category) {
                const events = category ?
                    this.auditLogger.queryAuditLog({ category }) :
                    this.auditLogger.getRecentEvents(50);

                // Update audit log display with filtered events
                const container = document.getElementById('audit-log-entries');
                container.innerHTML = events.reverse().map(event => `
                    <div class="border-l-4 ${this.getEventBorderClass(event.severity)} bg-white p-4 rounded shadow-sm">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <span class="badge ${this.getEventBadgeClass(event.category)}">${event.category}</span>
                                    <span class="text-sm font-medium">${event.type}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">${event.eventId}</div>
                            </div>
                            <div class="text-xs text-gray-500">${new Date(event.timestamp).toLocaleString()}</div>
                        </div>
                    </div>
                `).join('');
            }

            async exportAuditLog() {
                try {
                    const csv = await this.auditLogger.exportAuditLog('csv');
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `welltegra-audit-log-${Date.now()}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Export error:', error);
                    alert('Failed to export audit log');
                }
            }

            formatEventType(type) {
                return type.split('_').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            getEventBadgeClass(category) {
                const classes = {
                    auth: 'badge-info',
                    access: 'badge-warning',
                    security: 'badge-danger',
                    data: 'badge-success',
                    computation: 'badge-info'
                };
                return classes[category] || 'badge-info';
            }

            getEventBorderClass(severity) {
                const classes = {
                    debug: 'border-gray-400',
                    info: 'border-blue-400',
                    warning: 'border-yellow-400',
                    error: 'border-red-400',
                    critical: 'border-red-600'
                };
                return classes[severity] || 'border-gray-400';
            }
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.securityDashboard = new SecurityDashboard();
        });
    </script>
</body>
</html>
