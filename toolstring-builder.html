<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Brahan Engine - Toolstring Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .component-item {
            transition: all 0.2s ease;
            cursor: grab;
        }
        .component-item:hover {
            transform: translateX(4px);
            background-color: rgba(99, 102, 241, 0.1);
        }
        .component-item:active {
            cursor: grabbing;
        }
        .canvas-component {
            transition: all 0.3s ease;
            cursor: move;
        }
        .canvas-component:hover {
            box-shadow: 0 0 0 2px #6366f1;
        }
        .canvas-component.selected {
            box-shadow: 0 0 0 3px #8b5cf6;
            background-color: rgba(139, 92, 246, 0.05);
        }
        .connection-valid {
            border: 2px solid #10b981;
            animation: pulse-green 1s infinite;
        }
        .connection-invalid {
            border: 2px solid #ef4444;
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0); }
        }
        .drop-zone {
            min-height: 600px;
            background-image:
                linear-gradient(rgba(0, 0, 0, .05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, .05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .tool-svg {
            width: 60px;
            height: 80px;
        }
        .warning-badge {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">The Brahan Engine</h1>
                    <p class="text-indigo-100 mt-1">Module 3: Toolstring Builder</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-indigo-100">Well: <span class="font-semibold">W666</span></p>
                    <p class="text-sm text-indigo-100">Service Line: <span class="font-semibold" id="service-line-display">2" Coiled Tubing</span></p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-12 gap-6">

            <!-- Left Sidebar: Component Repository (Module 1) -->
            <div class="col-span-3">
                <div class="bg-white rounded-lg shadow-lg p-4 sticky top-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Component Library</h2>

                    <!-- CSV Upload -->
                    <div class="mb-4 p-3 bg-blue-50 border-2 border-blue-200 rounded-lg">
                        <label class="block text-sm font-semibold text-blue-900 mb-2">üì• Upload Toolstring CSV</label>
                        <input type="file" id="csv-upload" accept=".csv" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                        <p class="text-xs text-gray-600 mt-2">CSV format: Tool,OD,Length</p>
                    </div>

                    <!-- Service Line Filter -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Service Line</label>
                        <select id="service-line-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="slickline">Slickline</option>
                            <option value="eline">E-line (1.75")</option>
                            <option value="ct2" selected>2" Coiled Tubing</option>
                            <option value="ct2.5">2.5" Coiled Tubing</option>
                        </select>
                    </div>

                    <!-- Category Filter -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="category-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="all">All Categories</option>
                            <option value="drift">Drift Tools</option>
                            <option value="fishing">Fishing Tools</option>
                            <option value="milling">Milling Tools</option>
                            <option value="jetting">Jetting Tools</option>
                            <option value="setting">Setting Tools</option>
                            <option value="safety">Safety Tools</option>
                        </select>
                    </div>

                    <!-- Search -->
                    <div class="mb-4">
                        <input type="text" id="component-search" placeholder="Search components..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <!-- Component List -->
                    <div id="component-list" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Components will be dynamically loaded here -->
                    </div>
                </div>
            </div>

            <!-- Center: Assembly Canvas (Module 2) -->
            <div class="col-span-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-gray-900">Assembly Canvas</h2>
                        <div class="flex space-x-2">
                            <button id="clear-canvas" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                                Clear
                            </button>
                            <button id="export-schematic" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm">
                                Export Schematic
                            </button>
                        </div>
                    </div>

                    <!-- Canvas -->
                    <div id="canvas" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-4 bg-white relative">
                        <div id="canvas-empty-state" class="absolute inset-0 flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <p class="mt-2 text-sm">Drag components here to build your toolstring</p>
                            </div>
                        </div>
                        <div id="toolstring-display" class="space-y-1">
                            <!-- Toolstring components will appear here -->
                        </div>
                    </div>

                    <!-- Validation Messages -->
                    <div id="validation-messages" class="mt-4 space-y-2">
                        <!-- Validation errors/warnings will appear here -->
                    </div>
                </div>
            </div>

            <!-- Right Sidebar: Properties & Analysis (Module 3) -->
            <div class="col-span-3">
                <div class="bg-white rounded-lg shadow-lg p-4 sticky top-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Analysis</h2>

                    <!-- Toolstring Stats -->
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-sm text-gray-600">Total Length</span>
                            <span class="text-sm font-semibold" id="stat-length">0.0 ft</span>
                        </div>
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-sm text-gray-600">Total Weight (Air)</span>
                            <span class="text-sm font-semibold" id="stat-weight-air">0 lbs</span>
                        </div>
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-sm text-gray-600">Weight (In Fluid)</span>
                            <span class="text-sm font-semibold" id="stat-weight-fluid">0 lbs</span>
                        </div>
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-sm text-gray-600">Max OD</span>
                            <span class="text-sm font-semibold" id="stat-max-od">0.0"</span>
                        </div>
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-sm text-gray-600">Components</span>
                            <span class="text-sm font-semibold" id="stat-count">0</span>
                        </div>
                    </div>

                    <!-- Wellbore Restriction Data -->
                    <div class="mb-6">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Wellbore Restrictions</h3>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <button id="load-restrictions-btn" class="w-full px-3 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition-colors mb-2">
                                Load Well 666 Data
                            </button>
                            <div id="restriction-summary" class="text-xs text-gray-600">
                                <span>No restriction data loaded</span>
                            </div>
                        </div>
                    </div>

                    <!-- Clash Detection -->
                    <div class="mb-6">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Clash Detection</h3>
                        <div id="clash-detection-result" class="rounded-lg p-4 border-2">
                            <div class="text-center text-sm text-gray-500">
                                Upload toolstring & load wellbore data
                            </div>
                        </div>
                    </div>

                    <!-- Selected Component Details -->
                    <div id="component-details" class="hidden">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Component Details</h3>
                        <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                            <div class="text-xs">
                                <span class="text-gray-600">Name:</span>
                                <span class="font-semibold ml-1" id="detail-name"></span>
                            </div>
                            <div class="text-xs">
                                <span class="text-gray-600">OD:</span>
                                <span class="font-semibold ml-1" id="detail-od"></span>
                            </div>
                            <div class="text-xs">
                                <span class="text-gray-600">Length:</span>
                                <span class="font-semibold ml-1" id="detail-length"></span>
                            </div>
                            <div class="text-xs">
                                <span class="text-gray-600">Weight:</span>
                                <span class="font-semibold ml-1" id="detail-weight"></span>
                            </div>
                            <div class="text-xs">
                                <span class="text-gray-600">Connections:</span>
                                <div class="ml-1 mt-1 text-xs">
                                    <div><span class="text-gray-500">Top:</span> <span id="detail-top" class="font-mono"></span></div>
                                    <div><span class="text-gray-500">Bot:</span> <span id="detail-bottom" class="font-mono"></span></div>
                                </div>
                            </div>
                            <button id="remove-component" class="w-full mt-2 px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors">
                                Remove from String
                            </button>
                        </div>
                    </div>

                    <!-- Validation Summary -->
                    <div class="mt-6">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Validation Status</h3>
                        <div id="validation-summary" class="space-y-2">
                            <div class="flex items-center text-xs text-gray-500">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                Ready to build
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // ENHANCED TOOLSTRING BUILDER WITH CLASH DETECTION
        // The Brahan Engine - Option 2 Quick Win Implementation
        // Includes strategic propagation hooks for all stakeholders
        // ========================================================================

        // Global State
        let wellboreRestrictions = [];
        let uploadedToolstring = [];
        let currentUser = { id: 'user_001', name: 'Engineering Team', authenticated: true }; // Mock auth

        // Component Database (Module 1)
        const componentDatabase = {
            // Drift Tools
            drift1: {
                id: 'drift1',
                name: 'Gauge Ring 2.875"',
                category: 'drift',
                serviceLine: ['ct2', 'ct2.5'],
                od: 2.875,
                id_internal: 1.5,
                length: 1.5,
                weight: 12,
                topConnection: '2-3/8 PIN',
                bottomConnection: '2-3/8 BOX',
                manufacturer: 'Weatherford',
                status: 'available'
            },
            drift2: {
                id: 'drift2',
                name: 'Scraper 2.5"',
                category: 'drift',
                serviceLine: ['ct2', 'ct2.5'],
                od: 2.5,
                id_internal: 1.25,
                length: 2.0,
                weight: 15,
                topConnection: '2-3/8 PIN',
                bottomConnection: '2-3/8 BOX',
                manufacturer: 'Baker Hughes',
                status: 'available'
            },
            // Milling Tools
            mill1: {
                id: 'mill1',
                name: 'Junk Mill 3.0"',
                category: 'milling',
                serviceLine: ['ct2', 'ct2.5'],
                od: 3.0,
                id_internal: 1.0,
                length: 3.5,
                weight: 45,
                topConnection: '2-7/8 PIN',
                bottomConnection: 'CLOSED',
                manufacturer: 'Halliburton',
                status: 'available'
            },
            mill2: {
                id: 'mill2',
                name: 'Watermelon Mill 2.75"',
                category: 'milling',
                serviceLine: ['ct2'],
                od: 2.75,
                id_internal: 0.75,
                length: 4.0,
                weight: 38,
                topConnection: '2-3/8 PIN',
                bottomConnection: 'CLOSED',
                manufacturer: 'NOV',
                status: 'available'
            },
            // Jetting Tools
            jet1: {
                id: 'jet1',
                name: 'Rotating Jetting Tool',
                category: 'jetting',
                serviceLine: ['ct2', 'ct2.5'],
                od: 2.25,
                id_internal: 1.5,
                length: 5.0,
                weight: 28,
                topConnection: '2-3/8 PIN',
                bottomConnection: '2-3/8 BOX',
                manufacturer: 'Schlumberger',
                status: 'available'
            },
            jet2: {
                id: 'jet2',
                name: 'Fixed Nozzle Jetting Sub',
                category: 'jetting',
                serviceLine: ['ct2'],
                od: 2.0,
                id_internal: 1.25,
                length: 2.5,
                weight: 18,
                topConnection: '2-3/8 PIN',
                bottomConnection: '2-3/8 BOX',
                manufacturer: 'Baker Hughes',
                status: 'available'
            },
            // Safety Tools
            safety1: {
                id: 'safety1',
                name: 'Check Valve',
                category: 'safety',
                serviceLine: ['ct2', 'ct2.5', 'eline', 'slickline'],
                od: 1.75,
                id_internal: 1.25,
                length: 1.0,
                weight: 8,
                topConnection: '2-3/8 PIN',
                bottomConnection: '2-3/8 BOX',
                manufacturer: 'Halliburton',
                status: 'available'
            },
            safety2: {
                id: 'safety2',
                name: 'Shear Sub (3000 lbs)',
                category: 'safety',
                serviceLine: ['ct2', 'ct2.5'],
                od: 2.0,
                id_internal: 1.5,
                length: 1.5,
                weight: 10,
                topConnection: '2-3/8 PIN',
                bottomConnection: '2-3/8 BOX',
                manufacturer: 'NOV',
                status: 'available'
            },
            // Fishing Tools
            fish1: {
                id: 'fish1',
                name: 'Overshot 2.875"',
                category: 'fishing',
                serviceLine: ['ct2.5'],
                od: 3.5,
                id_internal: 2.875,
                length: 4.0,
                weight: 55,
                topConnection: '2-7/8 PIN',
                bottomConnection: 'OPEN',
                manufacturer: 'Weatherford',
                status: 'available'
            },
            // Setting Tools
            set1: {
                id: 'set1',
                name: 'Mechanical Setting Tool',
                category: 'setting',
                serviceLine: ['ct2', 'eline'],
                od: 2.5,
                id_internal: 1.0,
                length: 6.0,
                weight: 42,
                topConnection: '2-3/8 PIN',
                bottomConnection: '2-3/8 BOX',
                manufacturer: 'Baker Hughes',
                status: 'available'
            }
        };

        // State Management
        let currentToolstring = [];
        let selectedComponentId = null;
        let currentServiceLine = 'ct2';
        let restrictionID = 2.992;

        // DOM Elements
        const serviceLineFilter = document.getElementById('service-line-filter');
        const categoryFilter = document.getElementById('category-filter');
        const componentSearch = document.getElementById('component-search');
        const componentList = document.getElementById('component-list');
        const canvas = document.getElementById('canvas');
        const toolstringDisplay = document.getElementById('toolstring-display');
        const canvasEmptyState = document.getElementById('canvas-empty-state');
        const clearCanvasBtn = document.getElementById('clear-canvas');
        const exportSchematicBtn = document.getElementById('export-schematic');
        const restrictionInput = document.getElementById('restriction-id');

        // Initialize
        renderComponentLibrary();
        updateAnalysis();

        // Service Line Filter
        serviceLineFilter.addEventListener('change', (e) => {
            currentServiceLine = e.target.value;
            const serviceNames = {
                'slickline': 'Slickline',
                'eline': 'E-line (1.75")',
                'ct2': '2" Coiled Tubing',
                'ct2.5': '2.5" Coiled Tubing'
            };
            document.getElementById('service-line-display').textContent = serviceNames[currentServiceLine];
            renderComponentLibrary();
        });

        // Category Filter
        categoryFilter.addEventListener('change', () => {
            renderComponentLibrary();
        });

        // Search
        componentSearch.addEventListener('input', () => {
            renderComponentLibrary();
        });

        // CSV Upload Handler
        document.getElementById('csv-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // SECURITY: Catriona Cameron - Audit Trail
            logSecurityEvent('CSV_UPLOAD_INITIATED', {
                userId: currentUser.id,
                filename: file.name,
                fileSize: file.size,
                timestamp: new Date().toISOString()
            });

            // SECURITY: Validate file type
            if (!file.name.endsWith('.csv')) {
                alert('‚ö†Ô∏è Security: Only CSV files are allowed');
                logSecurityEvent('CSV_UPLOAD_REJECTED', { reason: 'invalid_extension', filename: file.name });
                return;
            }

            // SECURITY: Check file size (max 1MB)
            if (file.size > 1024 * 1024) {
                alert('‚ö†Ô∏è Security: File too large (max 1MB)');
                logSecurityEvent('CSV_UPLOAD_REJECTED', { reason: 'file_too_large', size: file.size });
                return;
            }

            try {
                const text = await file.text();
                const parsed = parseToolstringCSV(text);

                if (parsed.length === 0) {
                    alert('‚ö†Ô∏è No valid tools found in CSV');
                    return;
                }

                uploadedToolstring = parsed;

                // Clear current toolstring and load from CSV
                currentToolstring = [...parsed];
                renderToolstring();
                updateAnalysis();
                canvasEmptyState.classList.add('hidden');

                // SECURITY: Log successful upload
                logSecurityEvent('CSV_UPLOAD_SUCCESS', {
                    userId: currentUser.id,
                    filename: file.name,
                    toolsCount: parsed.length,
                    timestamp: new Date().toISOString()
                });

                // DATA ENGINEERING: Angus Campbell - Data Lake Ingestion
                ingestToDataLake({
                    eventType: 'TOOLSTRING_UPLOAD',
                    wellId: '666',
                    toolstring: parsed,
                    uploadedBy: currentUser.id,
                    timestamp: new Date().toISOString()
                });

                alert(`‚úÖ Loaded ${parsed.length} tools from CSV`);

                // Run clash detection if restrictions are loaded
                if (wellboreRestrictions.length > 0) {
                    runClashDetection();
                }

            } catch (error) {
                console.error('[CSV Upload Error]', error);
                alert('‚ö†Ô∏è Error parsing CSV: ' + error.message);
                logSecurityEvent('CSV_UPLOAD_ERROR', { error: error.message, filename: file.name });
            }
        });

        // Load Wellbore Restrictions
        document.getElementById('load-restrictions-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('data/well_666_restrictions.csv');
                if (!response.ok) throw new Error('Failed to load restriction data');

                const text = await response.text();
                wellboreRestrictions = parseRestrictionsCSV(text);

                updateRestrictionSummary();

                // INTEGRITY: Dr. Isla Munro - Data Pipeline Hook
                feedToIntegrityModels({
                    wellId: '666',
                    restrictionData: wellboreRestrictions,
                    timestamp: new Date().toISOString(),
                    source: 'Caliper Log',
                    analysisType: 'Real-time Deformation Tracking'
                });

                alert(`‚úÖ Loaded ${wellboreRestrictions.length} restriction data points for Well 666`);

                // Run clash detection if toolstring is loaded
                if (currentToolstring.length > 0) {
                    runClashDetection();
                }

            } catch (error) {
                console.error('[Restriction Load Error]', error);
                alert('‚ö†Ô∏è Error loading restriction data: ' + error.message);
            }
        });

        // Render Component Library
        function renderComponentLibrary() {
            const selectedCategory = categoryFilter.value;
            const searchTerm = componentSearch.value.toLowerCase();

            const filtered = Object.values(componentDatabase).filter(comp => {
                const matchesServiceLine = comp.serviceLine.includes(currentServiceLine);
                const matchesCategory = selectedCategory === 'all' || comp.category === selectedCategory;
                const matchesSearch = comp.name.toLowerCase().includes(searchTerm) || comp.manufacturer.toLowerCase().includes(searchTerm);
                return matchesServiceLine && matchesCategory && matchesSearch;
            });

            componentList.innerHTML = filtered.map(comp => `
                <div class="component-item p-3 border border-gray-200 rounded-lg" draggable="true" data-component-id="${comp.id}">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <svg class="tool-svg" viewBox="0 0 60 80" fill="none" stroke="#6366f1" stroke-width="2">
                                ${getToolSVG(comp.category)}
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${comp.name}</p>
                            <p class="text-xs text-gray-500">${comp.manufacturer}</p>
                            <p class="text-xs text-gray-600 mt-1">OD: ${comp.od}" | L: ${comp.length} ft</p>
                        </div>
                    </div>
                </div>
            `).join('');

            // Add drag event listeners
            componentList.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
            });
        }

        // Get Tool SVG based on category
        function getToolSVG(category) {
            const svgs = {
                drift: '<rect x="20" y="10" width="20" height="60" rx="2"/>',
                milling: '<path d="M 30 10 L 40 30 L 30 70 L 20 30 Z"/>',
                jetting: '<circle cx="30" cy="15" r="8"/><rect x="25" y="20" width="10" height="50"/><path d="M 20 70 L 30 60 L 40 70"/>',
                safety: '<rect x="22" y="15" width="16" height="50" rx="8"/><circle cx="30" cy="40" r="5" fill="#6366f1"/>',
                fishing: '<path d="M 25 10 L 35 10 L 40 30 L 35 70 L 25 70 L 20 30 Z"/>',
                setting: '<rect x="24" y="10" width="12" height="60" rx="1"/><rect x="20" y="30" width="20" height="10" fill="#6366f1"/>'
            };
            return svgs[category] || '<rect x="25" y="10" width="10" height="60"/>';
        }

        // Drag and Drop Handlers
        function handleDragStart(e) {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('componentId', e.currentTarget.dataset.componentId);
        }

        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const componentId = e.dataTransfer.getData('componentId');
            addComponentToString(componentId);
        });

        // Add Component to Toolstring
        function addComponentToString(componentId) {
            const component = componentDatabase[componentId];
            if (!component) return;

            // Validate connection if there are existing components
            if (currentToolstring.length > 0) {
                const lastComponent = currentToolstring[currentToolstring.length - 1];
                const isValid = validateConnection(lastComponent, component);

                if (!isValid) {
                    showValidationMessage('error', `Connection Error: ${lastComponent.bottomConnection} cannot connect to ${component.topConnection}`);
                    return;
                }
            }

            currentToolstring.push({...component, instanceId: Date.now()});
            renderToolstring();
            updateAnalysis();
            canvasEmptyState.classList.add('hidden');
        }

        // Validate Connection
        function validateConnection(topTool, bottomTool) {
            // Simplified validation: check if connections match
            if (topTool.bottomConnection === 'CLOSED' || topTool.bottomConnection === 'OPEN') {
                return false;
            }

            // In real implementation, this would check thread compatibility
            // For now, just check if they're similar sizes
            const topSize = parseFloat(topTool.bottomConnection);
            const bottomSize = parseFloat(bottomTool.topConnection);

            return Math.abs(topSize - bottomSize) < 0.5 || topTool.bottomConnection === bottomTool.topConnection;
        }

        // Render Toolstring
        function renderToolstring() {
            if (currentToolstring.length === 0) {
                toolstringDisplay.innerHTML = '';
                canvasEmptyState.classList.remove('hidden');
                return;
            }

            canvasEmptyState.classList.add('hidden');
            toolstringDisplay.innerHTML = currentToolstring.map((comp, index) => `
                <div class="canvas-component p-3 bg-white border-2 border-gray-200 rounded-lg flex items-center space-x-3 ${selectedComponentId === comp.instanceId ? 'selected' : ''}"
                     data-instance-id="${comp.instanceId}">
                    <div class="flex-shrink-0 text-gray-400 font-mono text-xs">
                        ${index + 1}
                    </div>
                    <div class="flex-shrink-0">
                        <svg class="w-12 h-16" viewBox="0 0 60 80" fill="none" stroke="#6366f1" stroke-width="2">
                            ${getToolSVG(comp.category)}
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-900">${comp.name}</p>
                        <p class="text-xs text-gray-500">${comp.od}" OD √ó ${comp.length} ft</p>
                        <div class="flex items-center mt-1 space-x-2">
                            ${comp.od > restrictionID ? '<span class="warning-badge inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">‚ö† Clearance Issue</span>' : ''}
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <button class="delete-btn p-1 text-gray-400 hover:text-red-600 transition-colors" data-instance-id="${comp.instanceId}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');

            // Add click handlers
            toolstringDisplay.querySelectorAll('.canvas-component').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-btn')) {
                        selectComponent(parseInt(item.dataset.instanceId));
                    }
                });
            });

            toolstringDisplay.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeComponent(parseInt(btn.dataset.instanceId));
                });
            });
        }

        // Select Component
        function selectComponent(instanceId) {
            selectedComponentId = instanceId;
            const component = currentToolstring.find(c => c.instanceId === instanceId);

            if (component) {
                document.getElementById('component-details').classList.remove('hidden');
                document.getElementById('detail-name').textContent = component.name;
                document.getElementById('detail-od').textContent = `${component.od}"`;
                document.getElementById('detail-length').textContent = `${component.length} ft`;
                document.getElementById('detail-weight').textContent = `${component.weight} lbs`;
                document.getElementById('detail-top').textContent = component.topConnection;
                document.getElementById('detail-bottom').textContent = component.bottomConnection;
            }

            renderToolstring();
        }

        // Remove Component
        document.getElementById('remove-component')?.addEventListener('click', () => {
            if (selectedComponentId) {
                removeComponent(selectedComponentId);
            }
        });

        function removeComponent(instanceId) {
            currentToolstring = currentToolstring.filter(c => c.instanceId !== instanceId);
            selectedComponentId = null;
            document.getElementById('component-details').classList.add('hidden');
            renderToolstring();
            updateAnalysis();
        }

        // Clear Canvas
        clearCanvasBtn.addEventListener('click', () => {
            if (confirm('Clear entire toolstring?')) {
                currentToolstring = [];
                selectedComponentId = null;
                document.getElementById('component-details').classList.add('hidden');
                renderToolstring();
                updateAnalysis();
            }
        });

        // Update Analysis (Module 3)
        function updateAnalysis() {
            const totalLength = currentToolstring.reduce((sum, c) => sum + c.length, 0);
            const totalWeightAir = currentToolstring.reduce((sum, c) => sum + c.weight, 0);
            const maxOD = currentToolstring.length > 0 ? Math.max(...currentToolstring.map(c => c.od)) : 0;

            // Buoyancy factor for weight in fluid (simplified: assumes 9.6 ppg brine)
            const buoyancyFactor = 0.85;
            const totalWeightFluid = totalWeightAir * buoyancyFactor;

            document.getElementById('stat-length').textContent = `${totalLength.toFixed(1)} ft`;
            document.getElementById('stat-weight-air').textContent = `${totalWeightAir.toFixed(0)} lbs`;
            document.getElementById('stat-weight-fluid').textContent = `${totalWeightFluid.toFixed(0)} lbs`;
            document.getElementById('stat-max-od').textContent = `${maxOD.toFixed(3)}"`;
            document.getElementById('stat-count').textContent = currentToolstring.length;

            // Clearance Check
            updateClearanceStatus(maxOD);
            updateValidationSummary();
        }

        // Clearance Status
        function updateClearanceStatus(maxOD) {
            const clearanceDiv = document.getElementById('clearance-status');

            if (currentToolstring.length === 0) {
                clearanceDiv.innerHTML = '<span class="text-gray-500">No components added</span>';
                return;
            }

            const clearance = restrictionID - maxOD;

            if (clearance < 0) {
                clearanceDiv.innerHTML = `
                    <div class="flex items-center text-red-600">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-semibold">FAIL: ${Math.abs(clearance).toFixed(3)}" oversize</span>
                    </div>
                `;
            } else if (clearance < 0.1) {
                clearanceDiv.innerHTML = `
                    <div class="flex items-center text-yellow-600">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-semibold">TIGHT: ${clearance.toFixed(3)}" clearance</span>
                    </div>
                `;
            } else {
                clearanceDiv.innerHTML = `
                    <div class="flex items-center text-green-600">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-semibold">PASS: ${clearance.toFixed(3)}" clearance</span>
                    </div>
                `;
            }
        }

        // Validation Summary
        function updateValidationSummary() {
            const summary = document.getElementById('validation-summary');
            const issues = [];

            // Check for clearance issues
            const maxOD = currentToolstring.length > 0 ? Math.max(...currentToolstring.map(c => c.od)) : 0;
            if (maxOD > restrictionID) {
                issues.push({type: 'error', text: 'Toolstring will not pass restriction'});
            }

            // Check for connection issues
            for (let i = 0; i < currentToolstring.length - 1; i++) {
                if (!validateConnection(currentToolstring[i], currentToolstring[i + 1])) {
                    issues.push({type: 'warning', text: `Connection mismatch at position ${i + 1}-${i + 2}`});
                }
            }

            if (issues.length === 0 && currentToolstring.length > 0) {
                summary.innerHTML = `
                    <div class="flex items-center text-xs text-green-600">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        All validations passed
                    </div>
                `;
            } else if (currentToolstring.length === 0) {
                summary.innerHTML = `
                    <div class="flex items-center text-xs text-gray-500">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        Ready to build
                    </div>
                `;
            } else {
                summary.innerHTML = issues.map(issue => `
                    <div class="flex items-center text-xs ${issue.type === 'error' ? 'text-red-600' : 'text-yellow-600'}">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            ${issue.type === 'error'
                                ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />'
                                : '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />'
                            }
                        </svg>
                        ${issue.text}
                    </div>
                `).join('');
            }
        }

        // Show Validation Message
        function showValidationMessage(type, message) {
            const msgDiv = document.getElementById('validation-messages');
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-3 rounded-lg ${type === 'error' ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800'}`;
            alertDiv.innerHTML = `
                <div class="flex items-start">
                    <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-sm">${message}</span>
                </div>
            `;
            msgDiv.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // ========================================================================
        // CSV PARSING FUNCTIONS
        // ========================================================================

        function parseToolstringCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const tools = [];

            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const [tool, od, length] = line.split(',').map(s => s.trim());

                if (tool && od && length) {
                    tools.push({
                        id: `csv_tool_${i}`,
                        instanceId: Date.now() + i,
                        name: tool,
                        category: 'uploaded',
                        serviceLine: [currentServiceLine],
                        od: parseFloat(od),
                        id_internal: parseFloat(od) * 0.7, // Estimate
                        length: parseFloat(length),
                        weight: parseFloat(od) * parseFloat(length) * 10, // Estimate
                        topConnection: '2-3/8 PIN',
                        bottomConnection: '2-3/8 BOX',
                        manufacturer: 'Uploaded',
                        status: 'uploaded'
                    });
                }
            }

            return tools;
        }

        function parseRestrictionsCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const restrictions = [];

            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(',');
                if (parts.length >= 4) {
                    restrictions.push({
                        depth_m: parseFloat(parts[0]),
                        depth_ft: parseFloat(parts[1]),
                        id_mm: parseFloat(parts[2]),
                        id_in: parseFloat(parts[3]),
                        type: parts[4] || 'Unknown',
                        severity: parts[5] || 'Unknown',
                        notes: parts[6] || ''
                    });
                }
            }

            return restrictions;
        }

        function updateRestrictionSummary() {
            const summary = document.getElementById('restriction-summary');

            if (wellboreRestrictions.length === 0) {
                summary.innerHTML = '<span class="text-gray-600">No restriction data loaded</span>';
                return;
            }

            // Find critical restrictions
            const critical = wellboreRestrictions.filter(r => r.severity === 'High');
            const minID = Math.min(...wellboreRestrictions.map(r => r.id_in));

            summary.innerHTML = `
                <div class="text-xs">
                    <div class="font-semibold text-green-700 mb-1">‚úÖ Data Loaded</div>
                    <div class="mb-1">${wellboreRestrictions.length} data points</div>
                    <div class="mb-1">Min ID: <span class="font-mono font-bold">${minID.toFixed(3)}"</span></div>
                    ${critical.length > 0 ? `<div class="text-red-600 font-semibold">‚ö†Ô∏è ${critical.length} Critical Restriction(s)</div>` : ''}
                </div>
            `;
        }

        // ========================================================================
        // CLASH DETECTION LOGIC
        // Core functionality for Option 2
        // ========================================================================

        function runClashDetection() {
            if (currentToolstring.length === 0 || wellboreRestrictions.length === 0) {
                return;
            }

            console.log('[Clash Detection] Starting analysis...');

            // Find the minimum restriction ID
            const minRestriction = Math.min(...wellboreRestrictions.map(r => r.id_in));
            const criticalRestriction = wellboreRestrictions.find(r => r.id_in === minRestriction);

            // Find the maximum tool OD
            const maxToolOD = Math.max(...currentToolstring.map(t => t.od));
            const problematicTool = currentToolstring.find(t => t.od === maxToolOD);

            // Calculate clearance
            const clearance = minRestriction - maxToolOD;
            const hasClash = clearance <= 0;

            console.log('[Clash Detection] Results:', {
                minRestriction: minRestriction,
                maxToolOD: maxToolOD,
                clearance: clearance,
                hasClash: hasClash
            });

            // Display high-contrast UI feedback
            displayClashResult(hasClash, clearance, problematicTool, criticalRestriction);

            // If clash detected, trigger strategic propagation hooks
            if (hasClash) {
                handleClashDetected(problematicTool, criticalRestriction, clearance);
            } else {
                // Even successful runs get logged for data lake
                logSuccessfulClearanceCheck(maxToolOD, minRestriction, clearance);
            }
        }

        // Escape HTML meta-characters to prevent XSS when inserting user content via innerHTML
        function escapeHTML(str) {
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function displayClashResult(hasClash, clearance, tool, restriction) {
            const resultDiv = document.getElementById('clash-detection-result');

            if (hasClash) {
                // CRITICAL: CLASH DETECTED - High-contrast red UI for field tablets
                resultDiv.className = 'rounded-lg p-4 border-4 border-red-600 bg-red-100';
                resultDiv.innerHTML = `
                    <div class="text-center">
                        <div class="text-3xl font-black text-red-900 mb-3">
                            ‚õî CLASH DETECTED
                        </div>
                        <div class="text-lg font-bold text-red-800 mb-3">
                            Tool will NOT pass restriction
                        </div>
                        <div class="bg-white rounded-lg p-3 mb-3 border-2 border-red-600">
                            <div class="text-sm font-semibold text-red-900 mb-1">Problem Tool:</div>
                            <div class="text-base font-mono text-red-800">${escapeHTML(tool.name)}</div>
                            <div class="text-sm font-mono text-red-700">OD: ${tool.od.toFixed(3)}"</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 mb-3 border-2 border-red-600">
                            <div class="text-sm font-semibold text-red-900 mb-1">Restriction:</div>
                            <div class="text-base font-mono text-red-800">@ ${restriction.depth_ft.toFixed(0)} ft MD</div>
                            <div class="text-sm font-mono text-red-700">ID: ${restriction.id_in.toFixed(3)}"</div>
                        </div>
                        <div class="bg-red-200 rounded-lg p-3 mb-3">
                            <div class="text-sm font-semibold text-red-900 mb-1">Interference:</div>
                            <div class="text-2xl font-black text-red-900">${Math.abs(clearance).toFixed(3)}" OVERSIZE</div>
                        </div>
                        <button id="moc-trigger-btn" class="w-full px-4 py-3 bg-orange-600 text-white text-base font-bold rounded-lg hover:bg-orange-700 transition-colors">
                            üö® INITIATE MOC WORKFLOW
                        </button>
                    </div>
                `;

                // Add MOC button handler (Finlay MacLeod - Operations)
                document.getElementById('moc-trigger-btn')?.addEventListener('click', () => {
                    initiateMOCWorkflow(tool, restriction, clearance);
                });

            } else {
                // SUCCESS: CLEARANCE PASS - High-contrast green UI
                resultDiv.className = 'rounded-lg p-4 border-4 border-green-600 bg-green-100';
                resultDiv.innerHTML = `
                    <div class="text-center">
                        <div class="text-3xl font-black text-green-900 mb-3">
                            ‚úÖ CLEARANCE PASS
                        </div>
                        <div class="text-lg font-bold text-green-800 mb-3">
                            All tools will pass restriction
                        </div>
                        <div class="bg-white rounded-lg p-3 mb-2 border-2 border-green-600">
                            <div class="text-sm font-semibold text-green-900 mb-1">Maximum Tool OD:</div>
                            <div class="text-base font-mono text-green-800">${tool.name}</div>
                            <div class="text-sm font-mono text-green-700">OD: ${tool.od.toFixed(3)}"</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 mb-2 border-2 border-green-600">
                            <div class="text-sm font-semibold text-green-900 mb-1">Minimum Restriction:</div>
                            <div class="text-base font-mono text-green-800">@ ${restriction.depth_ft.toFixed(0)} ft MD</div>
                            <div class="text-sm font-mono text-green-700">ID: ${restriction.id_in.toFixed(3)}"</div>
                        </div>
                        <div class="bg-green-200 rounded-lg p-3">
                            <div class="text-sm font-semibold text-green-900 mb-1">Clearance:</div>
                            <div class="text-2xl font-black text-green-900">${clearance.toFixed(3)}"</div>
                        </div>
                    </div>
                `;
            }
        }

        // ========================================================================
        // STRATEGIC PROPAGATION HOOKS
        // These are the critical integration points for stakeholders
        // ========================================================================

        /**
         * OPERATIONS: Finlay MacLeod
         * Trigger Management of Change (MOC) workflow when clash is detected
         */
        function initiateMOCWorkflow(tool, restriction, clearance) {
            console.log('[OPERATIONS - Finlay MacLeod] Initiating MOC Workflow...');

            const mocData = {
                eventType: 'CLASH_DETECTED_MOC',
                wellId: '666',
                timestamp: new Date().toISOString(),
                initiatedBy: currentUser.id,
                tool: {
                    name: tool.name,
                    od: tool.od,
                    manufacturer: tool.manufacturer
                },
                restriction: {
                    depth_ft: restriction.depth_ft,
                    id_in: restriction.id_in,
                    severity: restriction.severity
                },
                interference: Math.abs(clearance),
                requiredActions: [
                    'Engineering review required',
                    'Alternative toolstring design needed',
                    'Update risk assessment',
                    'Notify operations supervisor'
                ],
                priority: 'HIGH',
                status: 'PENDING_REVIEW'
            };

            // In production: POST to MOC system API
            console.log('[MOC Workflow] Data:', mocData);

            // Simulate MOC workflow trigger
            alert(`üö® MOC WORKFLOW INITIATED\n\nA Management of Change request has been created.\n\nCase ID: MOC-${Date.now()}\nPriority: HIGH\nStatus: Pending Engineering Review\n\nFinlay MacLeod will be notified immediately.`);

            // Log to console for demo purposes
            console.table(mocData);
        }

        /**
         * FINANCE: Marcus King
         * Log every clash event for ROI and NPT cost tracking
         */
        function handleClashDetected(tool, restriction, clearance) {
            console.log('[FINANCE - Marcus King] Logging clash event for ROI analysis...');

            const financialRiskData = {
                eventType: 'CLASH_EVENT',
                wellId: '666',
                toolName: tool.name,
                clashDepth_ft: restriction.depth_ft,
                interference_in: Math.abs(clearance),
                timestamp: new Date().toISOString(),
                estimatedNPT_hours: 24, // Conservative estimate: 1 day NPT
                estimatedCost_USD: 150000, // Rig rate $6250/hr * 24hr
                mitigationStatus: 'PREVENTED',
                detectedBy: 'WellTegra Clash Detection'
            };

            // In production: POST to financial risk database
            console.log('[Financial Risk DB] Logging event:', financialRiskData);

            // Simulate database write
            if (typeof localStorage !== 'undefined') {
                const existingEvents = JSON.parse(localStorage.getItem('welltegra_clash_events') || '[]');
                existingEvents.push(financialRiskData);
                localStorage.setItem('welltegra_clash_events', JSON.stringify(existingEvents));
            }

            console.log('[FINANCE] ROI Impact: Prevented potential $150,000 NPT incident');
        }

        /**
         * INTEGRITY: Dr. Isla Munro
         * Feed restriction data back to integrity models for corrosion prediction
         */
        function feedToIntegrityModels(data) {
            console.log('[INTEGRITY - Dr. Isla Munro] Feeding data to integrity models...');

            const integrityData = {
                eventType: 'WELLBORE_DEFORMATION_DATA',
                wellId: data.wellId,
                dataPoints: data.restrictionData.length,
                criticalRestrictions: data.restrictionData.filter(r => r.severity === 'High'),
                timestamp: data.timestamp,
                source: data.source,
                integrityPredictions: {
                    corrosionRate: 'ACCELERATED',
                    estimatedRemainingLife_years: 3.5,
                    nextInspectionDue: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString(), // 6 months
                    recommendation: 'Schedule detailed casing inspection within 6 months'
                }
            };

            // In production: POST to Dr. Munro's integrity modeling system
            console.log('[Integrity Models] Processing:', integrityData);
            console.log('[INTEGRITY] Data will improve long-term corrosion failure predictions');
        }

        /**
         * SECURITY: Catriona Cameron
         * Log all file uploads and operations to SIEM platform
         */
        function logSecurityEvent(eventType, details) {
            console.log('[SECURITY - Catriona Cameron] Logging to SIEM...');

            const securityEvent = {
                eventType: eventType,
                timestamp: new Date().toISOString(),
                userId: currentUser.id,
                userName: currentUser.name,
                ipAddress: '192.168.1.100', // Mock IP
                sessionId: 'sess_' + Date.now(),
                details: details,
                severity: eventType.includes('REJECT') || eventType.includes('ERROR') ? 'WARNING' : 'INFO'
            };

            // In production: POST to SIEM platform (Splunk, ELK, etc.)
            console.log('[SIEM] Event:', securityEvent);

            // Simulate audit trail storage
            if (typeof localStorage !== 'undefined') {
                const auditTrail = JSON.parse(localStorage.getItem('welltegra_audit_trail') || '[]');
                auditTrail.push(securityEvent);
                // Keep only last 100 events in browser storage
                if (auditTrail.length > 100) auditTrail.shift();
                localStorage.setItem('welltegra_audit_trail', JSON.stringify(auditTrail));
            }
        }

        /**
         * DATA ENGINEERING: Angus Campbell & DATA SCIENCE: Dr. Alistair Fraser
         * Stream all toolstring configurations to data lake for ML training
         */
        function ingestToDataLake(data) {
            console.log('[DATA ENG - Angus Campbell] Ingesting to data lake...');
            console.log('[DATA SCI - Dr. Alistair Fraser] Building ML training dataset...');

            const dataLakeRecord = {
                eventType: data.eventType,
                wellId: data.wellId,
                timestamp: data.timestamp,
                uploadedBy: data.uploadedBy,
                toolstring: data.toolstring.map(t => ({
                    name: t.name,
                    od: t.od,
                    length: t.length,
                    category: t.category
                })),
                totalLength: data.toolstring.reduce((sum, t) => sum + t.length, 0),
                maxOD: Math.max(...data.toolstring.map(t => t.od)),
                toolCount: data.toolstring.length,
                // Metadata for ML
                mlFeatures: {
                    avgOD: data.toolstring.reduce((sum, t) => sum + t.od, 0) / data.toolstring.length,
                    odVariance: calculateVariance(data.toolstring.map(t => t.od)),
                    toolSequence: data.toolstring.map(t => t.category).join('-')
                }
            };

            // In production: POST to data lake (S3, Azure Data Lake, etc.)
            console.log('[Data Lake] Record:', dataLakeRecord);

            // Simulate data pipeline
            if (typeof localStorage !== 'undefined') {
                const dataLake = JSON.parse(localStorage.getItem('welltegra_data_lake') || '[]');
                dataLake.push(dataLakeRecord);
                localStorage.setItem('welltegra_data_lake', JSON.stringify(dataLake));
            }

            console.log('[DATA SCI] Training data enriched for future ML models');
        }

        /**
         * Log successful clearance checks (still valuable data!)
         */
        function logSuccessfulClearanceCheck(maxOD, minID, clearance) {
            console.log('[SUCCESS] Clearance check passed - logging for analytics...');

            // DATA ENGINEERING: Still send successful runs to data lake
            ingestToDataLake({
                eventType: 'CLEARANCE_CHECK_SUCCESS',
                wellId: '666',
                toolstring: currentToolstring,
                uploadedBy: currentUser.id,
                timestamp: new Date().toISOString(),
                clearanceResult: {
                    maxOD: maxOD,
                    minID: minID,
                    clearance: clearance,
                    status: 'PASS'
                }
            });
        }

        // Helper: Calculate variance for ML features
        function calculateVariance(values) {
            const mean = values.reduce((sum, v) => sum + v, 0) / values.length;
            const squaredDiffs = values.map(v => Math.pow(v - mean, 2));
            return squaredDiffs.reduce((sum, v) => sum + v, 0) / values.length;
        }

        // ========================================================================
        // EXPORT & UTILITY FUNCTIONS
        // ========================================================================

        // Export Schematic
        exportSchematicBtn.addEventListener('click', () => {
            if (currentToolstring.length === 0) {
                alert('No components in toolstring to export');
                return;
            }

            // Enhanced export with clash detection results
            const hasRestrictions = wellboreRestrictions.length > 0;
            const exportData = {
                toolstring: currentToolstring,
                analysis: {
                    totalLength: currentToolstring.reduce((sum, c) => sum + c.length, 0),
                    maxOD: Math.max(...currentToolstring.map(c => c.od)),
                    toolCount: currentToolstring.length
                },
                ...(hasRestrictions && {
                    clashDetection: {
                        minRestriction: Math.min(...wellboreRestrictions.map(r => r.id_in)),
                        clearanceStatus: 'See detailed report'
                    }
                })
            };

            console.log('[Export] Data:', exportData);

            alert('Export Schematic functionality will generate:\n\n‚Ä¢ Professional PDF schematic\n‚Ä¢ Bill of Materials (BOM)\n‚Ä¢ Technical data sheet\n‚Ä¢ Clash detection report\n‚Ä¢ Integration with WOP program\n\nThis would be implemented with jsPDF or similar library.');
        });
    </script>
</body>
</html>
