<!DOCTYPE html>

<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>The Brahan Engine | See What Others Can't - AI-Powered Well Engineering Intelligence</title>
    <meta name="description" content="The Brahan Engine reveals hidden conflicts, predicts operational outcomes, and prevents disasters before they happen. Real-time clash detection, safety barrier gateway, and AI co-pilot for well operations.">
    <meta name="keywords" content="well engineering, intervention planning, NPT reduction, drilling optimization, well data management, oil and gas software, well planning software, drilling automation">
    <meta name="author" content="The Brahan Engine">
    <link rel="canonical" href="https://welltegra.network/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://welltegra.network/">
    <meta property="og:title" content="The Brahan Engine | See What Others Can't">
    <meta property="og:description" content="The Brahan Engine reveals hidden conflicts, predicts operational outcomes, and prevents disasters. AI-powered well engineering intelligence.">
    <meta property="og:image" content="https://welltegra.network/assets/logo.jpg">
    <meta property="og:site_name" content="Well-Tegra">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://welltegra.network/">
    <meta name="twitter:title" content="The Brahan Engine | See What Others Can't">
    <meta name="twitter:description" content="Real-time clash detection, safety barrier gateway, and predictive clarity for well operations. The Brahan Engine.">
    <meta name="twitter:image" content="https://welltegra.network/assets/logo.jpg">

    <!-- Additional Meta -->
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https://welltegra.network; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://www.data.boem.gov https://gdr.openei.org https://factpages.npd.no https://raw.githubusercontent.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; media-src 'self' data:;  base-uri 'self'; form-action 'self'">
    <link rel="stylesheet" href="assets/css/tailwind.css">
    <link rel="icon" href="assets/logo.jpg" type="image/jpeg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" integrity="sha384-JUh163oCRItcbPme8pYnROHQMC6fNKTBWtRG3I3I0erJkzNgL7uxKlNwcrcFKeqF" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono&display=swap" rel="stylesheet">

    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha384-JcnsjUPPylna1s1fvi1u12X5qjY5OL56iySh75FdtrwhO/SWXgMjoVqcKyIIWOLk" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* --- Base & Theme Setup --- */
        body { font-family: 'Inter', sans-serif; font-weight: 500; }
        h1, h2, h3, h4, h5, h6 { font-weight: 800; } /* Bolder headings */
        .theme-light { background-color: #f8fafc; }
        .theme-dark { background-color: #0f172a; color: #e2e8f0; }

        /* --- Watermark Background --- */
        #main-content {
            position: relative;
            z-index: 1;
        }
        .theme-light #main-content::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('assets/watermark.jpg');
            background-repeat: repeat;
            background-position: center;
            background-size: 350px;
            opacity: 0.02;
            z-index: -1;
            pointer-events: none;
        }
        .theme-dark #main-content::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('assets/watermark.jpg');
            background-repeat: repeat;
            background-position: center;
            background-size: 350px;
            opacity: 0.04;
            filter: invert(1);
            z-index: -1;
            pointer-events: none;
        }

        .gradient-text {
            background: linear-gradient(to right, #60a5fa, #5eead4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- Light & Dark Theme Specific Styles --- */
        .theme-light .light-card { background-color: white; }
        .theme-dark .light-card { background-color: #1e293b; border: 1px solid #334155; }
        .theme-light .header { background-color: white; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        .theme-dark .header { background-color: #0f172a; border-bottom: 1px solid #1e293b; }
        .theme-light .nav-link { color: #475569; }
        .theme-dark .nav-link { color: #94a3b8; }
        .theme-light .nav-link.active { color: #2563eb; border-bottom-color: #2563eb; }
        .theme-dark .nav-link.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .nav-link.disabled { color: #9ca3af !important; cursor: not-allowed; opacity: 0.5; }
        
        .theme-light h1, .theme-light h2, .theme-light h3, .theme-light h4 { color: #111827; } 
        .theme-dark h1, .theme-dark h2, .theme-dark h3, .theme-dark h4 { color: #f8fafc; }
        
        .theme-light p, .theme-light span, .theme-light label, .theme-light td, .theme-light li { color: #1f2937; line-height: 1.65; }
        .theme-dark p, .theme-dark span, .theme-dark label, .theme-dark td, .theme-dark li { color: #e2e8f0; line-height: 1.65; }

        .theme-light .table-header { background-color: #f1f5f9; }
        .theme-dark .table-header { background-color: #334155; }
        .theme-light .table-row-alt { background-color: #f8fafc; }
        .theme-dark .table-row-alt { background-color: rgba(30, 41, 59, 0.5); }
        .theme-light .modal-container { background-color: white; }
        .theme-dark .modal-container { background-color: #1e293b; }
        .theme-light .modal-tab { color: #6b7280; }
        .theme-dark .modal-tab { color: #9ca3af; }
        .theme-light .modal-tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .theme-dark .modal-tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .theme-light input, .theme-light textarea { background-color: white; border-color: #d1d5db; color: #111827; }
        .theme-dark input, .theme-dark textarea { background-color: #334155; border-color: #4b5563; color: #f3f4f6; }
        .theme-light .objective-label, .theme-light .problem-label { border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s ease-in-out; }
        .theme-dark .objective-label, .theme-dark .problem-label { border: 1px solid #475569; cursor: pointer; transition: all 0.2s ease-in-out; }
        .theme-light input[type="radio"]:checked + .objective-label, .theme-light input[type="radio"]:checked + .problem-label { border-color: #2563eb; background-color: #eff6ff; }
        .theme-dark input[type="radio"]:checked + .objective-label, .theme-dark input[type="radio"]:checked + .problem-label { border-color: #60a5fa; background-color: #0f172a; }
        .theme-light .ai-recommendation-card.selected { border-color: #2563eb; background-color: #eff6ff; }
        .theme-dark .ai-recommendation-card.selected { border-color: #60a5fa; background-color: #0f172a; }
        .theme-light .bg-gray-50 { background-color: #f9fafb; }
        .theme-dark .bg-gray-50 { background-color: #334155; }
        .theme-light #theme-icon-dark { display: none; }
        .theme-light #theme-icon-light { display: block; }
        .theme-dark #theme-icon-dark { display: block; }
        .theme-dark #theme-icon-light { display: none; }

        /* --- Global Component Styles --- */
        .planner-card { transition: all 0.3s ease-in-out; }
        .planner-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .theme-light .planner-card.selected { border-color: #2563eb; transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); border-width: 2px; }
        .theme-dark .planner-card.selected { border-color: #60a5fa; transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); border-width: 2px; }

        /* Highlight the "Well From Hell" */
        .planner-card[data-well-id="Well_666"] {
            border-color: #991b1b;
            background-image: linear-gradient(rgba(255,0,0,0.05), rgba(255,0,0,0));
            position: relative;
            overflow: hidden;
        }
        .planner-card[data-well-id="Well_666"]::before {
            content: "âš  WELL FROM HELL";
            position: absolute;
            top: 10px;
            right: -30px;
            background-color: #ef4444;
            color: white;
            padding: 5px 30px;
            font-size: 10px;
            font-weight: bold;
            transform: rotate(45deg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .theme-dark .planner-card[data-well-id="Well_666"] {
            border-color: #ef4444;
            background-image: linear-gradient(rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0));
        }
        .planner-card[data-well-id="Well_666"].selected {
             border-color: #ef4444 !important;
             box-shadow: 0 10px 15px -3px rgb(239 68 68 / 0.2), 0 4px 6px -4px rgb(239 68 68 / 0.2);
        }

        .step-indicator { transition: all 0.3s; }
        .step-indicator.active { 
            background-color: #2563eb; 
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .step-indicator.completed { 
            background-color: #1d4ed8; 
            color: white;
        }
        .step-connector {
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .step-connector.active {
            background-color: #2563eb;
        }
        .step-connector.completed {
            background-color: #1d4ed8;
        }
        .risk-low { background-color: #dcfce7; color: #166534; }
        .risk-medium { background-color: #fef9c3; color: #854d0e; }
        .risk-high { background-color: #fee2e2; color: #991b1b; }
        .status-available, .status-active-underperforming, .status-active-lowinjectivity, .status-approved, .status-mustered, .status-passed, .status-active-restoredproduction, .status-pa-successful { background-color: #dcfce7; color: #166534; }
        .status-maintenance, .status-pending, .status-intransit, .status-standby { background-color: #fef9c3; color: #854d0e; }
        .status-unavailable, .status-onjob, .status-expired, .status-unaccounted, .status-failed, .status-drilling-criticalsection, .status-shut-in, .status-shut-in-wellintegrityissues, .status-pacandidate { background-color: #fee2e2; color: #991b1b; }
        .status-onboard { background-color: #cffafe; color: #0e7490; }

        /* --- Performer View Styles --- */
        .performer-view .dashboard-grid { display: grid; grid-template-columns: 2fr 5fr 3fr; gap: 1.5rem; height: calc(100vh - 80px); }
        .performer-view .kpi-card { background-color: #1e293b; border-radius: 0.5rem; border: 1px solid #334155; color: #f8fafc; }
        .performer-view .procedure-step { border-left: 4px solid #475569; transition: all 0.3s; cursor: pointer; }
        .performer-view .procedure-step.active { background-color: rgba(96, 165, 250, 0.1); border-left-color: #60a5fa; }
        .performer-view .procedure-step.completed { border-left-color: #64748b; opacity: 0.6; }
        .performer-view .log-entry { border-bottom: 1px solid #475569; }
        .performer-view .alarm, .emergency-header { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* --- KPI Gauge Styles --- */
        .gauge-bg { stroke: #374151; }
        .gauge-fg { transition: stroke-dashoffset 0.3s ease-in-out, stroke 0.3s ease-in-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .gauge-text { font-family: 'Roboto Mono', monospace; }
        .bar-bg { background-color: #374151; }
        .bar-fg { transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out; }
        .text-normal { color: #5eead4; } .stroke-normal { stroke: #5eead4; } .bg-normal { background-color: #5eead4; }
        .text-warning { color: #facc15; } .stroke-warning { stroke: #facc15; } .bg-warning { background-color: #facc15; }
        .text-danger { color: #f87171; } .stroke-danger { stroke: #f87171; } .bg-danger { background-color: #f87171; }

        /* --- General UI Transitions & Styles --- */
        .ai-recommendation-card { border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s ease-in-out; }
        .ai-recommendation-card:hover { border-color: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .ai-recommendation-card.selected { border-width: 2px; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
        .schematic-label { font-family: 'Roboto Mono', monospace; font-size: 10px; fill: #4b5563; }
        .schematic-depth-marker { font-size: 9px; font-family: 'Roboto Mono', monospace; fill: #1d4ed8; }
        .modal-tab { border-bottom: 2px solid transparent; }
        
        /* --- Home Page Specific Styles --- */
        .hero-section {
            position: relative;
            overflow: hidden;
            min-height: 500px;
            height: 80vh;
            max-height: 900px;
            display: flex;
            align-items: center;
            padding: 2rem 0;
        }
        #hero-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -100;
        }
        @media (max-width: 768px) {
            .hero-section {
                min-height: 400px;
                height: 70vh;
            }
        }
        .hero-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 23, 42, 0.8); /* Darker overlay for better contrast */
            z-index: -50;
        }
        .hero-section h1 { text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7); }

        /* Remove empty space at top */
        #main-content {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        #home-view {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        .hero-section {
            margin-top: 0 !important;
        }

        .hero-section p { text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5); }

        .section-title { font-size: 2.25rem; font-weight: 800; letter-spacing: -0.025em; }
        .accent-text { color: #2563eb; }
        .dark .accent-text { color: #60a5fa; }
        .roi-calculator { background-color: #f0f9ff; }
        .dark .roi-calculator { background-color: #1e293b; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 350px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }

        /* --- FAQ & About Page Styles --- */
        .faq-question {
            width: 100%;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .theme-dark .faq-question { border-bottom-color: #374151; }
        .faq-answer {
            display: none;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .theme-dark .faq-answer { border-bottom-color: #374151; }
        .faq-answer p, .faq-answer ul { margin-bottom: 1rem; }
        .faq-answer li { margin-left: 1.5rem; list-style-type: disc; }
        .faq-question.active + .faq-answer {
            display: block;
        }
        .faq-question .icon {
            transition: transform 0.3s ease;
        }
        .faq-question.active .icon {
            transform: rotate(180deg);
        }
        .about-view h3, .about-view h4 {
             margin-bottom: 0.75rem;
        }

        /* --- Enhanced Planner Styles --- */
        .planner-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .well-card-enhanced {
            position: relative;
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .well-card-enhanced .card-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .well-card-enhanced .card-body {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .well-card-enhanced .card-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .well-card-enhanced.selected {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .objective-card {
            border-radius: 0.5rem;
            padding: 1.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .objective-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .objective-card.selected {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .ai-recommendation-enhanced {
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }
        
        .ai-recommendation-enhanced:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .ai-recommendation-enhanced.selected {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .ai-recommendation-enhanced .confidence-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            color: white;
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .plan-summary-card {
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .plan-summary-card .card-header {
            background: linear-gradient(135deg, #047857 0%, #10b981 100%);
            color: white;
            padding: 1.5rem;
        }
        
        .timeline-step {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 1.5rem;
        }
        
        .timeline-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 2px;
            background-color: #e5e7eb;
        }
        
        .timeline-step:last-child::before {
            height: 1.5rem;
        }
        
        .timeline-step::after {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: white;
            border: 2px solid #3b82f6;
        }
        
        .equipment-card {
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #3b82f6;
        }
        
        .risk-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .cost-estimation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.05);
            margin-bottom: 0.5rem;
        }
        
        .cost-estimation .label {
            font-weight: 600;
        }
        
        .cost-estimation .value {
            font-weight: bold;
            color: #10b981;
        }

        /* ========================================
           V23 FEATURE STYLES
           ======================================== */

        /* --- Anomaly Detection Styles --- */
        .anomaly-alert {
            animation: slideInRight 0.4s ease-out;
            border-left-width: 4px;
            transition: all 0.3s ease;
        }

        .anomaly-alert:hover {
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .anomaly-warning {
            border-left-color: #f59e0b;
            background-color: #fffbeb;
        }

        .theme-dark .anomaly-warning {
            background-color: rgba(251, 191, 36, 0.1);
            border-color: #fbbf24;
        }

        .anomaly-critical {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }

        .theme-dark .anomaly-critical {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: #f87171;
        }

        .anomaly-resolved {
            border-left-color: #10b981;
            background-color: #f0fdf4;
            opacity: 0.7;
        }

        .theme-dark .anomaly-resolved {
            background-color: rgba(16, 185, 129, 0.1);
            border-color: #34d399;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .anomaly-icon-warning {
            animation: pulse-warning 2s ease-in-out infinite;
        }

        /* --- Vendor Scorecard Styles --- */
        .vendor-scorecard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 24px;
            color: white;
        }

        .theme-dark .vendor-scorecard {
            background: linear-gradient(135deg, #4c51bf 0%, #553c9a 100%);
        }

        .star-rating {
            display: inline-flex;
            gap: 2px;
        }

        .star {
            color: #fbbf24;
            font-size: 18px;
        }

        .star.empty {
            color: #d1d5db;
        }

        .theme-dark .star.empty {
            color: #4b5563;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 600;
            font-size: 14px;
        }

        .metric-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 12px;
        }

        .score-excellent {
            background-color: #10b981;
            color: white;
        }

        .score-good {
            background-color: #3b82f6;
            color: white;
        }

        .score-fair {
            background-color: #f59e0b;
            color: white;
        }

        .score-poor {
            background-color: #ef4444;
            color: white;
        }

        /* --- PDF Export Styles --- */
        .pdf-export-btn {
            position: relative;
            overflow: hidden;
        }

        .pdf-export-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .pdf-export-btn:active::after {
            width: 300px;
            height: 300px;
        }

        .pdf-generating {
            pointer-events: none;
            opacity: 0.6;
        }

        .pdf-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Utility Classes for v23 --- */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .theme-dark .glass-effect {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        /* --- Job Costing Tool Styles --- */
        .cost-main-tab.active {
            background-color: #22d3ee;
            color: #1f2937;
            border-color: #22d3ee;
        }
        .cost-main-tab { transition: all 0.2s ease-in-out; }
        .cost-sub-tab.active {
            border-bottom-color: #22d3ee;
            color: #22d3ee;
        }
        .cost-sub-tab { transition: all 0.2s ease-in-out; }
        .cost-add-btn {
            padding: 0.25rem 0.75rem;
            background-color: #0891b2;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            transition: all 0.2s;
        }
        .cost-add-btn:hover {
            background-color: #06b6d4;
        }

        .step-card {
            background-color: #1e293b;
            border: 2px solid #475569;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            transition: all 0.2s;
        }
        .step-card.active {
            border-color: #22d3ee;
            box-shadow: 0 20px 25px -5px rgb(34 211 238 / 0.3);
        }
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #334155;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            border-bottom: 1px solid #475569;
            cursor: pointer;
        }
        .step-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #22d3ee;
        }
        .remove-step-btn {
            color: #6b7280;
            font-weight: 700;
            font-size: 0.875rem;
            transition: color 0.2s;
        }
        .remove-step-btn:hover {
            color: #ef4444;
        }
        .step-item-list {
            border-top: 1px solid #475569;
        }
        .step-item-list > li {
            border-bottom: 1px solid #475569;
        }
        .step-item-list > li:last-child {
            border-bottom: none;
        }
        .step-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
        }
        .step-item-name {
            font-size: 0.875rem;
            color: #e5e7eb;
        }
        .step-item-cost {
            font-size: 0.875rem;
            font-weight: 700;
            color: white;
        }
        .remove-item-btn {
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 1rem;
            transition: color 0.2s;
        }
        .remove-item-btn:hover {
            color: #dc2626;
        }
        .step-footer {
            padding: 0.75rem;
            background-color: #334155;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            text-align: right;
        }
        .step-footer strong {
            font-size: 1rem;
            font-weight: 700;
            color: #22d3ee;
        }

        .theme-light .step-card {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }
        .theme-light .step-card.active {
            border-color: #0891b2;
            box-shadow: 0 20px 25px -5px rgb(8 145 178 / 0.2);
        }
        .theme-light .step-header {
            background-color: #e2e8f0;
            border-bottom-color: #cbd5e1;
        }
        .theme-light .step-header h3 {
            color: #0891b2;
        }
        .theme-light .step-footer {
            background-color: #e2e8f0;
        }
        .theme-light .step-footer strong {
            color: #0891b2;
        }
        .theme-light .step-item-list > li {
            border-color: #cbd5e1;
        }

        /* Clean mode - hides side panels and controls for presentation */
        body.clean-mode #performer-wellbore > .grid > div:first-child,
        body.clean-mode #performer-wellbore > .grid > div:last-child,
        body.clean-mode #survey-controls {
            display: none !important;
        }

        body.clean-mode #performer-wellbore > .grid {
            grid-template-columns: 1fr !important;
        }

        body.clean-mode #delta-stats,
        body.clean-mode #dls-panel {
            display: flex !important;
        }

        /* 3D Tilt mode - parallax effect */
        body.tilt-mode #wbSvg {
            transform: perspective(1200px) rotateX(2deg) rotateY(-3deg);
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
        }

        body.tilt-mode #wbSvg:hover {
            transform: perspective(1200px) rotateX(-1deg) rotateY(2deg) scale(1.02);
        }

        /* Accessibility - Focus visibility for keyboard navigation */
        *:focus {
            outline: 2px solid #22d3ee;
            outline-offset: 2px;
        }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 3px solid #22d3ee;
            outline-offset: 2px;
        }

        /* Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .sr-only:focus {
            position: static;
            width: auto;
            height: auto;
            padding: 0.5rem 1rem;
            margin: 0;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }

        /* Print styles - clean output for PDF/print */
        @media print {
            /* Hide navigation and non-essential elements */
            nav, header, footer,
            .theme-toggle,
            #survey-controls,
            #performer-wellbore > .grid > div:first-child,
            #performer-wellbore > .grid > div:last-child {
                display: none !important;
            }

            /* Full width for visualization */
            #performer-wellbore > .grid {
                grid-template-columns: 1fr !important;
            }

            /* White background for printing */
            body {
                background: white !important;
                color: black !important;
            }

            /* Show delta stats and DLS panel */
            #delta-stats,
            #dls-panel {
                display: flex !important;
                page-break-inside: avoid;
            }

            /* Ensure SVG is visible */
            #wbSvg {
                max-width: 100%;
                height: auto;
            }

            /* Print in portrait or landscape */
            @page {
                size: A4;
                margin: 1.5cm;
            }

            /* Page breaks */
            #performer-wellbore {
                page-break-after: always;
            }
        }

        /* --- Equipment Catalog & Tool String Builder Styles --- */
        .equipment-tabs {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid #334155;
            margin-bottom: 1.5rem;
        }

        .equipment-tab {
            padding: 12px 24px;
            font-weight: 700;
            font-size: 1rem;
            color: #94a3b8;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .equipment-tab:hover {
            color: #14b8a6;
        }

        .equipment-tab.active {
            color: #14b8a6;
            border-bottom-color: #14b8a6;
        }

        .equipment-category-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.8));
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .equipment-category-card:hover {
            border-color: #14b8a6;
            box-shadow: 0 4px 20px rgba(20, 184, 166, 0.2);
            transform: translateY(-2px);
        }

        .equipment-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .equipment-item:hover {
            border-color: #14b8a6;
            background: rgba(20, 184, 166, 0.1);
        }

        .equipment-item-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.95rem;
        }

        .equipment-item-meta {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        .tool-string-card {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(59, 130, 246, 0.05));
            border: 2px solid #14b8a6;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .tool-string-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tool-string-name {
            font-size: 1.25rem;
            font-weight: 800;
            color: #14b8a6;
        }

        .tool-string-components {
            list-style: none;
            padding-left: 1rem;
            margin: 0;
        }

        .tool-string-component {
            padding: 6px 0;
            color: #cbd5e1;
            font-size: 0.9rem;
            border-left: 3px solid #475569;
            padding-left: 12px;
            margin-bottom: 6px;
        }

        .tool-string-component:hover {
            border-left-color: #14b8a6;
            color: #14b8a6;
        }

        .btn-add-equipment {
            background: #14b8a6;
            color: #0b1220;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-add-equipment:hover {
            background: #0ea5e9;
            transform: scale(1.05);
        }

        .btn-secondary {
            background: #475569;
            color: #e2e8f0;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #14b8a6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }

        .manufacturer-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid #eab308;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #fbbf24;
            margin-left: 8px;
        }

        .application-tag {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 4px;
            font-size: 0.7rem;
            color: #93c5fd;
            margin-right: 6px;
            margin-bottom: 6px;
        }

        .service-line-badge {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, #14b8a6, #0ea5e9);
            color: #0b1220;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 800;
            margin-left: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.125rem;
            font-weight: 600;
        }

    </style>

    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "Well-Tegra",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD",
            "priceValidUntil": "2025-12-31",
            "availability": "https://schema.org/InStock",
            "description": "Free trial available"
        },
        "description": "AI-powered well engineering platform for intervention planning, NPT reduction, and well data management in oil and gas operations.",
        "url": "https://welltegra.network",
        "creator": {
            "@type": "Organization",
            "name": "The Brahan Engine",
            "url": "https://welltegra.network",
            "contactPoint": {
                "@type": "ContactPoint",
                "email": "contact@welltegra.network",
                "contactType": "Customer Service"
            }
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.7",
            "ratingCount": "12",
            "bestRating": "5",
            "worstRating": "1"
        },
        "featureList": [
            "AI-assisted well intervention planning",
            "NPT reduction analytics",
            "Real-time drilling data monitoring",
            "Automated wellbore trajectory visualization",
            "Cost tracking and ROI calculation",
            "Vendor performance scorecards",
            "Multi-well portfolio management"
        ]
    }
    </script>

    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "The Brahan Engine",
        "url": "https://welltegra.network",
        "logo": "https://welltegra.network/assets/logo.jpg",
        "description": "Leading provider of AI-powered well engineering software for the oil and gas industry",
        "founder": {
            "@type": "Person",
            "name": "Ken McKenzie",
            "jobTitle": "Founder & Chief Engineer",
            "description": "30+ years of global experience in Well Engineering"
        },
        "sameAs": [
            "https://github.com/kenmck3772"
        ],
        "contactPoint": {
            "@type": "ContactPoint",
            "email": "contact@welltegra.network",
            "contactType": "Sales",
            "areaServed": "Worldwide",
            "availableLanguage": "English"
        }
    }
    </script>
</head>

<body class="theme-dark">

<!-- Login page removed - direct access to application -->

<div id="app-container" class="min-h-screen flex flex-col">

    <!-- Skip to main content link for keyboard navigation -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:px-4 focus:py-2 focus:bg-cyan-600 focus:text-white">
        Skip to main content
    </a>

    <header id="app-header" class="header sticky top-0 z-30 transition-colors" role="banner">
        <div class="max-w-full mx-auto py-2 px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="assets/logo.jpg" alt="The Brahan Engine Logo" class="h-12 w-auto mr-3" loading="lazy">
                    <div class="flex flex-col"><h1 id="header-title" class="text-xl font-bold">The Brahan Engine</h1><span class="text-xs text-slate-400 -mt-1">by WellTegra</span></div>
                </div>
                <nav id="header-nav" class="flex-1 flex items-center justify-center space-x-1 md:space-x-4" role="navigation" aria-label="Main navigation">
                    <a id="home-nav-link" title="Return to the Home Page" class="nav-link active flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        <span>Home</span>
                    </a>
                    <a id="planner-nav-link" title="Go to the Well Intervention Planner" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                        <span>Planner</span>
                    </a>
                    <a id="case-studies-nav-link" title="View Well Case Studies" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><path d="M8 7h8"/><path d="M8 11h8"/></svg>
                        <span>Case Studies</span>
                    </a>
                    <a href="intervention-guide.html" target="_blank" title="View Comprehensive Intervention Planning Guide" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        <span>Guide</span>
                    </a>
                    <a id="logistics-nav-link" title="Manage Equipment and Personnel" class="nav-link flex items-center space-x-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"/><path d="M14 9h4l4 4v4h-8v-4h-4V9Z"/><path d="M18 18h-1.3c-.5 0-.9-.3-1.1-.7l-2.6-5"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>
                        <span>Logistics</span>
                    </a>
                    <a id="commercial-nav-link" title="View Financial Dashboards" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        <span>Commercial</span>
                    </a>
                    <a id="hse-nav-link" title="View Health, Safety, and Environment Data" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        <span>HSE & Risk</span>
                    </a>
                    <a id="pob-nav-link" title="View Personnel on Board and Emergency Response" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <span>POB & ER</span>
                    </a>
                    <a id="whitepaper-nav-link" title="Download the White Paper" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span>White Paper</span>
                    </a>
                     <a id="faq-nav-link" title="Frequently Asked Questions" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" /></svg>
                        <span>FAQ</span>
                    </a>
                    <a id="security-nav-link" title="Security & Data Protection" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <span>Security</span>
                    </a>
                    <a id="about-nav-link" title="About the Founder" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>
                        <span>About</span>
                    </a>
                </div>
                <div id="header-details" class="flex items-center space-x-4">
                    <button id="theme-toggle-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700" aria-label="Toggle dark mode">
                        <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main id="main-content" class="flex-1" role="main">
        <div id="home-view" class="view-container">
<section class="hero-section px-4 relative overflow-hidden">
    <!-- Background Video -->
    <video autoplay loop muted playsinline id="hero-video" 
           poster="assets/logo.jpg">
        <source src="assets/hero33.mp4" type="video/mp4">
    </video>
    
    <!-- Animated gradient overlay -->
    <div class="hero-overlay"></div>
    
    <!-- Animated grid background -->
    <div class="absolute inset-0 opacity-10">
        <div class="absolute inset-0" style="background-image: radial-gradient(circle at 2px 2px, cyan 1px, transparent 0); background-size: 50px 50px;"></div>
    </div>
    
    <div class="max-w-5xl mx-auto text-center relative z-10 py-20">
        <!-- Logo/Badge -->
        <div class="inline-flex items-center gap-3 bg-gradient-to-r from-amber-500/20 to-cyan-500/20 backdrop-blur-sm border border-amber-500/30 rounded-full px-6 py-2 mb-6">
            <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-amber-600 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                </svg>
            </div>
            <span class="text-amber-400 font-bold text-sm tracking-wide">THE BRAHAN ENGINE</span>
        </div>
        
        <!-- Main Headline -->
        <h1 class="text-5xl md:text-7xl font-extrabold tracking-tight text-white mb-6 leading-tight">
            <span class="block">See What</span>
            <span class="block text-transparent bg-clip-text bg-gradient-to-r from-amber-400 via-cyan-400 to-blue-400">
                Others Can't
            </span>
        </h1>
        
        <!-- Subheadline -->
        <p class="mt-6 text-xl md:text-2xl text-slate-200 max-w-3xl mx-auto leading-relaxed">
            AI-powered well engineering intelligence that reveals hidden conflicts, 
            predicts operational outcomes, and prevents disasters before they happen.
        </p>
        
        <!-- Value Props -->
        <div class="mt-8 flex flex-wrap justify-center gap-6 text-slate-300">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-emerald-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <span class="font-semibold">Real-time Clash Detection</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-emerald-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <span class="font-semibold">Safety Barrier Gateway</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-emerald-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <span class="font-semibold">AI Co-Pilot</span>
            </div>
        </div>

        <!-- Hero CTAs -->
        <div class="mt-10 flex flex-col sm:flex-row gap-4 justify-center items-center">
            <a href="mailto:contact@welltegra.network?subject=Demo%20Request" class="group px-8 py-4 bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white text-lg font-bold rounded-xl shadow-2xl shadow-amber-500/30 transition-all transform hover:scale-105 hover:shadow-amber-500/50 flex items-center gap-2">
                <span>See a Live Demo</span>
                <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
            </a>
            <button onclick="showView('case-studies')" 
                    class="group px-8 py-4 bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white text-lg font-bold rounded-xl border-2 border-white/30 hover:border-white/50 transition-all transform hover:scale-105 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span>Case Studies</span>
            </button>
            <button onclick="showView('planner')" 
                    class="group px-8 py-4 bg-cyan-600/20 hover:bg-cyan-600/30 backdrop-blur-sm text-cyan-400 text-lg font-bold rounded-xl border-2 border-cyan-500/50 hover:border-cyan-400 transition-all transform hover:scale-105 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <span>Open Planner</span>
            </button>
        </div>
        
        <!-- Trust indicator -->
        <div class="mt-8 flex justify-center items-center gap-2 text-sm text-slate-400">
            <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span>Powered by 30+ years of North Sea operational data</span>
        </div>
    </div>
</section>

            <!-- Trajectory Viewer Showcase - RIGHT AFTER HERO -->
            <section class="py-16 px-4 bg-gradient-to-br from-slate-900 via-blue-900/20 to-slate-900 border-y-2 border-cyan-500/20">
                <div class="max-w-7xl mx-auto">
                    <div class="text-center mb-10">
                        <div class="inline-flex items-center gap-2 bg-cyan-500/10 border border-cyan-500/30 rounded-full px-4 py-1 mb-4">
                            <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            <span class="text-cyan-400 font-bold text-sm">SEE IT IN ACTION</span>
                        </div>
                        <h2 class="text-4xl md:text-5xl font-extrabold text-white mb-4">
                            Real-Time Wellbore Intelligence
                        </h2>
                        <p class="text-xl text-slate-300 max-w-3xl mx-auto">
                            The Brahan Engine visualizes your well in 3D, detects dimensional conflicts, and validates safety barriersâ€”all in real-time.
                        </p>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-8 items-start">
                        <!-- Trajectory Viewer -->
                        <div class="bg-slate-800/50 border-2 border-cyan-500/30 rounded-xl overflow-hidden shadow-2xl">
                            <div class="bg-slate-900/80 px-6 py-4 border-b border-cyan-500/20">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                        <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                        <span>Wellbore Trajectory</span>
                                    </h3>
                                    <span class="text-xs text-slate-400 bg-slate-700/50 px-3 py-1 rounded-full">Live Demo</span>
                                </div>
                            </div>
                            
                            <!-- SVG Trajectory Viewer -->
                            <div class="p-4 bg-gradient-to-br from-slate-900 to-blue-900/20">
                                <svg id="hero-trajectory-svg" viewBox="0 0 800 520" preserveAspectRatio="xMidYMid meet" class="w-full h-auto" style="background:linear-gradient(180deg,rgba(15,23,42,.85),rgba(2,6,23,.75)); border-radius: 8px;">
                                    <!-- Grid -->
                                    <defs>
                                        <pattern id="hero-grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#334155" stroke-width="0.5" opacity="0.3"/>
                                        </pattern>
                                    </defs>
                                    <rect width="800" height="520" fill="url(#hero-grid)"/>
                                    
                                    <!-- Trajectory Path - Sample Deviated Well -->
                                    <path d="M 100 50 L 100 150 Q 100 250 200 300 L 350 400 L 500 480" 
                                          stroke="#14b8a6" stroke-width="4" fill="none" opacity="0.8"
                                          stroke-dasharray="8,4"/>
                                    
                                    <!-- Wellbore sections -->
                                    <circle cx="100" cy="50" r="8" fill="#10b981" opacity="0.8"/>
                                    <text x="115" y="55" fill="#10b981" font-size="12" font-weight="bold">Surface</text>
                                    
                                    <circle cx="100" cy="150" r="6" fill="#14b8a6" opacity="0.8"/>
                                    <text x="115" y="155" fill="#14b8a6" font-size="11">Kickoff</text>
                                    
                                    <circle cx="350" cy="400" r="6" fill="#06b6d4" opacity="0.8"/>
                                    <text x="365" y="405" fill="#06b6d4" font-size="11">Build Section</text>
                                    
                                    <circle cx="500" cy="480" r="8" fill="#f59e0b" opacity="0.8"/>
                                    <text x="440" y="475" fill="#f59e0b" font-size="12" font-weight="bold">Target (TD)</text>
                                    
                                    <!-- Depth markers -->
                                    <line x1="60" y1="50" x2="60" y2="480" stroke="#475569" stroke-width="1" stroke-dasharray="2,2" opacity="0.4"/>
                                    <text x="40" y="50" fill="#94a3b8" font-size="10">0m</text>
                                    <text x="30" y="200" fill="#94a3b8" font-size="10">500m</text>
                                    <text x="25" y="350" fill="#94a3b8" font-size="10">1000m</text>
                                    <text x="25" y="480" fill="#94a3b8" font-size="10">1500m</text>
                                    
                                    <!-- Animated pulse at target -->
                                    <circle cx="500" cy="480" r="12" fill="none" stroke="#f59e0b" stroke-width="2" opacity="0.6">
                                        <animate attributeName="r" from="8" to="20" dur="2s" repeatCount="indefinite"/>
                                        <animate attributeName="opacity" from="0.8" to="0" dur="2s" repeatCount="indefinite"/>
                                    </circle>
                                </svg>
                            </div>
                            
                            <div class="bg-slate-900/60 px-6 py-3 border-t border-cyan-500/20 flex items-center justify-between">
                                <span class="text-sm text-slate-400">Interactive 3D visualization available in planner</span>
                                <button onclick="showView('planner')" 
                                        class="text-cyan-400 hover:text-cyan-300 text-sm font-semibold flex items-center gap-1">
                                    <span>Open Planner</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Key Features -->
                        <div class="space-y-6">
                            <h3 class="text-2xl font-bold text-white">What You're Seeing:</h3>
                            
                            <!-- Feature 1 -->
                            <div class="flex gap-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-cyan-500/20 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-1">Real-Time Clash Detection</h4>
                                    <p class="text-slate-400">Instantly identifies when tool OD exceeds tubing IDâ€”catching dimensional conflicts before deployment.</p>
                                </div>
                            </div>

                            <!-- Feature 2 -->
                            <div class="flex gap-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-amber-500/20 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-1">Safety Barrier Gateway</h4>
                                    <p class="text-slate-400">Blocks access to operations when critical safety data (SCSSV depth, barrier status) is missing.</p>
                                </div>
                            </div>

                            <!-- Feature 3 -->
                            <div class="flex gap-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-1">Instant Deviation Analysis</h4>
                                    <p class="text-slate-400">Upload CSV survey data, visualize trajectory, and identify high-DLS zones that impact tool running.</p>
                                </div>
                            </div>

                            <!-- Feature 4 -->
                            <div class="flex gap-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-violet-500/20 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-1">SVG Wellbore Schematics</h4>
                                    <p class="text-slate-400">Interactive diagrams showing casing, tubing, packers, and safety valves with depth annotations.</p>
                                </div>
                            </div>

                            <!-- CTA -->
                            <div class="mt-8 pt-6 border-t border-slate-700">
                                <button onclick="showView('planner')" 
                                        class="w-full px-6 py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-xl shadow-xl transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                    </svg>
                                    <span>Try the Interactive Planner</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Mini ROI Block + Outcome Bullets -->
            <section class="py-6 px-4 bg-gradient-to-r from-cyan-900/20 to-blue-900/20 border-y border-cyan-500/30">
                <div class="max-w-6xl mx-auto">
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                        <!-- Outcome Bullets -->
                        <div class="space-y-4">
                            <h3 class="text-2xl font-bold text-white">Proven Results</h3>
                            <ul class="space-y-3 text-lg">
                                <li class="flex items-start gap-3">
                                    <span class="text-emerald-400 text-2xl">âœ“</span>
                                    <span>Reduce NPT by <strong class="text-cyan-400">15â€“30%</strong> on pilot wells</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span class="text-emerald-400 text-2xl">âœ“</span>
                                    <span>Reclaim <strong class="text-cyan-400">2â€“3 hours/day</strong> of engineer time</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span class="text-emerald-400 text-2xl">âœ“</span>
                                    <span>Cut planning cycles from <strong class="text-cyan-400">days â†’ hours</strong></span>
                                </li>
                            </ul>
                        </div>

                        <!-- Mini ROI -->
                        <div class="bg-slate-800/80 border border-cyan-500/50 rounded-lg p-8 shadow-xl">
                            <h3 class="text-2xl font-bold text-white mb-4">It Pays for Itself</h3>
                            <p class="text-lg text-slate-300 mb-6">
                                Example: <strong class="text-cyan-400">20 engineers</strong> Ã— <strong class="text-cyan-400">20% NPT reduction</strong> â†’
                                <span class="block mt-2 text-3xl font-extrabold text-emerald-400">$2.17M annual savings</span>
                            </p>
                            <a href="#" onclick="document.querySelector('.roi-calculator').scrollIntoView({behavior:'smooth'}); return false;"
                               class="block w-full text-center px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-lg transition">
                                Run Your Numbers â†’
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Built by Experience Section -->
            <section class="py-12 px-4 bg-gradient-to-br from-slate-900 via-blue-900/20 to-slate-900">
                <div class="max-w-5xl mx-auto">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center gap-2 bg-amber-500/10 border border-amber-500/30 rounded-full px-4 py-1 mb-4">
                            <svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-amber-400 font-bold text-sm">BUILT BY EXPERIENCE</span>
                        </div>
                        <h2 class="text-4xl font-bold text-white mb-4">30+ Years of North Sea Operations</h2>
                        <p class="text-xl text-slate-300 max-w-3xl mx-auto">
                            The Brahan Engine is built on real operational data from tier-1 North Sea operatorsâ€”BG Group, Murphy Oil, and major P&A campaigns.
                        </p>
                    </div>

                    <div class="grid md:grid-cols-3 gap-6 mt-12">
                        <!-- Real Data -->
                        <div class="bg-slate-800/50 border border-cyan-500/30 rounded-xl p-6">
                            <div class="w-12 h-12 bg-cyan-500/20 rounded-lg flex items-center justify-center mb-4">
                                <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">Real Field Data</h3>
                            <p class="text-slate-400">
                                Built from actual daily reports, deviation surveys, completion schematics, and P&A procedures from live operations.
                            </p>
                        </div>

                        <!-- Real Problems -->
                        <div class="bg-slate-800/50 border border-amber-500/30 rounded-xl p-6">
                            <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center mb-4">
                                <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">Real Problems</h3>
                            <p class="text-slate-400">
                                Engineered to solve actual conflicts discovered in wellbore operationsâ€”dimensional clashes, missing safety data, incomplete documentation.
                            </p>
                        </div>

                        <!-- Real Solutions -->
                        <div class="bg-slate-800/50 border border-emerald-500/30 rounded-xl p-6">
                            <div class="w-12 h-12 bg-emerald-500/20 rounded-lg flex items-center justify-center mb-4">
                                <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">Real Solutions</h3>
                            <p class="text-slate-400">
                                Validated against real-world operations. Every feature addresses an actual bottleneck or safety concern from field experience.
                            </p>
                        </div>
                    </div>

                    <!-- Contact CTA -->
                    <div class="mt-12 text-center">
                        <p class="text-slate-300 mb-4">Currently in pilot phase with select operators.</p>
                        <a href="mailto:contact@welltegra.network?subject=Demo%20Request" class="inline-flex items-center gap-2 px-6 py-3 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-lg transition-all transform hover:scale-105">
                            <span>Join the Pilot Program</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </section>

            <section class="py-8 px-4 bg-white dark:bg-transparent">
                <div class="max-w-7xl mx-auto relative z-10">
                    <div class="text-center">
                        <h2 class="section-title">Are You Paying the Hidden Taxes of Inefficiency?</h2>
                        <p class="mt-4 text-lg">Your operations are being taxed by disconnected workflows you can't see on a balance sheet.</p>
                    </div>
                    <div class="mt-12 grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                        <div class="feature-card light-card p-6 rounded-lg shadow"><h3 class="text-xl font-bold">The Data Wrangling Tax</h3><p class="mt-2">Unlock Your Data. Your most valuable assetsâ€”your engineersâ€”are forced to act as data clerks, wasting countless hours hunting for information in emails, correcting spreadsheet errors, and re-entering data from PDFs.</p></div>
                        <div class="feature-card light-card p-6 rounded-lg shadow"><h3 class="text-xl font-bold">The NPT Tax</h3><p class="mt-2">Every moment of Non-Productive Time is a direct hit to your bottom line. Plans based on poor data lead to equipment failures, procedural errors, and costly downtime.</p></div>
                        <div class="feature-card light-card p-6 rounded-lg shadow"><h3 class="text-xl font-bold">The Collaboration Tax</h3><p class="mt-2">The critical gap between your team and service partners is where value is lost. Static PDF handoffs create slow, error-prone workflows that prevent true, real-time collaboration.</p></div>
                        <div class="feature-card light-card p-6 rounded-lg shadow"><h3 class="text-xl font-bold">The Energy & Emissions Tax</h3><p class="mt-2">Inefficient operations don't just waste moneyâ€”they waste energy. Extended run times and unnecessary flaring contribute to higher operational costs and a larger carbon footprint.</p></div>
                    </div>
                </div>
            </section>
            <section class="py-8 px-4 roi-calculator dark:bg-slate-900/50">
                <div class="max-w-6xl mx-auto relative z-10">
                    <div class="text-center"><h2 class="section-title">The Platform That Pays for Itself</h2><p class="mt-4 text-lg">Unlock Your Reservoir's True Potential. Use our interactive calculator to estimate your potential annual savings with Well-Tegra.</p></div>
                    <div class="mt-12 grid lg:grid-cols-2 gap-12 items-center">
                        <div class="light-card p-8 rounded-lg shadow-lg">
                            <div class="space-y-6">
                                <div><label for="engineerCount" class="font-semibold">Number of Well Engineers</label><div class="flex items-center space-x-4"><input type="range" id="engineerCount" min="5" max="100" value="20" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer"><span id="engineerCountValue" class="font-bold text-lg w-12 text-center">20</span></div></div>
                                <div><label for="nptReduction" class="font-semibold">Projected NPT Reduction</label><div class="flex items-center space-x-4"><input type="range" id="nptReduction" min="5" max="40" value="20" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer"><span id="nptReductionValue" class="font-bold text-lg w-12 text-center">20%</span></div></div>
                                <div><label for="timeSavings" class="font-semibold">Engineering Time Reclaimed</label><div class="flex items-center space-x-4"><input type="range" id="timeSavings" min="10" max="50" value="40" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer"><span id="timeSavingsValue" class="font-bold text-lg w-12 text-center">40%</span></div></div>
                            </div>
                            <div class="mt-8 pt-6 border-t border-slate-300 dark:border-slate-600 text-center"><p class="text-xl font-semibold">Total Estimated Annual Savings:</p><p id="totalSavings" class="text-5xl font-extrabold accent-text mt-2">$2,168,000</p></div>
                        </div>
                        <div class="chart-container"><canvas id="savingsChart"></canvas></div>
                    </div>
                </div>
            </section>
        </div>
        
        <div id="planner-view" class="view-container hidden max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="planner-header">
                <h2 class="text-3xl font-bold tracking-tight text-white">Well Intervention Planner</h2>
                <p class="mt-2 max-w-2xl mx-auto text-lg text-blue-100">The Single Source of Truth for Your Entire Well Portfolio.</p>
            </div>

            <!-- Wellbore Visualization Section -->
            <div id="planner-wellbore-viz" class="mt-8 mb-8 bg-slate-800/50 rounded-lg p-6 border-2 border-cyan-500/30">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-white">ðŸ“ Wellbore Trajectory Viewer</h3>
                    <button id="tiltModeBtn" onclick="toggleTiltMode()" class="px-4 py-2 bg-violet-600 hover:bg-violet-500 text-white font-bold rounded-lg transition text-sm">ðŸŽ­ 3D Tilt</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- SVG Visualization -->
                    <div class="lg:col-span-2 bg-slate-900/40 border border-slate-700 rounded-lg overflow-hidden">
                        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-slate-800/50">
                            <strong class="text-lg">Wellbore Trajectory</strong>
                            <span id="survey-view-label" class="text-sm text-slate-400">Profile View (Departure vs TVD)</span>
                        </div>

                        <!-- SVG canvas -->
                        <svg id="wbSvg" viewBox="0 0 800 520" preserveAspectRatio="xMidYMid meet" class="w-full h-auto block" style="background:linear-gradient(180deg,rgba(15,23,42,.45),rgba(2,6,23,.35))">
                            <defs>
                                <pattern id="grid" width="80" height="80" patternUnits="userSpaceOnUse">
                                    <path d="M80 0H0V80" fill="none" stroke="#334155" stroke-opacity=".4" stroke-width="1"/>
                                </pattern>
                                <linearGradient id="dlsGrad" x1="0" y1="0" x2="1" y2="1">
                                    <stop offset="0%" stop-color="#22d3ee"/>
                                    <stop offset="50%" stop-color="#14b8a6"/>
                                    <stop offset="100%" stop-color="#f59e0b"/>
                                </linearGradient>
                                <filter id="glow"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                            </defs>
                            <rect x="0" y="0" width="800" height="520" fill="url(#grid)"/>
                        </svg>
                    </div>

                    <!-- Controls Panel -->
                    <div class="bg-slate-900/40 border border-slate-700 rounded-lg p-4">
                        <div class="mb-4">
                            <strong class="text-base block mb-2">ðŸ“Š Survey Data</strong>
                            <p class="text-xs text-slate-400 mb-3">Upload CSV with MD, INC, AZ columns</p>
                        </div>

                        <!-- Quick action buttons -->
                        <div class="space-y-2 mb-4">
                            <button onclick="loadSampleSurvey()" class="w-full px-3 py-2 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-semibold rounded-md transition">
                                Load Sample Well
                            </button>
                            <button onclick="document.getElementById('survey-file-input').click()" class="w-full px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-semibold rounded-md transition">
                                Upload CSV
                            </button>
                            <input id="survey-file-input" type="file" accept=".csv,.txt" class="hidden">
                        </div>

                        <!-- View toggle -->
                        <div class="mb-4">
                            <p class="text-xs text-slate-400 mb-2">View Mode:</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="view-profile-btn" onclick="switchSurveyView('profile')"
                                        class="px-3 py-2 bg-cyan-600 text-white text-sm font-semibold rounded-md transition">
                                    Profile
                                </button>
                                <button id="view-plan-btn" onclick="switchSurveyView('plan')"
                                        class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-semibold rounded-md transition">
                                    Plan
                                </button>
                            </div>
                        </div>

                        <!-- Display options -->
                        <div class="p-3 bg-slate-800/60 border border-slate-600 rounded-lg">
                            <p class="text-xs font-semibold text-slate-300 mb-3">Display Options</p>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs text-slate-400">DLS Threshold</label>
                                    <input id="dls-threshold" type="range" min="3" max="12" step="0.5" value="6" class="w-20">
                                    <span id="dls-threshold-val" class="text-xs text-slate-300 w-8">6.0</span>
                                </div>
                                <label class="flex items-center gap-2 text-xs">
                                    <input id="toggle-plan" type="checkbox" checked class="rounded">
                                    <span class="text-slate-300">Show plan overlay</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs">
                                    <input id="toggle-hotspots" type="checkbox" checked class="rounded">
                                    <span class="text-slate-300">Show DLS hotspots</span>
                                </label>
                            </div>
                        </div>

                        <!-- Status -->
                        <div id="survey-status" class="mt-4 text-xs text-slate-400"></div>
                    </div>
                </div>
            </div>

            <div class="mb-12 flex items-center justify-center space-x-2">
                <div id="step-1-indicator" class="step-indicator w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">1</div>
                <div id="step-1-connector" class="step-connector flex-1"></div>
                <div id="step-2-indicator" class="step-indicator bg-gray-200 dark:bg-gray-700 text-gray-500 w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">2</div>
                <div id="step-2-connector" class="step-connector flex-1"></div>
                <div id="step-3-indicator" class="step-indicator bg-gray-200 dark:bg-gray-700 text-gray-500 w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">3</div>
            </div>
            
            <section id="step-1" class="mb-12">
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold tracking-tight">Step 1: Problem Well - Well_666 "The Perfect Storm"</h3>
                    <p class="mt-4 max-w-3xl mx-auto text-lg text-white">
                        This planner is specifically designed for <strong class="text-red-400">Well_666 - The Perfect Storm</strong>,
                        our most challenging shut-in well with multiple compounding failures.
                    </p>
                    <p class="mt-3 max-w-3xl mx-auto text-sm text-blue-100">
                        The intervention strategy leverages lessons learned from six successful case studies in the same field.
                        Each historical well solved one of the failure modes now present in Well_666.
                        <a href="#" onclick="showView('case-studies'); return false;" class="text-cyan-400 hover:text-cyan-300 underline font-semibold">
                            View Case Studies â†’
                        </a>
                    </p>

                    <!-- Intervention Guide Reference -->
                    <div class="mt-6 max-w-4xl mx-auto">
                        <div class="bg-gradient-to-r from-blue-900/80 to-cyan-900/80 border border-cyan-400/50 rounded-lg p-4 shadow-lg">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-300">
                                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-lg font-bold text-white mb-2">ðŸ“š New: Comprehensive Intervention Planning Guide</h4>
                                    <p class="text-blue-100 text-sm mb-3">
                                        Access our complete 6-phase methodology covering scoping, data gathering, engineering, risk assessment, execution, and continuous improvement.
                                        This guide provides the theoretical foundation and best practices that inform this planner.
                                    </p>
                                    <a href="intervention-guide.html" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold rounded-lg transition-all transform hover:scale-105 shadow-md">
                                        <span>Open Planning Guide</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                            <polyline points="15 3 21 3 21 9"/>
                                            <line x1="10" x2="21" y1="14" y2="3"/>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Well_666 Well Card (Auto-selected) -->
                <div class="max-w-2xl mx-auto">
                    <div id="w666-card" class="bg-slate-800/50 border-2 border-red-500 rounded-lg p-6 shadow-lg">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h4 class="text-2xl font-bold text-white flex items-center gap-2">
                                    <span class="text-red-500">âš ï¸</span>
                                    Well_666 - The Perfect Storm
                                </h4>
                                <p class="text-sm text-slate-400 mt-1">Brahan Field | Oil Producer | Subsea | 16,076ft</p>
                            </div>
                            <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full">SHUT-IN</span>
                        </div>

                        <div class="mb-4">
                            <p class="text-slate-300 text-sm">
                                A nightmare subsea well with multiple, compounding failures: severe BaSO4 scale
                                blockage in tubing and a failed primary safety valve. Requires a complex,
                                multi-stage intervention plan informed by historical case studies.
                            </p>
                        </div>

                        <div class="bg-slate-900/50 rounded p-3 mb-4">
                            <h5 class="text-xs font-bold text-red-400 mb-2">IDENTIFIED PROBLEMS:</h5>
                            <ul class="text-xs text-slate-300 space-y-1">
                                <li>â€¢ SSSV failure (failed test @ 2,500ft)</li>
                                <li>â€¢ Severe casing deformation @ 8,500ft</li>
                                <li>â€¢ BaSO4 scale bridge @ 14,200ft</li>
                            </ul>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="openModal('Well_666')" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold rounded transition">
                                View 3D & Schematic
                            </button>
                            <button onclick="selectWellW666()" class="flex-1 px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-semibold rounded transition">
                                Begin Planning â†’
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="step-2" class="mb-12 hidden">
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold tracking-tight">Step 2: Define Intervention Plan</h3>
                    <p class="mt-4 max-w-3xl mx-auto text-lg">You have selected <strong>Well_666</strong>. Now, define the objective. Use the <strong>AI Advisor</strong> to analyze the well's known problems. The AI will cross-reference the issues with our historical case studies (the other wells in the portfolio) to recommend the most effective intervention strategies, complete with confidence scores and projected outcomes based on proven solutions.</p>
                </div>
                <div class="mt-8 max-w-4xl mx-auto">
                    <div class="flex items-center justify-center mb-6">
                        <span class="text-sm font-medium mr-3">Manual Planning</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="ai-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-teal-300 dark:peer-focus:ring-teal-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                        </label>
                        <span class="text-sm font-medium ml-3">AI Advisor</span>
                    </div>
                    
                    <div id="manual-planning-view">
                        <h4 class="text-lg font-semibold mb-4 text-center">Select Intervention Objective</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div id="objectives-fieldset" class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                            <div id="cost-summary-panel" class="lg:col-span-1">
                                <!-- Cost estimate will appear here when objective is selected -->
                            </div>
                        </div>
                        <div class="mt-8 flex justify-center">
                            <button id="generate-plan-btn-manual" class="rounded-md bg-teal-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-teal-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" disabled>Generate Plan</button>
                        </div>
                    </div>
                    
                    <div id="ai-advisor-view" class="hidden">
                        <div class="bg-blue-50 dark:bg-blue-900/50 p-4 rounded-lg text-center mb-6">
                            <p class="text-sm text-blue-800 dark:text-blue-200">Our AI analyzes anonymized operational patterns from all community data providers to find optimal solutions. Your raw well data is never shared, and Well-Tegra cannot access it. This process is secured by smart contracts.</p>
                        </div>
                        
                        <div id="problem-selection">
                            <h3 class="text-lg font-semibold text-center mb-4">What is the primary problem with this well?</h3>
                            <div id="problems-fieldset" class="space-y-4"></div>
                        </div>
                        
                        <div id="ai-recommendations" class="hidden mt-8"></div>
                        
                        <div class="mt-8 flex justify-center">
                            <button id="generate-plan-btn-ai" class="rounded-md bg-teal-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-teal-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" disabled>Generate Plan from Recommendation</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Equipment Catalog & Tool String Builder -->
            <section id="equipment-tools-section" class="mt-12 max-w-7xl mx-auto px-4">
                <div class="light-card rounded-lg p-6 shadow-xl border-2 border-cyan-500/30">
                    <h3 class="text-2xl font-bold mb-6">ðŸ› ï¸ Equipment Catalog & Tool Strings</h3>

                    <!-- Tabs -->
                    <div class="equipment-tabs">
                        <button class="equipment-tab active" data-tab="catalog" onclick="switchEquipmentTab('catalog')">
                            Equipment Catalog
                        </button>
                        <button class="equipment-tab" data-tab="toolstrings" onclick="switchEquipmentTab('toolstrings')">
                            My Tool Strings
                        </button>
                        <button class="equipment-tab" data-tab="builder" onclick="switchEquipmentTab('builder')">
                            Build New String
                        </button>
                        <button class="equipment-tab" data-tab="templates" onclick="switchEquipmentTab('templates')">
                            Service Templates
                        </button>
                    </div>

                    <!-- Tab Content: Equipment Catalog -->
                    <div id="tab-catalog" class="equipment-tab-content">
                        <input type="text" id="equipment-search" class="search-box" placeholder="Search equipment by name, manufacturer, or application...">

                        <div class="mb-4 flex gap-3 flex-wrap">
                            <button class="btn-secondary" onclick="filterEquipmentCategory('all')">All</button>
                            <button class="btn-secondary" onclick="filterEquipmentCategory('fishing')">Fishing</button>
                            <button class="btn-secondary" onclick="filterEquipmentCategory('running')">Running Tools</button>
                            <button class="btn-secondary" onclick="filterEquipmentCategory('wireline')">Wireline</button>
                            <button class="btn-secondary" onclick="filterEquipmentCategory('completion')">Completion</button>
                            <button class="btn-secondary" onclick="filterEquipmentCategory('gaslift')">Gas Lift</button>
                        </div>

                        <div id="equipment-catalog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Equipment items will be rendered here -->
                        </div>
                    </div>

                    <!-- Tab Content: My Tool Strings -->
                    <div id="tab-toolstrings" class="equipment-tab-content hidden">
                        <div id="saved-toolstrings-list">
                            <!-- Saved tool strings will be rendered here -->
                        </div>
                        <div id="empty-toolstrings" class="empty-state">
                            <div class="empty-state-icon">ðŸ“¦</div>
                            <div class="empty-state-text">No tool strings saved yet</div>
                            <p class="mt-2">Use the Builder tab to create your first reusable tool string assembly.</p>
                        </div>
                    </div>

                    <!-- Tab Content: Build New String -->
                    <div id="tab-builder" class="equipment-tab-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Builder Form -->
                            <div>
                                <h4 class="text-xl font-bold mb-4">Create New Tool String</h4>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Assembly Name</label>
                                    <input type="text" id="new-toolstring-name" class="search-box" placeholder="e.g., Standard Fishing Assembly">
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Service Line</label>
                                    <select id="new-toolstring-service" class="search-box">
                                        <option value="CT">Coiled Tubing</option>
                                        <option value="ELS">E-Line Services</option>
                                        <option value="SLK">Slickline</option>
                                        <option value="WHM">Wireline/Hydraulics</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Select Equipment</label>
                                    <select id="equipment-selector" class="search-box">
                                        <option value="">-- Choose equipment --</option>
                                    </select>
                                    <button class="btn-add-equipment mt-2" onclick="addEquipmentToBuilder()">Add to String</button>
                                </div>

                                <button class="btn-add-equipment mt-4 w-full py-3 text-lg" onclick="saveToolString()">
                                    ðŸ’¾ Save Tool String
                                </button>
                            </div>

                            <!-- Right: Preview -->
                            <div>
                                <h4 class="text-xl font-bold mb-4">Assembly Preview</h4>
                                <div id="builder-preview" class="tool-string-card">
                                    <div class="tool-string-header">
                                        <span class="tool-string-name" id="preview-name">Untitled Assembly</span>
                                    </div>
                                    <ul id="builder-components-list" class="tool-string-components">
                                        <li class="text-gray-500 italic">No components added yet</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Service Templates -->
                    <div id="tab-templates" class="equipment-tab-content hidden">
                        <h4 class="text-xl font-bold mb-4">Pre-Configured Service Line Templates</h4>
                        <p class="text-gray-400 mb-6">Quick-start templates for common intervention scenarios</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="service-templates-grid">
                            <!-- Templates will be rendered here -->
                        </div>
                    </div>
                </div>
            </section>

            <section id="step-3" class="hidden">
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold tracking-tight">Step 3: Review the Generated Plan</h3>
                    <p class="mt-4 max-w-3xl mx-auto text-lg">This is the final review stage. Based on your selections, the platform has generated a comprehensive, data-driven intervention plan. This includes the baseline procedure, a list of required equipment and personnel, and an initial risk assessment. Please review all sections carefully. If everything is in order, you can proceed to the 'Live Operation' view, which simulates the execution of this plan in real-time. If you need to make changes, you can 'Start Over'.</p>
                </div>
                
                <div id="plan-output" class="mt-10 space-y-8"></div>

                <!-- Job Costing Tool -->
                <div id="job-costing-section" class="mt-12 max-w-7xl mx-auto">
                    <div class="light-card rounded-lg p-6 shadow-xl border-2 border-cyan-500/30">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold">ðŸ’° Detailed Job Costing & Resource Planning</h3>
                            <button id="toggle-costing-tool" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white font-semibold rounded-md transition">
                                Collapse Tool
                            </button>
                        </div>

                        <div id="costing-tool-content">
                            <div id="job-costing-tool-container" class="grid grid-cols-1 gap-6"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-center space-x-4">
                    <button id="start-over-btn" class="rounded-md bg-gray-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-gray-500 transition-colors">Start Over</button>
                    <button id="begin-op-btn" class="rounded-md bg-emerald-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-emerald-500 transition-colors">Begin Live Operation</button>
                </div>
            </section>
        </div>

        <!-- Case Studies Portfolio View -->
        <div id="case-studies-view" class="view-container hidden max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold tracking-tight text-white">Well Intervention Case Studies</h2>
                <p class="mt-4 max-w-4xl mx-auto text-lg text-blue-100">
                    Explore our portfolio of successful well interventions. Each case study represents a proven solution to a specific downhole challenge.
                    These learnings directly inform our intervention strategy for <strong class="text-cyan-400">Well_666 - The Perfect Storm</strong>,
                    our most complex problem well combining multiple failure modes.
                </p>
                <div class="mt-6 flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="showView('planner')" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white text-lg font-bold rounded-lg shadow-lg transition transform hover:scale-105">
                        Go to Well_666 Planner â†’
                    </button>
                </div>
            </div>

            <!-- Well Portfolio Grid -->
            <div id="case-studies-grid" class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                <!-- Will be populated dynamically -->
            </div>

            <!-- Legend explaining the well types -->
            <div class="mt-12 max-w-3xl mx-auto bg-slate-800/50 border border-cyan-500/30 rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">ðŸ’¡ Understanding Our Case Studies</h3>
                <div class="space-y-3 text-sm text-slate-300">
                    <div class="flex items-start gap-3">
                        <span class="text-red-500 text-2xl">âš ï¸</span>
                        <div>
                            <strong class="text-red-400">Well_666 - The Perfect Storm:</strong>
                            <span class="text-slate-300">Our challenge well - currently shut-in with multiple compounding failures requiring a complex intervention plan.</span>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="text-green-500 text-2xl">âœ“</span>
                        <div>
                            <strong class="text-green-400">Successful Interventions:</strong>
                            <span class="text-slate-300">The other six wells showcase proven solutions for casing deformation, scale blockage, valve failures, and more. Each lesson learned contributes to our strategy for Well_666.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Case Study Detail View -->
        <div id="case-study-view" class="view-container hidden max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="mb-6">
                <button id="back-to-case-studies" class="text-cyan-400 hover:text-cyan-300 font-semibold flex items-center gap-2 transition-colors">
                    <span>â†</span> Back to Case Studies
                </button>
            </div>

            <div id="case-study-header" class="mb-8">
                <!-- Header will be populated dynamically -->
            </div>

            <!-- Wellbore Trajectory Viewer Section -->
            <div id="case-study-wellbore-viz" class="mb-8 bg-slate-800/50 rounded-lg p-6 border-2 border-cyan-500/30">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-white">ðŸ“ Wellbore Trajectory Viewer</h3>
                    <button id="tiltModeBtn-case" onclick="toggleTiltModeCaseStudy()" class="px-4 py-2 bg-violet-600 hover:bg-violet-500 text-white font-bold rounded-lg transition text-sm">ðŸŽ­ 3D Tilt</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- SVG Visualization -->
                    <div class="lg:col-span-2 bg-slate-900/30 rounded-lg p-4 relative">
                        <svg id="wbSvg-case" viewBox="0 0 800 520" preserveAspectRatio="xMidYMid meet" class="w-full h-auto" style="filter:drop-shadow(0 0 8px rgba(6,182,212,0.3));">
                            <defs>
                                <pattern id="grid-case" width="40" height="40" patternUnits="userSpaceOnUse">
                                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(148,163,184,0.1)" stroke-width="1"/>
                                </pattern>
                                <linearGradient id="dlsGrad-case" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:rgb(34,197,94);stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:rgb(234,179,8);stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:rgb(239,68,68);stop-opacity:1" />
                                </linearGradient>
                                <filter id="glow-case">
                                    <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <rect width="800" height="520" fill="url(#grid-case)"/>
                            <text id="view-label-case" x="400" y="30" text-anchor="middle" fill="#94a3b8" font-size="16" font-weight="600"></text>
                            <path id="wbPath-case" fill="none" stroke="url(#dlsGrad-case)" stroke-width="3" filter="url(#glow-case)"/>
                            <g id="survey-stations-case"></g>
                            <g id="dls-hotspots-case"></g>
                        </svg>
                    </div>

                    <!-- Controls Panel -->
                    <div class="space-y-4">
                        <div class="bg-slate-900/50 rounded-lg p-4 border border-cyan-500/20">
                            <h4 class="text-sm font-bold text-cyan-400 mb-3">ðŸ“Š Survey Data</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Stations:</span>
                                    <span id="survey-count-case" class="text-white font-semibold">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Max Inc:</span>
                                    <span id="survey-max-inc-case" class="text-white font-semibold">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Total MD:</span>
                                    <span id="survey-total-md-case" class="text-white font-semibold">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-900/50 rounded-lg p-4 border border-cyan-500/20">
                            <h4 class="text-sm font-bold text-cyan-400 mb-3">ðŸŽ¯ View Options</h4>
                            <div class="space-y-2">
                                <button onclick="showProfileViewCaseStudy()" class="w-full px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold rounded transition">Profile View</button>
                                <button onclick="showPlanViewCaseStudy()" class="w-full px-3 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm font-semibold rounded transition">Plan View</button>
                            </div>
                        </div>

                        <div class="bg-slate-900/50 rounded-lg p-4 border border-cyan-500/20">
                            <h4 class="text-sm font-bold text-red-400 mb-2">âš ï¸ DLS Analysis</h4>
                            <div class="mb-2">
                                <label class="text-xs text-gray-400">Threshold (Â°/100ft):</label>
                                <input type="number" id="dls-threshold-case" value="3" min="1" max="10" step="0.5" class="w-full mt-1 px-2 py-1 bg-slate-800 text-white text-sm rounded border border-slate-600" onchange="updateDLSThresholdCaseStudy()">
                            </div>
                            <div id="dls-panel-case" class="text-xs text-gray-300 max-h-32 overflow-y-auto">
                                <!-- DLS warnings appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Well Details Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="md:col-span-2">
                    <div class="bg-slate-800/50 rounded-lg p-6 border border-cyan-500/20">
                        <h4 class="text-xl font-semibold mb-4 text-white">Operational History</h4>
                        <div id="case-study-history" class="max-h-96 overflow-y-auto pr-2 space-y-4">
                            <!-- History will be populated dynamically -->
                        </div>
                    </div>
                </div>
                <div class="md:col-span-1">
                    <div class="bg-slate-800/50 rounded-lg p-6 border border-cyan-500/20">
                        <h4 class="text-xl font-semibold mb-4 text-white">Wellbore Schematic</h4>
                        <div id="case-study-schematic" class="bg-slate-900/50 p-4 rounded-lg">
                            <!-- Schematic will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="logistics-view" class="view-container hidden max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Logistics & Asset Management</h2><p id="logistics-subtitle" class="mt-2 max-w-2xl mx-auto text-lg">Manage equipment and personnel availability, certifications, and maintenance schedules.</p></div>
            <div id="logistics-content" class="mt-10 grid gap-12 lg:grid-cols-2">
                <div class="light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Equipment Hub</h3><input type="text" id="equipment-search" placeholder="Search equipment..." class="w-full p-2 rounded-md mb-4"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Asset ID</th><th>Type</th><th>Location</th><th>Test Status</th><th>Actions</th></tr></thead><tbody id="equipment-table-body"></tbody></table></div></div>
                <div class="light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Personnel Roster</h3><input type="text" id="personnel-search" placeholder="Search personnel..." class="w-full p-2 rounded-md mb-4"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Name</th><th>Role</th><th>Status</th><th>Certs Valid</th></tr></thead><tbody id="personnel-table-body"></tbody></table></div></div>
            </div>
        </div>
        
        <div id="commercial-view" class="view-container hidden max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Commercial Dashboard</h2><p id="commercial-subtitle" class="mt-2 max-w-2xl mx-auto text-lg">Live financial tracking for the selected operation.</p></div>
            <div id="commercial-content" class="mt-10"></div>
        </div>

        <div id="hse-view" class="view-container hidden max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">HSE & Risk Dashboard</h2><p id="hse-subtitle" class="mt-2 max-w-2xl mx-auto text-lg">Centralized risk register and permit to work status.</p></div>
            <div id="hse-content" class="mt-10"></div>
        </div>

        <div id="pob-view" class="view-container hidden max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Personnel on Board & Emergency Response</h2><p id="pob-subtitle" class="mt-2 max-w-2xl mx-auto text-lg">Live POB manifest and emergency muster status.</p></div>
            <div id="pob-content" class="mt-10"></div>
        </div>

        <div id="whitepaper-view" class="view-container hidden max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold tracking-tight">Well-Tegra White Paper</h2>
                <p class="mt-4 max-w-2xl mx-auto text-lg">Dive deeper into the technical architecture and strategic vision behind the Well-Tegra platform. Our white paper provides a comprehensive overview of the privacy-preserving AI, enterprise blockchain, and data unification strategies that power our solution.</p>
                <a href="https://docs.google.com/document/d/1HEIv2E17aWXYltLh17FvDxc5Q3jWI7FA6fzU1JAhRwg/edit?usp=sharing" target="_blank" rel="noopener noreferrer" download class="mt-8 inline-block rounded-md bg-blue-600 px-8 py-4 text-lg font-semibold text-white shadow-sm hover:bg-blue-500 transition">
                    Download the White Paper
                </a>
            </div>
        </div>

        <div id="faq-view" class="view-container hidden max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Frequently Asked Questions</h2><p class="mt-2 max-w-2xl mx-auto text-lg">Find answers to common questions about the Well-Tegra platform.</p></div>
            <div id="faq-accordion" class="mt-10 light-card rounded-lg shadow-md overflow-hidden">
                </div>
        </div>

        <div id="about-view" class="view-container hidden max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">About Me & The Mission</h2></div>
            <div class="mt-10 light-card p-8 rounded-lg space-y-8">
                <div>
                    <h3 class="text-2xl font-bold">From the Wellsite to the Web</h3>
                    <p class="text-lg italic">"I built Well-Tegra because I've lived the problems it's designed to solve." - Kenneth McKenzie</p>
                </div>
                <div>
                    <h4 class="text-xl font-semibold">My Perspective</h4>
                    <p>I'm not a software developer who decided to get into oil and gas. I'm a well services guy who learned to code. My career started at the sharp end with Tristar Oilfield Services and took me around the world, working with service leaders like Expro and Wellserv, and later supervising operations for major operators like BG Group, CNR, and Woodside. I've been on both sides of the fenceÃ¢â‚¬â€I know the service company's challenges and the operator's objectives. That's the insight Well-Tegra is built on.</p>
                </div>
                 <div>
                    <h4 class="text-xl font-semibold">Why I Built This</h4>
                    <p>I've seen first-hand how much time, money, and energy we waste because our data is a mess. It's locked in different systems, buried in old reports, and stuck in spreadsheets. We repeat the same mistakes because the lessons learned from one job are never available for the next. The "Well From Hell" in this demo isn't an exaggeration; it's a sanitized version of the real-world train wrecks I've witnessedÃ¢â‚¬â€and helped clean up.</p>
                    <p class="mt-2">Well-Tegra is my answer to that chaos. It's a platform designed from an operator's perspective, focused on a single source of truth that connects planning, execution, and analysis.</p>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                    <h4 class="font-bold text-blue-800 dark:text-blue-300">The Path Forward</h4>
                    <p class="mt-2 text-blue-700 dark:text-blue-200">This demo is the blueprint. It was built on a Chromebook with a lot of determination, but to bring it to life, it needs the power of real, collective data. The next step is to partner with operators and service companies to build out the anonymized data pool that will drive the predictive AI. The platform is ready to scale, and I'm actively seeking the right partners to help build the future of well operations.</p>
                </div>
            </div>
        </div>

        <div id="performer-view" class="view-container hidden performer-view p-4 lg:p-6 h-full">
            <div class="h-full dashboard-grid">
                <div id="procedure-panel" class="bg-slate-800/50 rounded-lg p-4 flex flex-col">
                    <h2 class="text-lg font-semibold mb-2 border-b border-slate-700 pb-2">Operational Procedure</h2>
                    <p class="text-xs text-slate-400 mb-3">Simulation is running. Click a future step to jump ahead.</p>
                    <div id="procedure-steps" class="flex-1 space-y-3 overflow-y-auto pr-2"></div>
                    <div id="performer-controls" class="hidden mt-4">
                        <button id="view-analysis-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-md transition">View Post-Job Analysis</button>
                    </div>
                </div>
                <div class="flex flex-col gap-4 lg:gap-6">
                    <div id="kpi-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6">
                        </div>
                    <div id="chart-card" class="flex-1 bg-slate-800/50 rounded-lg p-4 flex-col"><h3 class="text-lg font-semibold mb-2">Tubing Force Analysis: Plan vs. Actual</h3><div class="flex-1 relative"><canvas id="tfaChart"></canvas></div></div>

                    <!-- V23: Real-Time Anomaly Detection -->
                    <div id="anomaly-alerts-container" class="bg-slate-800/50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-4">ðŸš¨ Live Anomaly Detection</h3>
                        <div id="anomaly-alerts" class="space-y-3">
                            <div class="text-slate-400 text-center py-8 text-sm">
                                Monitoring for anomalies... All systems normal.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-4 flex flex-col"><h2 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Operations Log</h2><div id="log-entries" class="flex-1 space-y-3 overflow-y-auto mb-4"></div><div class="mt-auto"><label for="log-input" class="sr-only">Add log entry</label><textarea id="log-input" class="w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm" rows="3" placeholder="Add log entry..." aria-label="New log entry"></textarea><button id="add-log-btn" class="mt-2 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-md transition">Add Entry</button></div></div>
            </div>

            <!-- Live Cost Tracker -->
            <div id="performer-cost-tracker" class="mt-6 bg-gradient-to-r from-green-900/50 to-emerald-900/50 rounded-lg p-6 border border-green-700/50">
                <h3 class="text-xl font-bold text-green-400 mb-4">ðŸ’° Live Cost Tracking</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-black/30 rounded-lg p-4 text-center">
                        <div class="text-sm text-gray-400 mb-1">AFE Budget</div>
                        <div id="performer-afe-budget" class="text-2xl font-bold text-white">$0</div>
                    </div>
                    <div class="bg-black/30 rounded-lg p-4 text-center">
                        <div class="text-sm text-gray-400 mb-1">Actual Cost</div>
                        <div id="performer-actual-cost" class="text-2xl font-bold text-white">$0</div>
                    </div>
                    <div class="bg-black/30 rounded-lg p-4 text-center">
                        <div class="text-sm text-gray-400 mb-1">Variance</div>
                        <div id="performer-variance" class="text-2xl font-bold text-white">$0</div>
                    </div>
                    <div class="bg-black/30 rounded-lg p-4 text-center">
                        <div class="text-sm text-gray-400 mb-1">% of Budget</div>
                        <div id="performer-budget-percent" class="text-2xl font-bold text-white">0%</div>
                    </div>
                </div>

                <!-- NPT Tracking Section -->
                <div class="mt-4 bg-red-900/30 rounded-lg p-4 border border-red-700/50">
                    <h4 class="text-lg font-bold text-red-400 mb-3">âš ï¸ Non-Productive Time (NPT) Tracking</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <select id="npt-type-select" class="bg-gray-800 border-gray-700 rounded-md px-3 py-2 text-white text-sm">
                            <option value="">Select NPT Type...</option>
                            <option value="stuck-pipe">Stuck Pipe</option>
                            <option value="equipment-failure">Equipment Failure</option>
                            <option value="weather-delay">Weather Delay</option>
                            <option value="well-control">Well Control Event</option>
                            <option value="fishing">Fishing Operations</option>
                            <option value="wait-on-weather">Wait on Weather</option>
                            <option value="wait-on-equipment">Wait on Equipment</option>
                            <option value="leak-repair">Leak/Seal Repair</option>
                            <option value="bop-test">Unplanned BOP Test</option>
                            <option value="fluid-loss">Fluid Loss/Kill</option>
                        </select>
                        <input type="number" id="npt-duration-input" placeholder="Duration (hours)" min="0.5" step="0.5" class="bg-gray-800 border-gray-700 rounded-md px-3 py-2 text-white text-sm">
                        <button onclick="addNPTEventFromUI()" class="bg-red-600 hover:bg-red-500 text-white font-bold px-4 py-2 rounded-md text-sm">Add NPT Event</button>
                    </div>
                    <div id="npt-events-list" class="max-h-48 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">No NPT events recorded</p>
                    </div>
                    <div class="mt-3 pt-3 border-t border-red-700/50 flex justify-between items-center">
                        <span class="text-sm font-semibold">Total NPT Cost:</span>
                        <span id="performer-npt-cost" class="text-xl font-bold text-red-400">$0</span>
                    </div>
                </div>
            </div>

            <!-- Wellbore Deviation Visualization with CSV Survey Import -->
            <div id="performer-wellbore" class="mt-6 bg-slate-800/50 rounded-lg p-6 border border-slate-700">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Left: CSV Upload & Controls -->
                    <div class="bg-slate-900/40 border border-slate-700 rounded-lg p-4">
                        <div class="mb-4">
                            <strong class="text-lg block mb-2">ðŸ“Š Survey Data</strong>
                            <p class="text-xs text-slate-400 mb-4">Upload CSV with MD, INC, AZ columns (degrees)</p>
                        </div>

                        <!-- File drop zone -->
                        <div id="survey-drop-zone" class="border-2 border-dashed border-slate-600 hover:border-cyan-500 rounded-lg p-6 text-center cursor-pointer transition mb-4">
                            <div class="text-slate-400">
                                <svg class="mx-auto h-12 w-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <p class="text-sm font-semibold">Drop CSV here or click</p>
                                <p class="text-xs mt-1">or paste below</p>
                            </div>
                            <input id="survey-file-input" type="file" accept=".csv,.txt" class="hidden">
                        </div>

                        <!-- Paste area -->
                        <textarea id="survey-paste-area" placeholder="Or paste CSV text here..."
                                  class="w-full h-24 bg-slate-800 border border-slate-700 rounded-md p-2 text-sm text-slate-300 font-mono resize-none mb-3"></textarea>

                        <!-- URL loader -->
                        <div class="mb-3 p-3 bg-slate-800/60 border border-slate-600 rounded-lg">
                            <p class="text-xs font-semibold text-slate-300 mb-2">ðŸ”— Load from URL</p>
                            <div class="flex gap-2">
                                <input id="survey-url-input" type="text" placeholder="https://example.com/survey.csv"
                                       class="flex-1 bg-slate-900 border border-slate-700 rounded-md px-2 py-1 text-sm text-slate-300">
                                <button onclick="loadSurveyFromURL()" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold rounded-md transition whitespace-nowrap">
                                    Load URL
                                </button>
                            </div>
                            <p id="url-load-status" class="mt-2 text-xs text-slate-400"></p>
                        </div>

                        <!-- Column mapping -->
                        <div id="survey-column-map" class="hidden mb-4 p-3 bg-slate-800/60 border border-slate-600 rounded-lg">
                            <p class="text-xs font-semibold text-slate-300 mb-2">Map Columns:</p>
                            <div class="space-y-2 text-xs">
                                <div class="flex items-center gap-2">
                                    <label class="w-12 text-slate-400">MD:</label>
                                    <select id="col-md" class="flex-1 bg-slate-900 border-slate-700 rounded px-2 py-1 text-slate-300"></select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="w-12 text-slate-400">INC:</label>
                                    <select id="col-inc" class="flex-1 bg-slate-900 border-slate-700 rounded px-2 py-1 text-slate-300"></select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="w-12 text-slate-400">AZ:</label>
                                    <select id="col-azi" class="flex-1 bg-slate-900 border-slate-700 rounded px-2 py-1 text-slate-300"></select>
                                </div>
                            </div>
                            <button onclick="applySurveyMapping()" class="mt-3 w-full px-3 py-2 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-semibold rounded-md transition">
                                Apply Mapping
                            </button>
                        </div>

                        <!-- View toggle -->
                        <div class="mb-4">
                            <p class="text-xs text-slate-400 mb-2">View Mode:</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="view-profile-btn" onclick="switchSurveyView('profile')"
                                        class="px-3 py-2 bg-cyan-600 text-white text-sm font-semibold rounded-md transition">
                                    Profile
                                </button>
                                <button id="view-plan-btn" onclick="switchSurveyView('plan')"
                                        class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-semibold rounded-md transition">
                                    Plan
                                </button>
                            </div>
                        </div>

                        <!-- Sample data button -->
                        <button onclick="loadSampleSurvey()" class="w-full px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-semibold rounded-md transition mb-3">
                            Load Sample Data
                        </button>

                        <!-- Open data links -->
                        <div class="mb-3 p-3 bg-slate-800/60 border border-slate-600 rounded-lg">
                            <p class="text-xs font-semibold text-slate-300 mb-2">ðŸ“‚ Open Data Sources</p>
                            <div class="space-y-1.5 text-xs">
                                <a href="#" onclick="loadOpenDataURL('utah-forge'); return false;" class="flex items-center gap-1.5 text-cyan-400 hover:text-cyan-300 transition">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                    <span>Utah FORGE Well</span>
                                </a>
                                <a href="#" onclick="loadOpenDataURL('boem'); return false;" class="flex items-center gap-1.5 text-cyan-400 hover:text-cyan-300 transition">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                    <span>BOEM Gulf Survey</span>
                                </a>
                                <a href="#" onclick="loadOpenDataURL('norway'); return false;" class="flex items-center gap-1.5 text-cyan-400 hover:text-cyan-300 transition">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                    <span>Norway NPD Well</span>
                                </a>
                                <a href="#" onclick="loadOpenDataURL('volve'); return false;" class="flex items-center gap-1.5 text-cyan-400 hover:text-cyan-300 transition">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                    <span>Equinor Volve</span>
                                </a>
                            </div>
                            <p class="mt-2 text-xs text-slate-500">Public domain & open license datasets</p>
                        </div>

                        <!-- Built-in tests -->
                        <button onclick="runSurveyTests()" class="w-full px-3 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm font-semibold rounded-md transition mb-3">
                            ðŸ§ª Run Built-in Tests
                        </button>
                        <div id="test-results" class="hidden mb-3 p-3 bg-slate-800/60 border border-slate-600 rounded-lg">
                            <p class="text-xs font-semibold text-slate-300 mb-2">Test Results:</p>
                            <div id="test-output" class="text-xs font-mono space-y-1"></div>
                        </div>

                        <!-- Plan overlay loader -->
                        <div class="mt-4 p-3 bg-slate-800/60 border border-slate-600 rounded-lg">
                            <p class="text-xs font-semibold text-slate-300 mb-2">ðŸ“‹ Plan Overlay (Optional)</p>
                            <button onclick="loadPlanCSV()" class="w-full px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold rounded-md transition">
                                Load Plan CSV
                            </button>
                            <p class="mt-2 text-xs text-slate-400">Load a separate plan to compare actual vs planned trajectory</p>
                        </div>

                        <!-- DLS & Display Controls -->
                        <div class="mt-4 p-3 bg-slate-800/60 border border-slate-600 rounded-lg">
                            <p class="text-xs font-semibold text-slate-300 mb-3">Display Options</p>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs text-slate-400">DLS Threshold (Â°/30m)</label>
                                    <input id="dls-threshold" type="range" min="3" max="12" step="0.5" value="6" class="w-24">
                                    <span id="dls-threshold-val" class="text-xs text-slate-300 w-8">6.0</span>
                                </div>
                                <label class="flex items-center gap-2 text-xs">
                                    <input id="toggle-plan" type="checkbox" checked class="rounded">
                                    <span class="text-slate-300">Show plan overlay</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs">
                                    <input id="toggle-hotspots" type="checkbox" checked class="rounded">
                                    <span class="text-slate-300">Show DLS hotspots</span>
                                </label>
                            </div>
                        </div>

                        <!-- Status -->
                        <div id="survey-status" class="mt-4 text-xs text-slate-400"></div>
                    </div>

                    <!-- Center: Animated deviation path -->
                    <div class="lg:col-span-2 bg-slate-900/40 border border-slate-700 rounded-lg overflow-hidden">
                        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-slate-800/50">
                            <strong class="text-lg">ðŸ“ Wellbore Trajectory</strong>
                            <span id="survey-view-label" class="text-sm text-slate-400">Profile View (Departure vs TVD)</span>
                        </div>

                        <!-- SVG canvas -->
                        <svg id="wbSvg" viewBox="0 0 800 520" preserveAspectRatio="xMidYMid meet" class="w-full h-auto block" style="background:linear-gradient(180deg,rgba(15,23,42,.45),rgba(2,6,23,.35))">
                            <defs>
                                <pattern id="grid" width="80" height="80" patternUnits="userSpaceOnUse">
                                    <path d="M80 0H0V80" fill="none" stroke="#334155" stroke-opacity=".4" stroke-width="1"/>
                                </pattern>
                                <linearGradient id="dlsGrad" x1="0" y1="0" x2="1" y2="1">
                                    <stop offset="0%" stop-color="#22d3ee"/>
                                    <stop offset="50%" stop-color="#14b8a6"/>
                                    <stop offset="100%" stop-color="#f59e0b"/>
                                </linearGradient>
                                <filter id="glow"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                            </defs>
                            <rect x="0" y="0" width="800" height="520" fill="url(#grid)"/>

                            <!-- Axes -->
                            <g id="survey-axes">
                                <text x="400" y="515" fill="#94a3b8" font-size="11" text-anchor="middle">Departure (m)</text>
                                <text x="10" y="260" fill="#94a3b8" font-size="11" transform="rotate(-90 10 260)" text-anchor="middle">TVD (m)</text>
                            </g>

                            <!-- Survey path will be drawn here -->
                            <path id="wbPath" d="" fill="none" stroke="url(#dlsGrad)" stroke-width="4" filter="url(#glow)"/>

                            <!-- Survey stations (dots) -->
                            <g id="survey-stations"></g>

                            <!-- Current tool position -->
                            <circle id="toolDot" r="8" fill="#14b8a6" stroke="#0b1220" stroke-width="2"/>
                            <text id="mdBadge" x="0" y="0" font-size="12" fill="#e2e8f0" stroke="#0b1220" stroke-width="0.6" paint-order="stroke" style="font-weight:700">MD 0 m</text>
                        </svg>

                        <!-- Animation controls -->
                        <div id="survey-controls" class="flex flex-wrap gap-2 items-center px-4 py-3 border-t border-slate-700 bg-slate-900/30">
                            <button id="wbPlay" class="px-3 py-2 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-lg transition text-sm">â–¶ Play</button>
                            <button id="wbPause" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition text-sm">â¸ Pause</button>
                            <button id="wbSavePNG" onclick="saveSurveyPNG()" class="px-3 py-2 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-lg transition text-sm">ðŸ’¾ PNG</button>
                            <button id="wbExportCSV" onclick="exportSurveyCSV()" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg transition text-sm">ðŸ“„ CSV</button>
                            <button id="wbShareLink" onclick="shareSurveyLink()" class="px-3 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg transition text-sm">ðŸ”— Share</button>
                            <button onclick="window.print()" class="px-3 py-2 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-lg transition text-sm">ðŸ–¨ï¸ Print</button>
                            <button id="cleanModeBtn" onclick="toggleCleanMode()" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg transition text-sm">ðŸ‘ï¸ Clean</button>
                            <button id="tiltModeBtn" onclick="toggleTiltMode()" class="px-3 py-2 bg-violet-600 hover:bg-violet-500 text-white font-bold rounded-lg transition text-sm">ðŸŽ­ 3D Tilt</button>
                            <label class="flex items-center gap-2">
                                <span class="text-xs text-slate-400">Speed</span>
                                <input id="wbSpeed" type="range" min="0.25" max="3" step="0.25" value="1" class="w-20">
                            </label>
                            <label class="flex items-center gap-2 flex-1">
                                <span class="text-xs text-slate-400">Depth</span>
                                <input id="wbScrub" type="range" min="0" max="1000" step="1" value="0" class="flex-1 min-w-[120px]">
                            </label>
                            <span id="wbInfo" class="text-xs text-slate-400">Incl: â€”Â° | Az: â€”Â°</span>
                        </div>

                        <!-- Delta statistics (shown when plan is loaded) -->
                        <div id="delta-stats" class="hidden px-4 py-3 border-t border-slate-700 bg-gradient-to-r from-cyan-900/20 to-blue-900/20">
                            <div class="flex flex-wrap gap-3 items-center text-xs">
                                <span class="font-semibold text-slate-300">Plan Deviation:</span>
                                <span class="px-2 py-1 bg-cyan-500/20 border border-cyan-500/30 rounded-full">
                                    Max: <strong id="delta-max" class="text-cyan-300">â€”</strong>
                                </span>
                                <span class="px-2 py-1 bg-blue-500/20 border border-blue-500/30 rounded-full">
                                    Avg: <strong id="delta-avg" class="text-blue-300">â€”</strong>
                                </span>
                                <span class="px-2 py-1 bg-purple-500/20 border border-purple-500/30 rounded-full">
                                    End: <strong id="delta-end" class="text-purple-300">â€”</strong>
                                </span>
                                <span class="px-2 py-1 bg-emerald-500/20 border border-emerald-500/30 rounded-full">
                                    Kickoff: <strong id="delta-kickoff" class="text-emerald-300">â€”</strong>
                                </span>
                                <div class="flex items-center gap-2 px-2 py-1 bg-slate-800/60 rounded-full">
                                    <span class="text-slate-400">Trend:</span>
                                    <svg id="delta-sparkline" width="60" height="20" class="inline-block">
                                        <polyline id="sparkline-path" fill="none" stroke="#22d3ee" stroke-width="2" points=""/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- DLS hotspots panel -->
                        <div id="dls-panel" class="hidden px-4 py-3 border-t border-slate-700 bg-red-900/10">
                            <div class="mb-2 font-semibold text-xs text-red-400">DLS Hotspots (click to jump)</div>
                            <div id="dls-list" class="grid grid-cols-2 gap-2 text-xs"></div>
                        </div>
                    </div>

                    <!-- Right: KPI & Stats -->
                    <div class="grid gap-4 content-start">
                        <div class="bg-slate-900/40 border border-slate-700 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <strong class="text-base">Live Survey</strong>
                                <span id="survey-data-badge" class="text-xs text-slate-400">No Data</span>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-slate-800/60 border border-slate-700 rounded-lg p-3">
                                    <div class="text-xs text-slate-400">MD</div>
                                    <div id="kpiMD" class="text-2xl font-bold text-cyan-400">0 m</div>
                                </div>
                                <div class="bg-slate-800/60 border border-slate-700 rounded-lg p-3">
                                    <div class="text-xs text-slate-400">TVD</div>
                                    <div id="kpiTVD" class="text-2xl font-bold text-cyan-400">0 m</div>
                                </div>
                                <div class="bg-slate-800/60 border border-slate-700 rounded-lg p-3">
                                    <div class="text-xs text-slate-400">Incl</div>
                                    <div id="kpiIncl" class="text-2xl font-bold text-emerald-400">â€”Â°</div>
                                </div>
                                <div class="bg-slate-800/60 border border-slate-700 rounded-lg p-3">
                                    <div class="text-xs text-slate-400">Az</div>
                                    <div id="kpiAz" class="text-2xl font-bold text-amber-400">â€”Â°</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-900/40 border border-slate-700 rounded-lg p-4">
                            <strong class="text-base block mb-3">Coordinates</strong>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-400">North:</span>
                                    <span id="kpiNorth" class="text-slate-200 font-mono">0.0 m</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">East:</span>
                                    <span id="kpiEast" class="text-slate-200 font-mono">0.0 m</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Departure:</span>
                                    <span id="kpiDep" class="text-slate-200 font-mono">0.0 m</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-900/40 border border-slate-700 rounded-lg p-4">
                            <strong class="text-base block mb-3">Survey Stats</strong>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Stations:</span>
                                    <span id="survey-count" class="text-slate-200">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Max Inc:</span>
                                    <span id="survey-max-inc" class="text-slate-200">â€”Â°</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Total MD:</span>
                                    <span id="survey-total-md" class="text-slate-200">0 m</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analyzer-view" class="view-container hidden max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Post-Job Analysis</h2><p id="analyzer-subtitle" class="mt-2 max-w-2xl mx-auto text-lg"></p></div>

            <!-- PDF Export Button -->
            <div class="mt-6 flex justify-center">
                <button onclick="generatePDFReport()" class="pdf-export-btn bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all shadow-lg">
                    ðŸ“„ Export Complete Report (PDF)
                </button>
            </div>

            <div class="mt-10 grid gap-8 lg:grid-cols-2"><div class="light-card p-6 md:p-8 rounded-lg"><h3 class="text-xl font-semibold mb-4">Performance Summary</h3><div id="summary-kpis" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div></div><div class="light-card p-6 md:p-8 rounded-lg"><h3 class="text-xl font-semibold mb-4">Non-Productive Time (NPT) Breakdown</h3><div class="h-64 md:h-80"><canvas id="nptChart"></canvas></div></div></div>

            <!-- V23: Enhanced Vendor Scorecard -->
            <div class="vendor-scorecard mt-8 fade-in-up">
                <h3 class="text-2xl font-bold mb-4">â­ Vendor Performance Scorecard</h3>
                <div class="bg-white/10 rounded-lg p-6 mb-4">
                    <div class="text-center mb-6">
                        <div class="text-5xl font-bold mb-2" id="vendor-overall-rating">4.2</div>
                        <div class="star-rating mb-2 justify-center" id="vendor-overall-stars">
                            <!-- Stars generated by JavaScript -->
                        </div>
                        <div class="text-sm opacity-90">Overall Performance Rating</div>
                    </div>
                </div>

                <div class="bg-white/5 rounded-lg p-6">
                    <div class="metric-row">
                        <span class="metric-label">On-Time Delivery</span>
                        <div class="metric-value">
                            <div class="star-rating" id="metric-delivery-stars"></div>
                            <span class="score-badge score-excellent">95%</span>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Equipment Quality</span>
                        <div class="metric-value">
                            <div class="star-rating" id="metric-quality-stars"></div>
                            <span class="score-badge score-good">88%</span>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Technical Support</span>
                        <div class="metric-value">
                            <div class="star-rating" id="metric-support-stars"></div>
                            <span class="score-badge score-excellent">92%</span>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Cost Competitiveness</span>
                        <div class="metric-value">
                            <div class="star-rating" id="metric-cost-stars"></div>
                            <span class="score-badge score-fair">78%</span>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Safety Record</span>
                        <div class="metric-value">
                            <div class="star-rating" id="metric-safety-stars"></div>
                            <span class="score-badge score-excellent">98%</span>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Responsiveness</span>
                        <div class="metric-value">
                            <div class="star-rating" id="metric-response-stars"></div>
                            <span class="score-badge score-good">85%</span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 text-sm opacity-90">
                    <strong>Recommendation:</strong> Excellent overall performance. Continue partnership and consider for additional wells.
                </div>
            </div>

            <!-- Detailed Cost Breakdown -->
            <div id="analyzer-cost-breakdown" class="mt-8 light-card p-6 md:p-8 rounded-lg">
                <h3 class="text-2xl font-bold mb-6">ðŸ’° Final Cost Analysis & Breakdown</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg p-6">
                        <div class="text-sm opacity-90 mb-2">AFE Budget</div>
                        <div id="analyzer-afe-budget" class="text-4xl font-bold">$0</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg p-6">
                        <div class="text-sm opacity-90 mb-2">Actual Cost</div>
                        <div id="analyzer-actual-cost" class="text-4xl font-bold">$0</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">Equipment</div>
                        <div id="analyzer-equipment-cost" class="text-xl font-bold">$0</div>
                    </div>
                    <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">Personnel</div>
                        <div id="analyzer-personnel-cost" class="text-xl font-bold">$0</div>
                    </div>
                    <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">Tools</div>
                        <div id="analyzer-tools-cost" class="text-xl font-bold">$0</div>
                    </div>
                    <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">Consumables</div>
                        <div id="analyzer-consumables-cost" class="text-xl font-bold">$0</div>
                    </div>
                </div>

                <!-- NPT Breakdown -->
                <div id="analyzer-npt-section" class="mt-6 bg-red-50 dark:bg-red-900/20 rounded-lg p-6 border-2 border-red-300 dark:border-red-700">
                    <h4 class="text-xl font-bold text-red-700 dark:text-red-400 mb-4">âš ï¸ NPT Impact Analysis</h4>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-white dark:bg-slate-800 rounded-lg p-4">
                            <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Total NPT Cost</div>
                            <div id="analyzer-npt-cost" class="text-2xl font-bold text-red-600 dark:text-red-400">$0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-lg p-4">
                            <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">NPT % of Total</div>
                            <div id="analyzer-npt-percent" class="text-2xl font-bold text-red-600 dark:text-red-400">0%</div>
                        </div>
                    </div>
                    <div id="analyzer-npt-events-list" class="space-y-2">
                        <!-- NPT events will be rendered here -->
                    </div>
                </div>
            </div>

            <div class="mt-8 light-card p-6 md:p-8 rounded-lg"><h3 class="text-xl font-semibold mb-4">Lessons Learned</h3><div id="lessons-learned-list" class="space-y-4 mb-6"></div><div><label for="lesson-input" class="sr-only">New lesson learned</label><textarea id="lesson-input" class="w-full p-2 text-base rounded-md" rows="3" placeholder="Add a new lesson learned..." aria-label="New lesson learned"></textarea><button id="add-lesson-btn" class="mt-2 rounded-md bg-teal-600 px-4 py-2 text-base font-semibold text-white shadow-sm hover:bg-teal-500">Add Lesson</button></div></div>
            <div class="mt-8 flex justify-center"><button id="plan-new-job-btn" class="rounded-md bg-gray-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-gray-500">Plan New Job</button></div>
        </div>

        <!-- Security View -->
        <div id="security-view" class="view-container hidden max-w-5xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold tracking-tight">Security & Data Protection</h1>
                <p class="mt-4 text-lg text-slate-400">We design for security from day one</p>
            </div>

            <div class="space-y-8">
                <!-- Security Overview -->
                <div class="light-card p-8 rounded-lg">
                    <p class="text-lg leading-relaxed">
                        Encryption in transit (TLS 1.2+), encryption at rest (AES-256), role-based access control,
                        and regional data residency by request. Your data security is our top priority.
                    </p>
                </div>

                <!-- Architecture Diagram Placeholder -->
                <div class="light-card p-8 rounded-lg">
                    <h2 class="text-2xl font-bold mb-6">Architecture & Data Flow</h2>
                    <div class="bg-slate-800/50 border-2 border-cyan-500/30 rounded-lg p-8 text-center">
                        <div class="space-y-4 text-left max-w-3xl mx-auto">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-cyan-600 rounded-full flex items-center justify-center text-white font-bold">1</div>
                                <div>
                                    <h4 class="font-semibold text-cyan-400">Browser to API</h4>
                                    <p class="text-sm text-slate-300">All data flows from your browser to our API over TLS 1.3 encrypted connections</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-cyan-600 rounded-full flex items-center justify-center text-white font-bold">2</div>
                                <div>
                                    <h4 class="font-semibold text-cyan-400">At-Rest Encryption</h4>
                                    <p class="text-sm text-slate-300">Data is encrypted with AES-256 using managed keys, never stored in plaintext</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-cyan-600 rounded-full flex items-center justify-center text-white font-bold">3</div>
                                <div>
                                    <h4 class="font-semibold text-cyan-400">Access Control</h4>
                                    <p class="text-sm text-slate-300">Role-based permissions ensure users only access data relevant to their role</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 w-10 h-10 bg-cyan-600 rounded-full flex items-center justify-center text-white font-bold">4</div>
                                <div>
                                    <h4 class="font-semibold text-cyan-400">Audit Logging</h4>
                                    <p class="text-sm text-slate-300">All admin actions and data access events are logged and monitored</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compliance Roadmap -->
                <div class="light-card p-8 rounded-lg">
                    <h2 class="text-2xl font-bold mb-6">Compliance & Certifications Roadmap</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="border-l-4 border-emerald-500 pl-4">
                            <h4 class="font-semibold text-emerald-400 mb-2">In Progress</h4>
                            <ul class="space-y-2 text-slate-300">
                                <li class="flex items-center gap-2">
                                    <span class="text-emerald-400">â³</span>
                                    <span>SOC 2 Type I Certification</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="text-emerald-400">â³</span>
                                    <span>Penetration Testing (Q1 2025)</span>
                                </li>
                            </ul>
                        </div>
                        <div class="border-l-4 border-cyan-500 pl-4">
                            <h4 class="font-semibold text-cyan-400 mb-2">Planned</h4>
                            <ul class="space-y-2 text-slate-300">
                                <li class="flex items-center gap-2">
                                    <span class="text-cyan-400">ðŸ“‹</span>
                                    <span>SSO/OIDC Integration (Okta, Azure AD)</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="text-cyan-400">ðŸ“‹</span>
                                    <span>Data Retention & Deletion Policy</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="text-cyan-400">ðŸ“‹</span>
                                    <span>ISO 27001 Certification</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Security Features -->
                <div class="light-card p-8 rounded-lg">
                    <h2 class="text-2xl font-bold mb-6">Security Features</h2>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <div class="text-4xl mb-3">ðŸ”’</div>
                            <h4 class="font-semibold mb-2">Encryption</h4>
                            <p class="text-sm text-slate-400">TLS 1.3 in transit, AES-256 at rest</p>
                        </div>
                        <div>
                            <div class="text-4xl mb-3">ðŸ‘¤</div>
                            <h4 class="font-semibold mb-2">Access Control</h4>
                            <p class="text-sm text-slate-400">Role-based permissions, MFA support</p>
                        </div>
                        <div>
                            <div class="text-4xl mb-3">ðŸ“Š</div>
                            <h4 class="font-semibold mb-2">Audit Logs</h4>
                            <p class="text-sm text-slate-400">Complete activity tracking</p>
                        </div>
                        <div>
                            <div class="text-4xl mb-3">ðŸŒ</div>
                            <h4 class="font-semibold mb-2">Data Residency</h4>
                            <p class="text-sm text-slate-400">Regional hosting options available</p>
                        </div>
                        <div>
                            <div class="text-4xl mb-3">ðŸ”„</div>
                            <h4 class="font-semibold mb-2">Backups</h4>
                            <p class="text-sm text-slate-400">Automated daily backups, 30-day retention</p>
                        </div>
                        <div>
                            <div class="text-4xl mb-3">ðŸ›¡ï¸</div>
                            <h4 class="font-semibold mb-2">Monitoring</h4>
                            <p class="text-sm text-slate-400">24/7 security monitoring & alerts</p>
                        </div>
                    </div>
                </div>

                <!-- Contact -->
                <div class="light-card p-8 rounded-lg text-center">
                    <h2 class="text-2xl font-bold mb-4">Have Security Questions?</h2>
                    <p class="text-lg text-slate-400 mb-6">Our security team is here to help</p>
                    <a href="mailto:contact@welltegra.network?subject=Demo%20Request" class="inline-block px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-lg transition">
                        Contact Security Team
                    </a>
                </div>
            </div>
        </div>

    </main>
    
    <div id="well-history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-overlay">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-5xl shadow-lg rounded-md modal-container">
            <div class="flex justify-between items-center border-b pb-3 dark:border-gray-700">
                <h3 id="modal-title" class="text-2xl font-bold"></h3>
                <button id="close-modal-btn" class="text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div id="modal-content" class="mt-4 max-h-[80vh] overflow-y-auto p-1"></div>
        </div>
    </div>

</div>

<script>
const pendingShowViewCalls = [];
if (typeof window !== 'undefined') {
    window.showView = function(viewName) {
        pendingShowViewCalls.push(viewName);
    };
}

document.addEventListener('DOMContentLoaded', function() {
    // --- UI COMPONENT BUILDERS --- 
    /**
     * Creates a radial gauge component and injects it into a container.
     * @param {string} containerId - The ID of the element to contain the gauge.
     * @param {string} label - The text label for the gauge.
     * @param {string} units - The units for the gauge value.
     * @param {number} maxValue - The maximum value for the gauge's scale.
     */
    function createRadialGauge(containerId, label, units, maxValue) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const size = 120;
        const strokeWidth = 10;
        const radius = (size / 2) - (strokeWidth * 2);
        const circumference = radius * 2 * Math.PI;

        container.innerHTML = `
            <div class="relative" style="width:${size}px; height:${size}px;">
                <svg class="w-full h-full" viewBox="0 0 ${size} ${size}">
                    <circle class="gauge-bg" cx="${size/2}" cy="${size/2}" r="${radius}" stroke-width="${strokeWidth}"></circle>
                    <circle class="gauge-fg stroke-normal" cx="${size/2}" cy="${size/2}" r="${radius}" stroke-width="${strokeWidth}"
                            stroke-dasharray="${circumference}" stroke-dashoffset="${circumference}"
                            style="transition: stroke-dashoffset 0.5s;"></circle>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="gauge-value text-2xl font-bold gauge-text text-normal">0</span>
                    <span class="gauge-units text-xs text-slate-400">${units}</span>
                </div>
            </div>
            <h4 class="mt-2 text-sm font-semibold text-slate-300">${label}</h4>
        `;
    }

    /**
     * Updates an existing radial gauge component with a new value.
     * @param {string} containerId - The ID of the gauge's container element.
     * @param {number} value - The new value to display.
     * @param {number} maxValue - The maximum value of the gauge's scale.
     */
    function updateRadialGauge(containerId, value, maxValue) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const gaugeFg = container.querySelector('.gauge-fg');
        const gaugeValue = container.querySelector('.gauge-value');
        if (!gaugeFg || !gaugeValue) return;

        const radius = gaugeFg.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        const offset = circumference - (value / maxValue) * circumference;
        gaugeFg.style.strokeDashoffset = Math.max(0, Math.min(circumference, offset));

        gaugeValue.textContent = value.toFixed(0);

        const percentage = (value / maxValue) * 100;
        let colorClass = 'normal';
        if (percentage > 90) colorClass = 'danger';
        else if (percentage > 75) colorClass = 'warning';

        gaugeFg.classList.remove('stroke-normal', 'stroke-warning', 'stroke-danger');
        gaugeValue.classList.remove('text-normal', 'text-warning', 'text-danger');
        gaugeFg.classList.add(`stroke-${colorClass}`);
        gaugeValue.classList.add(`text-${colorClass}`);
    }

    /**
     * Creates a horizontal bar gauge component.
     * @param {string} containerId - The ID of the element to contain the gauge.
     * @param {string} label - The text label for the gauge.
     * @param {string} units - The units for the gauge value.
     * @param {number} maxValue - The maximum value for the gauge's scale.
     */
    function createBarGauge(containerId, label, units, maxValue) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = `
            <h4 class="text-sm font-semibold text-slate-300">${label}</h4>
            <div class="w-full bar-bg rounded-full h-2.5 my-2">
                <div class="bar-fg bg-normal h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="text-center">
                <span class="bar-value text-2xl font-bold gauge-text text-normal">0</span>
                <span class="bar-units text-xs text-slate-400">${units}</span>
            </div>
        `;
    }

    /**
     * Updates an existing bar gauge component with a new value.
     * @param {string} containerId - The ID of the gauge's container element.
     * @param {number} value - The new value to display.
     * @param {number} maxValue - The maximum value of the gauge's scale.
     */
    function updateBarGauge(containerId, value, maxValue) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const barFg = container.querySelector('.bar-fg');
        const barValue = container.querySelector('.bar-value');
        if (!barFg || !barValue) return;

        const absValue = Math.abs(value);
        const percentage = Math.min(100, (absValue / maxValue) * 100);
        barFg.style.width = `${percentage}%`;
        barValue.textContent = value.toFixed(0);

        let colorClass = 'normal';
        if (percentage > 90) colorClass = 'danger';
        else if (percentage > 75) colorClass = 'warning';

        barFg.classList.remove('bg-normal', 'bg-warning', 'bg-danger');
        barValue.classList.remove('text-normal', 'text-warning', 'text-danger');
        barFg.classList.add(`bg-${colorClass}`);
        barValue.classList.add(`text-${colorClass}`);
    }

    // --- DATA STORE (REWRITTEN FOR NARRATIVE) ---
    const wellData = [
        {
            id: 'Well_11',
            name: 'Brahan Producer 11',
            field: 'Brahan',
            region: 'UKCS',
            type: 'HPHT Gas Condensate Producer',
            depth: '11,155ft',
            locationType: 'Platform',
            platform: 'Brahan Alpha',
            datumElevation: '82ft',
            waterDepth: '0ft',
            status: 'Active - Producing',
            issue: 'Standard platform producer, operating normally with routine monitoring.',
            wellboreImage: '/assets/wellbore-Well_11-3d.png',

            // PILLAR 1: Identity & Context
            administrative: {
                wellID: '11',
                regulatoryID: '12-345-67890-BRA-11',
                operator: 'Brahan Field Operating Company',
                lease: 'Brahan Alpha Lease',
                surfaceLocation: { lat: '58Â° 38\' 15.0" N', lon: '0Â° 20\' 05.0" E' },
                spudDate: '2018-07-15',
                completionDate: '2018-10-22',
                originalAFE: 45000000,
                actualCost: 43800000,
                classification: 'Active Producer',
                reportDate: '2023-10-26'
            },
            geological: {
                targetFormation: 'Brahan Alpha Sandstone (Upper Jurassic)',
                prognosisVsActual: 'Actual formation top encountered within 5m of prognosis',
                reservoirProperties: {
                    porosity: '18-22%',
                    permeability: '150-250 mD',
                    initialPressure: '7,500 psi @ 3,435 m TVD',
                    temperature: '160 Â°C'
                },
                fluidCharacteristics: {
                    fluidType: 'Rich Gas Condensate',
                    CGR: '120 bbl/MMscf',
                    gasGravity: 0.65,
                    h2s: '15 ppm',
                    co2: '3.5 mol%'
                },
                volumetrics: {
                    OGIP: '180 Bcf',
                    EUR: '65 Bcf'
                }
            },

            // PILLAR 2: Physical Blueprint
            trajectory: [
                {md: 0, inc: 0, azimuth: 0, tvd: 0},
                {md: 3281, inc: 1.5, azimuth: 45.2, tvd: 3280},
                {md: 6562, inc: 1.8, azimuth: 45.2, tvd: 6561},
                {md: 9843, inc: 2.0, azimuth: 45.2, tvd: 9841},
                {md: 11483, inc: 2.1, azimuth: 45.2, tvd: 11481}
            ],
            wellboreConstruction: [
                {component: 'Conductor', topMD: 0, bottomMD: 492, size: 30, weight: null, grade: null, connection: null, details: 'Driven Pile'},
                {component: 'Surface', topMD: 0, bottomMD: 3281, size: 20, weight: 94.0, grade: 'K-55', connection: 'BTC', details: 'TOC @ Surface (verified by returns)'},
                {component: 'Intermediate', topMD: 0, bottomMD: 8202, size: 13.375, weight: 54.5, grade: 'L-80', connection: 'BTC', details: 'TOC @ 1,500m (CBL/VDL verified)'},
                {component: 'Production', topMD: 0, bottomMD: 11483, size: 9.625, weight: 47.0, grade: 'C-90', connection: 'VAM TOP', details: 'TOC @ 2,000m (CBL/VDL verified)'}
            ],

            // PILLAR 3: Completion & Production Setup
            completion: {
                casing: [{type: 'Production', size: '9 5/8"', top: 0, bottom: 11483}],
                tubing: [{type: 'Production', size: '5.5"', top: 0, bottom: 11155, weight: '17.0 lb/ft', grade: 'L-80 13Cr', connection: 'VAM TOP'}],
                equipment: [
                    {item: 'SSSV', top: 1148, details: 'TRSSV, 1/4" control line, 1.875" bore, equalizing'},
                    {item: 'Gas Lift Mandrels', top: 3937, details: 'Side Pocket Mandrels at 1,200m, 1,500m, 1,800m - 1.0" OD valve pockets'},
                    {item: 'Packer', top: 10991, details: 'Model "A" Hydraulic Set Production Packer, 10k psi rating'},
                    {item: 'Landing Nipple', top: 11090, details: 'No-Go Nipple, 2.313" ID, located below packer'}
                ],
                perforations: [{top: 11220, bottom: 11319, details: '6 SPF, 60Â° phasing, Big Hole charges, TCP'}]
            },

            // PILLAR 4: Lifecycle Performance & Evolution
            productionHistory: {
                initialRate: {date: 'Q4 2018', oil: 1200, gas: 60, water: 0, unit: 'bbl/d oil, MMscf/d gas'},
                currentRate: {date: 'Q3 2023', oil: 980, gas: 48, water: 0, unit: 'bbl/d oil, MMscf/d gas'},
                cumulativeProduction: {gas: '28.5 Bcf', condensate: '3.4 MMbbl'},
                performanceTrend: 'Stable decline, consistent with reservoir simulation. No unexpected water or sand production.'
            },
            history: [
                {
                    date: '2018-10-22',
                    operation: 'Initial Production',
                    problem: 'Well brought online successfully at 8,000 boepd (60 MMscf/d gas, 1,200 bbl/d condensate).',
                    lesson: 'Baseline producer for Brahan field.',
                    serviceProvider: 'Brahan Operating Co.',
                    duration: 'N/A',
                    npt: 0
                },
                {
                    date: '2021-04-15',
                    operation: 'Wireline (PLT)',
                    problem: 'Production profiling and pressure survey',
                    lesson: 'Confirmed uniform inflow profile. No crossflow detected. Baseline profile established. Gas lift valves confirmed operating optimally.',
                    serviceProvider: 'WellServices Inc.',
                    duration: '24 hours',
                    npt: 4,
                    outcome: 'Successful'
                },
                {
                    date: '2023-03-02',
                    operation: 'Slickline',
                    problem: 'Replace Gas Lift Valves (GLVs) in SPMs',
                    lesson: 'Standard GLV replacement procedure validated. No issues with SPM integrity. Three GLVs replaced at depths 1,200m, 1,500m, 1,800m. Immediate lift improvement noted.',
                    serviceProvider: 'QuickWire Services',
                    duration: '12 hours',
                    npt: 2,
                    outcome: 'Successful'
                }
            ],
            dailyReports: [],

            // PILLAR 5: Current State & Future Outlook
            wellIntegrity: {
                wbsVerified: true,
                primaryBarriers: ['5.5" Production Tubing (intact)', 'Hydraulic Packer (set & tested)', 'TRSSV (function tested OK)', '9 5/8" Production Casing & Cement (CBL verified)'],
                secondaryBarriers: ['13 3/8" Intermediate Casing & Cement', '20" Surface Casing & Cement', 'Wellhead & X-mas Tree valves'],
                barrierVerification: {
                    annulusAPressure: '50 psi (stable, within operational limits)',
                    sssvTest: 'Passed (Quarterly test, Sept 2023)',
                    wellheadValves: 'Function tested monthly, all OK',
                    tubingCasingIntegrity: 'No leaks or abnormal pressures detected'
                }
            },
            futurePlans: {
                immediate: ['Routine quarterly surveillance (SSSV test, annulus pressure check)', 'Annual production logging run scheduled for Q1 2024'],
                mediumTerm: ['Consider downhole chemical squeeze for scale prevention if water cut increases', 'Evaluate potential for artificial lift optimization (e.g., gas lift redesign) as reservoir pressure declines'],
                longTerm: ['Not currently applicable. Well is a core, reliable producer with significant remaining reserve base.']
            }
        },
        {
            id: 'Well_22',
            name: 'Brahan Producer 22',
            field: 'Brahan',
            region: 'UKCS',
            type: 'HPHT Gas Condensate Producer',
            depth: '11,811ft',
            locationType: 'Platform',
            platform: 'Brahan Alpha',
            datumElevation: '82ft',
            waterDepth: '0ft',
            status: 'Active - Post-Intervention',
            issue: 'CASE STUDY: "The Brahan Squeeze" - Casing deformation successfully remediated with expandable steel patch.',
            wellboreImage: '/assets/wellbore-Well_22-3d.png',

            // PILLAR 1: Identity & Context
            administrative: {
                wellID: '22',
                regulatoryID: '12-345-67891-BRA-22',
                operator: 'Brahan Field Operating Company',
                lease: 'Brahan Alpha Lease',
                surfaceLocation: { lat: '58Â° 38\' 18.5" N', lon: '0Â° 20\' 12.0" E' },
                spudDate: '2019-01-10',
                completionDate: '2019-04-05',
                originalAFE: 47000000,
                actualCost: 52100000,
                classification: 'Active Producer (Post-Intervention)',
                reportDate: '2023-10-26'
            },
            geological: {
                targetFormation: 'Brahan Alpha Sandstone (Lower Zone - Compartment B)',
                prognosisVsActual: 'Actual formation top encountered 12m shallower than prognosis',
                reservoirProperties: {
                    porosity: '19-23%',
                    permeability: '170-280 mD',
                    initialPressure: '7,650 psi @ 3,535 m TVD',
                    temperature: '162 Â°C'
                },
                fluidCharacteristics: {
                    fluidType: 'Rich Gas Condensate',
                    CGR: '125 bbl/MMscf',
                    gasGravity: 0.64,
                    h2s: '12 ppm',
                    co2: '3.2 mol%'
                },
                volumetrics: {
                    OGIP: '165 Bcf',
                    EUR: '62 Bcf'
                }
            },

            // PILLAR 2: Physical Blueprint
            trajectory: [
                {md: 0, inc: 0, azimuth: 0, tvd: 0},
                {md: 3281, inc: 1.2, azimuth: 88.1, tvd: 3281},
                {md: 6562, inc: 1.5, azimuth: 88.1, tvd: 6561},
                {md: 9843, inc: 1.9, azimuth: 88.1, tvd: 9841},
                {md: 11811, inc: 2.0, azimuth: 88.1, tvd: 11808}
            ],
            wellboreConstruction: [
                {component: 'Conductor', topMD: 0, bottomMD: 492, size: 30, weight: null, grade: null, connection: null, details: 'Driven Pile'},
                {component: 'Surface', topMD: 0, bottomMD: 3445, size: 20, weight: 94.0, grade: 'K-55', connection: 'BTC', details: 'TOC @ Surface (verified by returns)'},
                {component: 'Intermediate', topMD: 0, bottomMD: 8530, size: 13.375, weight: 54.5, grade: 'L-80', connection: 'BTC', details: 'TOC @ 1,450m (CBL/VDL verified)'},
                {component: 'Production', topMD: 0, bottomMD: 11811, size: 9.625, weight: 47.0, grade: 'C-90', connection: 'VAM TOP', details: 'TOC @ 2,100m (CBL verified). **7 5/8" Expandable Steel Patch installed across 2,180-2,220m MD on Oct 15, 2020**'}
            ],

            // PILLAR 3: Completion & Production Setup
            completion: {
                casing: [{type: 'Production', size: '9 5/8"', top: 0, bottom: 11811}],
                tubing: [{type: 'Production', size: '5.5"', top: 0, bottom: 11483, weight: '17.0 lb/ft', grade: 'L-80 13Cr', connection: 'VAM TOP'}],
                equipment: [
                    {item: 'SSSV', top: 1165, details: 'TRSSV, 1/4" control line, 1.875" bore, equalizing'},
                    {item: 'Gas Lift Mandrels', top: 4101, details: 'Side Pocket Mandrels at 1,250m, 1,550m, 1,850m - 1.0" OD valve pockets'},
                    {item: 'Packer', top: 11319, details: 'Model "A" Hydraulic Set Production Packer, 10k psi rating'},
                    {item: 'Landing Nipple', top: 11253, details: 'No-Go Nipple, 2.313" ID, located below packer'},
                    {item: 'Expandable Patch', top: 7152, details: '7 5/8" Expandable Steel Patch across deformed interval (2,180-2,220m MD). Pressure tested to 5,000 psi', isProblem: false, isRepair: true}
                ],
                perforations: [{top: 11549, bottom: 11680, details: '6 SPF, 60Â° phasing, Big Hole charges, TCP'}]
            },

            // PILLAR 4: Lifecycle Performance & Evolution
            productionHistory: {
                initialRate: {date: 'Q2 2019', oil: 1300, gas: 65, water: 0, unit: 'bbl/d oil, MMscf/d gas'},
                preInterventionRate: {date: 'Q2 2020', oil: 512, gas: 32, water: 0, unit: 'bbl/d oil, MMscf/d gas (declined due to restriction)'},
                currentRate: {date: 'Q3 2023', oil: 1250, gas: 60, water: 0, unit: 'bbl/d oil, MMscf/d gas'},
                cumulativeProduction: {gas: '25.1 Bcf', condensate: '3.1 MMbbl'},
                performanceTrend: 'Stable and strong post-intervention, with minor decline consistent with field norms.'
            },
            history: [
                {
                    date: '2019-04-05',
                    operation: 'Initial Production',
                    problem: 'Well brought online successfully at 8,500 boepd (65 MMscf/d gas, 1,300 bbl/d condensate).',
                    lesson: 'High-performing initial producer for Brahan field.',
                    serviceProvider: 'Brahan Operating Co.',
                    duration: 'N/A',
                    npt: 0
                },
                {
                    date: '2020-05-20',
                    operation: 'Wireline (Diagnostic)',
                    problem: 'Investigate production decline',
                    lesson: 'Early diagnostics are crucial. Multi-Finger Caliper identified severe casing deformation (ovality >15%) at ~2,200m MD. Confirmed as cause of restriction.',
                    serviceProvider: 'DiagTech Solutions',
                    duration: '18 hours',
                    npt: 6,
                    outcome: 'Successful - Deformation identified'
                },
                {
                    date: '2020-10-12',
                    operation: 'Coiled Tubing (Major Workover)',
                    problem: 'Remediate casing deformation and restore wellbore access',
                    lesson: 'Expandable patch technology is highly effective for compaction-induced deformation. 7 5/8" expandable steel patch deployed across deformed interval (2,180-2,220m MD). Wellbore ID restored to >95% of nominal. This intervention became the "Brahan Squeeze" case study.',
                    serviceProvider: 'CT Intervention Specialists',
                    duration: '96 hours',
                    npt: 24,
                    outcome: 'Successful - Full access restored'
                },
                {
                    date: '2020-10-20',
                    operation: 'Wireline (Post-Job)',
                    problem: 'Verify patch integrity and clean out wellbore',
                    lesson: 'Patch provides a reliable, long-term barrier and structural support. Drift gauge confirmed patch integrity.',
                    serviceProvider: 'DiagTech Solutions',
                    duration: '12 hours',
                    npt: 2,
                    outcome: 'Successful - Patch verified'
                },
                {
                    date: '2023-08-30',
                    operation: 'Slickline',
                    problem: 'Replace Gas Lift Valves (GLVs) in SPMs',
                    lesson: 'Standard maintenance. No issues encountered within the patched section. Three GLVs replaced. Gas lift performance optimized.',
                    serviceProvider: 'QuickWire Services',
                    duration: '14 hours',
                    npt: 3,
                    outcome: 'Successful'
                }
            ],
            dailyReports: [],

            // PILLAR 5: Current State & Future Outlook
            wellIntegrity: {
                wbsVerified: true,
                primaryBarriers: ['5.5" Production Tubing (intact)', 'Hydraulic Packer (set & tested)', 'TRSSV (function tested OK)', '7 5/8" Expandable Patch (pressure tested to 5,000 psi)', '9 5/8" Production Casing & Cement (CBL verified above and below patch)'],
                secondaryBarriers: ['13 3/8" Intermediate Casing & Cement', '20" Surface Casing & Cement', 'Wellhead & X-mas Tree valves'],
                barrierVerification: {
                    annulusAPressure: '45 psi (stable, within operational limits)',
                    sssvTest: 'Passed (Quarterly test, Sept 2023)',
                    expandablePatchIntegrity: 'Monitored via differential pressure across patch. No leaks detected.',
                    wellheadValves: 'Function tested monthly, all OK'
                }
            },
            futurePlans: {
                immediate: ['Routine quarterly surveillance (SSSV test, annulus pressure check)', 'Continue monitoring of expandable patch via pressure gauges'],
                mediumTerm: ['Schedule multi-arm caliper run in 2025 to confirm long-term integrity and dimensional stability of expandable patch', 'Review gas lift performance to optimize for declining reservoir pressure'],
                longTerm: ['Expandable patch is considered a permanent part of well architecture. P&A procedures will account for its presence and integrity.']
            }
        },
        {
            id: 'Well_33',
            name: 'CASE STUDY: The Scale Victory',
            field: 'Brahan',
            region: 'UKCS',
            type: 'HPHT Gas Condensate Producer',
            depth: '11,647ft',
            locationType: 'Platform',
            platform: 'Brahan Alpha',
            datumElevation: '82ft',
            waterDepth: '0ft',
            status: 'Active - Post-Intervention',
            issue: 'CASE STUDY: "The Scale Trap" - Severe BaSO4 scale successfully removed with chemical/jetting treatment.',
            wellboreImage: '/assets/wellbore-Well_33-3d.png',

            // PILLAR 1: Identity & Context
            administrative: {
                wellID: '33',
                regulatoryID: '12-345-67892-BRA-33',
                operator: 'Brahan Field Operating Company',
                lease: 'Brahan Alpha Lease',
                surfaceLocation: { lat: '58Â° 38\' 22.1" N', lon: '0Â° 20\' 18.5" E' },
                spudDate: '2019-09-05',
                completionDate: '2019-12-12',
                originalAFE: 48500000,
                actualCost: 51200000,
                classification: 'Active Producer (Post-Intervention)',
                reportDate: '2023-10-26'
            },
            geological: {
                targetFormation: 'Brahan Alpha Sandstone (HPHT Zone)',
                prognosisVsActual: 'Actual formation top encountered 8m deeper than prognosis',
                reservoirProperties: {
                    porosity: '16-20%',
                    permeability: '120-200 mD',
                    initialPressure: '8,200 psi @ 3,535 m TVD',
                    temperature: '168 Â°C'
                },
                fluidCharacteristics: {
                    fluidType: 'Gas Condensate with high scaling tendency',
                    CGR: '115 bbl/MMscf',
                    gasGravity: 0.67,
                    h2s: '18 ppm',
                    co2: '4.1 mol%',
                    scaleTendency: 'High Barium Sulphate (BaSOâ‚„) precipitation risk identified during PVT analysis'
                },
                volumetrics: {
                    OGIP: '155 Bcf',
                    EUR: '58 Bcf'
                }
            },

            // PILLAR 2: Physical Blueprint
            trajectory: [
                {md: 0, inc: 0, azimuth: 0, tvd: 0},
                {md: 3281, inc: 5.0, azimuth: 120.0, tvd: 3277},
                {md: 6562, inc: 8.0, azimuth: 120.0, tvd: 6547},
                {md: 9843, inc: 10.0, azimuth: 120.0, tvd: 9792},
                {md: 11647, inc: 10.5, azimuth: 120.0, tvd: 11580}
            ],
            wellboreConstruction: [
                {component: 'Conductor', topMD: 0, bottomMD: 492, size: 30, weight: null, grade: null, connection: null, details: 'Driven Pile'},
                {component: 'Surface', topMD: 0, bottomMD: 3281, size: 20, weight: 94.0, grade: 'K-55', connection: 'BTC', details: 'TOC @ Surface (verified by returns)'},
                {component: 'Intermediate', topMD: 0, bottomMD: 8366, size: 13.375, weight: 54.5, grade: 'L-80', connection: 'BTC', details: 'TOC @ 1,500m (CBL/VDL verified)'},
                {component: 'Production', topMD: 0, bottomMD: 11647, size: 9.625, weight: 47.0, grade: 'C-90', connection: 'VAM TOP', details: 'TOC @ 2,050m (CBL/VDL verified)'}
            ],

            // PILLAR 3: Completion & Production Setup
            completion: {
                casing: [{type: 'Production', size: '9 5/8"', top: 0, bottom: 11647}],
                tubing: [{type: 'Production', size: '5.5"', top: 0, bottom: 11319, weight: '17.0 lb/ft', grade: 'L-80 13Cr', connection: 'VAM TOP', comments: '**Chemically/Jet Cleaned for BaSOâ‚„ Scale on Dec 10, 2021**'}],
                equipment: [
                    {item: 'SSSV', top: 1115, details: 'TRSSV, 1/4" control line, 1.875" bore, equalizing'},
                    {item: 'Chemical Injection Mandrel', top: 3609, details: 'Side Pocket Mandrel for scale inhibitor injection'},
                    {item: 'Gas Lift Mandrels', top: 4265, details: 'Side Pocket Mandrels at 1,300m, 1,600m, 1,900m - 1.0" OD valve pockets'},
                    {item: 'Packer', top: 11155, details: 'Model "A" Hydraulic Set Production Packer, 10k psi rating'},
                    {item: 'Landing Nipple', top: 11253, details: 'No-Go Nipple, 2.313" ID, located below packer'}
                ],
                perforations: [{top: 11384, bottom: 11483, details: '6 SPF, 60Â° phasing, Big Hole charges, TCP'}]
            },

            // PILLAR 4: Lifecycle Performance & Evolution
            productionHistory: {
                initialRate: {date: 'Q1 2020', oil: 1350, gas: 70, water: 0, unit: 'bbl/d oil, MMscf/d gas'},
                preInterventionRate: {date: 'Q3 2021', oil: 240, gas: 12, water: 0, unit: 'bbl/d oil, MMscf/d gas (declined due to severe scale blockage)'},
                currentRate: {date: 'Q3 2023', oil: 1240, gas: 63, water: 0, unit: 'bbl/d oil, MMscf/d gas'},
                cumulativeProduction: {gas: '22.8 Bcf', condensate: '2.7 MMbbl'},
                performanceTrend: 'Strong and stable post-intervention, benefiting from optimized scale inhibitor program.'
            },
            history: [
                {
                    date: '2019-12-12',
                    operation: 'Initial Production',
                    problem: 'Well brought online successfully at 9,000 boepd (70 MMscf/d gas, 1,350 bbl/d condensate).',
                    lesson: 'High-performing producer but identified high scaling risk during initial PVT analysis.',
                    serviceProvider: 'Brahan Operating Co.',
                    duration: 'N/A',
                    npt: 0
                },
                {
                    date: '2021-08-15',
                    operation: 'Wireline (Diagnostic)',
                    problem: 'Investigate rapid production decline',
                    lesson: 'Confirmed scale issue, not reservoir depletion. Memory gauge data indicated significant downhole restriction consistent with scale build-up.',
                    serviceProvider: 'DiagTech Solutions',
                    duration: '12 hours',
                    npt: 4,
                    outcome: 'Successful - Scale identified'
                },
                {
                    date: '2021-12-05',
                    operation: 'Coiled Tubing (Major Workover)',
                    problem: 'Remove hard BaSOâ‚„ scale blockage from tubing',
                    lesson: 'Combined chemical and mechanical approach is highly effective for hard BaSOâ‚„ scale. Hard BaSOâ‚„ scale bridge completely removed from 3,200m to 3,450m MD. Full wellbore access restored. This became the "Scale Trap" case study.',
                    serviceProvider: 'CT Intervention Specialists',
                    duration: '84 hours',
                    npt: 30,
                    outcome: 'Successful - Scale removed'
                },
                {
                    date: '2021-12-10',
                    operation: 'Coiled Tubing (Post-Job)',
                    problem: 'Clean out residual debris and perform final wellbore clean-up',
                    lesson: 'Thorough post-job clean-out is vital to prevent future issues. Wellbore prepared for re-start.',
                    serviceProvider: 'CT Intervention Specialists',
                    duration: '24 hours',
                    npt: 4,
                    outcome: 'Successful - Clean-out complete'
                },
                {
                    date: '2022-01-15',
                    operation: 'Slickline',
                    problem: 'Re-set Chemical Injection Valve',
                    lesson: 'Ensured continuous chemical protection post-intervention. Scale inhibitor injection re-established.',
                    serviceProvider: 'QuickWire Services',
                    duration: '8 hours',
                    npt: 1,
                    outcome: 'Successful'
                },
                {
                    date: '2023-07-20',
                    operation: 'Wireline (Surveillance)',
                    problem: 'Production logging and fluid sampling',
                    lesson: 'Validated the success of the remediation and new chemical program. Confirmed clean tubing ID and effective scale inhibition across the interval.',
                    serviceProvider: 'DiagTech Solutions',
                    duration: '20 hours',
                    npt: 3,
                    outcome: 'Successful - Validation complete'
                }
            ],
            dailyReports: [],

            // PILLAR 5: Current State & Future Outlook
            wellIntegrity: {
                wbsVerified: true,
                primaryBarriers: ['5.5" Production Tubing (intact, post-clean)', 'Hydraulic Packer (set & tested)', 'TRSSV (function tested OK)', '9 5/8" Production Casing & Cement (CBL verified)'],
                secondaryBarriers: ['13 3/8" Intermediate Casing & Cement', '20" Surface Casing & Cement', 'Wellhead & X-mas Tree valves'],
                barrierVerification: {
                    annulusAPressure: '55 psi (stable, within operational limits)',
                    sssvTest: 'Passed (Quarterly test, Sept 2023)',
                    wellheadValves: 'Function tested monthly, all OK',
                    tubingIntegrity: 'Monitored via regular PLTs. No signs of re-occurring scale build-up'
                }
            },
            futurePlans: {
                immediate: ['Routine quarterly surveillance (SSSV test, annulus pressure check)', 'Continue monthly monitoring of scale inhibitor injection rates and effectiveness'],
                mediumTerm: ['Perform routine caliper log in 2025 to proactively monitor for any early signs of scale re-formation', 'Evaluate long-term performance of current scale inhibitor chemistry and consider alternative formulations if needed'],
                longTerm: ['Well history of severe scaling will be key factor in designing P&A program, ensuring all scaled sections are properly isolated and cleaned']
            }
        },
        {
            id: 'Well_44',
            name: 'CASE STUDY: The Barrier Restoration',
            field: 'Brahan',
            region: 'UKCS',
            type: 'HPHT Gas Condensate Producer',
            depth: '13,123ft',
            locationType: 'Platform',
            platform: 'Brahan Alpha',
            datumElevation: '82ft',
            waterDepth: '0ft',
            status: 'Active - Post-Intervention',
            issue: 'CASE STUDY: "The Broken Barrier" - Failed TRSSV successfully replaced with slickline-retrievable insert valve.',
            wellboreImage: '/assets/wellbore-Well_44-3d.png',

            // PILLAR 1: Identity & Context
            administrative: {
                wellID: '44',
                regulatoryID: '12-345-67893-BRA-44',
                operator: 'Brahan Field Operating Company',
                lease: 'Brahan Alpha Lease',
                surfaceLocation: { lat: '58Â° 38\' 25.7" N', lon: '0Â° 20\' 25.1" E' },
                spudDate: '2020-03-18',
                completionDate: '2020-06-22',
                originalAFE: 49000000,
                actualCost: 49500000,
                classification: 'Active Producer (Post-Intervention)',
                reportDate: '2023-10-26'
            },
            geological: {
                targetFormation: 'Brahan Alpha Sandstone (Deep Reservoir Section)',
                prognosisVsActual: 'Actual formation top encountered 5m deeper than prognosis',
                reservoirProperties: {
                    porosity: '17-21%',
                    permeability: '140-220 mD',
                    initialPressure: '8,500 psi @ 3,935 m TVD',
                    temperature: '172 Â°C'
                },
                fluidCharacteristics: {
                    fluidType: 'Rich Gas Condensate',
                    CGR: '130 bbl/MMscf',
                    gasGravity: 0.68,
                    h2s: '20 ppm',
                    co2: '4.5 mol%'
                },
                volumetrics: {
                    OGIP: '145 Bcf',
                    EUR: '55 Bcf'
                }
            },

            // PILLAR 2: Physical Blueprint
            trajectory: [
                {md: 0, inc: 0, azimuth: 0, tvd: 0},
                {md: 3281, inc: 15.0, azimuth: 45.0, tvd: 3244},
                {md: 6562, inc: 30.0, azimuth: 45.0, tvd: 6279},
                {md: 9843, inc: 20.0, azimuth: 45.0, tvd: 9363},
                {md: 13123, inc: 10.0, azimuth: 45.0, tvd: 12550}
            ],
            wellboreConstruction: [
                {component: 'Conductor', topMD: 0, bottomMD: 492, size: 30, weight: null, grade: null, connection: null, details: 'Driven Pile'},
                {component: 'Surface', topMD: 0, bottomMD: 3609, size: 20, weight: 94.0, grade: 'K-55', connection: 'BTC', details: 'TOC @ Surface (verified by returns)'},
                {component: 'Intermediate', topMD: 0, bottomMD: 9186, size: 13.375, weight: 54.5, grade: 'L-80', connection: 'BTC', details: 'TOC @ 1,700m (CBL/VDL verified)'},
                {component: 'Production', topMD: 0, bottomMD: 13123, size: 9.625, weight: 47.0, grade: 'C-90', connection: 'VAM TOP', details: 'TOC @ 2,400m (CBL/VDL verified)'}
            ],

            // PILLAR 3: Completion & Production Setup
            completion: {
                casing: [{type: 'Production', size: '9 5/8"', top: 0, bottom: 13123}],
                tubing: [{type: 'Production', size: '5.5"', top: 0, bottom: 12795, weight: '17.0 lb/ft', grade: 'L-80 13Cr', connection: 'VAM TOP'}],
                equipment: [
                    {item: 'SSSV', top: 1312, details: '**Slickline-Retrievable Insert Valve (Installed May 25, 2022, to replace failed TRSSV). 1.750" bore.**', isRepair: true},
                    {item: 'Original TRSSV Nipple', top: 1312, details: 'Original TRSSV nipple profile. TRSSV was locked open and is now non-functional.'},
                    {item: 'Gas Lift Mandrels', top: 4593, details: 'Side Pocket Mandrels at 1,400m, 1,700m, 2,000m - 1.0" OD valve pockets'},
                    {item: 'Packer', top: 12631, details: 'Model "A" Hydraulic Set Production Packer, 10k psi rating'},
                    {item: 'Landing Nipple', top: 12730, details: 'No-Go Nipple, 2.313" ID, located below packer'}
                ],
                perforations: [{top: 12861, bottom: 12992, details: '6 SPF, 60Â° phasing, Big Hole charges, TCP'}]
            },

            // PILLAR 4: Lifecycle Performance & Evolution
            productionHistory: {
                initialRate: {date: 'Q3 2020', oil: 1400, gas: 75, water: 0, unit: 'bbl/d oil, MMscf/d gas'},
                duringSSVFailure: {date: 'Q1 2022', oil: 0, gas: 0, water: 0, unit: 'Well shut-in for safety reasons'},
                currentRate: {date: 'Q3 2023', oil: 1350, gas: 72, water: 0, unit: 'bbl/d oil, MMscf/d gas'},
                cumulativeProduction: {gas: '26.5 Bcf', condensate: '3.2 MMbbl'},
                performanceTrend: 'Excellent and stable post-intervention, with minimal decline.'
            },
            history: [
                {
                    date: '2020-06-22',
                    operation: 'Initial Production',
                    problem: 'Well brought online successfully at 9,500 boepd (75 MMscf/d gas, 1,400 bbl/d condensate).',
                    lesson: 'Strong initial producer for Brahan field.',
                    serviceProvider: 'Brahan Operating Co.',
                    duration: 'N/A',
                    npt: 0
                },
                {
                    date: '2022-02-10',
                    operation: 'Wireline (Diagnostic)',
                    problem: 'Perform routine TRSSV function test',
                    lesson: 'Confirmed a critical safety barrier failure. TRSSV found to be stuck in the closed position and would not open. Well immediately shut-in.',
                    serviceProvider: 'SafetyFirst Wireline',
                    duration: '6 hours',
                    npt: 2,
                    outcome: 'FAILED - TRSSV malfunction'
                },
                {
                    date: '2022-05-20',
                    operation: 'Slickline (Critical Intervention)',
                    problem: 'Restore downhole safety barrier',
                    lesson: 'Slickline-retrievable insert valves provide a highly efficient and cost-effective solution for TRSSV failure, avoiding a major workover. Failed TRSSV was mechanically locked open. New slickline-retrievable insert SSV was installed and successfully function tested. This became the "Broken Barrier" case study.',
                    serviceProvider: 'QuickWire Services',
                    duration: '18 hours',
                    npt: 4,
                    outcome: 'Successful - Safety barrier restored'
                },
                {
                    date: '2022-05-21',
                    operation: 'Wireline (Post-Job)',
                    problem: 'Final function test of new Insert SSV',
                    lesson: 'Confirmed integrity of the new safety barrier. Well cleared for re-start. Insert SSV cycled multiple times and held differential pressure.',
                    serviceProvider: 'SafetyFirst Wireline',
                    duration: '4 hours',
                    npt: 1,
                    outcome: 'Successful - Barrier verified'
                },
                {
                    date: '2023-09-15',
                    operation: 'Slickline (Surveillance)',
                    problem: 'Routine function test of Insert SSV',
                    lesson: 'Insert SSV continues to perform reliably. Valve functioned as designed.',
                    serviceProvider: 'QuickWire Services',
                    duration: '6 hours',
                    npt: 1,
                    outcome: 'Successful'
                }
            ],
            dailyReports: [],

            // PILLAR 5: Current State & Future Outlook
            wellIntegrity: {
                wbsVerified: true,
                primaryBarriers: ['5.5" Production Tubing (intact)', 'Hydraulic Packer (set & tested)', '**Slickline-Retrievable Insert SSV (function tested OK)**', '9 5/8" Production Casing & Cement (CBL verified)'],
                secondaryBarriers: ['13 3/8" Intermediate Casing & Cement', '20" Surface Casing & Cement', 'Wellhead & X-mas Tree valves'],
                barrierVerification: {
                    annulusAPressure: '60 psi (stable, within operational limits)',
                    insertSSVTest: 'Passed (Quarterly test, Sep 2023)',
                    wellheadValves: 'Function tested monthly, all OK',
                    tubingIntegrity: 'No leaks or abnormal pressures detected'
                }
            },
            futurePlans: {
                immediate: ['Continue quarterly function testing of insert SSV, as it is now the primary downhole safety barrier', 'Routine monthly wellhead and annulus monitoring'],
                mediumTerm: ['Monitor long-term reliability of insert SSV in this HPHT environment', 'Consider production logging run in 2025 to assess inflow performance and optimize gas lift'],
                longTerm: ['Presence of locked-open TRSSV and insert SSV must be clearly documented in P&A program. Insert SSV will likely be pulled, and profile will need to be addressed (e.g., with a plug) during abandonment']
            }
        },
        {
            id: 'Well_55',
            name: 'Brahan Injector 55',
            field: 'Brahan',
            region: 'UKCS',
            type: 'Water Injector',
            depth: '14,764ft',
            locationType: 'Satellite',
            platform: 'Brahan Bravo (Unmanned Satellite)',
            datumElevation: '82ft',
            waterDepth: '492ft',
            status: 'Active - Injecting',
            issue: 'Critical water injector supporting reservoir pressure maintenance. Operating at excellent injectivity.',
            wellboreImage: '/assets/wellbore-Well_55-3d.png',

            // PILLAR 1: Identity & Context
            administrative: {
                wellID: '55',
                regulatoryID: '12-345-67895-BRA-55',
                operator: 'Brahan Field Operating Company',
                lease: 'Brahan Bravo Satellite Lease Area',
                surfaceLocation: { lat: '58Â° 40\' 10.0" N', lon: '0Â° 22\' 30.0" E' },
                spudDate: '2021-05-10',
                completionDate: '2021-08-20',
                originalAFE: 38000000,
                actualCost: 37500000,
                classification: 'Active Water Injector',
                reportDate: '2023-10-26'
            },
            geological: {
                targetFormation: 'Brahan Alpha Sandstone (Northern Flank - Injection Target Zone)',
                prognosisVsActual: 'Actual formation top encountered within 3m of prognosis',
                reservoirProperties: {
                    porosity: '17-21%',
                    permeability: '180-260 mD (High permeability ideal for injectivity)',
                    initialPressure: '7,500 psi @ 2,500 m TVD',
                    temperature: '155 Â°C'
                },
                injectedFluid: {
                    source: 'Treated Raw Seawater',
                    filtration: '< 5 microns',
                    deaeration: '< 10 ppb Oâ‚‚',
                    biocideTreatment: 'Continuous glutaraldehyde injection'
                },
                injectionTargets: {
                    targetRate: '80,000 bbls/day',
                    targetPressure: '5,500 psi (surface)',
                    voidageReplacementRatio: 1.1
                }
            },

            // PILLAR 2: Physical Blueprint
            trajectory: [
                {md: 0, inc: 0, azimuth: 0, tvd: 0},
                {md: 3281, inc: 20.0, azimuth: 180.0, tvd: 3215},
                {md: 6562, inc: 45.0, azimuth: 180.0, tvd: 5865},
                {md: 9843, inc: 90.0, azimuth: 180.0, tvd: 8202},
                {md: 13123, inc: 90.0, azimuth: 180.0, tvd: 8202},
                {md: 14764, inc: 90.0, azimuth: 180.0, tvd: 8202}
            ],
            wellboreConstruction: [
                {component: 'Conductor', topMD: 574, bottomMD: 984, size: 30, weight: null, grade: null, connection: null, details: 'Subsea Wellhead Housing'},
                {component: 'Surface', topMD: 574, bottomMD: 3937, size: 20, weight: 94.0, grade: 'K-55', connection: 'BTC', details: 'TOC @ Seabed (175m MD, verified by returns)'},
                {component: 'Intermediate', topMD: 574, bottomMD: 9186, size: 13.375, weight: 54.5, grade: 'L-80', connection: 'BTC', details: 'TOC @ 1,800m MD (CBL/VDL verified)'},
                {component: 'Production (Injection)', topMD: 574, bottomMD: 14764, size: 9.625, weight: 47.0, grade: 'L-80', connection: 'VAM TOP', details: 'TOC @ 2,500m MD (CBL/VDL verified)'}
            ],

            // PILLAR 3: Completion & Production Setup
            completion: {
                casing: [{type: 'Production (Injection)', size: '9 5/8"', top: 574, bottom: 14764}],
                tubing: [{type: 'Injection', size: '5.5"', top: 0, bottom: 14436, weight: '17.0 lb/ft', grade: 'L-80', connection: 'VAM TOP', comments: '**Internally Coated with Glass-Reinforced Epoxy for corrosion resistance**'}],
                equipment: [
                    {item: 'SSSV', top: 1247, details: 'TRSSV, 1/4" control line, 1.875" bore, equalizing'},
                    {item: 'Packer', top: 14272, details: 'Model "B" Hydraulic Set Injection Packer, 7,500 psi rating'},
                    {item: 'Landing Nipple', top: 14337, details: 'No-Go Nipple, 2.313" ID, located below packer'}
                ],
                perforations: [{top: 14501, bottom: 14698, details: '6 SPF, 120Â° phasing, Big Hole charges, TCP (Optimized for injection)'}]
            },

            // PILLAR 4: Lifecycle Performance & Evolution
            injectionHistory: {
                targetRate: {date: 'Q4 2021', rate: 80000, unit: 'bbls/day'},
                actualInitialRate: {date: 'Q4 2021', rate: 82000, unit: 'bbls/day'},
                currentRate: {date: 'Q3 2023', rate: 78000, unit: 'bbls/day'},
                cumulativeInjection: '52.1 MMbbls of water',
                performanceTrend: 'Excellent and stable. Wellhead injection pressure has remained constant at ~5,200 psi, indicating sustained injectivity and no significant plugging or formation damage.'
            },
            history: [
                {
                    date: '2021-08-15',
                    operation: 'Wireline (Completion)',
                    problem: 'Run completion string, set packer, test SSSV',
                    lesson: 'Standard subsea completion procedures executed effectively. Packer set and tested. SSSV functioned correctly.',
                    serviceProvider: 'Subsea Well Services',
                    duration: '36 hours',
                    npt: 6,
                    outcome: 'Successful'
                },
                {
                    date: '2021-08-30',
                    operation: 'Wireline (Perforating)',
                    problem: 'Perforate injection interval',
                    lesson: 'TCP operations on satellite platform went smoothly. Perforations made across 4,420-4,480m MD.',
                    serviceProvider: 'Subsea Well Services',
                    duration: '12 hours',
                    npt: 2,
                    outcome: 'Successful'
                },
                {
                    date: '2021-09-05',
                    operation: 'Start-Up',
                    problem: 'Commence water injection',
                    lesson: 'Excellent injectivity confirmed from day one. Well brought on injection smoothly and immediately achieved target rates.',
                    serviceProvider: 'Brahan Operations Team',
                    duration: '24 hours',
                    npt: 0,
                    outcome: 'Successful'
                },
                {
                    date: '2022-10-20',
                    operation: 'Wireline (Surveillance)',
                    problem: 'Annual injection profile survey (PLT)',
                    lesson: 'Confirms integrity of completion and effectiveness of perforation strategy. Survey confirmed excellent, uniform zonal coverage across entire perforated interval. No out-of-zone injection detected.',
                    serviceProvider: 'DiagTech Solutions',
                    duration: '18 hours',
                    npt: 4,
                    outcome: 'Successful'
                },
                {
                    date: '2023-09-28',
                    operation: 'Wireline (Surveillance)',
                    problem: 'Annual injection profile survey (PLT)',
                    lesson: 'Continued stable performance validates the CRA coating and water treatment quality. Results consistent with 2022 survey, confirming sustained injectivity and well integrity.',
                    serviceProvider: 'DiagTech Solutions',
                    duration: '18 hours',
                    npt: 4,
                    outcome: 'Successful'
                }
            ],
            dailyReports: [],

            // PILLAR 5: Current State & Future Outlook
            wellIntegrity: {
                wbsVerified: true,
                primaryBarriers: ['5.5" Coated Injection Tubing (intact)', 'Hydraulic Injection Packer (set & tested)', 'TRSSV (function tested OK)', '9 5/8" Production Casing & Cement (CBL verified)'],
                secondaryBarriers: ['13 3/8" Intermediate Casing & Cement', '20" Surface Casing & Cement', 'Subsea Wellhead & X-mas Tree valves'],
                barrierVerification: {
                    annulusAPressure: '0 psi (monitored continuously, no communication detected)',
                    sssvTest: 'Passed (Quarterly test, Sep 2023)',
                    wellheadValves: 'Function tested and lubricated quarterly, all OK',
                    tubingIntegrity: 'Stable injection pressures indicate no leaks or significant corrosion/erosion. CRA coating integrity assumed intact'
                }
            },
            futurePlans: {
                immediate: ['Continue routine quarterly surveillance (SSSV test, annulus pressure monitoring)', 'Monitor water treatment plant performance to ensure injected water quality remains high'],
                mediumTerm: ['Continue annual injection profile surveys to monitor for any long-term changes in injectivity profile or potential for fines migration or near-wellbore scaling', 'Evaluate need for stimulation (e.g., acid wash) if injectivity declines significantly'],
                longTerm: ['Not applicable in near term. Well_55 is critical asset for reservoir pressure support and expected to operate for remaining life of Brahan field. P&A only considered as part of overall field abandonment plan']
            }
        },
        {
            id: 'Well_666',
            name: 'CASE STUDY: The Perfect Storm',
            field: 'Brahan',
            region: 'UKCS',
            type: 'HPHT Gas Condensate Producer',
            depth: '16,404ft',
            locationType: 'Subsea',
            platform: 'Brahan Gamma Subsea Manifold',
            datumElevation: '82ft',
            waterDepth: '591ft',
            status: 'SHUT-IN (Critical Intervention Candidate)',
            issue: 'THE PERFECT STORM: A cascade of compounding failures. Severe BaSOâ‚„ scale blockage, failed TRSSV stuck closed, and casing deformation at 14,764ft. Demonstrates why WellTegra is vital. Requires complex multi-phase intervention incorporating lessons from W22, W33, and W44.',
            wellboreImage: '/assets/wellbore-Well_666-3d.png',

            // PILLAR 1: Identity & Context
            administrative: {
                wellID: '666',
                regulatoryID: '12-345-67898-BRA-666',
                operator: 'Brahan Field Operating Company',
                lease: 'Brahan Gamma Subsea Development Area',
                surfaceLocation: { lat: '58Â° 41\' 55.0" N', lon: '0Â° 24\' 45.0" E' },
                spudDate: '2022-01-20',
                completionDate: '2022-04-10',
                originalAFE: 62000000,
                actualCost: 64500000,
                classification: 'SHUT-IN (Multiple Integrity & Flow Assurance Failures)',
                reportDate: '2023-10-26'
            },
            geological: {
                targetFormation: 'Brahan Alpha Sandstone (HPHT "Core" Zone - Same as W777)',
                prognosisVsActual: 'Actual formation top encountered as prognosed. Initial reservoir quality appeared excellent.',
                reservoirProperties: {
                    porosity: '19-23%',
                    permeability: '180-280 mD',
                    initialPressure: '8,750 psi @ 2,550 m TVD',
                    temperature: '178 Â°C (Slightly higher than prognosed, a potential contributing factor to issues)'
                },
                fluidCharacteristics: {
                    fluidType: 'Rich Gas Condensate',
                    CGR: '140 bbl/MMscf',
                    gasGravity: 0.70,
                    h2s: '25 ppm (Higher than W777, increasing corrosion risk)',
                    co2: '5.5 mol% (Higher than W777, increasing corrosion/scale risk)',
                    scaleTendency: 'Extreme Barium Sulphate (BaSOâ‚„) precipitation risk, confirmed by fluid sampling'
                },
                volumetrics: {
                    OGIP: '190 Bcf',
                    EUR: 'CRITICALLY REDUCED. Original estimate was 80 Bcf. Current estimate is highly dependent on intervention success'
                }
            },

            // PILLAR 2: Physical Blueprint
            trajectory: [
                {md: 0, inc: 0.0, azimuth: 0.0, tvd: 0},
                {md: 3281, inc: 25.0, azimuth: 210.0, tvd: 3135},
                {md: 6562, inc: 50.0, azimuth: 210.0, tvd: 5612},
                {md: 9843, inc: 75.0, azimuth: 210.0, tvd: 7527},
                {md: 13123, inc: 90.0, azimuth: 210.0, tvd: 8370},
                {md: 16404, inc: 90.0, azimuth: 210.0, tvd: 8370}
            ],
            wellboreConstruction: [
                {component: 'Conductor', topMD: 673, bottomMD: 1148, size: 30, weight: null, grade: null, connection: null, details: 'Subsea Wellhead Housing'},
                {component: 'Surface', topMD: 673, bottomMD: 4265, size: 20, weight: 94.0, grade: 'K-55', connection: 'BTC', details: 'TOC @ Seabed (673ft MD, verified by returns)'},
                {component: 'Intermediate', topMD: 673, bottomMD: 9843, size: 13.375, weight: 54.5, grade: 'L-80', connection: 'BTC', details: 'TOC @ 6,562ft MD (CBL/VDL verified)'},
                {component: 'Production', topMD: 673, bottomMD: 16404, size: 9.625, weight: 47.0, grade: 'C-90', connection: 'VAM TOP', details: '**TOC @ 8,858ft MD (CBL/VDL verified). SEVERE CASING DEFORMATION SUSPECTED AT ~14,764ft MD**', isProblem: true}
            ],

            // PILLAR 3: Completion & Production Setup
            completion: {
                casing: [
                    {type: 'Conductor', size: '30"', top: 673, bottom: 1148},
                    {type: 'Surface', size: '20"', top: 673, bottom: 4265},
                    {type: 'Intermediate', size: '13 3/8"', top: 673, bottom: 9843},
                    {type: 'Production', size: '9 5/8"', top: 673, bottom: 16404, comments: '**DEFORMED at ~14,764ft MD**', isProblem: true}
                ],
                tubing: [{
                    type: 'Production',
                    size: '5.5"',
                    top: 0,
                    bottom: 16076,
                    weight: '17.0 lb/ft',
                    grade: 'L-80 13Cr',
                    connection: 'VAM TOP',
                    comments: '**HARD BaSOâ‚„ SCALE BLOCKAGE PRESENT, restricting flow**',
                    isProblem: true
                }],
                equipment: [
                    {item: 'SSSV', top: 1345, details: 'TRSSV, 1/4" control line, 1.875" bore. **FAILED.** Found stuck in CLOSED position during routine test', isProblem: true},
                    {item: 'Gas Lift Mandrels', top: 6890, bottom: 8858, details: 'Side Pocket Mandrels at 6,890ft, 7,874ft, 8,858ft - 1.0" OD valve pockets. **Accessibility compromised**'},
                    {item: 'Packer', top: 15912, details: 'Model "A" Hydraulic Set Production Packer, 10k psi rating. **Integrity uncertain due to downhole conditions**'},
                    {item: 'Landing Nipple', top: 15977, details: 'No-Go Nipple, 2.313" ID, located below packer. **Accessibility compromised**'},
                    {item: 'BaSOâ‚„ Scale Bridge', top: 16076, details: '**SOLID BLOCKAGE in tubing**', isProblem: true}
                ],
                perforations: [{top: 16109, bottom: 16404, details: 'Gravel Pack assembly, 12 SPF, 60Â° phasing. **Inflow severely restricted by scale and potential formation damage**', isProblem: true}]
            },

            // PILLAR 4: Lifecycle Performance & Evolution
            productionHistory: {
                initialRate: {date: 'Q2 2022', oil: 1550, gas: 85, water: 0, unit: 'bbl/d condensate, MMscf/d gas', note: '11,000 boepd - Exceeded expectations'},
                rapidDecline: {date: 'Q3 2022', oil: 800, gas: 45, water: 0, unit: 'bbl/d condensate, MMscf/d gas', note: 'Rapid decline noted within 8 weeks of start-up'},
                finalRate: {date: 'Q4 2022', oil: 100, gas: 5, water: 0, unit: 'bbl/d condensate, MMscf/d gas', note: '< 1,000 boepd before shut-in for diagnostics'},
                cumulativeProduction: {gas: '4.1 Bcf', condensate: '0.5 MMbbl'},
                performanceTrend: '**CATASTROPHIC FAILURE.** Well is currently non-productive.'
            },
            history: [
                {
                    date: '2022-04-15',
                    operation: 'Start-Up',
                    problem: 'Commission well and bring on production',
                    lesson: 'Initial Success. Well started up and achieved high initial rates of 11,000 boepd (85 MMscf/d gas, 1,550 bbl/d condensate). High initial productivity confirmed reservoir potential.',
                    serviceProvider: 'Brahan Operations Team',
                    duration: '72 hours',
                    npt: 12,
                    outcome: 'Initial Success'
                },
                {
                    date: '2022-06-20',
                    operation: 'Wireline (Diagnostic)',
                    problem: 'Investigate rapid production decline',
                    lesson: 'INCONCLUSIVE. Data indicated a restriction but could not identify cause or depth. Standard diagnostics were insufficient for this complex failure.',
                    serviceProvider: 'DiagTech Solutions',
                    duration: '24 hours',
                    npt: 8,
                    outcome: 'INCONCLUSIVE'
                },
                {
                    date: '2022-08-30',
                    operation: 'Wireline (Diagnostic)',
                    problem: 'Attempt to run slickline to locate restriction',
                    lesson: 'FAILED. Slickline could not pass below 16,076ft MD, indicating a severe, hard blockage in the tubing. Confirmed a hard scale blockage, not a mechanical issue like a closed sleeve.',
                    serviceProvider: 'QuickWire Services',
                    duration: '6 hours',
                    npt: 6,
                    outcome: 'FAILED - Hard blockage confirmed'
                },
                {
                    date: '2022-09-15',
                    operation: 'Wireline (Diagnostic)',
                    problem: 'Routine TRSSV function test',
                    lesson: 'FAILED. TRSSV found to be stuck in the CLOSED position. Well immediately shut-in for safety. A critical safety barrier failure compounded the production problem.',
                    serviceProvider: 'SafetyFirst Wireline',
                    duration: '6 hours',
                    npt: 6,
                    outcome: 'FAILED - TRSSV malfunction'
                },
                {
                    date: '2022-10-10',
                    operation: 'Wireline (Diagnostic)',
                    problem: 'Multi-Finger Caliper run to assess tubing/casing integrity',
                    lesson: 'CRITICAL FINDING. Caliper log revealed severe (>20% ovality) casing deformation in the 9 5/8" production casing at approximately 14,764ft MD. Identified the root cause of potential future problems and a major complication for any intervention. The "Perfect Storm" scenario was confirmed.',
                    serviceProvider: 'DiagTech Solutions',
                    duration: '36 hours',
                    npt: 10,
                    outcome: 'CRITICAL - Casing deformation identified'
                },
                {
                    date: '2022-11-05',
                    operation: 'Planning Session',
                    problem: 'Develop complex intervention strategy',
                    lesson: 'PLAN DEVELOPED. A multi-stage intervention plan was drafted, requiring: (1) Scale removal via CT (Lesson from W33), (2) SSV replacement with insert valve (Lesson from W44), and (3) Casing remediation with expandable patch (Lesson from W22). The complexity of the job exceeds standard intervention capabilities. Requires a highly integrated plan.',
                    serviceProvider: 'Brahan Engineering Team',
                    duration: 'N/A',
                    npt: 0,
                    outcome: 'Multi-phase intervention plan developed'
                }
            ],
            dailyReports: [],

            // PILLAR 5: Current State & Future Outlook
            wellIntegrity: {
                wbsVerified: false,
                primaryBarriers: ['**5 1/2" Production Tubing (OBSTRUCTED)**', '**Hydraulic Packer (Integrity Unknown)**', '**TRSSV (FAILED)**', '**9 5/8" Production Casing (DEFORMED)**'],
                secondaryBarriers: ['13 3/8" Intermediate Casing & Cement (assumed intact)', '20" Surface Casing & Cement (assumed intact)', 'Subsea Wellhead & X-mas Tree valves (tested OK)'],
                barrierVerification: {
                    annulusAPressure: '100 psi (stable but elevated, requiring monitoring)',
                    trssvTest: '**FAILED (Sept 2022)**',
                    wellheadValves: 'Function tested quarterly via ROV, all OK',
                    tubingIntegrity: '**Known to be severely compromised**',
                    casingIntegrity: '**Known to be severely compromised**'
                }
            },
            futurePlans: {
                immediate: [
                    '**CRITICAL: Execute the multi-stage intervention plan.** This is the highest-priority well work in the Brahan field',
                    '**Phase 1: Scale Removal** - Mobilize coiled tubing unit with high-pressure jetting and specialized chemical dissolvers to remove BaSOâ‚„ blockage in tubing. This is a prerequisite for all subsequent work (Lessons from W33)',
                    '**Phase 2: SSV Replacement** - Once tubing access is restored, use slickline to lock open the failed TRSSV and install a slickline-retrievable insert safety valve to restore the primary downhole safety barrier (Lessons from W44)',
                    '**Phase 3: Casing Remediation** - Run multi-arm caliper to get detailed 3D map of deformed casing. Based on results, deploy expandable steel patch to restore casing structural integrity and nominal internal diameter (Lessons from W22)'
                ],
                mediumTerm: [
                    'If multi-stage intervention is successful, the well has the potential to return to high-rate production, significantly boosting field output',
                    'Well will require intensive, frequent monitoring to ensure long-term integrity of the repairs'
                ],
                longTerm: [
                    'The success or failure of the upcoming intervention will dictate the long-term economic viability of this well. A failed intervention could lead to early abandonment, representing a significant loss of reserves',
                    '**The lessons learned from tackling "The Perfect Storm" will be invaluable for the design and operation of all future high-risk, high-reward wells in the Brahan field and beyond**'
                ]
            }
        },
        {
            id: 'Well_777',
            name: 'CASE STUDY: Field of Dreams',
            field: 'Brahan',
            region: 'UKCS',
            type: 'HPHT Gas Condensate Producer',
            depth: '17,060ft',
            locationType: 'Subsea',
            platform: 'Brahan Gamma Subsea Manifold',
            datumElevation: '82ft',
            waterDepth: '591ft',
            status: 'Active - Peak Performance (Benchmark Well)',
            issue: 'BENCHMARK DESIGN: Strategically designed premium well incorporating all lessons learned from Well_22, Well_33, Well_44, and Well_666. Template for future Brahan development.',
            wellboreImage: '/assets/wellbore-Well_777-3d.png',

            // PILLAR 1: Identity & Context
            administrative: {
                wellID: '777',
                regulatoryID: '12-345-67899-BRA-777',
                operator: 'Brahan Field Operating Company',
                lease: 'Brahan Gamma Subsea Development Area',
                surfaceLocation: { lat: '58Â° 42\' 05.0" N', lon: '0Â° 25\' 15.0" E' },
                spudDate: '2023-03-01',
                completionDate: '2023-06-15',
                originalAFE: 65000000,
                actualCost: 64200000,
                classification: 'Active Producer (Benchmark Design)',
                reportDate: '2023-10-26'
            },
            geological: {
                targetFormation: 'Brahan Alpha Sandstone (HPHT "Core" Zone - Same as Well_666)',
                prognosisVsActual: 'Geosteering used to place wellbore in optimal reservoir facies, avoiding fault zones identified in seismic re-processing prompted by Well_666 data',
                reservoirProperties: {
                    porosity: '20-24%',
                    permeability: '200-300 mD',
                    initialPressure: '8,800 psi @ 2,605 m TVD',
                    temperature: '175 Â°C'
                },
                fluidCharacteristics: {
                    fluidType: 'Rich Gas Condensate (High Scaling Potential)',
                    CGR: '135 bbl/MMscf',
                    gasGravity: 0.69,
                    h2s: '22 ppm',
                    co2: '5.0 mol%',
                    scaleTendency: 'Very High Barium Sulphate (BaSOâ‚„) precipitation risk (Lesson from Well_33)'
                },
                volumetrics: {
                    OGIP: '195 Bcf',
                    EUR: '85 Bcf (Enhanced by premium completion)'
                }
            },

            // PILLAR 2: Physical Blueprint
            trajectory: [
                {md: 0, inc: 0, azimuth: 0, tvd: 0},
                {md: 3281, inc: 22.0, azimuth: 245.0, tvd: 3177},
                {md: 6562, inc: 48.0, azimuth: 245.0, tvd: 5719},
                {md: 9843, inc: 80.0, azimuth: 245.0, tvd: 7677},
                {md: 13123, inc: 90.0, azimuth: 245.0, tvd: 8549},
                {md: 17060, inc: 90.0, azimuth: 245.0, tvd: 8549}
            ],
            wellboreConstruction: [
                {component: 'Conductor', topMD: 673, bottomMD: 1148, size: 30, weight: null, grade: null, connection: null, details: 'Subsea Wellhead Housing'},
                {component: 'Surface', topMD: 673, bottomMD: 4429, size: 20, weight: 94.0, grade: 'K-55', connection: 'BTC', details: 'TOC @ Seabed (205m MD, verified by returns)'},
                {component: 'Intermediate', topMD: 673, bottomMD: 10171, size: 13.375, weight: 68.0, grade: '**P-110**', connection: '**VAM TOP**', details: '**Enhanced grade and premium connection to withstand compaction (Lesson from Well_22). TOC @ 2,100m MD (CBL/VDL verified)**'},
                {component: 'Production (Liner)', topMD: 9514, bottomMD: 17060, size: 9.625, weight: 53.5, grade: '**Q-125 13Cr**', connection: '**VAM TOP**', details: '**Corrosion-Resistant Alloy (CRA) liner to combat Hâ‚‚S/COâ‚‚ and scale (Lessons from Well_33, Well_55). TOC @ 2,800m MD (CBL/VDL verified)**'}
            ],

            // PILLAR 3: Completion & Production Setup
            completion: {
                casing: [{type: 'Production (CRA Liner)', size: '9 5/8"', top: 9514, bottom: 17060}],
                tubing: [{type: 'Production', size: '5.5"', top: 0, bottom: 16732, weight: '22.0 lb/ft', grade: '**Incoloy 825 CRA tubing**', connection: 'VAM TOP', comments: '**Glass-Reinforced Epoxy internal coating. Premium materials to resist corrosion and scale adhesion (Lessons from Well_33, Well_55)**'}],
                equipment: [
                    {item: 'SSSV (Primary)', top: 1362, details: '**Primary TRSSV, 1/4" control line, 1.875" bore**'},
                    {item: 'SSSV (Secondary)', top: 1394, details: '**Secondary, retrievable Insert SSV in dedicated nipple profile. Redundant safety barrier (Lesson from Well_44)**', isEnhancement: true},
                    {item: 'Chemical Injection Mandrel', top: 4921, details: '**Dual-Port Side Pocket Mandrel for continuous scale and corrosion inhibitor injection (Proactive scale management, Lesson from Well_33)**', isEnhancement: true},
                    {item: 'Gas Lift Mandrels', top: 7218, details: 'Side Pocket Mandrels at 2,200m, 2,500m, 2,800m - 1.0" OD, premium valve seats'},
                    {item: 'Packer', top: 16568, details: '**Model "C" Hydraulic Set Premium Production Packer, 12,500 psi rating, Elastomer seals compatible with high COâ‚‚/Hâ‚‚S**'},
                    {item: 'Landing Nipple', top: 16666, details: 'Premium No-Go Nipple, 2.313" ID, located below packer'},
                    {item: 'Sand Screen', top: 16798, details: '**Premium, expandable sand screen assembly across 5,120-5,180m MD, installed with gravel pack (Robust sand control, Lesson from Well_666)**', isEnhancement: true}
                ],
                perforations: [{top: 16798, bottom: 16995, details: 'Premium gravel pack, 12 SPF, 60Â° phasing'}]
            },

            // PILLAR 4: Lifecycle Performance & Evolution
            productionHistory: {
                initialRate: {date: 'Q3 2023', oil: 1600, gas: 95, water: 0, unit: 'bbl/d oil, MMscf/d gas', note: '**Exceeded initial forecasts by 15%**'},
                currentRate: {date: 'Q3 2023', oil: 1600, gas: 95, water: 0, unit: 'bbl/d oil, MMscf/d gas (Stable, on plateau)'},
                cumulativeProduction: {gas: '3.2 Bcf', condensate: '0.4 MMbbl'},
                performanceTrend: 'Operating at peak, stable performance. No decline observed to date.'
            },
            history: [
                {
                    date: '2023-06-20',
                    operation: 'Start-Up',
                    problem: 'Commission well and bring on production',
                    lesson: 'Premium completion design and commissioning procedures validated. Well started up smoothly, achieving target rates within 24 hours with no HSE incidents. Achieved 12,500 boepd (95 MMscf/d gas, 1,600 bbl/d condensate).',
                    serviceProvider: 'Brahan Operations Team',
                    duration: '48 hours',
                    npt: 0,
                    outcome: 'Outstanding'
                },
                {
                    date: '2023-07-15',
                    operation: 'Wireline (Proactive)',
                    problem: 'Function test primary and secondary SSVs',
                    lesson: 'Redundant SSV design provides unparalleled safety and operational flexibility. Both primary and secondary SSVs functioned perfectly, validating the redundant barrier design.',
                    serviceProvider: 'SafetyFirst Wireline',
                    duration: '8 hours',
                    npt: 2,
                    outcome: 'Successful'
                },
                {
                    date: '2023-08-30',
                    operation: 'Wireline (Proactive)',
                    problem: 'Initial production log and fluid sampling',
                    lesson: 'Proactive surveillance confirms effectiveness of premium materials and chemical injection program. Confirmed clean wellbore, uniform inflow across sand screen interval, and no early signs of scale or corrosion.',
                    serviceProvider: 'DiagTech Solutions',
                    duration: '20 hours',
                    npt: 4,
                    outcome: 'Successful'
                },
                {
                    date: '2023-09-25',
                    operation: 'Subsea Control System',
                    problem: 'Routine remote wellhead and annulus pressure monitoring',
                    lesson: 'Continuous monitoring provides early warning for any potential deviations. All parameters within operational limits. No anomalies detected.',
                    serviceProvider: 'Brahan Control Room',
                    duration: 'Continuous',
                    npt: 0,
                    outcome: 'Nominal'
                }
            ],
            dailyReports: [],

            // PILLAR 5: Current State & Future Outlook
            wellIntegrity: {
                wbsVerified: true,
                primaryBarriers: ['**Incoloy 825 CRA Tubing (intact)**', '**Premium Hydraulic Packer (set & tested)**', '**Dual SSV System (both tested OK)**', '**Q-125 13Cr CRA Liner & Cement (CBL verified)**', '**Premium Gravel Pack/Sand Screen**'],
                secondaryBarriers: ['P-110 Intermediate Casing & Cement', '20" Surface Casing & Cement', 'Subsea Wellhead & X-mas Tree valves'],
                barrierVerification: {
                    annulusAPressure: '0 psi (monitored continuously, no communication detected)',
                    sssvTest: 'Both primary and secondary valves passed (Quarterly test, Sep 2023)',
                    wellheadValves: 'Function tested and lubricated quarterly via ROV, all OK',
                    tubingCasingIntegrity: 'No leaks or abnormal pressures. Continuous monitoring confirms integrity of premium materials'
                }
            },
            futurePlans: {
                immediate: ['Continue proactive, routine surveillance (PLTs, SSV tests, fluid sampling) to validate the "Field of Dreams" design', 'Use data from this well to refine predictive maintenance models for other assets'],
                mediumTerm: ['**Well_777 will serve as the template for all future Brahan field development wells**', 'Data will be used to build high-fidelity digital twin, which can be used to simulate interventions on problem wells like Well_666 before execution', 'Analyze long-term performance of CRA materials and chemical injection program to optimize costs for future wells'],
                longTerm: ['Enhanced design of Well_777 will inform more efficient and reliable P&A procedures, ensuring its integrity can be safely and cost-effectively managed at end of life']
            }
        },
    ];
    const objectivesData = [
        { id: 'obj1', name: 'Remediate Casing Deformation', description: 'Install an expandable steel patch to restore wellbore access.', icon: 'wrench-screwdriver' },
        { id: 'obj2', name: 'Remove BaSO4 Scale', description: 'Use a chemical and mechanical method to clear tubing blockage.', icon: 'beaker' },
        { id: 'obj3', name: 'Restore Downhole Safety Valve', description: 'Lock open the failed TRSSV and install a new insert valve.', icon: 'shield-exclamation' },
        { id: 'obj4', name: 'Repair Sand Control', description: 'Install a through-tubing expandable sand screen patch.', icon: 'cube' },
        { id: 'obj5', name: 'Paraffin Wax Removal', description: 'Use CT with chemicals and tools to remove wax blockage.', icon: 'fire' }
    ];
    const problemsData = [
        { id: 'prob1', name: 'Loss of Well Access (Casing Deformation)', description: 'Wellbore is restricted due to geomechanical forces.', linked_objectives: ['obj1'], icon: 'no-symbol' },
        { id: 'prob2', name: 'Severe Scale Blockage', description: 'Production is blocked by hard, insoluble scale.', linked_objectives: ['obj2'], icon: 'chart-bar' },
        { id: 'prob3', name: 'Failed Primary Safety Barrier (DHSV)', description: 'Well is legally shut-in due to a failed safety valve.', linked_objectives: ['obj3'], icon: 'exclamation-triangle' },
        { id: 'prob4', name: 'Sand Control Failure', description: 'Excessive sand production is damaging equipment and limiting rates.', linked_objectives: ['obj4'], icon: 'cube' },
        { id: 'prob5', name: 'Flow Assurance Blockage (Wax)', description: 'Production is severely restricted by paraffin deposits.', linked_objectives: ['obj5'], icon: 'fire' }
    ];
    const aiRecommendations = {
        prob1: [
            { objectiveId: 'obj1', confidence: 95, outcome: 'Full-bore access restored', reason: 'Historical analysis confirms expandable steel patches are proven, high-success-rate rigless solutions for casing deformation in this field environment.' }
        ],
        prob2: [
            { objectiveId: 'obj2', confidence: 92, outcome: 'Blockage cleared, production restored', reason: 'Based on the successful intervention on case study <strong>Well_33 (The Scale Victory)</strong>, a two-stage chemical (DTPA) and mechanical (jetting) intervention has the highest probability of success. This avoids the high risk of stuck pipe associated with milling.' }
        ],
        prob3: [
            { objectiveId: 'obj3', confidence: 99, outcome: 'Well returned to safe, compliant production', reason: 'This is a standard operation. The critical lesson from case study <strong>Well_44 (The Barrier Restoration)</strong> is to use a reliable mechanical lock-open tool to avoid procedural failures and ensure a successful, single-run repair.' }
        ],
        prob4: [
            { objectiveId: 'obj4', confidence: 88, outcome: 'Sand-free production at >80% potential', reason: 'Through-tubing expandable sand screens are proven rigless solutions for sand control failures. This approach avoids costly workover operations.' }
        ],
        prob5: [
            { objectiveId: 'obj5', confidence: 90, outcome: 'Wax blockage removed, production increased by >400%', reason: 'Coiled Tubing interventions with both heated chemical dissolvers and mechanical scraper tools are the most effective procedures for paraffin removal.' }
        ]
    };
    const proceduresData = {
        obj1: { 
            name: "Expandable Casing Patch Installation", 
            personnel: ["Wellsite Engineer", "HWU Supervisor"], 
            steps: [
                "Perform wellbore cleanout trip with scraper and gauge ring.",
                "RIH with expandable patch on jointed pipe.",
                "Position patch across deformed interval using GR/CCL correlation.",
                "Set patch using hydraulic setting tool.",
                "Pressure test patch to verify seal.",
                "POOH and return well to service."
            ], 
            risks: { operational: 4, geological: 2, equipment: 4, hse: 3, financial: 3 }, 
            cost: 1200000, 
            duration: 8, 
            tfaModel: { pickUp: [[0,0], [9000, 60]], slackOff: [[0,0], [9000, -60]], alarmUpper: [[0,10], [9000, 70]], alarmLower: [[0,-10], [9000, -70]] } 
        },
        obj2: { 
            name: "CT Chemical & Mechanical Scale Removal", 
            personnel: ["Coiled Tubing Supervisor", "Pump Operator"], 
            steps: [
                "RIH with CT and spot DTPA chemical dissolver across scale.",
                "POOH with CT and let chemical soak for 36 hours.",
                "RIH with CT and rotating jetting BHA.",
                "Mechanically break up and circulate out softened scale.",
                "Circulate well clean and POOH.",
                "Return well to production."
            ], 
            risks: { operational: 5, geological: 2, equipment: 4, hse: 4, financial: 3 }, 
            cost: 950000, 
            duration: 6, 
            tfaModel: { pickUp: [[0,0], [14500, 35]], slackOff: [[0,0], [14500, -35]], alarmUpper: [[0,2], [14500, 37]], alarmLower: [[0,-2], [14500, -37]] } 
        },
        obj3: { 
            name: "Slickline Insert Safety Valve Installation", 
            personnel: ["Slickline Supervisor"], 
            steps: [
                "RIH with heavy-duty toolstring and mechanically lock open the failed TRSSV.",
                "POOH and confirm lock-open.",
                "RIH with new Wireline-Retrievable Safety Valve (WRSV) on a running tool.",
                "Set and lock the new WRSV in the old valve's nipple profile.",
                "Pressure up control line to hold new valve open, then retrieve running tool.",
                "Perform full inflow and function test of new valve to certify.",
                "Return well to production."
            ], 
            risks: { operational: 3, geological: 1, equipment: 4, hse: 3, financial: 2 }, 
            cost: 350000, 
            duration: 3, 
            tfaModel: { pickUp: [[0, 100], [9800, 160]], slackOff: [[0, 100], [9800, 40]], alarmUpper: [[0, 110], [9800, 170]], alarmLower: [[0, 90], [9800, 30]] } 
        },
        obj4: { 
            name: "Through-Tubing ESS Patch Installation", 
            personnel: ["Wellsite Engineer", "HWU Supervisor"], 
            steps: [
                "Perform CT cleanout of sand from inside existing screen.",
                "RIH with Expandable Sand Screen (ESS) patch on jointed pipe.",
                "Position patch across failed screen interval.",
                "Expand patch using mechanical expansion tool.",
                "POOH and slowly bring well back online, monitoring sand production."
            ], 
            risks: { operational: 4, geological: 3, equipment: 5, hse: 3, financial: 4 }, 
            cost: 1500000, 
            duration: 10, 
            tfaModel: { pickUp: [[0,0], [10000, 50]], slackOff: [[0,0], [10000, -50]], alarmUpper: [[0,5], [10000, 55]], alarmLower: [[0,-5], [10000, -55]] } 
        },
        obj5: { 
            name: "CT Wax Removal", 
            personnel: ["Coiled Tubing Supervisor", "Pump Operator"], 
            steps: [
                "Rig up Coiled Tubing unit.",
                "Pump heated solvent to dissolve wax.",
                "RIH with CT and a mechanical scraper BHA to clear remaining deposits.",
                "Circulate well clean with hot fluid.",
                "POOH with CT.",
                "Return well to production."
            ], 
            risks: { operational: 4, geological: 2, equipment: 3, hse: 3, financial: 2 }, 
            cost: 650000, 
            duration: 4, 
            tfaModel: { pickUp: [[0,0], [7500, 20]], slackOff: [[0,0], [7500, -20]], alarmUpper: [[0,2], [7500, 22]], alarmLower: [[0,-2], [7500, -22]] } 
        }
    };
    const equipmentRequirements = {
        obj1: [ { name: "Hydraulic Workover Unit (HWU)", source: "Vendor", price: 300000 }, { name: "Expandable Steel Patch & Setting Tool", source: "Vendor", price: 500000 } ],
        obj2: [ { name: "Coiled Tubing Unit", source: "Vendor", price: 125000 }, { name: "Rotating Jetting Nozzle", source: "Vendor", price: 25000 }, { name: "DTPA Chemical", source: "Vendor", price: 80000 } ],
        obj3: [ { name: "Slickline Unit", source: "Vendor", price: 75000 }, { name: "Insert Safety Valve (WRSV)", source: "Vendor", price: 150000 }, { name: "Lock-Open Tool", source: "Vendor", price: 20000 } ],
        obj4: [ { name: "Hydraulic Workover Unit (HWU)", source: "Vendor", price: 300000 }, { name: "Expandable Sand Screen & Expansion Tool", source: "Vendor", price: 600000 } ],
        obj5: [ { name: "Coiled Tubing Unit", source: "Vendor", price: 125000 }, { name: "Wax Dissolver Chemical", source: "Vendor", price: 50000 }, { name: "Mechanical Scraper BHA", source: "Vendor", price: 15000 } ]
    };
    const equipmentData = [ 
        { id: 'CTU-01', type: 'Coiled Tubing Unit', location: 'Onboard - Deck A', testStatus: 'Passed', nextMaint: '2025-09-15', rate: 25000, status: 'On Job' }, 
        { id: 'CTU-02', type: 'Coiled Tubing Unit', location: 'Onshore Base', testStatus: 'Pending', nextMaint: '2025-07-10', rate: 25000, status: 'Maintenance' }, 
        { id: 'WL-01', type: 'Wireline Truck/Skid', location: 'Onshore Base', testStatus: 'Passed', nextMaint: '2025-08-22', rate: 18000, status: 'Available' }, 
        { id: 'SL-01', type: 'Slickline Unit', location: 'In Transit', testStatus: 'Passed', nextMaint: '2025-07-20', rate: 15000, status: 'In Transit' }, 
        { id: 'PUMP-01', type: 'High-Pressure Pumps', location: 'Onboard - Pump Room', testStatus: 'Pending', nextMaint: '2025-10-01', rate: 8000, status: 'On Job' }, 
        { id: 'PUMP-02', type: 'High-Pressure Pumps', location: 'Onshore Base', testStatus: 'Passed', nextMaint: '2025-11-05', rate: 8000, status: 'Available' }, 
        { id: 'RIG-01', type: 'Workover Rig', location: 'Onboard - Drill Floor', testStatus: 'Passed', nextMaint: '2025-08-01', rate: 85000, status: 'On Job' }, 
    ];
    const personnelData = [ 
        { id: 'P001', name: 'Bob Raker', role: 'Wellsite Engineer', company: 'Operator', status: 'Onboard', certsValid: true, rate: 2200, muster: 'A', lifeboat: 1 }, 
        { id: 'P002', name: 'Jane Smith', role: 'Coiled Tubing Supervisor', company: 'Service Co.', status: 'Onboard', certsValid: true, rate: 2500, muster: 'A', lifeboat: 1 }, 
        { id: 'P003', name: 'Mike Johnson', role: 'Wireline Supervisor', company: 'Service Co.', status: 'On Job', certsValid: true, rate: 2300, muster: 'B', lifeboat: 2 }, 
        { id: 'P004', name: 'Emily White', role: 'Slickline Supervisor', company: 'Service Co.', status: 'Available', certsValid: false, rate: 2300, muster: 'B', lifeboat: 2 }, 
        { id: 'P005', name: 'Chris Green', role: 'Pump Operator', company: 'Service Co.', status: 'In Transit', certsValid: true, rate: 1800, muster: 'A', lifeboat: 1 }, 
        { id: 'P006', name: 'Alex Brown', role: 'Rig Supervisor', company: 'Operator', status: 'Onboard', certsValid: true, rate: 3000, muster: 'B', lifeboat: 2 }, 
        { id: 'P007', name: 'David Chen', role: 'ESP Specialist', company: 'Service Co.', status: 'Standby', certsValid: true, rate: 3500, muster: 'A', lifeboat: 2 } 
    ];
    const musterStations = [ { id: 'A', name: 'Muster Station A', capacity: 50, current: 0 }, { id: 'B', name: 'Muster Station B', capacity: 50, current: 0 } ];
    
    // --- FAQ DATA ---

    const faqData = [
        {
            question: "What is Well-Tegra?",
            answer: `<p>Well-Tegra is an advanced technology platform designed to foster collaborative intelligence within the energy sector. It provides a comprehensive architectural blueprint that integrates privacy-preserving Artificial Intelligence (AI) and enterprise blockchain technology to solve long-standing challenges in energy operations.</p><p>Its primary mission is to transform the vast, fragmented, and often inaccessible data generated by oil and gas operations into a unified, analysis-ready asset, enabling competing firms to securely pool operational insights for mutual benefit.</p>`
        },
        {
            question: "What fundamental problem does Well-Tegra solve?",
            answer: `<p>The fundamental problem Well-Tegra addresses is the <strong>endemic data fragmentation</strong> that plagues the modern energy sector. Data is typically locked in isolated "silos," hindering the application of advanced analytics and machine learning.</p><p>This fragmentation comes from disparate sources, incompatible digital formats, and inaccessible physical data, meaning decades of invaluable operational knowledge remain locked away and unusable.</p>`
        },
        {
            question: "Who is the target audience for the Well-Tegra platform?",
            answer: `<p>The primary target audience consists of <strong>oil and gas operators</strong> and other firms within the energy industry's operational ecosystem. The platform is designed to serve both individual companies seeking to optimize their internal operations and consortia of competing firms aiming to achieve shared intelligence.</p>`
        },
        {
            question: "Why does Well-Tegra use blockchain technology?",
            answer: `<p>Well-Tegra uses a <strong>private, permissioned blockchain</strong> to create a trusted, transparent, and tamper-proof foundation for its multi-client collaborative ecosystem. This is not a public cryptocurrency blockchain, but a secure environment for vetted partners.</p><p>It provides three core guarantees:</p><ul><li><strong>Cryptographic Hashing:</strong> A unique digital fingerprint for data, making tampering obvious.</li><li><strong>Block Chaining:</strong> An unbreakable, interlocking chain where altering one block invalidates all subsequent blocks.</li><li><strong>Decentralization:</strong> The ledger is copied across all members, requiring majority consensus for changes, making fraudulent changes practically impossible.</li></ul>`
        },
        {
            question: "How can competing companies share data without revealing confidential information?",
            answer: `<p>Well-Tegra implements a sophisticated, multi-stage anonymization protocol. This "defense-in-depth" strategy layers several advanced privacy-enhancing technologies:</p><ul><li><strong>Stage 1: Identification and Suppression:</strong> Removing explicit identifiers like company and well names.</li><li><strong>Stage 2: Generalization for K-Anonymity and L-Diversity:</strong> Making records indistinguishable from others to prevent re-identification from combined attributes.</li><li><strong>Stage 3: Perturbation with Differential Privacy:</strong> Adding calibrated statistical "noise" to sensitive numerical data to provide a formal, mathematical guarantee of privacy.</li></ul><p>The platform's most innovative feature is <strong>"verifiable privacy,"</strong> where the anonymization rules are coded into a smart contract on the blockchain, allowing participants to cryptographically verify that the agreed-upon privacy protocol was executed.</p>`
        },
        {
            question: "What is the 'network effect' and how does it benefit data providers?",
            answer: `<p>The "network effect" is the principle that the value of the platform increases for every participant as more members join. This is achieved by securely leveraging the collective, anonymized data of the entire consortium to build predictive models that are far more powerful than any single organization could develop alone.</p><p>This creates a <strong>virtuous cycle</strong>: more data leads to better models, which provides a powerful incentive for new members to join, which in turn makes the models even more powerful for everyone.</p>`
        },
    ];

    // --- GLOBAL STATE ---

    let appState = {
        currentView: 'home',
        selectedWell: null,
        selectedObjective: null,
        generatedPlan: null,
        liveData: null,
        logEntries: [],
        lessonsLearned: [],
        tfaChartInstance: null,
        nptChartInstance: null,
        savingsChartInstance: null,
        liveDataInterval: null,
        commercial: { afe: 0, actualCost: 0, serviceTickets: [], nptEvents: [] },
        ai: { selectedProblemId: null, selectedRecommendation: null },
        hse: { permits: [], riskRegister: [] },
        pob: { musterActive: false, musterInterval: null, personnel: [] },
        // Well-specific cost tracking
        wellCosts: {}  // { wellId: { jobSteps: [], totalCost: 0, nptCost: 0 } }
    };

    // --- HEROICONS HELPER ---
    // Heroicons v2 Outline icons - returns SVG markup
    const getIcon = (name, className = 'w-5 h-5') => {
        const icons = {
            // Navigation
            'home': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>',
            'clipboard': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>',
            'truck': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>',
            'currency-dollar': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            'shield-check': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>',
            'user-group': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>',
            'document-text': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>',
            'question-mark-circle': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            'user': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>',

            // Objectives & Problems
            'wrench-screwdriver': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" /></svg>',
            'beaker': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23-.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" /></svg>',
            'shield-exclamation': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z" /></svg>',
            'cube': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 7.353v9.294a1 1 0 01-.504.868l-8 4.632a1 1 0 01-.992 0l-8-4.632A1 1 0 013 16.647V7.353a1 1 0 01.504-.868l8-4.632a1 1 0 01.992 0l8 4.632A1 1 0 0121 7.353z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21v-9m0 0L3 7.5m9 4.5l9-4.5" /></svg>',
            'fire': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" /></svg>',

            // Status & Actions
            'exclamation-triangle': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>',
            'no-symbol': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>',
            'chart-bar': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>',
            'check-circle': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            'x-circle': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',

            // UI Actions
            'pencil': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>',
            'trash': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>',
            'plus': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v15m7.5-7.5h-15" /></svg>',
            'x-mark': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>',
            'arrow-down-tray': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>',
            'magnifying-glass': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>',
            'cog-6-tooth': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>',
            'sun': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>',
            'moon': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>',
            'bell': '<svg class="' + className + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>'
        };

        return icons[name] || icons['question-mark-circle']; // Default to question mark if icon not found
    };

    // --- DOM ELEMENTS ---

    const body = document.body;
    const appContainer = document.getElementById('app-container');
    const views = document.querySelectorAll('.view-container');
    const navLinks = document.querySelectorAll('.nav-link');
    const headerTitle = document.getElementById('header-title');
    const headerDetails = document.getElementById('header-details');
    const headerNav = document.getElementById('header-nav');
    
    // Planner

    const stepIndicators = { 
        1: document.getElementById('step-1-indicator'), 
        2: document.getElementById('step-2-indicator'), 
        3: document.getElementById('step-3-indicator') 
    };
    
    const stepConnectors = {
        1: document.getElementById('step-1-connector'),
        2: document.getElementById('step-2-connector')
    };
    
    const stepSections = { 
        1: document.getElementById('step-1'), 
        2: document.getElementById('step-2'), 
        3: document.getElementById('step-3') 
    };
    
    const wellSelectionGrid = document.getElementById('well-selection-grid');
    const objectivesFieldset = document.getElementById('objectives-fieldset');
    const problemsFieldset = document.getElementById('problems-fieldset');
    const generatePlanBtnManual = document.getElementById('generate-plan-btn-manual');
    const generatePlanBtnAi = document.getElementById('generate-plan-btn-ai');
    const planOutput = document.getElementById('plan-output');
    const startOverBtn = document.getElementById('start-over-btn');
    const beginOpBtn = document.getElementById('begin-op-btn');
    const aiToggle = document.getElementById('ai-toggle');
    const manualPlanningView = document.getElementById('manual-planning-view');
    const aiAdvisorView = document.getElementById('ai-advisor-view');
    const aiRecommendationsContainer = document.getElementById('ai-recommendations');

    // Performer

    const kpiGrid = document.getElementById('kpi-grid');
    const procedureStepsContainer = document.getElementById('procedure-steps');
    const logEntriesContainer = document.getElementById('log-entries'), 
    logInput = document.getElementById('log-input'), 
    addLogBtn = document.getElementById('add-log-btn');
    const chartCard = document.getElementById('chart-card');
    const performerControls = document.getElementById('performer-controls');
    const viewAnalysisBtn = document.getElementById('view-analysis-btn');

    // Analyzer

    const analyzerSubtitle = document.getElementById('analyzer-subtitle'), 
    summaryKpis = document.getElementById('summary-kpis'), 
    lessonsLearnedList = document.getElementById('lessons-learned-list'), 
    lessonInput = document.getElementById('lesson-input'), 
    addLessonBtn = document.getElementById('add-lesson-btn'), 
    planNewJobBtn = document.getElementById('plan-new-job-btn');

    // Logistics

    const logisticsSubtitle = document.getElementById('logistics-subtitle');
    const logisticsContent = document.getElementById('logistics-content');
    const equipmentTableBody = document.getElementById('equipment-table-body'), 
    personnelTableBody = document.getElementById('personnel-table-body');
    const equipmentSearch = document.getElementById('equipment-search'), 
    personnelSearch = document.getElementById('personnel-search');

    // Commercial

    const commercialContent = document.getElementById('commercial-content'), 
    commercialSubtitle = document.getElementById('commercial-subtitle');

    // HSE & POB

    const hseContent = document.getElementById('hse-content'), 
    hseSubtitle = document.getElementById('hse-subtitle');
    const pobContent = document.getElementById('pob-content'), 
    pobSubtitle = document.getElementById('pob-subtitle');

    // Modal

    const modal = document.getElementById('well-history-modal'), 
    modalTitle = document.getElementById('modal-title'), 
    modalContent = document.getElementById('modal-content'), 
    closeModalBtn = document.getElementById('close-modal-btn');
    
    // Theme

    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    
    // --- VIEW & STATE MANAGEMENT ---

    const switchView = (viewName) => {
        if (appState.liveDataInterval) {
            clearInterval(appState.liveDataInterval);
            appState.liveDataInterval = null;
        }

        appState.currentView = viewName;
        body.className = `theme-${localStorage.getItem('theme') || 'light'}`;
        if (viewName === 'performer') {
            body.classList.add('theme-dark');
        }

        views.forEach(v => v.classList.add('hidden'));
        document.getElementById(`${viewName}-view`).classList.remove('hidden');

        navLinks.forEach(l => l.classList.remove('active'));
        const activeLink = document.getElementById(`${viewName}-nav-link`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
        
        headerDetails.innerHTML = ''; 
        const theme = viewName === 'performer' ? 'dark' : localStorage.getItem('theme') || 'light';
        setTheme(theme);

        let viewTitle = viewName.charAt(0).toUpperCase() + viewName.slice(1);
        if(viewName === 'pob') viewTitle = 'POB & ER';
        if(viewName === 'hse') viewTitle = 'HSE & Risk';
        if(viewName === 'whitepaper') viewTitle = 'White Paper';
        headerTitle.textContent = `Well-Tegra: ${viewTitle}`;

        if (viewName === 'performer' && appState.selectedWell && appState.generatedPlan) {
            headerDetails.innerHTML = `<span id="job-status" class="text-lg font-semibold text-emerald-400">Ã¢â€”Â LIVE</span><div class="text-right"><p class="text-sm">Well: ${appState.selectedWell.name}</p><p class="text-sm">Job: ${appState.generatedPlan.name}</p></div>`;
            initializePerformer();
        } else if (['analyzer', 'commercial', 'hse', 'pob'].includes(viewName)) {
            if(appState.selectedWell && appState.generatedPlan) {
                headerDetails.innerHTML = `<div class="text-right"><p class="text-sm">Well: ${appState.selectedWell.name}</p><p class="text-sm">Job: ${appState.generatedPlan.name}</p></div>`;
            }
            if (viewName === 'commercial') renderCommercialView();
            if (viewName === 'hse') renderHSEView();
            if (viewName === 'pob') renderPOBView();
        } else if (viewName === 'logistics') {
            renderAssetManagementViews();
        } else if (viewName === 'faq') {
            initializeFaqAccordion();
        } else if (viewName === 'case-studies') {
            populateCaseStudiesGrid();
        }
    };
    
    const resetApp = (switchToHome = false) => {
        appState.selectedWell = null;
        appState.selectedObjective = null;
        appState.generatedPlan = null;
        appState.lessonsLearned = [];
        appState.commercial = { afe: 0, actualCost: 0, serviceTickets: [] };
        appState.ai = { selectedProblemId: null, selectedRecommendation: null };

        // Reset well selection
        document.querySelectorAll('.planner-card').forEach(c => c.classList.remove('selected'));

        // Clear cost summary
        updateCostSummary();
        
        // Reset objective selection
        const checkedObjective = document.querySelector('input[name="objective"]:checked');
        if(checkedObjective) { checkedObjective.checked = false; }
        
        // Reset problem selection
        const checkedProblem = document.querySelector('input[name="problem"]:checked');
        if(checkedProblem) { checkedProblem.checked = false; }
        
        // Reset buttons
        generatePlanBtnManual.disabled = true;
        generatePlanBtnAi.disabled = true;
        
        // Reset AI recommendations
        aiRecommendationsContainer.classList.add('hidden');
        
        // Reset AI toggle
        aiToggle.checked = false;
        manualPlanningView.classList.remove('hidden');
        aiAdvisorView.classList.add('hidden');
        
        switchView(switchToHome ? 'home' : 'planner');
        updatePlannerStepUI(1);
        updateNavLinks();
    };

    const updateNavLinks = () => {
        const planExists = !!appState.generatedPlan;
        navLinks.forEach(link => {
            const id = link.id.replace('-nav-link', '');
            if (id !== 'home' && id !== 'planner' && id !== 'case-studies' && id !== 'about' && id !== 'faq' && id !== 'whitepaper' && id !== 'security') {
                if (planExists) {
                    link.classList.remove('disabled');
                } else {
                    link.classList.add('disabled');
                }
            }
        });
    };

    // --- PLANNER LOGIC ---

    const renderWellCards = () => {
        if (!wellSelectionGrid) return; // Skip if element doesn't exist
        wellSelectionGrid.innerHTML = wellData.map(well => {
            const isWellFromHell = well.id === 'Well_666';
            const statusClass = well.status.toLowerCase().replace(/[\s-]/g, '');
            const statusColor = isWellFromHell ? 'text-red-600 dark:text-red-400' : 'text-teal-600 dark:text-teal-400';

            return `
                <div class="well-card-enhanced planner-card light-card ${isWellFromHell ? 'border-red-500' : 'border-gray-200'}" data-well-id="${well.id}">
                    <div class="card-header ${isWellFromHell ? 'bg-red-500' : 'bg-blue-500'}">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-white">${well.name}</h3>
                            ${isWellFromHell ? '<span class="bg-red-700 text-white text-xs px-2 py-1 rounded-full">CRITICAL</span>' : '<span class="bg-blue-700 text-white text-xs px-2 py-1 rounded-full">CASE STUDY</span>'}
                        </div>
                        <p class="text-sm text-blue-100">${well.field} - ${well.type}</p>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <span class="inline-block px-2 py-1 text-xs font-medium rounded-full status-${statusClass}">${well.status}</span>
                        </div>
                        <p class="text-sm">${well.issue}</p>
                    </div>
                    <div class="card-footer">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500">Depth: ${well.depth}</span>
                            <button class="view-details-btn text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200 font-semibold" data-well-id="${well.id}">View Details</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    };

    const populateCaseStudiesGrid = () => {
        const caseStudiesGrid = document.getElementById('case-studies-grid');
        if (!caseStudiesGrid) return;

        caseStudiesGrid.innerHTML = wellData.map(well => {
            const isWellFromHell = well.id === 'Well_666';
            const statusClass = well.status.toLowerCase().replace(/[\s-]/g, '');
            const bgColor = isWellFromHell ? 'bg-red-900/30' : 'bg-slate-800/30';
            const borderColor = isWellFromHell ? 'border-red-500' : 'border-cyan-500/30';
            const badge = isWellFromHell ?
                '<span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full">PROBLEM WELL</span>' :
                '<span class="px-2 py-1 bg-green-600 text-white text-xs font-bold rounded-full">SOLVED</span>';

            return `
                <div class="${bgColor} border ${borderColor} rounded-lg p-6 hover:border-cyan-400 transition-colors cursor-pointer shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-white">${well.name}</h3>
                            <p class="text-sm text-slate-400 mt-1">${well.field} | ${well.type}</p>
                        </div>
                        ${badge}
                    </div>

                    <div class="mb-4">
                        <span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${
                            isWellFromHell ? 'bg-red-600/50 text-red-200' : 'bg-green-600/50 text-green-200'
                        }">${well.status}</span>
                    </div>

                    <p class="text-sm text-slate-300 mb-4">${well.issue}</p>

                    <div class="flex items-center justify-between text-xs text-slate-400 mb-4">
                        <span>Depth: ${well.depth}</span>
                        <span>${well.history?.length || 0} events</span>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="openCaseStudyDetail('${well.id}')" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold rounded transition">
                            View Full Details
                        </button>
                        <button onclick="openModal('${well.id}')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-semibold rounded transition">
                            3D View
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    };

    const selectWellW666 = () => {
        const w666 = wellData.find(w => w.id === 'Well_666');
        if (!w666) return;

        appState.selectedWell = w666;
        updatePlannerStepUI(2);
        renderProblems();
    };

    const renderObjectives = () => { 
        objectivesFieldset.innerHTML = objectivesData.map(obj => `
            <div class="objective-card light-card" data-objective-id="${obj.id}">
                <input type="radio" name="objective" id="${obj.id}" value="${obj.id}" class="sr-only">
                <label for="${obj.id}" class="cursor-pointer h-full">
                    <div class="flex items-start">
                        <span class="mr-3">${getIcon(obj.icon, 'w-6 h-6')}</span>
                        <div>
                            <span class="font-semibold text-lg">${obj.name}</span>
                            <p class="text-sm mt-1">${obj.description}</p>
                        </div>
                    </div>
                </label>
            </div>
        `).join(''); 
    };

    const renderProblems = () => {
        // Only show problems relevant to the "Well From Hell"
        if (appState.selectedWell && appState.selectedWell.id === 'Well_666') {
             problemsFieldset.innerHTML = problemsData.map(prob => `
                <div class="objective-card light-card" data-problem-id="${prob.id}">
                    <input type="radio" name="problem" id="${prob.id}" value="${prob.id}" class="sr-only">
                    <label for="${prob.id}" class="cursor-pointer h-full">
                        <div class="flex items-start">
                            <span class="mr-3">${getIcon(prob.icon, 'w-6 h-6')}</span>
                            <div>
                                <span class="font-semibold text-lg">${prob.name}</span>
                                <p class="text-sm mt-1">${prob.description}</p>
                            </div>
                        </div>
                    </label>
                </div>
            `).join('');
        } else {
            problemsFieldset.innerHTML = `
                <div class="bg-yellow-50 dark:bg-yellow-900/50 p-6 rounded-lg text-center">
                    <p class="text-yellow-800 dark:text-yellow-200">Please select the 'Well From Hell' (Well_666) to use the AI Advisor.</p>
                </div>
            `;
        }
    };

    const renderPlan = () => {
        const well = appState.selectedWell, 
        procedure = appState.generatedPlan, 
        riskLabels = ['Operational', 'Geological', 'Equipment', 'HSE', 'Financial'], 
        riskData = Object.values(procedure.risks);
        
        const getRiskTag = (level) => { 
            if (level <= 2) return `<span class="risk-badge risk-low">Low</span>`; 
            if (level <= 3) return `<span class="risk-badge risk-medium">Medium</span>`; 
            return `<span class="risk-badge risk-high">High</span>`; 
        };
        
        const logisticsConflicts = checkLogistics();
        let logisticsHtml = logisticsConflicts.length > 0 ? `
            <div class="plan-summary-card light-card overflow-hidden">
                <div class="card-header bg-red-500">
                    <h4 class="text-xl font-semibold text-white">Logistics & Resource Conflicts</h4>
                </div>
                <div class="p-6">
                    <ul class="space-y-2">
                        ${logisticsConflicts.map(c => `
                            <li class="flex items-start p-3 rounded-md bg-red-50 dark:bg-red-900/50 border-l-4 border-red-400">
                                <span class="text-red-600 mr-2">${getIcon('exclamation-triangle', 'w-5 h-5')}</span>
                                <span class="text-red-800 dark:text-red-300">${c}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        ` : '';
        
        const equipmentList = equipmentRequirements[appState.selectedObjective.id];
        let equipmentHtml = `
            <div class="plan-summary-card light-card overflow-hidden">
                <div class="card-header bg-blue-500">
                    <h4 class="text-xl font-semibold text-white">Equipment Requirements</h4>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        ${equipmentList.map(item => `
                            <div class="equipment-card">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500 mr-4" ${item.source !== 'Vendor' ? 'checked disabled' : ''}>
                                        <div>
                                            <p class="font-semibold">${item.name}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                                Source: ${item.source}
                                            </p>
                                        </div>
                                    </div>
                                    <p class="font-semibold text-sm">${item.price > 0 ? `$${item.price.toLocaleString()}` : 'N/A'}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        // Create timeline for procedure steps
        const timelineHtml = `
            <div class="plan-summary-card light-card overflow-hidden">
                <div class="card-header bg-green-500">
                    <h4 class="text-xl font-semibold text-white">Procedure Timeline</h4>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        ${procedure.steps.map((step, index) => `
                            <div class="timeline-step">
                                <h5 class="font-semibold">Step ${index + 1}</h5>
                                <p class="text-sm">${step}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        // Create risk assessment visualization
        const riskHtml = `
            <div class="plan-summary-card light-card overflow-hidden">
                <div class="card-header bg-purple-500">
                    <h4 class="text-xl font-semibold text-white">Risk Assessment</h4>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div class="space-y-3">
                            ${riskLabels.map((label, i) => `
                                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                    <span class="font-medium">${label}</span>
                                    ${getRiskTag(riskData[i])}
                                </div>
                            `).join('')}
                        </div>
                        <div class="h-64 md:h-80">
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Cost estimation
        const costHtml = `
            <div class="plan-summary-card light-card overflow-hidden">
                <div class="card-header bg-yellow-500">
                    <h4 class="text-xl font-semibold text-white">Cost Estimation</h4>
                </div>
                <div class="p-6">
                    <div class="space-y-2">
                        <div class="cost-estimation">
                            <span class="label">Estimated Duration:</span>
                            <span class="value">${procedure.duration} days</span>
                        </div>
                        <div class="cost-estimation">
                            <span class="label">Estimated Cost (AFE):</span>
                            <span class="value">$${procedure.cost.toLocaleString()}</span>
                        </div>
                        <div class="cost-estimation">
                            <span class="label">Daily Cost:</span>
                            <span class="value">$${Math.round(procedure.cost / procedure.duration).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        planOutput.innerHTML = `
            <div class="plan-summary-card light-card overflow-hidden mb-8">
                <div class="card-header bg-gradient-to-r from-blue-600 to-teal-500">
                    <h3 class="text-2xl font-bold text-white">Intervention Plan: ${well.name}</h3>
                    <p class="text-lg text-blue-100">${appState.selectedObjective.name}</p>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                            <p class="text-sm font-medium">Selected Well</p>
                            <p class="text-lg font-semibold">${well.name}</p>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                            <p class="text-sm font-medium">Est. Duration</p>
                            <p class="text-lg font-semibold">${procedure.duration} days</p>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                            <p class="text-sm font-medium">Est. Cost (AFE)</p>
                            <p class="text-lg font-semibold">$${procedure.cost.toLocaleString()}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                ${timelineHtml}
                ${equipmentHtml}
            </div>
            
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                ${riskHtml}
                ${costHtml}
            </div>
            
            ${logisticsHtml}
        `;
        
        // Initialize risk chart
        const riskChartCtx = document.getElementById('riskChart');
        if (riskChartCtx) {
            const chartTheme = getChartThemeOptions();
            new Chart(riskChartCtx.getContext('2d'), { 
                type: 'radar', 
                data: { 
                    labels: riskLabels, 
                    datasets: [{ 
                        label: 'Risk Level', 
                        data: riskData, 
                        backgroundColor: 'rgba(139, 92, 246, 0.2)', 
                        borderColor: 'rgba(139, 92, 246, 1)', 
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(139, 92, 246, 1)'
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        r: { 
                            suggestedMin: 0, 
                            suggestedMax: 5, 
                            ticks: { 
                                display: false,
                                stepSize: 1
                            }, 
                            grid: { 
                                color: chartTheme.scales.x.grid.color 
                            }, 
                            angleLines: { 
                                color: chartTheme.scales.x.grid.color 
                            }, 
                            pointLabels: { 
                                color: chartTheme.scales.x.ticks.color,
                                font: {
                                    size: 12
                                }
                            } 
                        } 
                    }, 
                    plugins: { 
                        legend: { 
                            display: false 
                        }
                    }
                } 
            });
        }
        
        updateNavLinks();
    };

    const updatePlannerStepUI = (currentStep) => { 
        // Reset all step indicators and connectors
        Object.values(stepIndicators).forEach(ind => {
            ind.classList.remove('active', 'completed');
            ind.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-500');
        });
        
        Object.values(stepConnectors).forEach(conn => {
            conn.classList.remove('active', 'completed');
        });
        
        // Mark completed steps
        for (let i = 1; i < currentStep; i++) {
            stepIndicators[i].classList.add('completed');
            stepIndicators[i].classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-500');
            stepIndicators[i].classList.add('bg-blue-600', 'text-white');
            
            if (stepConnectors[i]) {
                stepConnectors[i].classList.add('completed');
                stepConnectors[i].classList.remove('bg-gray-200');
                stepConnectors[i].classList.add('bg-blue-600');
            }
        }
        
        // Mark active step
        stepIndicators[currentStep].classList.add('active');
        stepIndicators[currentStep].classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-500');
        stepIndicators[currentStep].classList.add('bg-blue-600', 'text-white');
        
        // Show/hide step sections
        Object.keys(stepSections).forEach(key => {
            stepSections[key].classList.toggle('hidden', key != currentStep);
        });
    };

    // --- PERFORMER LOGIC ---

    const initializePerformer = () => {
        const isSlickline = appState.generatedPlan.name.toLowerCase().includes('slickline');
        
        kpiGrid.innerHTML = `
            <div id="kpi-weight-card" class="kpi-card p-4 flex flex-col items-center justify-center"></div>
            <div id="kpi-pressure-card" class="kpi-card p-4 flex flex-col items-center justify-center"></div>
            <div id="kpi-annulus-card" class="kpi-card p-4 flex flex-col items-center justify-center"></div>
            <div id="kpi-speed-card" class="kpi-card p-4 flex flex-col items-center justify-center"></div>
            <div id="kpi-depth-card" class="kpi-card p-4 flex flex-col items-center justify-center"></div>
        `;
        kpiGrid.className = 'grid grid-cols-2 md:grid-cols-5 gap-4 lg:gap-6';

        if (isSlickline) {
            createRadialGauge('kpi-weight-card', 'Weight', 'lbs', 2000);
            document.getElementById('kpi-pressure-card').style.display = 'none';
            document.getElementById('kpi-annulus-card').style.display = 'none';
            kpiGrid.className = 'grid grid-cols-2 md:grid-cols-3 gap-4 lg:gap-6';
        } else {
            createRadialGauge('kpi-weight-card', 'Hookload', 'klbf', 100);
            createRadialGauge('kpi-pressure-card', 'Tubing Pressure', 'psi', 5000);
            createRadialGauge('kpi-annulus-card', 'Annulus Pressure', 'psi', 3000);
        }
        createBarGauge('kpi-speed-card', 'Line Speed', 'ft/min', 150);
        createRadialGauge('kpi-depth-card', 'Depth', 'ft', 18500);

        appState.liveData = { 
            depth: 0, 
            hookload: 0, 
            pressure: 0, 
            annulusPressure: 1500, 
            speed: 0, 
            currentStep: 1, 
            isRIH: true, 
            jobRunning: true, 
            alarmState: false, 
            npt: { weather: 0, equipment: 0, operational: 0 }, 
            opTime: 0, 
            stepStartTime: Date.now() 
        };
        
        appState.logEntries = [{ 
            time: new Date(), 
            user: 'System', 
            text: 'Job initiated.' 
        }];
        
        appState.generatedPlan.procedure = appState.generatedPlan.steps.map((s, i) => ({ 
            id: i + 1, 
            text: s, 
            completed: false, 
            active: false 
        }));
        
        if (appState.tfaChartInstance) {
            appState.tfaChartInstance.destroy();
            appState.tfaChartInstance = null;
        }
        
        chartCard.style.display = isSlickline ? 'none' : 'flex';
        
        if (!isSlickline) {
            const chartCtx = document.getElementById('tfaChart').getContext('2d');
            const chartThemeOptions = getChartThemeOptions();
            chartThemeOptions.scales.y.title.text = 'Hookload (klbf)';
            appState.tfaChartInstance = new Chart(chartCtx, { 
                type: 'line', 
                data: { 
                    datasets: [ 
                        { 
                            label: 'Planned Pick-up', 
                            data: appState.generatedPlan.tfaModel.pickUp.map(p => ({x: p[0], y: p[1]})), 
                            borderColor: 'rgba(52, 211, 153, 0.8)', 
                            borderWidth: 2, 
                            pointRadius: 0, 
                            tension: 0.1 
                        }, 
                        { 
                            label: 'Planned Slack-off', 
                            data: appState.generatedPlan.tfaModel.slackOff.map(p => ({x: p[0], y: p[1]})), 
                            borderColor: 'rgba(96, 165, 250, 0.8)', 
                            borderWidth: 2, 
                            pointRadius: 0, 
                            tension: 0.1 
                        }, 
                        { 
                            label: 'Upper Alarm', 
                            data: appState.generatedPlan.tfaModel.alarmUpper.map(p => ({x: p[0], y: p[1]})), 
                            borderColor: 'rgba(239, 68, 68, 0.4)', 
                            borderWidth: 1, 
                            pointRadius: 0, 
                            borderDash: [5, 5], 
                            fill: '+1' 
                        }, 
                        { 
                            label: 'Lower Alarm', 
                            data: appState.generatedPlan.tfaModel.alarmLower.map(p => ({x: p[0], y: p[1]})), 
                            borderColor: 'rgba(239, 68, 68, 0.4)', 
                            borderWidth: 1, 
                            pointRadius: 0, 
                            borderDash: [5, 5], 
                            backgroundColor: 'rgba(239, 68, 68, 0.1)', 
                            fill: '-1' 
                        }, 
                        { 
                            label: 'Actual Hookload', 
                            data: [], 
                            borderColor: '#f59e0b', 
                            borderWidth: 3, 
                            pointRadius: 0, 
                            tension: 0.1 
                        } 
                    ] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    ...chartThemeOptions 
                } 
            });
        }
        
        renderPerformerProcedure(); 
        renderPerformerLog();
        updatePerformerState();
        
        performerControls.classList.add('hidden');

        if (appState.liveDataInterval) clearInterval(appState.liveDataInterval);
        appState.liveDataInterval = setInterval(simulateLiveData, 1000);
    };
    
    const simulateLiveData = () => {
        if (!appState.liveData.jobRunning) {
            clearInterval(appState.liveDataInterval);
            appState.liveDataInterval = null;
            return;
        }

        const step = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep);
        if (!step) return;

        const stepText = step.text.toLowerCase();
        const targetDepth = 18500;
        let isMoving = false;

        if (stepText.includes('rih')) {
            isMoving = true;
            appState.liveData.speed = 100 + Math.random() * 10 - 5;
            appState.liveData.depth = Math.min(targetDepth, appState.liveData.depth + appState.liveData.speed / 60 * 2); // Simulate 2 sec interval
            if (appState.liveData.depth >= targetDepth) {
                advancePerformerStep();
            }
        } else if (stepText.includes('pooh')) {
            isMoving = true;
            appState.liveData.speed = -100 + Math.random() * 10 - 5;
            appState.liveData.depth = Math.max(0, appState.liveData.depth + appState.liveData.speed / 60 * 2);
             if (appState.liveData.depth <= 0) {
                advancePerformerStep();
            }
        } else if (stepText.includes('spot') || stepText.includes('pump') || stepText.includes('circulate')) {
            isMoving = false;
            appState.liveData.speed = 0;
            appState.liveData.pressure = Math.min(2500, appState.liveData.pressure + 250);
            appState.liveData.annulusPressure += 50;
        } else {
             isMoving = false;
             appState.liveData.speed = 0;
             appState.liveData.pressure = Math.max(0, appState.liveData.pressure - 250);
             appState.liveData.annulusPressure = Math.max(1500, appState.liveData.annulusPressure - 50);
        }
        
        if (!isMoving && (Date.now() - appState.liveData.stepStartTime > 2000)) {
            advancePerformerStep();
        }
        
        const modelPoints = appState.liveData.isRIH ? appState.generatedPlan.tfaModel.slackOff : appState.generatedPlan.tfaModel.pickUp;
        appState.liveData.hookload = interpolate(modelPoints, appState.liveData.depth) + (Math.random() * 2 - 1);
        if(appState.liveData.depth > 6000 && appState.liveData.depth < 7000 && appState.liveData.isRIH) { 
            appState.liveData.hookload -= 5; 
            appState.liveData.npt.operational += 0.005; 
        }
        
        updatePerformerState();
    };

    const updatePerformerState = () => {
        if (!appState.liveData || !appState.generatedPlan) return;
        const isSlickline = appState.generatedPlan.name.toLowerCase().includes('slickline');

        const upperLimit = interpolate(appState.generatedPlan.tfaModel.alarmUpper, appState.liveData.depth);
        const lowerLimit = interpolate(appState.generatedPlan.tfaModel.alarmLower, appState.liveData.depth);
        
        if (appState.liveData.hookload > upperLimit || appState.liveData.hookload < lowerLimit) { 
            if (!appState.liveData.alarmState) { 
                addLogEntry('System', 'ALARM: Primary tension outside envelope!'); 
                appState.liveData.alarmState = true; 
                if (!isSlickline) chartCard.classList.add('alarm'); 
                appState.liveData.npt.equipment += 0.01; 
            } 
        } else { 
            if (appState.liveData.alarmState) { 
                addLogEntry('System', 'INFO: Primary tension back in envelope.'); 
                appState.liveData.alarmState = false; 
                if (!isSlickline) chartCard.classList.remove('alarm'); 
            } 
        }

        if (isSlickline) {
            updateRadialGauge('kpi-weight-card', appState.liveData.hookload * 1000, 2000);
        } else {
            updateRadialGauge('kpi-weight-card', appState.liveData.hookload, 100);
            updateRadialGauge('kpi-pressure-card', appState.liveData.pressure, 5000);
            updateRadialGauge('kpi-annulus-card', appState.liveData.annulusPressure, 3000);
        }
        updateBarGauge('kpi-speed-card', appState.liveData.speed, 150);
        updateRadialGauge('kpi-depth-card', appState.liveData.depth, 18500);
        
        if (appState.tfaChartInstance) {
            const actualData = appState.tfaChartInstance.data.datasets[4].data;
            actualData.push({ x: appState.liveData.depth, y: appState.liveData.hookload }); 
            actualData.sort((a, b) => a.x - b.x);
            if (actualData.length > 500) {
                actualData.splice(0, actualData.length - 500);
            }
            appState.tfaChartInstance.update('none');
        }
    };

    const renderPerformerProcedure = () => {
        const currentStepId = appState.liveData.currentStep;
        procedureStepsContainer.innerHTML = appState.generatedPlan.procedure.map(step => `
            <div id="step-${step.id}" data-step-id="${step.id}" class="procedure-step p-3 rounded-md ${step.completed ? 'completed' : ''} ${currentStepId === step.id ? 'active' : ''}">
                <p class="font-semibold text-sm">${step.id}. ${step.text}</p>
            </div>
        `).join('');
        
        const activeStepElement = document.getElementById(`step-${currentStepId}`);
        if (activeStepElement) { 
            activeStepElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
        }
    };

    const renderPerformerLog = () => { 
        logEntriesContainer.innerHTML = appState.logEntries.slice().reverse().map(entry => `
            <div class="log-entry p-2">
                <p class="text-xs text-gray-400">${entry.time.toLocaleTimeString()} - ${entry.user}</p>
                <p class="text-sm">${entry.text}</p>
            </div>
        `).join(''); 
        logEntriesContainer.scrollTop = 0; 
    };

    const addLogEntry = (user, text) => { 
        if (!text.trim()) return; 
        appState.logEntries.push({ 
            time: new Date(), 
            user, 
            text 
        }); 
        renderPerformerLog(); 
    };

    const advancePerformerStep = () => {
        const current = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep); 
        if (current) current.completed = true;
        
        if (appState.liveData.currentStep < appState.generatedPlan.procedure.length) {
            appState.liveData.currentStep++; 
            const next = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep); 
            addLogEntry('System', `Starting Step ${next.id}: ${next.text}`); 
            appState.liveData.isRIH = next.text.toLowerCase().includes('rih');
            appState.liveData.stepStartTime = Date.now();
        } else { 
            appState.liveData.jobRunning = false; 
            addLogEntry('System', 'Job procedure complete.'); 
            document.getElementById('job-status').textContent = "Ã¢â€”Â JOB COMPLETE"; 
            document.getElementById('job-status').classList.replace('text-emerald-400', 'text-gray-500'); 
            performerControls.classList.remove('hidden'); 
        }
        
        renderPerformerProcedure();
    };

    const jumpToStep = (targetStepId) => {
        addLogEntry('Operator', `Jumping forward to Step ${targetStepId}.`);
        
        for (let i = appState.liveData.currentStep; i < targetStepId; i++) {
            const stepToComplete = appState.generatedPlan.procedure.find(s => s.id === i);
            if (stepToComplete) {
                stepToComplete.completed = true;
            }
        }
        
        appState.liveData.currentStep = targetStepId;
        const newStep = appState.generatedPlan.procedure.find(s => s.id === targetStepId);
        addLogEntry('System', `Starting Step ${targetStepId}: ${newStep.text}`);
        
        let lastDepth = appState.liveData.depth;
        const previousStep = appState.generatedPlan.procedure.find(s => s.id === targetStepId - 1);
        if (previousStep) {
            const prevStepText = previousStep.text.toLowerCase();
            if (prevStepText.includes('rih')) { lastDepth = 18500; }
            else if (prevStepText.includes('pooh')) { lastDepth = 0; }
        }
        
        appState.liveData.depth = lastDepth;
        appState.liveData.stepStartTime = Date.now();
        updatePerformerState();
        renderPerformerProcedure();
    };

    function interpolate(points, x) { 
        for (let i = 0; i < points.length - 1; i++) { 
            if (x >= points[i][0] && x <= points[i+1][0]) { 
                return points[i][1] + (points[i+1][1] - points[i][1]) * (x - points[i][0]) / (points[i+1][0] - points[i][0]); 
            } 
        } 
        return points[points.length - 1][1]; 
    }

    // --- ANALYZER LOGIC ---

    const initializeAnalyzer = () => {
        analyzerSubtitle.textContent = `Analysis for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
        const plannedDuration = appState.generatedPlan.duration;
        const actualDuration = plannedDuration + appState.liveData.npt.weather + appState.liveData.npt.equipment + appState.liveData.npt.operational;
        const plannedCost = appState.generatedPlan.cost;
        const actualCost = appState.commercial.actualCost;
        
        const renderKPI = (label, plan, actual) => `
            <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                <p class="text-sm font-medium">${label}</p>
                <p class="text-lg font-semibold">${actual} <span class="text-sm font-normal">(Plan: ${plan})</span></p>
            </div>
        `;
        
        summaryKpis.innerHTML = renderKPI('Job Duration (Days)', plannedDuration.toFixed(1), actualDuration.toFixed(1)) + 
                              renderKPI('Total Cost (USD)', `$${plannedCost.toLocaleString()}`, `$${actualCost.toLocaleString()}`);
        
        if (appState.nptChartInstance) appState.nptChartInstance.destroy();
        
        const nptCtx = document.getElementById('nptChart');
        if (nptCtx) {
            const chartThemeOptions = getChartThemeOptions();
            appState.nptChartInstance = new Chart(nptCtx.getContext('2d'), { 
                type: 'doughnut', 
                data: { 
                    labels: ['Weather', 'Equipment Failure', 'Operational Inefficiency'], 
                    datasets: [{ 
                        data: [appState.liveData.npt.weather, appState.liveData.npt.equipment, appState.liveData.npt.operational], 
                        backgroundColor: ['#3b82f6', '#f97316', '#ef4444'], 
                        borderColor: body.classList.contains('theme-dark') ? '#0f172a' : 'white', 
                        borderWidth: 4 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                color: chartThemeOptions.plugins.legend.labels.color 
                            } 
                        } 
                    } 
                } 
            });
        }
        
        renderLessons();
    };

    const renderLessons = () => { 
        lessonsLearnedList.innerHTML = appState.lessonsLearned.length ? 
            appState.lessonsLearned.map(lesson => `
                <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-md">
                    <p>${lesson}</p>
                </div>
            `).join('') : 
            '<p class="text-center">No lessons learned have been added for this job.</p>'; 
    };
    
    // --- ASSET & POB LOGIC ---

    const renderAssetManagementViews = (eqFilter = '', persFilter = '') => {
        if (!appState.generatedPlan) {
            logisticsSubtitle.textContent = "Please generate a plan in the Planner to view job-specific logistics.";
            logisticsContent.innerHTML = `
                <div class="text-center col-span-2 light-card p-8 rounded-lg">
                    <p>No plan is currently active. Please use the Planner module to generate an intervention plan, and the required tooling and personnel will be displayed here.</p>
                </div>
            `;
            return;
        }
        
        logisticsSubtitle.textContent = `Logistics for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
        
        const requiredEquipment = equipmentRequirements[appState.selectedObjective.id];
        const requiredRoles = appState.generatedPlan.personnel;

        const eqF = eqFilter.toLowerCase();
        const filteredEquipment = equipmentData.filter(e => 
            requiredEquipment.some(req => req.name === e.type) && 
            (e.id.toLowerCase().includes(eqF) || e.type.toLowerCase().includes(eqF))
        );
        
        equipmentTableBody.innerHTML = filteredEquipment.map(e => `
            <tr>
                <td class="p-2">${e.id}</td>
                <td class="p-2">${e.type}</td>
                <td class="p-2">${e.location}</td>
                <td class="p-2">
                    <span class="px-2 py-1 text-xs font-medium rounded-full status-${e.status.toLowerCase()}">${e.status}</span>
                </td>
                <td class="p-2">
                    <button class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full hover:bg-blue-200 disabled:opacity-50" 
                            ${e.location === 'Onboard - Pump Room' && e.testStatus === 'Pending' ? '' : 'disabled'}>
                        Test
                    </button>
                </td>
            </tr>
        `).join('');

        const persF = persFilter.toLowerCase();
        const filteredPersonnel = personnelData.filter(p => 
            requiredRoles.includes(p.role) && 
            (p.name.toLowerCase().includes(persF) || p.role.toLowerCase().includes(persF))
        );
        
        personnelTableBody.innerHTML = filteredPersonnel.map(p => `
            <tr>
                <td class="p-2">${p.name}</td>
                <td class="p-2">${p.role}</td>
                <td class="p-2">
                    <span class="px-2 py-1 text-xs font-medium rounded-full status-${p.status.toLowerCase().replace(/\s/g, '')}">${p.status}</span>
                </td>
                <td class="p-2">${p.certsValid ? 'Ã¢Å“â€¦ Valid' : 'Ã¢ÂÅ’ Expired'}</td>
            </tr>
        `).join('');
    };

    const checkLogistics = () => {
        const conflicts = [];
        const requiredEquipment = equipmentRequirements[appState.selectedObjective.id];

        requiredEquipment.forEach(req => {
            if (req.source === 'Vendor') {
                const availableTool = equipmentData.find(e => e.type === req.name && e.status === 'Available');
                if (!availableTool) {
                    conflicts.push(`No available equipment of type: <strong>${req.name}</strong>. Must be ordered from vendor.`);
                }
            }
        });

        appState.generatedPlan.personnel.forEach(roleName => {
            const availablePerson = personnelData.find(p => p.role === roleName && p.status === 'Available');
            if (!availablePerson) {
                conflicts.push(`No available personnel for role: <strong>${roleName}</strong>.`);
            } else if (!availablePerson.certsValid) {
                conflicts.push(`Personnel <strong>${availablePerson.name} (${roleName})</strong> has expired certifications.`);
            }
        });
        
        return conflicts;
    };

    const renderPOBView = () => {
        if (!appState.generatedPlan) {
            pobSubtitle.textContent = "Please generate a plan in the Planner to view job-specific POB.";
            pobContent.innerHTML = `
                <div class="text-center light-card p-8 rounded-lg">
                    <p>No plan is currently active. Please use the Planner module to generate an intervention plan, and the required personnel for that job will be displayed here.</p>
                </div>
            `;
            return;
        }

        const requiredPersonnel = personnelData.filter(p => appState.generatedPlan.personnel.includes(p.role));
        appState.pob.personnel = JSON.parse(JSON.stringify(requiredPersonnel)).map(p => ({
            ...p, 
            musterStatus: 'Unaccounted'
        }));
        
        pobSubtitle.textContent = `Live POB manifest for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;

        const totalPOB = appState.pob.personnel.length;
        const musteredCount = appState.pob.personnel.filter(p => p.musterStatus === 'Mustered').length;
        
        musterStations.forEach(ms => { 
            ms.current = appState.pob.personnel.filter(p => p.muster === ms.id && p.musterStatus === 'Mustered').length; 
        });
        
        const summaryHtml = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="light-card p-6 text-center rounded-lg">
                    <p class="text-sm font-medium">Total POB</p>
                    <p class="text-4xl font-bold">${totalPOB}</p>
                </div>
                <div class="light-card p-6 text-center rounded-lg">
                    <p class="text-sm font-medium">Accounted For</p>
                    <p class="text-4xl font-bold text-green-600">${musteredCount}</p>
                </div>
                <div class="light-card p-6 text-center rounded-lg">
                    <p class="text-sm font-medium">Unaccounted For</p>
                    <p class="text-4xl font-bold text-red-600">${totalPOB - musteredCount}</p>
                </div>
            </div>
        `;
        
        const musterStationHtml = musterStations.map(ms => `
            <div class="light-card p-4 rounded-lg">
                <h4 class="font-semibold">${ms.name}</h4>
                <p class="text-sm">Capacity: ${ms.capacity}</p>
                <p class="text-2xl font-bold">${ms.current}</p>
            </div>
        `).join('');
        
        const pobTableHtml = `
            <div class="light-card p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4">Live POB Manifest</h3>
                <div class="h-96 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="table-header sticky top-0">
                            <tr>
                                <th class="p-2">Name</th>
                                <th class="p-2">Company</th>
                                <th class="p-2">Role</th>
                                <th class="p-2">Muster Station</th>
                                <th class="p-2">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appState.pob.personnel.map(p => `
                                <tr class="border-b table-row-alt dark:border-gray-700">
                                    <td class="p-2">${p.name}</td>
                                    <td class="p-2">${p.company}</td>
                                    <td class="p-2">${p.role}</td>
                                    <td class="p-2">${p.muster}</td>
                                    <td class="p-2">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full status-${p.musterStatus.toLowerCase().replace(' ', '')}">${p.musterStatus}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        pobContent.innerHTML = `
            ${summaryHtml}
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-2">${pobTableHtml}</div>
                <div>
                    <div class="light-card p-6 rounded-lg">
                        <h3 class="text-xl font-semibold mb-4">Muster Stations</h3>
                        <div class="grid grid-cols-2 gap-4">${musterStationHtml}</div>
                    </div>
                    <div class="mt-8">
                        <button id="muster-drill-btn" class="w-full rounded-md ${appState.pob.musterActive ? 'bg-red-600 hover:bg-red-500' : 'bg-yellow-500 hover:bg-yellow-400'} px-6 py-3 text-base font-semibold text-white shadow-sm">
                            ${appState.pob.musterActive ? 'End Muster Drill' : 'Simulate Emergency Muster'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('muster-drill-btn').addEventListener('click', toggleMusterDrill);
    };

    const toggleMusterDrill = () => {
        appState.pob.musterActive = !appState.pob.musterActive;
        
        if (appState.pob.musterActive) {
            headerNav.classList.add('emergency-header');
            appState.pob.musterInterval = setInterval(() => {
                const unaccounted = appState.pob.personnel.filter(p => p.musterStatus === 'Unaccounted');
                if (unaccounted.length > 0) {
                    unaccounted[Math.floor(Math.random() * unaccounted.length)].musterStatus = 'Mustered';
                    renderPOBView();
                } else {
                    clearInterval(appState.pob.musterInterval);
                }
            }, 1000);
        } else {
            clearInterval(appState.pob.musterInterval);
            headerNav.classList.remove('emergency-header');
        }
        
        renderPOBView();
    };

    // --- COMMERCIAL & HSE LOGIC ---

    const initializeCommercial = () => {
        if (!appState.generatedPlan) { 
            commercialContent.innerHTML = `
                <div class="text-center light-card p-8 rounded-lg">
                    <p>No plan is currently active. Please use the Planner module to generate an intervention plan, and the associated financial data will be displayed here.</p>
                </div>
            `;
            commercialSubtitle.textContent = "No active operation."
            return; 
        }
        
        commercialSubtitle.textContent = `Live financial tracking for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
        appState.commercial.afe = appState.generatedPlan.cost;
        appState.commercial.actualCost = 0;
        appState.commercial.serviceTickets = [];
        
        const equipmentList = equipmentRequirements[appState.selectedObjective.id] || [];
        equipmentList.forEach(item => {
            if (item.price > 0) {
                const cost = item.price * appState.generatedPlan.duration;
                appState.commercial.serviceTickets.push({ 
                    description: `Rental: ${item.name}`, 
                    cost: cost, 
                    validated: true 
                });
                appState.commercial.actualCost += cost;
            }
        });
        
        renderCommercialView();
    };

    const renderCommercialView = () => {
        if (!appState.generatedPlan) {
            initializeCommercial();
            return;
        }
        
        const afe = appState.commercial.afe, 
        actual = appState.commercial.actualCost;
        const burnPercent = afe > 0 ? Math.min(100, (actual / afe) * 100) : 0;
        const burnColor = burnPercent > 90 ? 'bg-red-500' : burnPercent > 75 ? 'bg-yellow-500' : 'bg-teal-500';
        
        commercialContent.innerHTML = `
            <div class="grid gap-8 lg:grid-cols-3">
                <div class="lg:col-span-2 light-card p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4">Live AFE vs. Actual</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between font-bold text-lg">
                            <span>Actual Cost</span>
                            <span>$${actual.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                            <div class="${burnColor} h-4 rounded-full" style="width: ${burnPercent}%"></div>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Budget (AFE): $${afe.toLocaleString()}</span>
                            <span>${burnPercent.toFixed(1)}% Used</span>
                        </div>
                    </div>
                    <h3 class="text-xl font-semibold mt-8 mb-4">Automated Service Tickets</h3>
                    <div class="h-64 overflow-y-auto border dark:border-gray-700 rounded-md">
                        <table class="w-full text-sm text-left">
                            <thead class="table-header sticky top-0">
                                <tr>
                                    <th class="p-2">Description</th>
                                    <th class="p-2">Cost</th>
                                    <th class="p-2">Status</th>
                                </tr>
                            </thead>
                            <tbody id="service-ticket-body">
                                ${appState.commercial.serviceTickets.map(t => `
                                    <tr class="border-b table-row-alt dark:border-gray-700">
                                        <td class="p-2">${t.description}</td>
                                        <td class="p-2">$${t.cost.toLocaleString()}</td>
                                        <td class="p-2">
                                            <span class="status-approved px-2 py-1 text-xs font-medium rounded-full">Validated</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="light-card p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4">Invoice Validation</h3>
                    <p class="text-sm mb-4">Enter a service company invoice amount to check it against validated, system-generated costs.</p>
                    <div class="space-y-2">
                        <label for="invoice-amount" class="text-sm font-medium">Invoice Amount (USD)</label>
                        <input type="number" id="invoice-amount" class="w-full p-2 rounded-md" placeholder="e.g., 850000">
                    </div>
                    <button id="validate-invoice-btn" class="mt-4 w-full rounded-md bg-blue-600 px-4 py-2 text-base font-semibold text-white shadow-sm hover:bg-blue-500">
                        Validate Invoice
                    </button>
                    <div id="invoice-result" class="mt-4"></div>
                </div>
            </div>
        `;
        
        document.getElementById('validate-invoice-btn').addEventListener('click', validateInvoice);
    };

    const validateInvoice = () => {
        const invoiceAmount = parseFloat(document.getElementById('invoice-amount').value);
        const validatedCost = appState.commercial.actualCost;
        const resultContainer = document.getElementById('invoice-result');
        
        if(isNaN(invoiceAmount)) { 
            resultContainer.innerHTML = `
                <div class="p-3 rounded-md bg-yellow-50 dark:bg-yellow-900/50 border-l-4 border-yellow-400 text-yellow-800 dark:text-yellow-300">
                    Please enter a valid amount.
                </div>
            `; 
            return; 
        }
        
        const difference = invoiceAmount - validatedCost;
        
        if (Math.abs(difference) < 0.01) { 
            resultContainer.innerHTML = `
                <div class="p-3 rounded-md bg-green-50 dark:bg-green-900/50 border-l-4 border-green-400 text-green-800 dark:text-green-300">
                    <strong>Match!</strong> Invoice amount of $${invoiceAmount.toLocaleString()} matches validated system cost.
                </div>
            `;
        } else { 
            resultContainer.innerHTML = `
                <div class="p-3 rounded-md bg-red-50 dark:bg-red-900/50 border-l-4 border-red-400 text-red-800 dark:text-red-300">
                    <strong>Discrepancy Found!</strong> Invoice is <strong>$${Math.abs(difference).toLocaleString()} ${difference > 0 ? 'over' : 'under'}</strong> system-validated cost.
                </div>
            `;
        }
    };

    const initializeHSE = () => {
        if (!appState.generatedPlan) { 
            hseContent.innerHTML = `
                <div class="text-center light-card p-8 rounded-lg">
                    <p>No plan is currently active. Please use the Planner module to generate an intervention plan, and the associated HSE & Risk data will be displayed here.</p>
                </div>
            `;
            hseSubtitle.textContent = "No active operation."
            return; 
        }
        
        hseSubtitle.textContent = `Risk register and permits for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
        appState.hse.permits = [ 
            { id: 'PTW001', name: 'General Permit to Work', status: 'Approved' }, 
            { id: 'PTW002', name: 'Hot Work Permit', status: 'Pending' }, 
            { id: 'PTW003', name: 'Confined Space Entry', status: 'Approved' }, 
        ];
        
        appState.hse.riskRegister = [ 
            { 
                hazard: 'Dropped Objects during Rig Up', 
                consequence: 'Personnel Injury', 
                mitigation: 'Establish exclusion zones; secure all items aloft.', 
                risk: 'Medium' 
            }, 
            { 
                hazard: 'Loss of Containment', 
                consequence: 'Environmental Spill', 
                mitigation: 'Verify PCE integrity; function test all valves.', 
                risk: 'High' 
            } 
        ];
        
        renderHSEView();
    };

    const renderHSEView = () => {
        if (!appState.generatedPlan) {
            initializeHSE();
            return;
        }
        
        const riskRegisterHtml = `
            <div class="light-card p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4">Dynamic Risk Register</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="table-header">
                            <tr>
                                <th class="p-2">Hazard</th>
                                <th class="p-2">Consequence</th>
                                <th class="p-2">Mitigation</th>
                                <th class="p-2">Risk Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appState.hse.riskRegister.map(r => `
                                <tr class="border-b table-row-alt dark:border-gray-700">
                                    <td class="p-2">${r.hazard}</td>
                                    <td class="p-2">${r.consequence}</td>
                                    <td class="p-2">${r.mitigation}</td>
                                    <td class="p-2">
                                        <span class="risk-${r.risk.toLowerCase()} px-2 py-1 text-xs font-medium rounded-full">${r.risk}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        const ptwHtml = `
            <div class="light-card p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4">Permit to Work (PTW) Status</h3>
                <div class="space-y-3">
                    ${appState.hse.permits.map(p => `
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-md">
                            <span class="font-medium">${p.name}</span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full status-${p.status.toLowerCase()}">${p.status}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        hseContent.innerHTML = `
            <div class="grid gap-8 lg:grid-cols-2">
                ${riskRegisterHtml}
                ${ptwHtml}
            </div>
        `;
    };
    
    // --- FAQ LOGIC ---

    const initializeFaqAccordion = () => {
        const accordion = document.getElementById('faq-accordion');
        accordion.innerHTML = faqData.map(item => `
            <div>
                <button class="faq-question flex justify-between items-center">
                    <span>${item.question}</span>
                    <svg class="icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="faq-answer">${item.answer}</div>
            </div>
        `).join('');

        accordion.addEventListener('click', (e) => {
            const questionButton = e.target.closest('.faq-question');
            if (questionButton) {
                const currentlyActive = document.querySelector('.faq-question.active');
                if (currentlyActive && currentlyActive !== questionButton) {
                    currentlyActive.classList.remove('active');
                }
                questionButton.classList.toggle('active');
            }
        });
    };

    // --- MODAL LOGIC ---

    const openModal = (wellId) => {
        const well = wellData.find(w => w.id === wellId);
        if (!well) return;

        modalTitle.textContent = `Well History & Schematic: ${well.name}`;

        // Build 3D wellbore visualization section
        const wellbore3DSection = `
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3">3D Wellbore Visualization</h3>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-lg border dark:border-slate-700">
                    ${render3DWellbore(well)}
                </div>
            </div>
        `;

        modalContent.innerHTML = `
            <div class="mb-4 border-b dark:border-gray-700">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <a href="#" class="modal-tab active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="history">History & Schematic</a>
                    <a href="#" class="modal-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="reports">Daily Reports</a>
                </nav>
            </div>
            <div id="modal-tab-history">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <h4 class="text-xl font-semibold mb-4">Operational History</h4>
                        <div id="history-content" class="max-h-96 overflow-y-auto pr-2"></div>
                    </div>
                    <div class="md:col-span-1">
                        ${wellbore3DSection}
                        <h4 class="text-xl font-semibold mb-4">Wellbore Schematic</h4>
                        <div class="bg-white dark:bg-slate-800 p-2 rounded-lg shadow-inner border dark:border-slate-700">
                            ${renderWellSchematic(well)}
                        </div>
                    </div>
                </div>
            </div>
            <div id="modal-tab-reports" class="hidden">
                <h4 class="text-xl font-semibold mb-4">Daily Reports (from legacy spreadsheets)</h4>
                <div id="reports-content" class="h-96 overflow-y-auto"></div>
            </div>
        `;

        renderModalTabs(well);
        
        document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('modal-tab-history').classList.toggle('hidden', e.target.dataset.tab !== 'history');
                document.getElementById('modal-tab-reports').classList.toggle('hidden', e.target.dataset.tab !== 'reports');
            });
        });
        
        modal.classList.remove('hidden');
    };

    const renderModalTabs = (well) => {
        document.getElementById('history-content').innerHTML = well.history.length ? well.history.map(h => `
            <div class="p-4 mb-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                <p class="font-bold text-lg">${h.operation} <span class="text-sm font-normal">- ${h.date}</span></p>
                <div class="mt-3 space-y-3">
                    <div class="flex items-start">
                        <span class="text-red-600 dark:text-red-400 mr-3">${getIcon('exclamation-triangle', 'w-6 h-6')}</span>
                        <div>
                            <strong class="font-semibold text-red-600 dark:text-red-400">Problem:</strong>
                            <p class="text-sm">${h.problem}</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <span class="text-green-600 dark:text-green-400 mr-3">${getIcon('check-circle', 'w-6 h-6')}</span>
                        <div>
                            <strong class="font-semibold text-green-600 dark:text-green-400">Lesson Learned:</strong>
                            <p class="text-sm">${h.lesson}</p>
                        </div>
                    </div>
                </div>
            </div>
        `).join('') : '<p>No historical data available.</p>';
        
        document.getElementById('reports-content').innerHTML = well.dailyReports.length ? `
            <table class="w-full text-sm text-left">
                <thead class="table-header">
                    <tr>
                        <th class="p-2">Date</th>
                        <th class="p-2">Summary</th>
                        <th class="p-2">NPT (hrs)</th>
                        <th class="p-2">Toolstring Run</th>
                    </tr>
                </thead>
                <tbody>
                    ${well.dailyReports.map(r => `
                        <tr class="border-b table-row-alt dark:border-gray-700">
                            <td class="p-2 align-top">${r.date}</td>
                            <td class="p-2 align-top">${r.summary}</td>
                            <td class="p-2 align-top">${r.npt}</td>
                            <td class="p-2 align-top font-mono text-xs">
                                <ul class="space-y-1">
                                    ${r.toolstringRun.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        ` : '<p>No daily reports available.</p>';
    };

    const closeModal = () => modal.classList.add('hidden');

    const renderWellSchematic = (well) => {
        const isDark = body.classList.contains('theme-dark');
        const maxDepth = Math.max(...well.completion.casing.map(c => c.bottom), 18500); // Dynamic max depth
        const scale = 600 / maxDepth;

        let svgContent = `<svg viewBox="0 0 150 600" class="w-full h-auto">`;
        
        // Depth markers
        svgContent += `<g class="schematic-depth-marker" text-anchor="end" fill="${isDark ? '#94a3b8' : '#1d4ed8'}">`;
        for (let d = 0; d <= maxDepth; d += 5000) {
            const y = d * scale;
            svgContent += `<text x="25" y="${y+3}">${d/1000}k</text><line x1="28" y1="${y}" x2="35" y2="${y}" stroke="${isDark ? '#4b5563' : '#d1d5db'}" stroke-width="1"/>`;
        }
        svgContent += `</g>`;

        // Wellbore background
        svgContent += `
            <rect x="40" y="0" width="100" height="600" fill="${isDark ? '#281e14' : '#eaddc7'}" />
            <rect x="50" y="0" width="80" height="600" fill="${isDark ? '#3a2d21' : '#d2b48c'}" />
            <rect x="50" y="20" width="80" height="10" fill="${isDark ? '#4b5563' : '#9ca3af'}"/>
            <rect x="75" y="10" width="30" height="10" fill="${isDark ? '#6b7280' : '#6b7280'}"/>
        `;
        
        // Components
        well.completion.casing?.forEach(c => { 
            const topY = c.top * scale; 
            const height = (c.bottom - c.top) * scale; 
            svgContent += `<rect x="60" y="${topY}" width="60" height="${height}" fill="none" stroke="${c.isProblem ? '#ef4444' : '#6b7280'}" stroke-width="2"/>`; 
        });
        
        well.completion.tubing?.forEach(t => { 
            const topY = t.top * scale; 
            const height = (t.bottom - t.top) * scale; 
            svgContent += `<rect x="85" y="${topY}" width="10" height="${height}" fill="${t.isProblem ? 'rgba(239, 68, 68, 0.3)' : (isDark ? '#6b7280' : '#d1d5db')}" stroke="${t.isProblem ? '#ef4444' : (isDark ? '#4b5563' : '#9ca3af')}" stroke-width="0.5"/>`; 
        });
        
        well.completion.equipment?.forEach(e => { 
            const y = e.top * scale; 
            const fillProblem = 'rgba(239, 68, 68, 0.5)';
            const strokeProblem = '#ef4444';
            const fillNormal = isDark ? '#9ca3af' : '#4b5563';
            const fillSuccess = 'rgba(22, 163, 74, 0.5)';
            const strokeSuccess = '#16a34a';

            if(e.item.includes('Packer')) { 
                svgContent += `<polygon points="75,${y-10} 105,${y-10} 110,${y} 70,${y}" fill="${fillNormal}"/>`; 
            } else if (e.item.includes('SSSV')) { 
                svgContent += `
                    <rect x="82" y="${y}" width="16" height="20" fill="${e.isProblem ? 'rgba(239,68,68,0.2)' : 'rgba(107,114,128,0.5)'}" stroke="${e.isProblem ? strokeProblem : '#6b7280'}" stroke-width="1"/>
                    <path d="M 85 ${y+3} l 10 14 M 85 ${y+17} l 10 -14" stroke="${e.isProblem ? strokeProblem : '#6b7280'}" stroke-width="1.5"/>
                `; 
            } else if (e.item.includes('Scale')) { 
                svgContent += `
                    <path d="M 85 ${y-10} C 80 ${y}, 80 ${y+10}, 85 ${y+20}" stroke="#c2410c" stroke-width="2" fill="none" stroke-linecap="round"/>
                    <path d="M 95 ${y-10} C 100 ${y}, 100 ${y+10}, 95 ${y+20}" stroke="#c2410c" stroke-width="2" fill="none" stroke-linecap="round"/>
                `; 
            } else if (e.item.includes('Casing Deformation')) { 
                svgContent += `
                    <path d="M 60 ${y} C 50 ${y+10}, 70 ${y+20}, 60 ${y+30}" stroke="${strokeProblem}" stroke-width="1.5" fill="none" />
                    <path d="M 120 ${y} C 130 ${y+10}, 110 ${y+20}, 120 ${y+30}" stroke="${strokeProblem}" stroke-width="1.5" fill="none" />
                `; 
            } else if (e.item.includes('Fish')) { 
                svgContent += `
                    <g transform="translate(90 ${y})">
                        <path d="M-5 -10 L 5 -10 L 3 -5 L -3 -5 Z M-2 -5 L 2 -5 L 2 10 L -2 10 Z" fill="${fillProblem}" stroke="${strokeProblem}" stroke-width="1" />
                        <text x="15" y="5" class="schematic-label" fill="${strokeProblem}">${e.item}</text>
                    </g>
                `; 
            } else if (e.item.includes('Tubing Patch')) { 
                svgContent += `
                    <rect x="82" y="${y}" width="16" height="50" fill="${fillSuccess}" stroke="${strokeSuccess}" stroke-width="1.5"/>
                    <text x="105" y="${y+25}" class="schematic-label" fill="${strokeSuccess}">${e.item}</text>
                `;
            }
        });
        
        well.completion.perforations?.forEach(p => { 
            const topY = p.top * scale; 
            const bottomY = p.bottom * scale; 
            for(let y = topY; y <= bottomY; y += 10) { 
                svgContent += `<path d="M 60 ${y} L 40 ${y}" stroke="${p.isProblem ? '#ef4444' : '#1d4ed8'}" stroke-width="1.5" />`; 
                if(p.isProblem) svgContent += `<path d="M 40 ${y} l 4 4 m -4 0 l 4 -4" stroke="#ef4444" stroke-width="1.5"/>`; 
            } 
        });
        
        well.completion.plugs?.forEach(p => { 
            const topY = p.top * scale; 
            const height = (p.bottom - p.top) * scale; 
            svgContent += `<rect x="55" y="${topY}" width="70" height="${height}" fill="#a8a29e"/>`; 
        });
        
        svgContent += `</svg>`;
        return svgContent;
    };

    const render3DWellbore = (well) => {
        const isDark = body.classList.contains('theme-dark');
        const maxDepth = Math.max(...well.completion.casing.map(c => c.bottom), 18500);
        const scale = 500 / maxDepth;
        const width = 300;
        const height = 600;

        // Define gradients and 3D effects
        let svgContent = `
            <svg viewBox="0 0 ${width} ${height}" class="w-full h-auto">
                <defs>
                    <!-- Gradient for wellbore formation -->
                    <linearGradient id="formation-grad-${well.id}" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:${isDark ? '#1a1410' : '#8b7355'};stop-opacity:1" />
                        <stop offset="50%" style="stop-color:${isDark ? '#3a2d21' : '#a0826d'};stop-opacity:1" />
                        <stop offset="100%" style="stop-color:${isDark ? '#1a1410' : '#8b7355'};stop-opacity:1" />
                    </linearGradient>

                    <!-- Gradient for casing (normal) -->
                    <linearGradient id="casing-grad-${well.id}" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#6b7280;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#9ca3af;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#6b7280;stop-opacity:1" />
                    </linearGradient>

                    <!-- Gradient for casing (problem) -->
                    <linearGradient id="casing-problem-grad-${well.id}" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#dc2626;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#ef4444;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                    </linearGradient>

                    <!-- Gradient for tubing -->
                    <linearGradient id="tubing-grad-${well.id}" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#4b5563;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#6b7280;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#4b5563;stop-opacity:1" />
                    </linearGradient>
                </defs>

                <!-- Background formation -->
                <rect x="0" y="0" width="${width}" height="${height}" fill="url(#formation-grad-${well.id})"/>
        `;

        // Add depth markers on the left
        svgContent += `<g class="depth-markers">`;
        for (let d = 0; d <= maxDepth; d += 5000) {
            const y = d * scale + 50;
            svgContent += `
                <text x="20" y="${y}"
                      font-size="12"
                      fill="${isDark ? '#94a3b8' : '#1e40af'}"
                      text-anchor="end">${d/1000}k</text>
                <line x1="25" y1="${y}" x2="35" y2="${y}"
                      stroke="${isDark ? '#475569' : '#94a3b8'}"
                      stroke-width="1"/>
            `;
        }
        svgContent += `</g>`;

        // Surface equipment (wellhead)
        svgContent += `
            <g class="wellhead">
                <!-- Wellhead platform -->
                <rect x="${width/2 - 50}" y="30" width="100" height="15"
                      fill="${isDark ? '#1e293b' : '#cbd5e1'}"
                      stroke="${isDark ? '#475569' : '#64748b'}"
                      stroke-width="2"/>
                <!-- Christmas tree -->
                <rect x="${width/2 - 15}" y="10" width="30" height="25"
                      fill="${isDark ? '#334155' : '#94a3b8'}"
                      stroke="${isDark ? '#64748b' : '#475569'}"
                      stroke-width="2"/>
            </g>
        `;

        // Draw casing strings in 3D perspective
        well.completion.casing?.forEach((c, idx) => {
            const topY = c.top * scale + 50;
            const bottomY = c.bottom * scale + 50;
            const height = bottomY - topY;

            // Perspective effect: wider at surface, narrower at depth
            const topWidth = 80 - (idx * 8);
            const bottomWidth = 70 - (idx * 8);
            const leftX = width/2 - topWidth/2;
            const rightX = width/2 + topWidth/2;

            const fill = c.isProblem ? `url(#casing-problem-grad-${well.id})` : `url(#casing-grad-${well.id})`;
            const stroke = c.isProblem ? '#dc2626' : '#4b5563';

            // Left side of casing
            svgContent += `
                <path d="M ${leftX} ${topY}
                         L ${width/2 - bottomWidth/2} ${bottomY}
                         L ${width/2 - bottomWidth/2 + 5} ${bottomY}
                         L ${leftX + 5} ${topY} Z"
                      fill="${fill}"
                      stroke="${stroke}"
                      stroke-width="1"
                      opacity="0.9"/>
            `;

            // Right side of casing
            svgContent += `
                <path d="M ${rightX} ${topY}
                         L ${width/2 + bottomWidth/2} ${bottomY}
                         L ${width/2 + bottomWidth/2 - 5} ${bottomY}
                         L ${rightX - 5} ${topY} Z"
                      fill="${fill}"
                      stroke="${stroke}"
                      stroke-width="1"
                      opacity="0.9"/>
            `;

            // Casing label
            if (idx === 0) {
                svgContent += `
                    <text x="${rightX + 10}" y="${topY + 30}"
                          font-size="10"
                          fill="${c.isProblem ? '#ef4444' : (isDark ? '#cbd5e1' : '#1e40af')}">${c.size}" ${c.type}</text>
                `;
            }
        });

        // Draw tubing string
        well.completion.tubing?.forEach(t => {
            const topY = t.top * scale + 50;
            const bottomY = t.bottom * scale + 50;
            const tubingWidth = 8;
            const leftX = width/2 - tubingWidth/2;
            const rightX = width/2 + tubingWidth/2;

            svgContent += `
                <rect x="${leftX}" y="${topY}"
                      width="${tubingWidth}"
                      height="${bottomY - topY}"
                      fill="url(#tubing-grad-${well.id})"
                      stroke="#374151"
                      stroke-width="0.5"/>
            `;
        });

        // Draw equipment with 3D effects
        well.completion.equipment?.forEach(e => {
            const y = e.top * scale + 50;
            const isProblem = e.isProblem;

            if (e.item.includes('Packer')) {
                // 3D packer visualization
                svgContent += `
                    <g class="packer">
                        <ellipse cx="${width/2}" cy="${y}" rx="45" ry="8"
                                fill="${isDark ? '#475569' : '#94a3b8'}"
                                opacity="0.7"/>
                        <rect x="${width/2 - 40}" y="${y}" width="80" height="3"
                              fill="${isDark ? '#1e293b' : '#64748b'}"/>
                        <ellipse cx="${width/2}" cy="${y + 3}" rx="45" ry="8"
                                fill="${isDark ? '#334155' : '#475569'}"/>
                    </g>
                `;
            } else if (e.item.includes('SSSV')) {
                // Safety valve with failure indicator
                const color = isProblem ? '#dc2626' : '#0891b2';
                svgContent += `
                    <g class="sssv">
                        <rect x="${width/2 - 20}" y="${y - 10}" width="40" height="20"
                              fill="${color}"
                              opacity="0.8"
                              stroke="${isProblem ? '#991b1b' : '#155e75'}"
                              stroke-width="2"/>
                        ${isProblem ? `
                            <path d="M ${width/2 - 15} ${y - 5} L ${width/2 + 15} ${y + 5}
                                     M ${width/2 - 15} ${y + 5} L ${width/2 + 15} ${y - 5}"
                                  stroke="#fee2e2" stroke-width="2"/>
                        ` : ''}
                        <text x="${width/2 + 25}" y="${y + 5}"
                              font-size="9"
                              fill="${color}">${e.item}</text>
                    </g>
                `;
            } else if (e.item.includes('Scale')) {
                // Scale blockage visualization
                svgContent += `
                    <g class="scale-blockage">
                        <ellipse cx="${width/2}" cy="${y}" rx="35" ry="15"
                                fill="#c2410c"
                                opacity="0.6"/>
                        <ellipse cx="${width/2}" cy="${y - 5}" rx="30" ry="12"
                                fill="#ea580c"
                                opacity="0.7"/>
                        <text x="${width/2 + 40}" y="${y}"
                              font-size="9"
                              fill="#ea580c">Scale Blockage</text>
                    </g>
                `;
            } else if (e.item.includes('Fish')) {
                // Stuck fish visualization
                svgContent += `
                    <g class="fish">
                        <rect x="${width/2 - 5}" y="${y - 20}" width="10" height="40"
                              fill="#dc2626"
                              opacity="0.8"
                              stroke="#991b1b"
                              stroke-width="1"/>
                        <text x="${width/2 + 15}" y="${y}"
                              font-size="9"
                              fill="#dc2626">Fish</text>
                    </g>
                `;
            }
        });

        // Draw perforations
        well.completion.perforations?.forEach(p => {
            const topY = p.top * scale + 50;
            const bottomY = p.bottom * scale + 50;
            const perfColor = p.isProblem ? '#ef4444' : '#3b82f6';

            // Perforation zone indicator
            svgContent += `
                <line x1="${width/2 - 60}" y1="${topY}"
                      x2="${width/2 - 40}" y2="${topY}"
                      stroke="${perfColor}"
                      stroke-width="2"/>
                <line x1="${width/2 - 60}" y1="${bottomY}"
                      x2="${width/2 - 40}" y2="${bottomY}"
                      stroke="${perfColor}"
                      stroke-width="2"/>
                <line x1="${width/2 - 60}" y1="${topY}"
                      x2="${width/2 - 60}" y2="${bottomY}"
                      stroke="${perfColor}"
                      stroke-width="1"
                      stroke-dasharray="3,3"/>
                <text x="${width/2 - 75}" y="${(topY + bottomY)/2}"
                      font-size="8"
                      fill="${perfColor}"
                      text-anchor="end">Perfs</text>
            `;
        });

        svgContent += `</svg>`;
        return svgContent;
    };

    // --- THEME & CHART LOGIC ---

    const setTheme = (theme) => {
        body.className = `theme-${theme}`;
        localStorage.setItem('theme', theme);
        if(appState.currentView === 'performer') body.classList.add('theme-dark');

        // Update charts
        const charts = [appState.savingsChartInstance, appState.tfaChartInstance, appState.nptChartInstance];
        charts.forEach(chart => {
            if (chart) {
                const chartTheme = getChartThemeOptions();
                if(chart.options.scales.x) {
                    chart.options.scales.x.grid.color = chartTheme.scales.x.grid.color;
                    chart.options.scales.x.ticks.color = chartTheme.scales.x.ticks.color;
                }
                 if(chart.options.scales.y) {
                    chart.options.scales.y.grid.color = chartTheme.scales.y.grid.color;
                    chart.options.scales.y.ticks.color = chartTheme.scales.y.ticks.color;
                }
                if(chart.options.plugins.legend) {
                    chart.options.plugins.legend.labels.color = chartTheme.plugins.legend.labels.color;
                }
                if(chart.config.type === 'doughnut') {
                    chart.data.datasets[0].borderColor = theme === 'dark' ? '#0f172a' : 'white';
                }
                chart.update();
            }
        });
    };

    const getChartThemeOptions = () => {
        const isDark = body.classList.contains('theme-dark');
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#e5e7eb';
        const textColor = isDark ? '#d1d5db' : '#4b5563';
        return {
            scales: { 
                x: { 
                    grid: { color: gridColor }, 
                    ticks: { color: textColor }, 
                    title: { display: true, text: 'Depth (ft)', color: textColor } 
                }, 
                y: { 
                    grid: { color: gridColor }, 
                    ticks: { color: textColor }, 
                    title: { display: true, text: 'Value', color: textColor } 
                } 
            },
            plugins: { 
                legend: { 
                    labels: { color: textColor } 
                } 
            }
        };
    };

    // --- ROI CALCULATOR LOGIC (Home Page) ---

    const engineerCountSlider = document.getElementById('engineerCount');
    const nptReductionSlider = document.getElementById('nptReduction');
    const timeSavingsSlider = document.getElementById('timeSavings');
    const engineerCountValue = document.getElementById('engineerCountValue');
    const nptReductionValue = document.getElementById('nptReductionValue');
    const timeSavingsValue = document.getElementById('timeSavingsValue');
    const totalSavingsValue = document.getElementById('totalSavings');
    const savingsChartCanvas = document.getElementById('savingsChart');

    const calculateROI = () => {
        if (!engineerCountSlider) return;
        
        const engineers = parseInt(engineerCountSlider.value);
        const nptReduction = parseInt(nptReductionSlider.value) / 100;
        const timeSavings = parseInt(timeSavingsSlider.value) / 100;

        const avgEngineerSalary = 120000;
        const avgNptCostPerDay = 250000;
        const avgNptDaysPerYear = 15;

        const engineerSavings = engineers * avgEngineerSalary * timeSavings;
        const nptSavings = avgNptCostPerDay * avgNptDaysPerYear * nptReduction;
        const totalSavings = engineerSavings + nptSavings;

        engineerCountValue.textContent = engineers;
        nptReductionValue.textContent = `${nptReduction * 100}%`;
        timeSavingsValue.textContent = `${timeSavings * 100}%`;
        totalSavingsValue.textContent = `$${Math.round(totalSavings).toLocaleString()}`;

        updateSavingsChart(engineerSavings, nptSavings);
    };

    const updateSavingsChart = (engineerSavings, nptSavings) => {
        if(appState.savingsChartInstance) {
            appState.savingsChartInstance.data.datasets[0].data = [engineerSavings, nptSavings];
            appState.savingsChartInstance.update();
        }
    };

    const initSavingsChart = () => {
        if (!savingsChartCanvas) return;
        
        const ctx = savingsChartCanvas.getContext('2d');
        const isDark = body.classList.contains('theme-dark');
        
        appState.savingsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Engineering Time', 'NPT Reduction'],
                datasets: [{
                    label: 'Annual Savings',
                    data: [0, 0],
                    backgroundColor: ['#0d9488', '#0891b2'],
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        ticks: {
                            callback: (value) => `$${(value / 1000).toLocaleString()}k`,
                            color: isDark ? '#d1d5db' : '#4b5563'
                        },
                        grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : '#e5e7eb' }
                    },
                    y: { 
                        ticks: { color: isDark ? '#d1d5db' : '#4b5563' }, 
                        grid: { display: false } 
                    }
                },
                plugins: { 
                    legend: { display: false } 
                }
            }
        });
        
        calculateROI();
    };

    if (engineerCountSlider && nptReductionSlider && timeSavingsSlider) {
        [engineerCountSlider, nptReductionSlider, timeSavingsSlider].forEach(slider => {
            slider.addEventListener('input', calculateROI);
        });
    }

    // --- EVENT LISTENERS ---

    // Auto-initialize application on page load (login removed)
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);
        switchView('home');
    });

    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = body.classList.contains('theme-dark') ? 'dark' : 'light';
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });
    }

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            if (link.classList.contains('disabled')) return;
            switchView(e.currentTarget.id.replace('-nav-link', ''));
        });
    });

    // Well selection event listener
    if (wellSelectionGrid) {
        wellSelectionGrid.addEventListener('click', (e) => {
            // Handle view details button
            if (e.target.closest('.view-details-btn')) {
                e.stopPropagation();
                openModal(e.target.closest('.view-details-btn').dataset.wellId);
                return;
            }

            // Handle well card selection
            const card = e.target.closest('.planner-card');
            if (!card) return;

            appState.selectedWell = wellData.find(w => w.id === card.dataset.wellId);
            document.querySelectorAll('.planner-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            renderProblems(); // Update the problems list based on selection
            updatePlannerStepUI(2);
        });
    }

    // Objective selection event listener
    if (objectivesFieldset) {
        objectivesFieldset.addEventListener('change', (e) => {
            // Find the selected objective card and update its styling
            document.querySelectorAll('.objective-card').forEach(card => {
                card.classList.remove('selected');
            });

            const selectedCard = document.querySelector(`input[name="objective"]:checked`).closest('.objective-card');
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            appState.selectedObjective = objectivesData.find(o => o.id === e.target.value);
            if (generatePlanBtnManual) generatePlanBtnManual.disabled = !appState.selectedObjective;
            updateCostSummary(); // Update cost estimate display
        });
    }

    // Problem selection event listener
    if (problemsFieldset) {
        problemsFieldset.addEventListener('change', (e) => {
        // Find the selected problem card and update its styling
        document.querySelectorAll('.objective-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`input[name="problem"]:checked`).closest('.objective-card');
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
        
        appState.ai.selectedProblemId = e.target.value;
        const recommendations = aiRecommendations[appState.ai.selectedProblemId] || [];
        
        aiRecommendationsContainer.innerHTML = `
            <h3 class="text-lg font-semibold text-center mb-4 mt-6">AI Recommendations</h3>
            <div class="space-y-4">
                ${recommendations.map((rec, i) => { 
                    const objective = objectivesData.find(o => o.id === rec.objectiveId); 
                    return `
                        <div class="ai-recommendation-enhanced" data-rec-index="${i}">
                            <div class="confidence-badge">${rec.confidence}% Confidence</div>
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-lg text-teal-700 dark:text-teal-400 flex items-center gap-2">${getIcon(objective.icon, 'w-5 h-5')} ${objective.name}</h4>
                            </div>
                            <p class="text-sm mb-1"><strong>Projected Outcome:</strong> ${rec.outcome}</p>
                            <p class="text-xs"><strong>Reasoning:</strong> ${rec.reason}</p>
                        </div>
                    `; 
                }).join('')}
            </div>
        `;
        
        aiRecommendationsContainer.classList.remove('hidden');
        
        // Add event listeners to recommendation cards
        document.querySelectorAll('.ai-recommendation-enhanced').forEach(card => card.addEventListener('click', (ev) => {
            const selectedCard = ev.target.closest('.ai-recommendation-enhanced');
            const recIndex = parseInt(selectedCard.dataset.recIndex);
            appState.ai.selectedRecommendation = aiRecommendations[appState.ai.selectedProblemId][recIndex];
            
            document.querySelectorAll('.ai-recommendation-enhanced').forEach(c => c.classList.remove('selected'));
            selectedCard.classList.add('selected');

            if (generatePlanBtnAi) generatePlanBtnAi.disabled = false;
        }));
        });
    }

    // AI toggle event listener
    if (aiToggle) {
        aiToggle.addEventListener('change', (e) => { 
        manualPlanningView.classList.toggle('hidden', e.target.checked); 
        aiAdvisorView.classList.toggle('hidden', !e.target.checked);
        
        if(e.target.checked && appState.selectedWell && appState.selectedWell.id !== 'Well_666') {
             aiAdvisorView.innerHTML = `
                <div class="bg-yellow-50 dark:bg-yellow-900/50 p-6 rounded-lg text-center">
                    <p class="text-yellow-800 dark:text-yellow-200">The AI Advisor is configured for the 'Well From Hell' (Well_666) scenario. Please select Well_666 to see AI recommendations.</p>
                </div>
            `;
        } else {
             renderProblems(); // Re-render problems list
        }
        });
    }

    // Generate plan buttons event listeners
    if (generatePlanBtnManual) {
        generatePlanBtnManual.addEventListener('click', () => {
            if (!appState.selectedWell || !appState.selectedObjective) return;
            appState.generatedPlan = proceduresData[appState.selectedObjective.id];
            renderPlan();
            updatePlannerStepUI(3);
        });
    }

    if (generatePlanBtnAi) {
        generatePlanBtnAi.addEventListener('click', () => {
            if (!appState.selectedWell || !appState.ai.selectedRecommendation) return;
            appState.selectedObjective = objectivesData.find(o => o.id === appState.ai.selectedRecommendation.objectiveId);
            appState.generatedPlan = proceduresData[appState.selectedObjective.id];
            renderPlan();
            updatePlannerStepUI(3);
        });
    }

    // Control buttons event listeners
    if (startOverBtn) {
        startOverBtn.addEventListener('click', () => resetApp(false));
    }
    if (beginOpBtn) {
        beginOpBtn.addEventListener('click', () => {
            if (!appState.generatedPlan) return;
            switchView('performer');
        });
    }

    if (addLogBtn) {
        addLogBtn.addEventListener('click', () => {
            addLogEntry('Operator', logInput.value);
            logInput.value = '';
        });
    }

    if (procedureStepsContainer) {
        procedureStepsContainer.addEventListener('click', (e) => {
            const stepDiv = e.target.closest('.procedure-step');
            if (!stepDiv || !appState.liveData.jobRunning) return;

            const targetStepId = parseInt(stepDiv.dataset.stepId);
            const currentStepId = appState.liveData.currentStep;

            if (targetStepId > currentStepId) {
                jumpToStep(targetStepId);
            }
        });
    }

    if (viewAnalysisBtn) {
        viewAnalysisBtn.addEventListener('click', () => {
            switchView('analyzer');
            if (window.initializeAnalyzer) {
                window.initializeAnalyzer();
            } else {
                initializeAnalyzer();
                initializeVendorScorecard();
            }
        });
    }

    if (addLessonBtn && lessonInput) {
        addLessonBtn.addEventListener('click', () => {
            if(lessonInput.value.trim()){
                appState.lessonsLearned.push(lessonInput.value.trim());
                lessonInput.value = '';
                renderLessons();
            }
        });
    }

    if (planNewJobBtn) {
        planNewJobBtn.addEventListener('click', () => resetApp(true));
    }

    if (equipmentSearch && personnelSearch) {
        equipmentSearch.addEventListener('input', (e) =>
            renderAssetManagementViews(e.target.value, personnelSearch.value)
        );

        personnelSearch.addEventListener('input', (e) =>
            renderAssetManagementViews(equipmentSearch.value, e.target.value)
        );
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }

    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
    }

    /* ========================================
       V23 FEATURE FUNCTIONS
       ======================================== */

    // --- ANOMALY DETECTION SYSTEM ---

    let anomalyCounter = 0;
    let detectedAnomalies = [];

    function detectAnomalies(whp, hookload, depth, time) {
        const anomalies = [];

        // WHP Anomaly Detection
        if (whp > 8000) {
            anomalies.push({
                type: 'critical',
                parameter: 'WHP',
                value: whp,
                threshold: 8000,
                message: 'Wellhead Pressure critically high',
                recommendation: 'STOP OPERATIONS. Initiate well control procedures. Check for kick indicators.',
                icon: 'ðŸ”´'
            });
        } else if (whp > 6500) {
            anomalies.push({
                type: 'warning',
                parameter: 'WHP',
                value: whp,
                threshold: 6500,
                message: 'Wellhead Pressure elevated',
                recommendation: 'Monitor closely. Prepare for pressure management. Review mud weight.',
                icon: 'âš ï¸'
            });
        }

        // Hookload Anomaly Detection
        if (hookload > 450) {
            anomalies.push({
                type: 'critical',
                parameter: 'Hookload',
                value: hookload,
                threshold: 450,
                message: 'Hookload critically high - Stuck pipe likely',
                recommendation: 'STOP PULLING. Initiate stuck pipe procedures. Work pipe gently.',
                icon: 'ðŸ”´'
            });
        } else if (hookload > 380) {
            anomalies.push({
                type: 'warning',
                parameter: 'Hookload',
                value: hookload,
                threshold: 380,
                message: 'Hookload elevated - Monitor for stuck pipe',
                recommendation: 'Reduce pulling speed. Increase circulation. Monitor for drag trends.',
                icon: 'âš ï¸'
            });
        } else if (hookload < 150) {
            anomalies.push({
                type: 'warning',
                parameter: 'Hookload',
                value: hookload,
                threshold: 150,
                message: 'Hookload unusually low',
                recommendation: 'Check for free-falling pipe or equipment failure. Verify weight readings.',
                icon: 'âš ï¸'
            });
        }

        return anomalies;
    }

    function displayAnomaly(anomaly, time) {
        const alertsContainer = document.getElementById('anomaly-alerts');
        if (!alertsContainer) return;

        const alertId = `anomaly-${anomalyCounter++}`;

        // Remove "all systems normal" message if present
        if (detectedAnomalies.length === 0) {
            alertsContainer.innerHTML = '';
        }

        const alertDiv = document.createElement('div');
        alertDiv.id = alertId;
        alertDiv.className = `anomaly-alert anomaly-${anomaly.type} p-4 rounded-lg`;

        alertDiv.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="text-2xl anomaly-icon-${anomaly.type}">${anomaly.icon}</div>
                <div class="flex-1">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-lg">${anomaly.message}</h4>
                        <span class="text-sm opacity-75">t=${time} min</span>
                    </div>
                    <div class="text-sm mb-2">
                        <strong>${anomaly.parameter}:</strong> ${anomaly.value.toFixed(1)}
                        (Threshold: ${anomaly.threshold})
                    </div>
                    <div class="bg-white/20 p-3 rounded text-sm">
                        <strong>Recommendation:</strong> ${anomaly.recommendation}
                    </div>
                </div>
            </div>
        `;

        alertsContainer.insertBefore(alertDiv, alertsContainer.firstChild);
        detectedAnomalies.push({ id: alertId, anomaly, time });

        // Auto-resolve warnings after 5 minutes (300000ms)
        if (anomaly.type === 'warning') {
            setTimeout(() => resolveAnomaly(alertId), 300000);
        }
    }

    function resolveAnomaly(alertId) {
        const alertDiv = document.getElementById(alertId);
        if (alertDiv) {
            alertDiv.classList.remove('anomaly-warning', 'anomaly-critical');
            alertDiv.classList.add('anomaly-resolved');
            const icon = alertDiv.querySelector('.anomaly-icon-warning, .anomaly-icon-critical');
            if (icon) {
                icon.classList.remove('anomaly-icon-warning', 'anomaly-icon-critical');
            }
        }
    }

    // Integrate anomaly detection with gauge updates
    const originalUpdateGauges = window.updateGauges || function() {};
    window.updateGauges = function(whp, hookload, depth, time) {
        originalUpdateGauges(whp, hookload, depth, time);

        // Run anomaly detection
        if (appState.liveData.jobRunning) {
            const anomalies = detectAnomalies(whp, hookload, depth, time);
            anomalies.forEach(anomaly => displayAnomaly(anomaly, time));
        }
    };

    // --- VENDOR SCORECARD SYSTEM ---

    function generateStarRating(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        let html = '';

        for (let i = 0; i < fullStars; i++) {
            html += '<span class="star">â˜…</span>';
        }
        if (hasHalfStar) {
            html += '<span class="star">â˜…</span>';
        }
        const emptyStars = 5 - Math.ceil(rating);
        for (let i = 0; i < emptyStars; i++) {
            html += '<span class="star empty">â˜…</span>';
        }

        return html;
    }

    function initializeVendorScorecard() {
        const metrics = {
            'delivery': 4.8,    // 95%
            'quality': 4.4,     // 88%
            'support': 4.6,     // 92%
            'cost': 3.9,        // 78%
            'safety': 4.9,      // 98%
            'response': 4.3     // 85%
        };

        // Calculate overall rating
        const overall = Object.values(metrics).reduce((a, b) => a + b, 0) / Object.keys(metrics).length;

        // Update overall rating
        const overallRatingEl = document.getElementById('vendor-overall-rating');
        const overallStarsEl = document.getElementById('vendor-overall-stars');

        if (overallRatingEl) {
            overallRatingEl.textContent = overall.toFixed(1);
        }
        if (overallStarsEl) {
            overallStarsEl.innerHTML = generateStarRating(overall);
        }

        // Update individual metrics
        Object.keys(metrics).forEach(metric => {
            const element = document.getElementById(`metric-${metric}-stars`);
            if (element) {
                element.innerHTML = generateStarRating(metrics[metric]);
            }
        });
    }

    // Store the original initializeAnalyzer function
    const originalInitializeAnalyzer = initializeAnalyzer;

    // Create wrapper function for vendor scorecard initialization
    const initializeAnalyzerWithVendor = function() {
        originalInitializeAnalyzer();
        initializeVendorScorecard();
    };

    // Replace the function globally
    window.initializeAnalyzer = initializeAnalyzerWithVendor;

    /* ========================================
       COST & RESOURCE TRACKING
       ======================================== */

    // Cost data storage
    let costData = {
        equipment: [],
        personnel: [],
        activities: []
    };

    // Parse CSV data handling quoted fields properly
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');

        // Parse a CSV line respecting quotes
        function parseLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        const headers = parseLine(lines[0]);
        return lines.slice(1).filter(line => line.trim()).map(line => {
            const values = parseLine(line);
            const obj = {};
            headers.forEach((header, i) => {
                obj[header] = values[i] || '';
            });
            return obj;
        });
    }

    // Load cost data from CSV files
    async function loadCostData() {
        try {
            const [equipResp, persResp, actResp] = await Promise.all([
                fetch('data-equipment-tools.csv'),
                fetch('data-personnel-rates.csv'),
                fetch('data-activity-cost-rates.csv')
            ]);

            if (equipResp.ok) {
                const equipText = await equipResp.text();
                costData.equipment = parseCSV(equipText);
            }

            if (persResp.ok) {
                const persText = await persResp.text();
                costData.personnel = parseCSV(persText);
            }

            if (actResp.ok) {
                const actText = await actResp.text();
                costData.activities = parseCSV(actText);
            }

            console.log('Cost data loaded:', {
                equipment: costData.equipment.length,
                personnel: costData.personnel.length,
                activities: costData.activities.length
            });

            // Update UI if cost data is loaded
            if (document.getElementById('cost-summary-panel')) {
                updateCostSummary();
            }
        } catch (error) {
            console.warn('Could not load cost data files:', error);
            // Graceful degradation - app works without cost data
        }
    }

    // Calculate job cost estimate
    function calculateJobCost(objective) {
        let totalCost = 0;
        let breakdown = {
            equipment: 0,
            personnel: 0,
            tools: 0,
            consumables: 0
        };

        // Use existing proceduresData cost if available
        if (proceduresData[objective.id]) {
            totalCost = proceduresData[objective.id].cost || 0;
        }

        // If we have loaded cost data, use it for more detailed breakdown
        if (costData.activities.length > 0) {
            const activity = costData.activities.find(a =>
                a.Activity_Name && a.Activity_Name.toLowerCase().includes(objective.name.toLowerCase().split(' ')[0])
            );

            if (activity) {
                totalCost = parseFloat(activity.Base_Cost_USD) || totalCost;
            }
        }

        // Simple breakdown estimate (can be enhanced)
        breakdown.equipment = Math.floor(totalCost * 0.40);
        breakdown.personnel = Math.floor(totalCost * 0.30);
        breakdown.tools = Math.floor(totalCost * 0.20);
        breakdown.consumables = Math.floor(totalCost * 0.10);

        return { totalCost, breakdown };
    }

    // Update cost summary display
    function updateCostSummary() {
        const panel = document.getElementById('cost-summary-panel');
        if (!panel) return;

        if (!appState.selectedObjective) {
            panel.innerHTML = '';
            return;
        }

        const { totalCost, breakdown } = calculateJobCost(appState.selectedObjective);

        panel.innerHTML = `
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4">ðŸ’° Cost Estimate</h3>
                <div class="text-center mb-4">
                    <div class="text-4xl font-bold">$${(totalCost / 1000).toFixed(0)}K</div>
                    <div class="text-sm opacity-90 mt-1">Total Job Cost</div>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center bg-white/20 p-2 rounded">
                        <span>Equipment</span>
                        <span class="font-bold">$${(breakdown.equipment / 1000).toFixed(0)}K</span>
                    </div>
                    <div class="flex justify-between items-center bg-white/20 p-2 rounded">
                        <span>Personnel</span>
                        <span class="font-bold">$${(breakdown.personnel / 1000).toFixed(0)}K</span>
                    </div>
                    <div class="flex justify-between items-center bg-white/20 p-2 rounded">
                        <span>Tools</span>
                        <span class="font-bold">$${(breakdown.tools / 1000).toFixed(0)}K</span>
                    </div>
                    <div class="flex justify-between items-center bg-white/20 p-2 rounded">
                        <span>Consumables</span>
                        <span class="font-bold">$${(breakdown.consumables / 1000).toFixed(0)}K</span>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/30 text-xs opacity-75">
                    Based on industry standard rates â€¢ Actual costs may vary
                </div>
            </div>
        `;
    }

    /* ========================================
       JOB COSTING TOOL
       ======================================== */

    // Service catalogue database
    const serviceCatalogue = {
        ct: {
            personnel: [
                { code: 'CT-CREW-SUP', name: 'Supervisor (Crew Lead)', baseRate: 1400, unit: 'Day' },
                { code: 'CT-CREW-SOP', name: 'Senior Operator (Control Cabin)', baseRate: 1100, unit: 'Day' },
                { code: 'CT-CREW-PUMP', name: 'Pumping Operator (Fluids/N2)', baseRate: 900, unit: 'Day' },
                { code: 'CT-CREW-OP', name: 'Operator (Rig-Up/Tools)', baseRate: 800, unit: 'Day' },
            ],
            equipment: [
                { code: 'CT-EQP-UNIT', name: 'CT Unit (Reel, Injector, Cabin)', baseRate: 18000, unit: 'Day' },
                { code: 'CT-EQP-PCE', name: 'Pressure Control (Stripper, BOPs)', baseRate: 5000, unit: 'Day' },
                { code: 'CT-EQP-PUMP', name: 'High-Pressure Pump Unit (15k)', baseRate: 4500, unit: 'Day' },
                { code: 'CT-EQP-N2', name: 'Nitrogen Unit (Pumper & Tank)', baseRate: 4000, unit: 'Day' },
            ],
            tools: [
                { code: 'CT-EQP-BHA', name: 'Basic BHA (Connector, Check Valves)', baseRate: 800, unit: 'Day' },
                { code: 'CT-EQP-MOTOR', name: 'Downhole Motor (Milling)', baseRate: 2500, unit: 'Day' },
                { code: 'CT-EQP-JAR', name: 'Hydraulic Jars', baseRate: 1000, unit: 'Day' },
                { code: 'CT-EQP-NOZZLE', name: 'Jetting Nozzle (Wash)', baseRate: 700, unit: 'Day' },
            ]
        },
        els: {
            personnel: [
                { code: 'ELS-CREW-SUP', name: 'Supervisor (Crew Lead)', baseRate: 1300, unit: 'Day' },
                { code: 'ELS-CREW-SOP', name: 'Senior Operator (Logging Unit)', baseRate: 1000, unit: 'Day' },
                { code: 'ELS-CREW-OP', name: 'Operator (Winch/Tools)', baseRate: 750, unit: 'Day' },
            ],
            equipment: [
                { code: 'ELS-EQP-UNIT', name: 'E-Line Unit (Winch & Cabin)', baseRate: 6000, unit: 'Day' },
                { code: 'ELS-EQP-PCE', name: 'Pressure Control (BOP, Lubricator)', baseRate: 2000, unit: 'Day' },
            ],
            tools: [
                { code: 'ELS-EQP-TOOL-CCL', name: 'CCL / Gamma Ray Tool', baseRate: 1200, unit: 'Job' },
                { code: 'ELS-EQP-TOOL-PLT', name: 'Production Logging Tool (PLT)', baseRate: 4000, unit: 'Job' },
                { code: 'ELS-EQP-TOOL-CBL', name: 'Cement Bond Log (CBL)', baseRate: 3500, unit: 'Job' },
                { code: 'ELS-EQP-TOOL-PERF', name: 'Perforating Guns (Base Charge)', baseRate: 2500, unit: 'Job' },
            ]
        },
        slk: {
            personnel: [
                { code: 'SLK-CREW-SUP', name: 'Supervisor (Crew Lead)', baseRate: 1200, unit: 'Day' },
                { code: 'SLK-CREW-SOP', name: 'Senior Operator (Winch)', baseRate: 950, unit: 'Day' },
                { code: 'SLK-CREW-OP', name: 'Operator (Tools)', baseRate: 700, unit: 'Day' },
            ],
            equipment: [
                { code: 'SLK-EQP-UNIT', name: 'Slickline Unit (Winch & Powerpack)', baseRate: 3000, unit: 'Day' },
                { code: 'SLK-EQP-PCE', name: 'Pressure Control (BOP, Lubricator)', baseRate: 1500, unit: 'Day' },
            ],
            tools: [
                { code: 'SLK-EQP-TOOLS', name: 'Standard Toolstring (Jars, Stem)', baseRate: 500, unit: 'Day' },
                { code: 'SLK-EQP-PULL', name: 'Pulling/Running Tool (e.g., GS)', baseRate: 300, unit: 'Day' },
                { code: 'SLK-EQP-BAILER', name: 'Bailer (Sand/Debris)', baseRate: 400, unit: 'Day' },
            ]
        },
        whm: {
            personnel: [
                { code: 'WHM-CREW-SUP', name: 'Supervisor (Lead Technician)', baseRate: 1200, unit: 'Day' },
                { code: 'WHM-CREW-TECH', name: 'Wellhead Technician', baseRate: 900, unit: 'Day' },
            ],
            equipment: [
                { code: 'WHM-EQP-GREASE', name: 'Grease/Sealant Injection Pump (15k)', baseRate: 1200, unit: 'Day' },
                { code: 'WHM-EQP-TEST', name: 'Test Pump & Chart Recorder', baseRate: 1000, unit: 'Day' },
                { code: 'WHM-EQP-FLUSH', name: 'Wellhead Flushing Unit', baseRate: 900, unit: 'Day' },
            ],
            consumables: [
                { code: 'WHM-MAT-SEAL', name: 'Valve Sealant (Stick/Bulk)', baseRate: 500, unit: 'Job' },
                { code: 'WHM-MAT-GREASE', name: 'Valve Grease (Bulk)', baseRate: 400, unit: 'Job' },
                { code: 'WHM-MAT-RING', name: 'Ring Gasket (e.g., R, RX)', baseRate: 250, unit: 'Item' },
            ]
        }
    };

    // NPT Event Types and Costs
    const nptEventTypes = [
        { id: 'stuck-pipe', name: 'Stuck Pipe', description: 'Tools or pipe stuck downhole', avgDuration: 12, severity: 'high' },
        { id: 'equipment-failure', name: 'Equipment Failure', description: 'Primary equipment breakdown', avgDuration: 8, severity: 'high' },
        { id: 'weather-delay', name: 'Weather Delay', description: 'Adverse weather conditions', avgDuration: 24, severity: 'medium' },
        { id: 'well-control', name: 'Well Control Event', description: 'Pressure control issues', avgDuration: 6, severity: 'critical' },
        { id: 'fishing', name: 'Fishing Operations', description: 'Retrieve lost tools/equipment', avgDuration: 16, severity: 'high' },
        { id: 'wait-on-weather', name: 'Wait on Weather', description: 'Waiting for weather window', avgDuration: 48, severity: 'low' },
        { id: 'wait-on-equipment', name: 'Wait on Equipment', description: 'Waiting for equipment delivery', avgDuration: 24, severity: 'medium' },
        { id: 'leak-repair', name: 'Leak/Seal Repair', description: 'Pressure equipment leak', avgDuration: 4, severity: 'medium' },
        { id: 'bop-test', name: 'Unplanned BOP Test', description: 'Additional BOP pressure test', avgDuration: 3, severity: 'low' },
        { id: 'fluid-loss', name: 'Fluid Loss/Kill', description: 'Lost circulation or well kill', avgDuration: 8, severity: 'high' }
    ];

    // Job costing state
    let jobCostingState = {
        steps: [],
        activeStepId: null,
        jobDuration: 1,
        isToolExpanded: false,
        currentDiscipline: 'ct',
        currentCategories: {
            ct: 'personnel',
            els: 'personnel',
            slk: 'personnel',
            whm: 'personnel'
        },
        currentWellId: null  // Track which well these costs are for
    };

    // Initialize job costing tool
    function initJobCostingTool() {
        const toggleBtn = document.getElementById('toggle-costing-tool');
        const toolContent = document.getElementById('costing-tool-content');

        if (!toggleBtn || !toolContent) return;

        toggleBtn.addEventListener('click', () => {
            jobCostingState.isToolExpanded = !jobCostingState.isToolExpanded;
            if (jobCostingState.isToolExpanded) {
                toolContent.classList.remove('hidden');
                toggleBtn.textContent = 'Collapse Tool';
                loadWellCosts();  // Load costs for selected well
                renderJobCostingTool();
            } else {
                toolContent.classList.add('hidden');
                toggleBtn.textContent = 'Expand Tool';
            }
        });
    }

    // Load costs for the currently selected well
    function loadWellCosts() {
        if (!appState.selectedWell) return;

        const wellId = appState.selectedWell.id;
        jobCostingState.currentWellId = wellId;

        // Load saved costs for this well if they exist
        if (appState.wellCosts[wellId]) {
            jobCostingState.steps = appState.wellCosts[wellId].jobSteps || [];
            if (jobCostingState.steps.length > 0) {
                jobCostingState.activeStepId = jobCostingState.steps[jobCostingState.steps.length - 1].id;
            }
        } else {
            // Initialize empty cost tracking for this well
            appState.wellCosts[wellId] = {
                jobSteps: [],
                totalCost: 0,
                nptCost: 0,
                nptEvents: []
            };
        }
    }

    // Save costs for the currently selected well
    function saveWellCosts() {
        if (!jobCostingState.currentWellId) return;

        const totalCost = calculateTotalJobCost();
        const nptCost = calculateTotalNPTCost();

        appState.wellCosts[jobCostingState.currentWellId] = {
            jobSteps: [...jobCostingState.steps],
            totalCost: totalCost,
            nptCost: nptCost,
            nptEvents: appState.commercial.nptEvents
        };
    }

    // Calculate total job cost from steps
    function calculateTotalJobCost() {
        let total = 0;
        jobCostingState.steps.forEach(step => {
            step.items.forEach(item => {
                if (item.unit === 'Day') {
                    total += item.baseRate * jobCostingState.jobDuration;
                } else {
                    total += item.baseRate;
                }
            });
        });
        return total;
    }

    // Calculate total NPT cost
    function calculateTotalNPTCost() {
        let total = 0;
        appState.commercial.nptEvents.forEach(event => {
            total += event.cost || 0;
        });
        return total;
    }

    // Add NPT event
    function addNPTEvent(eventTypeId, actualDuration, description) {
        const eventType = nptEventTypes.find(et => et.id === eventTypeId);
        if (!eventType) return;

        // Calculate NPT cost based on day rates of active personnel and equipment
        const dailyCost = calculateDailySpreadRate();
        const nptCost = (actualDuration / 24) * dailyCost;

        const nptEvent = {
            id: `npt-${Date.now()}`,
            type: eventType.name,
            typeId: eventTypeId,
            description: description || eventType.description,
            duration: actualDuration,
            cost: nptCost,
            severity: eventType.severity,
            timestamp: new Date().toISOString()
        };

        appState.commercial.nptEvents.push(nptEvent);
        saveWellCosts();
        renderNPTList();
        updatePerformerCostDisplay(calculateTotalJobCost() + calculateTotalNPTCost());
    }

    // Calculate daily spread rate from job costing items
    function calculateDailySpreadRate() {
        let dailyRate = 0;
        jobCostingState.steps.forEach(step => {
            step.items.forEach(item => {
                if (item.unit === 'Day') {
                    dailyRate += item.baseRate;
                }
            });
        });
        return dailyRate;
    }

    // Render NPT event list
    function renderNPTList() {
        const container = document.getElementById('npt-events-list');
        if (!container) return;

        if (appState.commercial.nptEvents.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No NPT events recorded</p>';
            return;
        }

        container.innerHTML = appState.commercial.nptEvents.map(event => {
            const severityColors = {
                low: 'bg-yellow-500/20 border-yellow-500',
                medium: 'bg-orange-500/20 border-orange-500',
                high: 'bg-red-500/20 border-red-500',
                critical: 'bg-purple-500/20 border-purple-500'
            };
            const colorClass = severityColors[event.severity] || 'bg-gray-500/20 border-gray-500';

            return `
                <div class="p-3 rounded-lg border-l-4 ${colorClass} mb-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold">${event.type}</div>
                            <div class="text-sm text-gray-400">${event.description}</div>
                            <div class="text-xs text-gray-500 mt-1">${event.duration}hrs</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-red-400">Â£${(event.cost / 1000).toFixed(0)}K</div>
                            <button class="text-xs text-red-500 hover:text-red-400 mt-1" onclick="removeNPTEvent('${event.id}')">Remove</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Remove NPT event
    function removeNPTEvent(eventId) {
        appState.commercial.nptEvents = appState.commercial.nptEvents.filter(e => e.id !== eventId);
        saveWellCosts();
        renderNPTList();
        updatePerformerCostDisplay(calculateTotalJobCost() + calculateTotalNPTCost());
    }

    // Render the complete job costing tool
    function renderJobCostingTool() {
        const container = document.getElementById('job-costing-tool-container');
        if (!container) return;

        container.innerHTML = `
            <div class="lg:grid lg:grid-cols-2 lg:gap-10">
                <!-- Service Catalogue -->
                <div class="lg:col-span-1">
                    <h3 class="text-xl font-bold mb-4">Service Catalogue</h3>
                    <div id="cost-main-tabs" class="flex flex-wrap border-b border-gray-700 mb-4">
                        <button class="cost-main-tab text-sm font-bold py-2 px-4 border-b-2 border-transparent hover:text-cyan-400" onclick="showCostMainTab('ct')">CT</button>
                        <button class="cost-main-tab text-sm font-bold py-2 px-4 border-b-2 border-transparent hover:text-cyan-400" onclick="showCostMainTab('els')">ELS</button>
                        <button class="cost-main-tab text-sm font-bold py-2 px-4 border-b-2 border-transparent hover:text-cyan-400" onclick="showCostMainTab('slk')">SLK</button>
                        <button class="cost-main-tab text-sm font-bold py-2 px-4 border-b-2 border-transparent hover:text-cyan-400" onclick="showCostMainTab('whm')">WHM</button>
                    </div>
                    <div id="cost-main-content-panels"></div>
                </div>

                <!-- Job Procedure Builder -->
                <div class="lg:col-span-1 mt-8 lg:mt-0">
                    <div class="light-card rounded-lg shadow-xl">
                        <div class="p-4 border-b border-gray-700">
                            <h3 class="text-xl font-bold">Job Procedure & Cost</h3>
                            ${appState.selectedWell ? `<p class="text-sm text-cyan-400 mt-1">ðŸ“ Well: ${appState.selectedWell.id} - ${appState.selectedWell.name}</p>` : ''}
                        </div>

                        <div class="p-4 border-b border-gray-700">
                            <label class="block text-sm font-semibold text-cyan-400 mb-2">Job Duration (Days)</label>
                            <input type="number" id="job-duration-input" value="1" min="1"
                                class="w-1/2 bg-gray-800 border-gray-700 rounded-md px-3 py-2 text-white font-bold"
                                onchange="updateJobDuration(this.value)">
                            <p class="text-xs text-gray-400 mt-2">Costs for "/Day" items will be multiplied by this value.</p>
                        </div>

                        <div class="p-4 border-b border-gray-700">
                            <h4 class="text-sm font-semibold text-cyan-400 mb-3">Add Job Step</h4>
                            <div class="flex gap-2">
                                <input type="text" id="step-title-input" placeholder="e.g., Step 1: Rig Up"
                                    class="flex-grow bg-gray-800 border-gray-700 rounded-md px-3 py-2 text-white">
                                <button onclick="addJobStep()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-md">Add</button>
                            </div>
                        </div>

                        <div id="procedure-list-container" class="max-h-96 overflow-y-auto p-4">
                            <ul id="procedure-list">
                                <li class="py-6 text-center text-gray-500">Add a job step to begin building your procedure.</li>
                            </ul>
                        </div>

                        <div class="p-4 bg-gray-800 rounded-b-lg flex justify-between items-center">
                            <span class="text-lg font-bold uppercase">Total Cost</span>
                            <span id="job-total" class="text-3xl font-black text-cyan-400">Â£0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Render the service catalogue
        renderServiceCatalogue();

        // Activate first tab
        document.querySelector('.cost-main-tab').classList.add('active');
    }

    // Render service catalogue panels
    function renderServiceCatalogue() {
        const panels = document.getElementById('cost-main-content-panels');
        if (!panels) return;

        let html = '';
        for (const discipline in serviceCatalogue) {
            html += `
                <div id="cost-content-${discipline}" class="cost-main-content" style="display:none;">
                    <div class="flex flex-wrap border-b border-gray-600 mb-4">
            `;

            const categories = Object.keys(serviceCatalogue[discipline]);
            categories.forEach(category => {
                html += `
                    <button class="cost-sub-tab text-sm font-semibold py-2 px-3 border-b-2 border-transparent text-gray-400 hover:text-cyan-300"
                            onclick="showCostSubTab('${discipline}', '${category}')">${category.charAt(0).toUpperCase() + category.slice(1)}</button>
                `;
            });

            html += `</div><div class="catalogue-table-container">`;

            categories.forEach(category => {
                html += `
                    <div class="cost-sub-content-${discipline}" id="cost-content-${discipline}-${category}" style="display:none;">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700 text-cyan-400 text-xs">
                                <tr>
                                    <th class="p-2 text-left">Description</th>
                                    <th class="p-2 text-left">Code</th>
                                    <th class="p-2 text-left">Rate/Unit</th>
                                    <th class="p-2"></th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                serviceCatalogue[discipline][category].forEach(item => {
                    const itemJSON = JSON.stringify(item).replace(/"/g, '&quot;');
                    html += `
                        <tr class="border-b border-gray-700 hover:bg-gray-800">
                            <td class="p-2">${item.name}</td>
                            <td class="p-2 font-mono text-xs text-gray-400">${item.code}</td>
                            <td class="p-2 font-bold">Â£${item.baseRate}<span class="text-xs font-normal text-gray-400">/${item.unit}</span></td>
                            <td class="p-2 text-right">
                                <button class="cost-add-btn" onclick='addItemToActiveStep(${itemJSON})'>Add</button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            html += `</div></div>`;
        }

        panels.innerHTML = html;

        // Show first discipline and first category
        showCostMainTab('ct');
    }

    // --- INITIALIZATION ---

    const init = () => {
        // Expose functions to window FIRST before rendering (so onclick handlers work)
        window.jobCostingState = jobCostingState;
        window.appState = appState;
        window.addNPTEvent = addNPTEvent;
        window.removeNPTEvent = removeNPTEvent;
        window.calculateTotalNPTCost = calculateTotalNPTCost;
        window.calculateTotalJobCost = calculateTotalJobCost;
        window.saveWellCosts = saveWellCosts;
        window.renderNPTList = renderNPTList;
        window.showView = switchView;
        window.addNPTEventFromUI = addNPTEventFromUI;
        window.wellData = wellData;
        window.openModal = openModal;
        window.selectWellW666 = selectWellW666;

        // Now render UI (which uses the above functions in onclick handlers)
        renderWellCards();
        renderObjectives();
        renderProblems();
        initSavingsChart();
        updateNavLinks();
        loadCostData(); // Load cost data from CSV files
        initJobCostingTool(); // Initialize job costing tool

        while (pendingShowViewCalls.length > 0) {
            const queuedView = pendingShowViewCalls.shift();
            if (queuedView) {
                switchView(queuedView);
            }
        }
    };

    init();
});

// --- WELLBORE SURVEY CSV TOOL WITH MINIMUM CURVATURE ---
(function() {
    // Survey data state
    let surveyData = [];
    let computed = [];
    let currentView = 'profile'; // or 'plan'
    let running = false, tNorm = 0, speed = 1, last = 0;
    let pathLength = 0;

    // DOM elements
    const svg = document.getElementById('wbSvg');
    const path = document.getElementById('wbPath');
    const dot = document.getElementById('toolDot');
    const mdBadge = document.getElementById('mdBadge');
    const stationsG = document.getElementById('survey-stations');
    const axesG = document.getElementById('survey-axes');

    const dropZone = document.getElementById('survey-drop-zone');
    const fileInput = document.getElementById('survey-file-input');
    const pasteArea = document.getElementById('survey-paste-area');
    const columnMap = document.getElementById('survey-column-map');
    const statusEl = document.getElementById('survey-status');
    const viewLabel = document.getElementById('survey-view-label');
    const dataBadge = document.getElementById('survey-data-badge');

    const playBtn = document.getElementById('wbPlay');
    const pauseBtn = document.getElementById('wbPause');
    const speedEl = document.getElementById('wbSpeed');
    const scrubEl = document.getElementById('wbScrub');
    const infoEl = document.getElementById('wbInfo');

    const kMD = document.getElementById('kpiMD');
    const kTVD = document.getElementById('kpiTVD');
    const kInc = document.getElementById('kpiIncl');
    const kAz = document.getElementById('kpiAz');
    const kNorth = document.getElementById('kpiNorth');
    const kEast = document.getElementById('kpiEast');
    const kDep = document.getElementById('kpiDep');

    const surveyCount = document.getElementById('survey-count');
    const surveyMaxInc = document.getElementById('survey-max-inc');
    const surveyTotalMD = document.getElementById('survey-total-md');

    if (!svg || !path) return;

    // CSV Parsing with delimiter detection
    function sniffDelimiter(text) {
        const first = text.split('\n')[0];
        const delims = [',', ';', '\t', '|'];
        let best = ',', maxCount = 0;
        for (const d of delims) {
            const count = (first.match(new RegExp('\\' + d, 'g')) || []).length;
            if (count > maxCount) {
                maxCount = count;
                best = d;
            }
        }
        return best;
    }

    function parseCSV(text) {
        const delim = sniffDelimiter(text);
        const lines = text.trim().split('\n');
        const rows = [];
        for (const line of lines) {
            const row = [];
            let current = '', inQuote = false;
            for (let i = 0; i < line.length; i++) {
                const c = line[i];
                if (c === '"') inQuote = !inQuote;
                else if (c === delim && !inQuote) {
                    row.push(current.trim());
                    current = '';
                } else {
                    current += c;
                }
            }
            row.push(current.trim());
            rows.push(row);
        }
        return { rows, delim };
    }

    // Auto-detect MD, INC, AZ columns with enhanced synonym support
    function autoDetectColumns(headers) {
        const lower = headers.map(h=> (h||'').toString().trim().toLowerCase());

        function findOne(candidates){
            for(const c of candidates){
                const idx = lower.indexOf(c);
                if(idx!==-1) return idx;
            }
            // Try partial match
            for(const c of candidates){
                const idx = lower.findIndex(h => h.includes(c));
                if(idx!==-1) return idx;
            }
            return -1;
        }

        // Broader synonym support for BOEM/NSTA/NLOG/FORGE/Volve datasets
        const md = findOne(['md','measured depth','measured_depth','measureddepth','md (m)','mdm','depth md','depth (md)','depth (m)','depth']);
        const inc = findOne(['inc','incl','inclination','inclination (deg)','inc (deg)','angle']);
        const azi = findOne(['azi','azimuth','az','az (deg)','azimuth (deg)','azm','bearing']);
        const tvd = findOne(['tvd','tvd (m)','tvdss','true vertical depth']);
        const north = findOne(['n','north','northing','y','y (m)','northing (m)','deviation north']);
        const east = findOne(['e','east','easting','x','x (m)','easting (m)','deviation east']);

        return {md, inc, azi, tvd, north, east};
    }

    // Minimum Curvature calculation
    function computeCoordinates(stations) {
        if (stations.length === 0) return;

        // Initialize first station
        stations[0].tvd = stations[0].tvd || 0;
        stations[0].north = stations[0].north || 0;
        stations[0].east = stations[0].east || 0;

        for (let i = 1; i < stations.length; i++) {
            const a = stations[i - 1];
            const b = stations[i];

            const md1 = a.md, md2 = b.md;
            const inc1 = (a.inc || 0) * Math.PI / 180;
            const inc2 = (b.inc || 0) * Math.PI / 180;
            const az1 = (a.azi || 0) * Math.PI / 180;
            const az2 = (b.azi || 0) * Math.PI / 180;

            const dMD = md2 - md1;

            // Minimum curvature method
            const cosDL = Math.sin(inc1) * Math.sin(inc2) * Math.cos(az2 - az1) + Math.cos(inc1) * Math.cos(inc2);
            const DL = Math.acos(Math.min(1, Math.max(-1, cosDL)));
            const RF = (DL > 1e-6) ? (2 / DL) * Math.tan(DL / 2) : 1;

            const dN = 0.5 * dMD * RF * (Math.sin(inc1) * Math.cos(az1) + Math.sin(inc2) * Math.cos(az2));
            const dE = 0.5 * dMD * RF * (Math.sin(inc1) * Math.sin(az1) + Math.sin(inc2) * Math.sin(az2));
            const dV = 0.5 * dMD * RF * (Math.cos(inc1) + Math.cos(inc2));

            b.tvd = (a.tvd || 0) + dV;
            b.north = (a.north || 0) + dN;
            b.east = (a.east || 0) + dE;
        }

        // Calculate departure
        stations.forEach(s => {
            s.departure = Math.sqrt(s.north * s.north + s.east * s.east);
        });
    }

    // Process CSV and extract survey data
    function processSurveyData(text) {
        try {
            const { rows } = parseCSV(text);
            if (rows.length < 2) {
                throw new Error('Not enough data rows');
            }

            const headers = rows[0];
            const colMap = autoDetectColumns(headers);

            // Check if manual mapping needed
            if (colMap.md === -1 || colMap.inc === -1 || colMap.azi === -1) {
                showColumnMapper(headers);
                return null;
            }

            return extractStations(rows.slice(1), colMap);
        } catch (err) {
            statusEl.textContent = 'âŒ Error: ' + err.message;
            statusEl.className = 'mt-4 text-xs text-red-400';
            return null;
        }
    }

    function extractStations(dataRows, colMap) {
        const stations = [];
        for (const row of dataRows) {
            const md = parseFloat(row[colMap.md]);
            const inc = parseFloat(row[colMap.inc]);
            const azi = parseFloat(row[colMap.azi]);

            if (isNaN(md) || isNaN(inc) || isNaN(azi)) continue;

            const station = { md, inc, azi };

            // Optional coordinates
            if (colMap.tvd >= 0) station.tvd = parseFloat(row[colMap.tvd]) || 0;
            if (colMap.north >= 0) station.north = parseFloat(row[colMap.north]) || 0;
            if (colMap.east >= 0) station.east = parseFloat(row[colMap.east]) || 0;

            stations.push(station);
        }

        // Sort by MD
        stations.sort((a, b) => a.md - b.md);

        // Compute missing coordinates
        computeCoordinates(stations);

        return stations;
    }

    function showColumnMapper(headers) {
        const selects = ['col-md', 'col-inc', 'col-azi'];
        selects.forEach(id => {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="">-- Select --</option>';
            headers.forEach((h, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = h;
                sel.appendChild(opt);
            });
        });
        columnMap.classList.remove('hidden');
        statusEl.textContent = 'âš ï¸ Please map columns manually';
        statusEl.className = 'mt-4 text-xs text-amber-400';
    }

    window.applySurveyMapping = function() {
        const colMap = {
            md: parseInt(document.getElementById('col-md').value),
            inc: parseInt(document.getElementById('col-inc').value),
            azi: parseInt(document.getElementById('col-azi').value),
            tvd: -1, north: -1, east: -1
        };

        if (isNaN(colMap.md) || isNaN(colMap.inc) || isNaN(colMap.azi)) {
            alert('Please select all required columns (MD, INC, AZ)');
            return;
        }

        const text = pasteArea.value.trim();
        if (!text) return;

        const { rows } = parseCSV(text);
        const stations = extractStations(rows.slice(1), colMap);

        if (stations && stations.length > 0) {
            surveyData = stations;
            columnMap.classList.add('hidden');
            renderSurvey();
        }
    };

    // Render survey visualization
    function renderSurvey() {
        if (surveyData.length === 0) return;

        computed = surveyData.slice();

        // Update stats
        surveyCount.textContent = surveyData.length;
        surveyMaxInc.textContent = Math.max(...surveyData.map(s => s.inc)).toFixed(1) + 'Â°';
        surveyTotalMD.textContent = surveyData[surveyData.length - 1].md.toFixed(1) + ' m';
        dataBadge.textContent = surveyData.length + ' stations';
        dataBadge.className = 'text-xs text-cyan-400';

        statusEl.textContent = 'âœ“ ' + surveyData.length + ' survey stations loaded';
        statusEl.className = 'mt-4 text-xs text-emerald-400';

        // Compute DLS for actual survey
        if (computed && computed.length > 1) {
            dlsData = computeDLS(computed);
        }

        // Render current view
        if (currentView === 'profile') {
            renderProfileView();
        } else {
            renderPlanView();
        }

        // Render DLS hotspots and panel
        renderDLSHotspots();
        renderDLSPanel();

        // Reset animation
        tNorm = 0;
        updateAnimation(0);
    }

    function renderProfileView() {
        viewLabel.textContent = 'Profile View (Departure vs TVD)';

        if (!computed || computed.length === 0) return;

        // Find bounds
        const maxDep = Math.max(...computed.map(s => s.departure));
        const maxTVD = Math.max(...computed.map(s => s.tvd));

        // SVG dimensions
        const margin = 60, width = 800 - 2 * margin, height = 520 - 2 * margin;
        const scaleX = width / (maxDep * 1.1 || 1);
        const scaleY = height / (maxTVD * 1.1 || 1);

        // Build actual path
        let pathD = '';
        computed.forEach((s, i) => {
            const dep = Math.sqrt(s.north * s.north + s.east * s.east);
            const x = margin + dep * scaleX;
            const y = margin + s.tvd * scaleY;
            pathD += (i === 0 ? 'M' : 'L') + x + ',' + y + ' ';
        });

        path.setAttribute('d', pathD);
        pathLength = path.getTotalLength();

        // Draw station dots
        stationsG.innerHTML = '';
        computed.forEach(s => {
            const dep = Math.sqrt(s.north * s.north + s.east * s.east);
            const x = margin + dep * scaleX;
            const y = margin + s.tvd * scaleY;
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '3');
            circle.setAttribute('fill', '#22d3ee');
            circle.setAttribute('opacity', '0.6');
            stationsG.appendChild(circle);
        });

        // Render plan overlay if available
        if (planSurvey.length > 0 && togglePlan && togglePlan.checked) {
            let planPathD = '';
            planSurvey.forEach((s, i) => {
                const dep = Math.sqrt(s.north * s.north + s.east * s.east);
                const x = margin + dep * scaleX;
                const y = margin + s.tvd * scaleY;
                planPathD += (i === 0 ? 'M' : 'L') + x + ',' + y + ' ';
            });

            // Remove existing plan path
            const existingPlan = svg.querySelector('#plan-overlay-path');
            if (existingPlan) existingPlan.remove();

            // Add plan path
            const planPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            planPath.setAttribute('id', 'plan-overlay-path');
            planPath.setAttribute('d', planPathD);
            planPath.setAttribute('fill', 'none');
            planPath.setAttribute('stroke', '#94a3b8');
            planPath.setAttribute('stroke-width', '3');
            planPath.setAttribute('stroke-dasharray', '8 6');
            planPath.setAttribute('opacity', '0.7');
            svg.insertBefore(planPath, path);
        } else {
            const existingPlan = svg.querySelector('#plan-overlay-path');
            if (existingPlan) existingPlan.remove();
        }

        // Update axes labels
        axesG.innerHTML = `
            <text x="400" y="515" fill="#94a3b8" font-size="11" text-anchor="middle">Departure (m)</text>
            <text x="10" y="260" fill="#94a3b8" font-size="11" transform="rotate(-90 10 260)" text-anchor="middle">TVD (m)</text>
        `;
    }

    function renderPlanView() {
        viewLabel.textContent = 'Plan View (East vs North)';

        if (!computed || computed.length === 0) return;

        // Find bounds
        const minN = Math.min(...computed.map(s => s.north || 0));
        const maxN = Math.max(...computed.map(s => s.north || 0));
        const minE = Math.min(...computed.map(s => s.east || 0));
        const maxE = Math.max(...computed.map(s => s.east || 0));

        const rangeN = maxN - minN || 1;
        const rangeE = maxE - minE || 1;

        const margin = 60, width = 800 - 2 * margin, height = 520 - 2 * margin;
        const scale = Math.min(width / (rangeE * 1.1), height / (rangeN * 1.1));

        // Build actual path
        let pathD = '';
        computed.forEach((s, i) => {
            const x = margin + width / 2 + (s.east - (minE + maxE) / 2) * scale;
            const y = margin + height / 2 - (s.north - (minN + maxN) / 2) * scale;
            pathD += (i === 0 ? 'M' : 'L') + x + ',' + y + ' ';
        });

        path.setAttribute('d', pathD);
        pathLength = path.getTotalLength();

        // Draw station dots
        stationsG.innerHTML = '';
        computed.forEach(s => {
            const x = margin + width / 2 + (s.east - (minE + maxE) / 2) * scale;
            const y = margin + height / 2 - (s.north - (minN + maxN) / 2) * scale;
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '3');
            circle.setAttribute('fill', '#22d3ee');
            circle.setAttribute('opacity', '0.6');
            stationsG.appendChild(circle);
        });

        // Render plan overlay if available
        if (planSurvey.length > 0 && togglePlan && togglePlan.checked) {
            let planPathD = '';
            planSurvey.forEach((s, i) => {
                const x = margin + width / 2 + (s.east - (minE + maxE) / 2) * scale;
                const y = margin + height / 2 - (s.north - (minN + maxN) / 2) * scale;
                planPathD += (i === 0 ? 'M' : 'L') + x + ',' + y + ' ';
            });

            // Remove existing plan path
            const existingPlan = svg.querySelector('#plan-overlay-path');
            if (existingPlan) existingPlan.remove();

            // Add plan path
            const planPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            planPath.setAttribute('id', 'plan-overlay-path');
            planPath.setAttribute('d', planPathD);
            planPath.setAttribute('fill', 'none');
            planPath.setAttribute('stroke', '#94a3b8');
            planPath.setAttribute('stroke-width', '3');
            planPath.setAttribute('stroke-dasharray', '8 6');
            planPath.setAttribute('opacity', '0.7');
            svg.insertBefore(planPath, path);
        } else {
            const existingPlan = svg.querySelector('#plan-overlay-path');
            if (existingPlan) existingPlan.remove();
        }

        // Update axes labels
        axesG.innerHTML = `
            <text x="400" y="515" fill="#94a3b8" font-size="11" text-anchor="middle">East (m)</text>
            <text x="10" y="260" fill="#94a3b8" font-size="11" transform="rotate(-90 10 260)" text-anchor="middle">North (m)</text>
        `;
    }

    // Animation system
    function updateAnimation(norm) {
        if (surveyData.length === 0 || pathLength === 0) return;

        norm = Math.max(0, Math.min(1, norm));
        const len = norm * pathLength;
        const p = path.getPointAtLength(len);

        // Update tool position
        dot.setAttribute('cx', p.x);
        dot.setAttribute('cy', p.y);
        mdBadge.setAttribute('x', p.x + 12);
        mdBadge.setAttribute('y', p.y - 12);

        // Find current survey station by interpolation
        const totalMD = surveyData[surveyData.length - 1].md;
        const currentMD = norm * totalMD;

        // Find surrounding stations
        let idx = 0;
        for (let i = 0; i < surveyData.length - 1; i++) {
            if (currentMD >= surveyData[i].md && currentMD <= surveyData[i + 1].md) {
                idx = i;
                break;
            }
        }

        const s1 = surveyData[idx];
        const s2 = surveyData[Math.min(idx + 1, surveyData.length - 1)];
        const ratio = s2.md > s1.md ? (currentMD - s1.md) / (s2.md - s1.md) : 0;

        // Interpolate values
        const md = s1.md + ratio * (s2.md - s1.md);
        const tvd = s1.tvd + ratio * (s2.tvd - s1.tvd);
        const inc = s1.inc + ratio * (s2.inc - s1.inc);
        const azi = s1.azi + ratio * (s2.azi - s1.azi);
        const north = s1.north + ratio * (s2.north - s1.north);
        const east = s1.east + ratio * (s2.east - s1.east);
        const dep = Math.sqrt(north * north + east * east);

        // Update KPIs
        mdBadge.textContent = 'MD ' + md.toFixed(1) + ' m';
        kMD.textContent = md.toFixed(1) + ' m';
        kTVD.textContent = tvd.toFixed(1) + ' m';
        kInc.textContent = inc.toFixed(1) + 'Â°';
        kAz.textContent = azi.toFixed(1) + 'Â°';
        kNorth.textContent = north.toFixed(1) + ' m';
        kEast.textContent = east.toFixed(1) + ' m';
        kDep.textContent = dep.toFixed(1) + ' m';

        infoEl.textContent = 'Incl: ' + inc.toFixed(1) + 'Â° | Az: ' + azi.toFixed(1) + 'Â°';
        scrubEl.value = Math.round(norm * 1000);
        tNorm = norm;
    }

    function animationLoop(ts) {
        if (!running) {
            last = ts;
            return;
        }
        const dt = (ts - last) / 1000;
        last = ts;
        const advance = dt * 0.08 * speed;
        let next = tNorm + advance;
        if (next >= 1) {
            next = 1;
            running = false;
        }
        updateAnimation(next);
        requestAnimationFrame(animationLoop);
    }

    // Event handlers
    playBtn.addEventListener('click', () => {
        if (surveyData.length === 0) {
            statusEl.textContent = 'âš ï¸ Please load survey data first';
            statusEl.className = 'mt-4 text-xs text-amber-400';
            return;
        }
        running = true;
        requestAnimationFrame((ts) => {
            last = ts;
            requestAnimationFrame(animationLoop);
        });
    });

    pauseBtn.addEventListener('click', () => {
        running = false;
    });

    speedEl.addEventListener('input', e => {
        speed = parseFloat(e.target.value);
    });

    scrubEl.addEventListener('input', e => {
        running = false;
        updateAnimation(e.target.value / 1000);
    });

    // File upload handlers
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#22d3ee';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = '#475569';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#475569';
        const file = e.dataTransfer.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const text = evt.target.result;
                pasteArea.value = text;
                const stations = processSurveyData(text);
                if (stations) {
                    surveyData = stations;
                    renderSurvey();
                }
            };
            reader.readAsText(file);
        }
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const text = evt.target.result;
                pasteArea.value = text;
                const stations = processSurveyData(text);
                if (stations) {
                    surveyData = stations;
                    renderSurvey();
                }
            };
            reader.readAsText(file);
        }
    });

    pasteArea.addEventListener('input', () => {
        const text = pasteArea.value.trim();
        if (text) {
            const stations = processSurveyData(text);
            if (stations) {
                surveyData = stations;
                renderSurvey();
            }
        }
    });

    // View switching
    window.switchSurveyView = function(view) {
        currentView = view;

        const profileBtn = document.getElementById('view-profile-btn');
        const planBtn = document.getElementById('view-plan-btn');

        if (view === 'profile') {
            profileBtn.className = 'px-3 py-2 bg-cyan-600 text-white text-sm font-semibold rounded-md transition';
            planBtn.className = 'px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-semibold rounded-md transition';
        } else {
            profileBtn.className = 'px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-semibold rounded-md transition';
            planBtn.className = 'px-3 py-2 bg-cyan-600 text-white text-sm font-semibold rounded-md transition';
        }

        if (surveyData.length > 0) {
            renderSurvey();
        }
    };

    // Sample data loader
    window.loadSampleSurvey = function() {
        const sample = `MD,INC,AZ
0,0,0
500,5,45
1000,15,90
1500,30,120
2000,45,135
2500,60,150
3000,75,165
3500,85,180`;

        pasteArea.value = sample;
        const stations = processSurveyData(sample);
        if (stations) {
            surveyData = stations;
            renderSurvey();
        }
    };

    // ========= PLAN OVERLAY & DLS ENHANCEMENTS =========

    let planSurvey = [];  // Separate plan data
    let dlsData = [];     // DLS calculations for actual survey
    let deltaStats = null; // Delta statistics when plan is loaded

    const dlsThreshold = document.getElementById('dls-threshold');
    const dlsThresholdVal = document.getElementById('dls-threshold-val');
    const togglePlan = document.getElementById('toggle-plan');
    const toggleHotspots = document.getElementById('toggle-hotspots');
    const deltaStatsDiv = document.getElementById('delta-stats');
    const dlsPanel = document.getElementById('dls-panel');
    const dlsList = document.getElementById('dls-list');

    // Update DLS threshold display
    if (dlsThreshold && dlsThresholdVal) {
        dlsThreshold.addEventListener('input', (e) => {
            dlsThresholdVal.textContent = parseFloat(e.target.value).toFixed(1);
            if (dlsData.length > 0) {
                renderDLSHotspots();
                renderDLSPanel();
            }
        });
    }

    // Toggle event listeners
    if (togglePlan) {
        togglePlan.addEventListener('change', () => {
            if (surveyData.length > 0) renderSurvey();
        });
    }

    if (toggleHotspots) {
        toggleHotspots.addEventListener('change', () => {
            renderDLSHotspots();
            renderDLSPanel();
        });
    }

    // Compute DLS (Dogleg Severity) for survey
    function computeDLS(stations) {
        const dls = [];
        if (stations.length < 2) return dls;

        for (let i = 1; i < stations.length; i++) {
            const a = stations[i - 1];
            const b = stations[i];

            const inc1 = (a.inc || 0) * Math.PI / 180;
            const inc2 = (b.inc || 0) * Math.PI / 180;
            const az1 = (a.azi || 0) * Math.PI / 180;
            const az2 = (b.azi || 0) * Math.PI / 180;

            const cosDL = Math.sin(inc1) * Math.sin(inc2) * Math.cos(az2 - az1) + Math.cos(inc1) * Math.cos(inc2);
            const DL = Math.acos(Math.min(1, Math.max(-1, cosDL)));
            const dmd = (b.md - a.md) || 1;
            const dlsDeg = (DL * 180 / Math.PI) / (dmd / 30); // degrees per 30m

            dls.push({ md: b.md, dls: dlsDeg, tvd: b.tvd, north: b.north, east: b.east });
        }

        return dls;
    }

    // Render DLS hotspots on SVG
    function renderDLSHotspots() {
        // Remove existing hotspots
        const existing = svg.querySelectorAll('.dls-hotspot');
        existing.forEach(el => el.remove());

        if (!toggleHotspots || !toggleHotspots.checked || dlsData.length === 0) return;

        const threshold = dlsThreshold ? parseFloat(dlsThreshold.value) : 6;
        const pathEl = document.getElementById('wbPath');
        if (!pathEl) return;

        const L = pathEl.getTotalLength();
        if (L === 0) return;

        dlsData.forEach(item => {
            if (item.dls < threshold) return;

            const t = (item.md - mdMin) / ((mdMax - mdMin) || 1);
            const p = pathEl.getPointAtLength(t * L);

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('class', 'dls-hotspot');
            circle.setAttribute('cx', p.x);
            circle.setAttribute('cy', p.y);
            circle.setAttribute('r', '5');
            circle.setAttribute('fill', '#ef4444');
            circle.setAttribute('stroke', '#0b1220');
            circle.setAttribute('stroke-width', '2');
            circle.setAttribute('opacity', '0.9');

            const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
            title.textContent = `MD ${Math.round(item.md)} m Â· ${item.dls.toFixed(1)}Â°/30m`;
            circle.appendChild(title);

            svg.appendChild(circle);
        });
    }

    // Render DLS panel with top hotspots
    function renderDLSPanel() {
        if (!dlsData.length || !toggleHotspots || !toggleHotspots.checked) {
            if (dlsPanel) dlsPanel.classList.add('hidden');
            return;
        }

        const threshold = dlsThreshold ? parseFloat(dlsThreshold.value) : 6;
        const hotspots = dlsData.filter(d => d.dls >= threshold).sort((a, b) => b.dls - a.dls).slice(0, 6);

        if (hotspots.length === 0) {
            if (dlsPanel) dlsPanel.classList.add('hidden');
            return;
        }

        if (dlsPanel) {
            dlsPanel.classList.remove('hidden');
            if (dlsList) {
                dlsList.innerHTML = hotspots.map(h => `
                    <button onclick="jumpToMD(${h.md})" class="px-2 py-1 bg-red-900/30 hover:bg-red-900/50 border border-red-700/50 rounded text-left transition">
                        MD ${Math.round(h.md)} m
                    </button>
                    <div class="px-2 py-1 bg-red-900/20 border border-red-700/30 rounded text-right">
                        ${h.dls.toFixed(1)}Â°/30m
                    </div>
                `).join('');
            }
        }
    }

    // Jump to specific MD on animation
    window.jumpToMD = function(md) {
        const t = (md - mdMin) / ((mdMax - mdMin) || 1);
        running = false;
        updateAnimation(t);
    };

    // Compute delta statistics between actual and plan
    function computeDeltaStats(actual, plan) {
        if (!actual.length || !plan.length) return null;

        const deltas = actual.map(a => {
            // Find or interpolate plan point at same MD
            const pIdx = plan.findIndex(p => p.md >= a.md);
            if (pIdx === -1) return { md: a.md, deltaLat: 0 };
            if (pIdx === 0) {
                const dN = a.north - plan[0].north;
                const dE = a.east - plan[0].east;
                return { md: a.md, deltaLat: Math.sqrt(dN * dN + dE * dE) };
            }

            const p1 = plan[pIdx - 1];
            const p2 = plan[pIdx];
            const ratio = (a.md - p1.md) / ((p2.md - p1.md) || 1);
            const pN = p1.north + ratio * (p2.north - p1.north);
            const pE = p1.east + ratio * (p2.east - p1.east);

            const dN = a.north - pN;
            const dE = a.east - pE;
            return { md: a.md, deltaLat: Math.sqrt(dN * dN + dE * dE) };
        });

        const maxDelta = Math.max(...deltas.map(d => d.deltaLat));
        const avgDelta = deltas.reduce((sum, d) => sum + d.deltaLat, 0) / deltas.length;
        const endDelta = deltas[deltas.length - 1].deltaLat;

        // Find kickoff delta (where deviation > 1m)
        const kickoffThreshold = 1.0; // meters
        const kickoffPoint = deltas.find(d => d.deltaLat > kickoffThreshold);
        const kickoffDelta = kickoffPoint ? kickoffPoint.deltaLat : 0;

        return { maxDelta, avgDelta, endDelta, kickoffDelta, deltas };
    }

    // Update delta stats display
    function updateDeltaStats() {
        if (!deltaStats || !deltaStatsDiv) {
            if (deltaStatsDiv) deltaStatsDiv.classList.add('hidden');
            return;
        }

        deltaStatsDiv.classList.remove('hidden');
        document.getElementById('delta-max').textContent = Math.round(deltaStats.maxDelta) + ' m';
        document.getElementById('delta-avg').textContent = Math.round(deltaStats.avgDelta) + ' m';
        document.getElementById('delta-end').textContent = Math.round(deltaStats.endDelta) + ' m';
        document.getElementById('delta-kickoff').textContent = Math.round(deltaStats.kickoffDelta) + ' m';

        // Draw sparkline
        if (deltaStats.deltas && deltaStats.deltas.length > 0) {
            const sparklinePath = document.getElementById('sparkline-path');
            if (sparklinePath) {
                const width = 60;
                const height = 20;
                const padding = 2;
                const maxVal = Math.max(...deltaStats.deltas.map(d => d.deltaLat), 1);

                const points = deltaStats.deltas.map((d, i) => {
                    const x = padding + (i / (deltaStats.deltas.length - 1)) * (width - 2 * padding);
                    const y = height - padding - ((d.deltaLat / maxVal) * (height - 2 * padding));
                    return `${x},${y}`;
                }).join(' ');

                sparklinePath.setAttribute('points', points);
            }
        }
    }

    // Load plan CSV
    window.loadPlanCSV = function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv,.txt';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const text = await file.text();
            const res = tryBuildStations(text);
            if (res.needsMap) {
                statusEl.textContent = 'âš ï¸ Plan CSV needs MD, INC, AZ columns';
                statusEl.className = 'mt-4 text-xs text-amber-400';
                return;
            }

            planSurvey = res.stations;
            computeCoordinates.call({ length: planSurvey.length }, planSurvey); // Compute coordinates for plan

            statusEl.textContent = 'âœ“ Plan loaded (' + planSurvey.length + ' stations)';
            statusEl.className = 'mt-4 text-xs text-emerald-400';

            if (surveyData.length > 0) {
                renderSurvey();
                deltaStats = computeDeltaStats(computed, planSurvey);
                updateDeltaStats();
            }
        };
        input.click();
    };

    // Load survey from URL
    window.loadSurveyFromURL = async function() {
        const urlInput = document.getElementById('survey-url-input');
        const urlStatus = document.getElementById('url-load-status');
        const url = urlInput.value.trim();

        if (!url) {
            urlStatus.textContent = 'âš ï¸ Please enter a URL';
            urlStatus.className = 'mt-2 text-xs text-amber-400';
            return;
        }

        urlStatus.textContent = 'Loading...';
        urlStatus.className = 'mt-2 text-xs text-cyan-400';

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const text = await response.text();
            const stations = processSurveyData(text);

            if (stations) {
                surveyData = stations;
                pasteArea.value = text;
                renderSurvey();
                urlStatus.textContent = `âœ“ Loaded ${stations.length} stations from URL`;
                urlStatus.className = 'mt-2 text-xs text-emerald-400';
            } else {
                urlStatus.textContent = 'âš ï¸ Invalid CSV format';
                urlStatus.className = 'mt-2 text-xs text-amber-400';
            }
        } catch (error) {
            urlStatus.textContent = `âŒ Error: ${error.message}`;
            urlStatus.className = 'mt-2 text-xs text-red-400';
        }
    };

    // Open data URLs
    const openDataURLs = {
        'utah-forge': 'https://gdr.openei.org/files/1163/Well_58-32_Survey.csv',
        'boem': 'https://www.data.boem.gov/api/devsurvey/csv',
        'norway': 'https://factpages.npd.no/ReportServer_npdpublic?/FactPages/TableView/wellbore_development_all&rs:Command=Render&rc:Toolbar=false&rc:Parameters=f&rs:Format=CSV&Top100=false&IpAddress=not_used&CultureCode=en',
        'volve': 'https://raw.githubusercontent.com/equinor/volve-field-data/master/directional_surveys/directional_survey_15_9-F-11_A.csv'
    };

    window.loadOpenDataURL = function(source) {
        const urlInput = document.getElementById('survey-url-input');
        const url = openDataURLs[source];

        if (url) {
            urlInput.value = url;
            window.loadSurveyFromURL();
        }
    };

    function tryBuildStations(text) {
        const { rows } = parseCSV(text);
        if (!rows.length) return { needsMap: true };

        const headers = rows[0];
        const colMap = autoDetectColumns(headers);

        if (colMap.md === -1 || colMap.inc === -1 || colMap.azi === -1) {
            return { needsMap: true, headers, rows };
        }

        const dataRows = rows.slice(1).filter(r => r.some(x => (x || '').toString().trim() !== ''));
        const stations = dataRows.map(r => ({
            md: parseFloat(r[colMap.md]),
            inc: parseFloat(r[colMap.inc]),
            azi: parseFloat(r[colMap.azi]),
            tvd: colMap.tvd >= 0 ? parseFloat(r[colMap.tvd]) : undefined,
            north: colMap.north >= 0 ? parseFloat(r[colMap.north]) : undefined,
            east: colMap.east >= 0 ? parseFloat(r[colMap.east]) : undefined,
        })).filter(s => Number.isFinite(s.md) && Number.isFinite(s.inc) && Number.isFinite(s.azi));

        return { needsMap: false, stations };
    }

    // ========= EXPORT FUNCTIONS =========

    // Export to PNG
    window.saveSurveyPNG = function() {
        if (!svg) return;

        const serializer = new XMLSerializer();
        const source = serializer.serializeToString(svg);
        const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 1600;
            canvas.height = 1040;
            const ctx = canvas.getContext('2d');

            // Dark background
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(b => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(b);
                a.download = 'welltegra-survey-' + Date.now() + '.png';
                a.click();
                URL.revokeObjectURL(a.href);
            });

            URL.revokeObjectURL(url);
        };
        img.src = url;
    };

    // Export to CSV
    window.exportSurveyCSV = function() {
        if (!surveyData.length) {
            alert('Load a survey first');
            return;
        }

        // Base headers
        let header = ['MD', 'TVD', 'NORTH', 'EAST', 'INC', 'AZ'];

        // Add delta columns if plan is loaded
        const hasPlan = planSurvey && planSurvey.length > 0;
        if (hasPlan) {
            header.push('DELTA_N', 'DELTA_E', 'DELTA_LAT');
        }

        let rows = surveyData.map(p => {
            let row = [
                p.md.toFixed(3),
                (p.tvd || 0).toFixed(3),
                (p.north || 0).toFixed(3),
                (p.east || 0).toFixed(3),
                p.inc.toFixed(3),
                p.azi.toFixed(3)
            ];

            // If plan loaded, calculate deltas for this point
            if (hasPlan) {
                const pIdx = planSurvey.findIndex(planPt => planPt.md >= p.md);
                let deltaN = 0, deltaE = 0, deltaLat = 0;

                if (pIdx > 0) {
                    const p1 = planSurvey[pIdx - 1];
                    const p2 = planSurvey[pIdx];
                    const ratio = (p.md - p1.md) / ((p2.md - p1.md) || 1);
                    const pN = p1.north + ratio * (p2.north - p1.north);
                    const pE = p1.east + ratio * (p2.east - p1.east);

                    deltaN = (p.north || 0) - pN;
                    deltaE = (p.east || 0) - pE;
                    deltaLat = Math.sqrt(deltaN * deltaN + deltaE * deltaE);
                } else if (pIdx === 0) {
                    deltaN = (p.north || 0) - planSurvey[0].north;
                    deltaE = (p.east || 0) - planSurvey[0].east;
                    deltaLat = Math.sqrt(deltaN * deltaN + deltaE * deltaE);
                }

                row.push(deltaN.toFixed(3), deltaE.toFixed(3), deltaLat.toFixed(3));
            }

            return row.join(',');
        });

        const csv = header.join(',') + '\n' + rows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'welltegra-survey-export-' + Date.now() + '.csv';
        a.click();
        URL.revokeObjectURL(a.href);
    };

    // Share link (base64 encode survey data in URL hash)
    window.shareSurveyLink = async function() {
        if (!surveyData.length) {
            alert('Load a survey first');
            return;
        }

        const data = { survey: surveyData.slice(0, 100) }; // Limit to 100 stations to avoid huge URLs
        const json = JSON.stringify(data);
        const b64 = btoa(unescape(encodeURIComponent(json)));

        const url = new URL(window.location.href);
        url.hash = '#survey=' + b64;

        try {
            await navigator.clipboard.writeText(url.toString());
            statusEl.textContent = 'âœ“ Link copied to clipboard!';
            statusEl.className = 'mt-4 text-xs text-emerald-400';
            setTimeout(() => {
                statusEl.textContent = '';
            }, 3000);
        } catch (err) {
            prompt('Copy this link:', url.toString());
        }
    };

    // ========= BUILT-IN TESTS =========

    window.runSurveyTests = function() {
        const testOutput = document.getElementById('test-output');
        const testResults = document.getElementById('test-results');
        if (!testOutput || !testResults) return;

        testResults.classList.remove('hidden');
        testOutput.innerHTML = '<div class="text-yellow-400">Running tests...</div>';

        const results = [];
        let passed = 0, failed = 0;

        function test(name, fn) {
            try {
                fn();
                results.push(`<div class="text-emerald-400">âœ“ ${name}</div>`);
                passed++;
            } catch (err) {
                results.push(`<div class="text-red-400">âœ— ${name}: ${err.message}</div>`);
                failed++;
            }
        }

        // Test 1: Delimiter sniffing
        test('Delimiter sniff (comma)', () => {
            const delim = sniffDelimiter('MD,INC,AZ\n0,0,0');
            if (delim !== ',') throw new Error(`Expected ',', got '${delim}'`);
        });

        test('Delimiter sniff (semicolon)', () => {
            const delim = sniffDelimiter('MD;INC;AZ\n0;0;0');
            if (delim !== ';') throw new Error(`Expected ';', got '${delim}'`);
        });

        // Test 2: CSV parsing
        test('CSV parse basic', () => {
            const { rows } = parseCSV('A,B,C\n1,2,3\n4,5,6');
            if (rows.length !== 3) throw new Error(`Expected 3 rows, got ${rows.length}`);
            if (rows[1][1] !== '2') throw new Error(`Expected '2', got '${rows[1][1]}'`);
        });

        test('CSV parse with quotes', () => {
            const { rows } = parseCSV('A,B\n"hello,world",test');
            if (rows[1][0] !== 'hello,world') throw new Error('Quote handling failed');
        });

        // Test 3: Header auto-mapping
        test('Auto-map standard headers', () => {
            const colMap = autoDetectColumns(['MD', 'INC', 'AZ']);
            if (colMap.md !== 0 || colMap.inc !== 1 || colMap.azi !== 2) {
                throw new Error('Standard header mapping failed');
            }
        });

        test('Auto-map synonym headers', () => {
            const colMap = autoDetectColumns(['Measured Depth', 'Inclination', 'Azimuth']);
            if (colMap.md === -1 || colMap.inc === -1 || colMap.azi === -1) {
                throw new Error('Synonym mapping failed');
            }
        });

        // Test 4: Minimum curvature calculation
        test('Min-curv vertical well', () => {
            const stations = [
                { md: 0, inc: 0, azi: 0 },
                { md: 100, inc: 0, azi: 0 }
            ];
            computeCoordinates(stations);
            if (Math.abs(stations[1].tvd - 100) > 0.1) {
                throw new Error(`Vertical TVD wrong: ${stations[1].tvd}`);
            }
            if (Math.abs(stations[1].north) > 0.1 || Math.abs(stations[1].east) > 0.1) {
                throw new Error('Vertical well should have zero lateral');
            }
        });

        test('Min-curv build section', () => {
            const stations = [
                { md: 0, inc: 0, azi: 0 },
                { md: 100, inc: 30, azi: 45 }
            ];
            computeCoordinates(stations);
            if (stations[1].tvd > 100) throw new Error('TVD should be less than MD in build');
            if (stations[1].north <= 0 || stations[1].east <= 0) {
                throw new Error('Build section should have positive N/E');
            }
        });

        // Test 5: DLS calculation
        test('DLS calculation', () => {
            const stations = [
                { md: 0, inc: 0, azi: 0, tvd: 0, north: 0, east: 0 },
                { md: 30, inc: 6, azi: 0, tvd: 29.9, north: 0, east: 0 }
            ];
            const dls = computeDLS(stations);
            if (dls.length !== 1) throw new Error('Expected 1 DLS point');
            // 6Â° change over 30m = 6Â°/30m
            if (Math.abs(dls[0].dls - 6) > 0.5) {
                throw new Error(`DLS expected ~6Â°/30m, got ${dls[0].dls.toFixed(2)}`);
            }
        });

        // Test 6: Share link encoding/decoding
        test('Share link encode', () => {
            const data = { survey: [{ md: 0, inc: 0, azi: 0 }] };
            const json = JSON.stringify(data);
            const encoded = btoa(unescape(encodeURIComponent(json)));
            if (!encoded || encoded.length === 0) throw new Error('Encoding failed');
        });

        test('Share link decode', () => {
            const data = { survey: [{ md: 0, inc: 0, azi: 0 }] };
            const json = JSON.stringify(data);
            const encoded = btoa(unescape(encodeURIComponent(json)));
            const decoded = JSON.parse(decodeURIComponent(escape(atob(encoded))));
            if (decoded.survey[0].md !== 0) throw new Error('Decode failed');
        });

        // Test 7: Export smoke test
        test('CSV export structure', () => {
            if (typeof window.exportSurveyCSV !== 'function') {
                throw new Error('Export function not found');
            }
        });

        // Test 8: Delta calculation
        test('Delta stats calculation', () => {
            const actual = [
                { md: 0, inc: 0, azi: 0, tvd: 0, north: 0, east: 0 },
                { md: 100, inc: 5, azi: 45, tvd: 99.8, north: 3.0, east: 3.0 }
            ];
            const plan = [
                { md: 0, inc: 0, azi: 0, tvd: 0, north: 0, east: 0 },
                { md: 100, inc: 5, azi: 45, tvd: 99.8, north: 2.0, east: 2.0 }
            ];
            const stats = computeDeltaStats(actual, plan);
            if (!stats || stats.maxDelta === undefined) throw new Error('Delta stats failed');
        });

        // Display results
        const summary = `<div class="mt-2 pt-2 border-t border-slate-600 font-semibold ${
            failed === 0 ? 'text-emerald-400' : 'text-amber-400'
        }">Passed: ${passed} | Failed: ${failed}</div>`;

        testOutput.innerHTML = results.join('') + summary;
    };

    // Clean mode toggle
    window.toggleCleanMode = function() {
        document.body.classList.toggle('clean-mode');
        const btn = document.getElementById('cleanModeBtn');
        if (btn) {
            if (document.body.classList.contains('clean-mode')) {
                btn.textContent = 'ðŸ‘ï¸ Exit Clean';
                btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
                btn.classList.add('bg-pink-600', 'hover:bg-pink-500');
            } else {
                btn.textContent = 'ðŸ‘ï¸ Clean';
                btn.classList.remove('bg-pink-600', 'hover:bg-pink-500');
                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
            }
        }
    };

    // 3D Tilt mode toggle
    window.toggleTiltMode = function() {
        document.body.classList.toggle('tilt-mode');
        const btn = document.getElementById('tiltModeBtn');
        if (btn) {
            if (document.body.classList.contains('tilt-mode')) {
                btn.textContent = 'ðŸŽ­ Tilt OFF';
                btn.classList.remove('bg-violet-600', 'hover:bg-violet-500');
                btn.classList.add('bg-rose-600', 'hover:bg-rose-500');
            } else {
                btn.textContent = 'ðŸŽ­ 3D Tilt';
                btn.classList.remove('bg-rose-600', 'hover:bg-rose-500');
                btn.classList.add('bg-violet-600', 'hover:bg-violet-500');
            }
        }
    };

    // Initialize with empty state
    updateAnimation(0);
})();

// --- CASE STUDY VIEW FUNCTIONS ---

// Case Study wellbore visualization state
(function() {
    let currentCaseView = 'profile'; // 'profile' or 'plan'
    let caseSurveyData = [];
    let caseDLSData = [];

    // Toggle 3D tilt mode for case study view
    window.toggleTiltModeCaseStudy = function() {
        const btn = document.getElementById('tiltModeBtn-case');
        const svg = document.getElementById('wbSvg-case');

        if (!btn || !svg) return;

        svg.classList.toggle('tilt-mode');

        if (svg.classList.contains('tilt-mode')) {
            btn.textContent = 'ðŸŽ­ Tilt OFF';
            btn.classList.remove('bg-violet-600', 'hover:bg-violet-500');
            btn.classList.add('bg-rose-600', 'hover:bg-rose-500');
            svg.style.transform = 'perspective(1200px) rotateX(20deg) rotateZ(-5deg)';
        } else {
            btn.textContent = 'ðŸŽ­ 3D Tilt';
            btn.classList.remove('bg-rose-600', 'hover:bg-rose-500');
            btn.classList.add('bg-violet-600', 'hover:bg-violet-500');
            svg.style.transform = '';
        }
    };

    // Show profile view for case study
    window.showProfileViewCaseStudy = function() {
        currentCaseView = 'profile';
        const viewLabel = document.getElementById('view-label-case');
        if (viewLabel) {
            viewLabel.textContent = 'Profile View (TVD vs Departure)';
        }
        if (caseSurveyData.length > 0) {
            renderCaseSurvey();
        }
    };

    // Show plan view for case study
    window.showPlanViewCaseStudy = function() {
        currentCaseView = 'plan';
        const viewLabel = document.getElementById('view-label-case');
        if (viewLabel) {
            viewLabel.textContent = 'Plan View (North vs East)';
        }
        if (caseSurveyData.length > 0) {
            renderCaseSurvey();
        }
    };

    // Update DLS threshold for case study
    window.updateDLSThresholdCaseStudy = function() {
        if (caseDLSData.length > 0) {
            renderCaseDLSHotspots();
        }
    };

    // Back to planner button (legacy - kept for compatibility)
    const backBtn = document.getElementById('back-to-planner');
    if (backBtn) {
        backBtn.addEventListener('click', function() {
            if (typeof window.showView === 'function') {
                window.showView('planner');
            }
        });
    }

    // Back to case studies button
    const backToCaseStudiesBtn = document.getElementById('back-to-case-studies');
    if (backToCaseStudiesBtn) {
        backToCaseStudiesBtn.addEventListener('click', function() {
            if (typeof window.showView === 'function') {
                window.showView('case-studies');
            }
        });
    }

    // Open case study detail function
    window.openCaseStudyDetail = function(wellId) {
        const well = window.wellData ? window.wellData.find(w => w.id === wellId) : null;
        if (!well) return;

        // Load the case study data
        if (well.survey) {
            window.loadCaseStudy(well);
        }

        // Show the case study detail view
        if (typeof window.showView === 'function') {
            // Switch to case-study-view (detail view)
            document.querySelectorAll('.view-container').forEach(v => v.classList.add('hidden'));
            document.getElementById('case-study-view').classList.remove('hidden');
        }
    };

    // Load case study data
    window.loadCaseStudy = function(caseData) {
        if (!caseData || !caseData.survey) return;

        // Store survey data
        caseSurveyData = caseData.survey;

        // Compute DLS
        caseDLSData = computeCaseDLS(caseSurveyData);

        // Update UI
        renderCaseSurvey();
        renderCaseStudyDetails(caseData);

        // Show case study view
        if (typeof window.showView === 'function') {
            window.showView('case-study');
        }
    };

    // Compute DLS for case study
    function computeCaseDLS(stations) {
        const dls = [];
        if (stations.length < 2) return dls;

        for (let i = 1; i < stations.length; i++) {
            const a = stations[i - 1];
            const b = stations[i];

            const inc1 = (a.inc || 0) * Math.PI / 180;
            const inc2 = (b.inc || 0) * Math.PI / 180;
            const az1 = (a.azi || 0) * Math.PI / 180;
            const az2 = (b.azi || 0) * Math.PI / 180;

            const cosDL = Math.sin(inc1) * Math.sin(inc2) * Math.cos(az2 - az1) + Math.cos(inc1) * Math.cos(inc2);
            const DL = Math.acos(Math.min(1, Math.max(-1, cosDL)));
            const dmd = (b.md - a.md) || 1;
            const dlsDeg = (DL * 180 / Math.PI) / (dmd / 100); // degrees per 100ft

            dls.push({
                md: b.md,
                dls: dlsDeg,
                tvd: b.tvd || 0,
                north: b.north || 0,
                east: b.east || 0,
                departure: Math.sqrt((b.north || 0) ** 2 + (b.east || 0) ** 2)
            });
        }

        return dls;
    }

    // Render case study survey
    function renderCaseSurvey() {
        if (caseSurveyData.length === 0) return;

        const path = document.getElementById('wbPath-case');
        const stationsG = document.getElementById('survey-stations-case');
        const viewLabel = document.getElementById('view-label-case');
        const surveyCount = document.getElementById('survey-count-case');
        const surveyMaxInc = document.getElementById('survey-max-inc-case');
        const surveyTotalMD = document.getElementById('survey-total-md-case');

        if (!path || !stationsG) return;

        // Update stats
        const maxInc = Math.max(...caseSurveyData.map(s => s.inc || 0));
        const totalMD = caseSurveyData[caseSurveyData.length - 1].md || 0;

        if (surveyCount) surveyCount.textContent = caseSurveyData.length;
        if (surveyMaxInc) surveyMaxInc.textContent = maxInc.toFixed(1) + 'Â°';
        if (surveyTotalMD) surveyTotalMD.textContent = totalMD.toFixed(0) + 'ft';

        // Determine coordinates based on view
        let coords = caseSurveyData.map(s => {
            if (currentCaseView === 'profile') {
                return {
                    x: s.departure || Math.sqrt((s.north || 0) ** 2 + (s.east || 0) ** 2),
                    y: s.tvd || s.md || 0,
                    md: s.md
                };
            } else {
                return {
                    x: s.east || 0,
                    y: s.north || 0,
                    md: s.md
                };
            }
        });

        // Find bounds
        const xs = coords.map(c => c.x);
        const ys = coords.map(c => c.y);
        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);

        const rangeX = maxX - minX || 100;
        const rangeY = maxY - minY || 100;
        const margin = 40;
        const svgWidth = 800;
        const svgHeight = 520;

        // Scale to SVG
        function scaleX(x) {
            return margin + ((x - minX) / rangeX) * (svgWidth - 2 * margin);
        }
        function scaleY(y) {
            return svgHeight - margin - ((y - minY) / rangeY) * (svgHeight - 2 * margin);
        }

        // Draw path
        let pathD = coords.map((c, i) =>
            `${i === 0 ? 'M' : 'L'} ${scaleX(c.x)} ${scaleY(c.y)}`
        ).join(' ');
        path.setAttribute('d', pathD);

        // Draw stations
        stationsG.innerHTML = '';
        coords.forEach((c, i) => {
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', scaleX(c.x));
            circle.setAttribute('cy', scaleY(c.y));
            circle.setAttribute('r', 4);
            circle.setAttribute('fill', '#06b6d4');
            circle.setAttribute('stroke', '#164e63');
            circle.setAttribute('stroke-width', 1);
            stationsG.appendChild(circle);
        });

        // Update view label
        if (viewLabel) {
            viewLabel.textContent = currentCaseView === 'profile'
                ? 'Profile View (TVD vs Departure)'
                : 'Plan View (North vs East)';
        }

        // Render DLS hotspots
        renderCaseDLSHotspots();
    }

    // Render DLS hotspots for case study
    function renderCaseDLSHotspots() {
        const hotspotsG = document.getElementById('dls-hotspots-case');
        const dlsPanel = document.getElementById('dls-panel-case');
        const thresholdInput = document.getElementById('dls-threshold-case');

        if (!hotspotsG || !dlsPanel) return;

        const threshold = thresholdInput ? parseFloat(thresholdInput.value) : 3;

        // Clear existing
        hotspotsG.innerHTML = '';
        dlsPanel.innerHTML = '';

        if (caseDLSData.length === 0) {
            dlsPanel.innerHTML = '<p class="text-gray-500">No DLS data available</p>';
            return;
        }

        // Filter high DLS points
        const hotspots = caseDLSData.filter(d => d.dls > threshold);

        if (hotspots.length === 0) {
            dlsPanel.innerHTML = `<p class="text-green-400">âœ“ All DLS values below ${threshold}Â°/100ft</p>`;
            return;
        }

        // Display warnings
        dlsPanel.innerHTML = `<p class="text-red-400 font-semibold mb-2">âš ï¸ ${hotspots.length} high DLS point(s):</p>`;
        hotspots.forEach(h => {
            const warning = document.createElement('div');
            warning.className = 'mb-1 text-xs';
            warning.innerHTML = `MD ${h.md.toFixed(0)}ft: <strong class="text-red-300">${h.dls.toFixed(2)}Â°/100ft</strong>`;
            dlsPanel.appendChild(warning);
        });

        // Draw hotspots on SVG (simplified - would need proper scaling)
        hotspots.forEach(h => {
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            marker.setAttribute('r', 8);
            marker.setAttribute('fill', 'rgba(239, 68, 68, 0.3)');
            marker.setAttribute('stroke', '#ef4444');
            marker.setAttribute('stroke-width', 2);
            // Note: Actual positioning would require the same scaling logic as renderCaseSurvey
            hotspotsG.appendChild(marker);
        });
    }

    // Render case study details
    function renderCaseStudyDetails(caseData) {
        const header = document.getElementById('case-study-header');
        const history = document.getElementById('case-study-history');
        const schematic = document.getElementById('case-study-schematic');

        if (header) {
            header.innerHTML = `
                <h2 class="text-4xl font-bold text-white mb-2">${caseData.title || 'Well Case Study'}</h2>
                <p class="text-cyan-400 text-lg">${caseData.subtitle || 'Detailed Analysis'}</p>
            `;
        }

        if (history && caseData.history) {
            history.innerHTML = caseData.history.map(item => `
                <div class="bg-slate-900/30 rounded p-3 border-l-4 border-cyan-500">
                    <p class="text-sm text-gray-400">${item.date || ''}</p>
                    <p class="text-white">${item.description || ''}</p>
                </div>
            `).join('');
        }

        if (schematic) {
            let content = '';
            // Add 3D wellbore image if available
            if (caseData.wellboreImage) {
                content += `
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-white mb-3">3D Wellbore Visualization</h3>
                        <img src="${caseData.wellboreImage}"
                             alt="3D Wellbore Visualization for ${caseData.name || caseData.id}"
                             class="w-full rounded-lg shadow-lg border border-slate-700"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="hidden bg-slate-800 p-4 rounded text-center text-slate-400">
                            <p>3D Wellbore visualization will be available soon</p>
                        </div>
                    </div>
                `;
            }
            // Add schematic if available
            if (caseData.schematic) {
                content += `<div class="mb-4"><h3 class="text-xl font-bold text-white mb-3">Wellbore Schematic</h3>${caseData.schematic}</div>`;
            }
            schematic.innerHTML = content;
        }
    }

    // Initialize view label
    const viewLabel = document.getElementById('view-label-case');
    if (viewLabel) {
        viewLabel.textContent = 'Profile View (TVD vs Departure)';
    }
})();

// --- PDF EXPORT SYSTEM (Global scope for onclick) ---

async function generatePDFReport() {
    const button = event.target;
    const originalText = button.innerHTML;

    // Show loading state
    button.innerHTML = '<span class="pdf-spinner"></span> Generating PDF...';
    button.classList.add('pdf-generating');

    try {
        // Check if jsPDF is loaded
        if (typeof window.jspdf === 'undefined') {
            throw new Error('PDF library not loaded');
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        // Page dimensions
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 20;
        let yPosition = margin;

        // --- COVER PAGE ---
        pdf.setFillColor(37, 99, 235); // Blue background
        pdf.rect(0, 0, pageWidth, 80, 'F');

        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(32);
        pdf.setFont(undefined, 'bold');
        pdf.text('Well-Tegra', pageWidth / 2, 35, { align: 'center' });

        pdf.setFontSize(20);
        pdf.text('Well Intervention Close-Out Report', pageWidth / 2, 50, { align: 'center' });

        pdf.setFontSize(12);
        pdf.setFont(undefined, 'normal');
        pdf.text('Generated: ' + new Date().toLocaleDateString(), pageWidth / 2, 65, { align: 'center' });

        yPosition = 100;
        pdf.setTextColor(0, 0, 0);

        // --- EXECUTIVE SUMMARY ---
        pdf.setFontSize(18);
        pdf.setFont(undefined, 'bold');
        pdf.text('Executive Summary', margin, yPosition);
        yPosition += 10;

        pdf.setFontSize(11);
        pdf.setFont(undefined, 'normal');
        const summaryText = 'This report provides a comprehensive analysis of the well intervention campaign, including operational performance, financial impact, vendor evaluation, and key learnings.';
        const splitSummary = pdf.splitTextToSize(summaryText, pageWidth - 2 * margin);
        pdf.text(splitSummary, margin, yPosition);
        yPosition += splitSummary.length * 5 + 10;

        // --- KEY PERFORMANCE INDICATORS ---
        pdf.setFontSize(16);
        pdf.setFont(undefined, 'bold');
        pdf.text('Key Performance Indicators', margin, yPosition);
        yPosition += 8;

        const kpis = [
            { label: 'Total Cost Savings', value: '$2,847,000', color: [34, 197, 94] },
            { label: 'Time Saved', value: '18.5 days', color: [59, 130, 246] },
            { label: 'NPT Avoided', value: '12.3 days', color: [168, 85, 247] },
            { label: 'Well Integrity', value: '100%', color: [34, 197, 94] },
            { label: 'Safety Record', value: 'Zero incidents', color: [34, 197, 94] }
        ];

        kpis.forEach(kpi => {
            pdf.setFillColor(249, 250, 251);
            pdf.roundedRect(margin, yPosition, pageWidth - 2 * margin, 10, 2, 2, 'F');

            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(75, 85, 99);
            pdf.text(kpi.label, margin + 3, yPosition + 6);

            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(...kpi.color);
            pdf.text(kpi.value, pageWidth - margin - 3, yPosition + 6, { align: 'right' });

            yPosition += 12;
        });

        yPosition += 5;

        // --- VENDOR PERFORMANCE ---
        if (yPosition > pageHeight - 60) {
            pdf.addPage();
            yPosition = margin;
        }

        pdf.setFontSize(16);
        pdf.setFont(undefined, 'bold');
        pdf.setTextColor(0, 0, 0);
        pdf.text('Vendor Performance Scorecard', margin, yPosition);
        yPosition += 8;

        const vendorMetrics = [
            { metric: 'On-Time Delivery', score: '95%', rating: 'â˜…â˜…â˜…â˜…â˜…' },
            { metric: 'Equipment Quality', score: '88%', rating: 'â˜…â˜…â˜…â˜…â˜†' },
            { metric: 'Technical Support', score: '92%', rating: 'â˜…â˜…â˜…â˜…â˜…' },
            { metric: 'Cost Competitiveness', score: '78%', rating: 'â˜…â˜…â˜…â˜…â˜†' },
            { metric: 'Safety Record', score: '98%', rating: 'â˜…â˜…â˜…â˜…â˜…' },
            { metric: 'Responsiveness', score: '85%', rating: 'â˜…â˜…â˜…â˜…â˜†' }
        ];

        // Table header
        pdf.setFillColor(37, 99, 235);
        pdf.rect(margin, yPosition, pageWidth - 2 * margin, 8, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'bold');
        pdf.text('Metric', margin + 3, yPosition + 5);
        pdf.text('Score', margin + 100, yPosition + 5);
        pdf.text('Rating', margin + 130, yPosition + 5);
        yPosition += 8;

        // Table rows
        pdf.setTextColor(0, 0, 0);
        vendorMetrics.forEach((item, index) => {
            if (index % 2 === 0) {
                pdf.setFillColor(249, 250, 251);
                pdf.rect(margin, yPosition, pageWidth - 2 * margin, 7, 'F');
            }

            pdf.setFont(undefined, 'normal');
            pdf.setFontSize(9);
            pdf.text(item.metric, margin + 3, yPosition + 5);
            pdf.text(item.score, margin + 100, yPosition + 5);
            pdf.text(item.rating, margin + 130, yPosition + 5);
            yPosition += 7;
        });

        yPosition += 5;

        // Overall rating
        pdf.setFontSize(11);
        pdf.setFont(undefined, 'bold');
        pdf.text('Overall Vendor Rating: 4.2/5.0 â˜…â˜…â˜…â˜…â˜†', margin, yPosition);
        yPosition += 8;

        pdf.setFont(undefined, 'normal');
        pdf.setFontSize(9);
        pdf.setTextColor(75, 85, 99);
        pdf.text('Recommendation: Excellent performance. Continue partnership.', margin, yPosition);

        // --- FOOTER ---
        const addFooter = (pageNum) => {
            pdf.setFontSize(8);
            pdf.setTextColor(150, 150, 150);
            pdf.text('Well-Tegra | Confidential', margin, pageHeight - 10);
            pdf.text(`Page ${pageNum}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
        };

        addFooter(1);

        // --- SAVE PDF ---
        const fileName = `WellTegra_Report_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);

        // Success feedback
        button.innerHTML = 'âœ“ PDF Downloaded!';
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('pdf-generating');
        }, 3000);

    } catch (error) {
        console.error('PDF generation error:', error);
        alert('Error generating PDF. Please try again.');
        button.innerHTML = originalText;
        button.classList.remove('pdf-generating');
    }
}

// ---Global Job Costing Functions (for onclick handlers) ---
function showCostMainTab(discipline) {
    if (!window.jobCostingState) return;

    window.jobCostingState.currentDiscipline = discipline;
    document.querySelectorAll('.cost-main-content').forEach(panel => panel.style.display = 'none');
    document.getElementById(`cost-content-${discipline}`).style.display = 'block';
    document.querySelectorAll('#cost-main-tabs .cost-main-tab').forEach(tab => tab.classList.remove('active'));
    event.currentTarget.classList.add('active');
    showCostSubTab(discipline, window.jobCostingState.currentCategories[discipline]);
}

function showCostSubTab(discipline, category) {
    if (!window.jobCostingState) return;

    window.jobCostingState.currentCategories[discipline] = category;
    document.querySelectorAll(`.cost-sub-content-${discipline}`).forEach(panel => panel.style.display = 'none');
    const targetPanel = document.getElementById(`cost-content-${discipline}-${category}`);
    if (targetPanel) targetPanel.style.display = 'block';
    document.querySelectorAll(`#cost-content-${discipline} .cost-sub-tab`).forEach(tab => tab.classList.remove('active'));
    if (event && event.currentTarget) event.currentTarget.classList.add('active');
}

function addJobStep() {
    if (!window.jobCostingState) return;

    const input = document.getElementById('step-title-input');
    const title = input.value.trim();
    if (!title) {
        alert('Please enter a title for the job step.');
        return;
    }
    const newStep = {
        id: `step-${Date.now()}`,
        title: title,
        items: []
    };
    window.jobCostingState.steps.push(newStep);
    window.jobCostingState.activeStepId = newStep.id;
    input.value = '';
    renderProcedureList();
}

function addItemToActiveStep(item) {
    if (!window.jobCostingState || !window.jobCostingState.activeStepId) {
        alert('Please add or select a job step first.');
        return;
    }
    const step = window.jobCostingState.steps.find(s => s.id === window.jobCostingState.activeStepId);
    if (step) {
        step.items.push(item);
        renderProcedureList();
    }
}

function removeJobStep(stepId) {
    if (!window.jobCostingState) return;

    window.jobCostingState.steps = window.jobCostingState.steps.filter(s => s.id !== stepId);
    if (window.jobCostingState.activeStepId === stepId) {
        window.jobCostingState.activeStepId = window.jobCostingState.steps.length > 0 ? window.jobCostingState.steps[window.jobCostingState.steps.length - 1].id : null;
    }
    renderProcedureList();
}

function removeItemFromStep(stepId, itemIndex) {
    if (!window.jobCostingState) return;

    const step = window.jobCostingState.steps.find(s => s.id === stepId);
    if (step) {
        step.items.splice(itemIndex, 1);
        renderProcedureList();
    }
}

function setActiveJobStep(stepId) {
    if (!window.jobCostingState) return;

    window.jobCostingState.activeStepId = stepId;
    renderProcedureList();
}

function updateJobDuration(value) {
    if (!window.jobCostingState) return;

    window.jobCostingState.jobDuration = parseFloat(value) || 1;
    if (window.jobCostingState.jobDuration < 1) window.jobCostingState.jobDuration = 1;
    document.getElementById('job-duration-input').value = window.jobCostingState.jobDuration;
    renderProcedureList();
}

function renderProcedureList() {
    const list = document.getElementById('procedure-list');
    if (!list || !window.jobCostingState) return;

    list.innerHTML = '';
    let globalTotal = 0;

    if (window.jobCostingState.steps.length === 0) {
        list.innerHTML = '<li class="py-6 text-center text-gray-500">Add a job step to begin building your procedure.</li>';
    } else {
        window.jobCostingState.steps.forEach(step => {
            let stepSubtotal = 0;
            const stepCard = document.createElement('li');
            stepCard.className = 'step-card';
            if (step.id === window.jobCostingState.activeStepId) {
                stepCard.classList.add('active');
            }

            let itemsHTML = '<ul class="step-item-list">';
            step.items.forEach((item, index) => {
                let itemCost = 0;
                if (item.unit === 'Day') {
                    itemCost = item.baseRate * window.jobCostingState.jobDuration;
                } else {
                    itemCost = item.baseRate;
                }
                stepSubtotal += itemCost;

                itemsHTML += `
                    <li class="step-item">
                        <div class="flex-1 pr-4">
                            <span class="step-item-name">${item.name}</span>
                            <span class="block text-xs text-gray-400 font-mono">${item.code} / ${item.unit}</span>
                        </div>
                        <span class="step-item-cost">Â£${itemCost.toFixed(2)}</span>
                        <button class="remove-item-btn" onclick="event.stopPropagation(); removeItemFromStep('${step.id}', ${index})">remove</button>
                    </li>
                `;
            });
            itemsHTML += '</ul>';

            globalTotal += stepSubtotal;

            stepCard.innerHTML = `
                <div class="step-header" onclick="setActiveJobStep('${step.id}')">
                    <h3 class="flex-1">${step.title}</h3>
                    <button class="remove-step-btn" onclick="event.stopPropagation(); removeJobStep('${step.id}')">REMOVE</button>
                </div>
                ${itemsHTML}
                <div class="step-footer">
                    <strong>Step Subtotal: Â£${stepSubtotal.toFixed(2)}</strong>
                </div>
            `;
            list.appendChild(stepCard);
        });
    }

    const totalDisplay = document.getElementById('job-total');
    if (totalDisplay) {
        totalDisplay.textContent = `Â£${globalTotal.toFixed(2)}`;
    }

    // Save costs for the current well
    if (window.saveWellCosts) {
        window.saveWellCosts();
    }

    // Update cost displays in Performer and Analyzer views (include NPT)
    const nptCost = window.calculateTotalNPTCost ? window.calculateTotalNPTCost() : 0;
    updatePerformerCostDisplay(globalTotal + nptCost);
    updateAnalyzerCostDisplay(globalTotal + nptCost);
}

function updatePerformerCostDisplay(totalCost) {
    const afeDisplay = document.getElementById('performer-afe-budget');
    const actualDisplay = document.getElementById('performer-actual-cost');
    const varianceDisplay = document.getElementById('performer-variance');
    const percentDisplay = document.getElementById('performer-budget-percent');
    const nptCostDisplay = document.getElementById('performer-npt-cost');

    if (!afeDisplay) return;

    // Use the existing AFE from app state or the job costing total
    const afeBudget = window.appState && window.appState.commercial ? window.appState.commercial.afe : totalCost;
    const actualCost = totalCost;
    const variance = afeBudget - actualCost;
    const percent = afeBudget > 0 ? (actualCost / afeBudget * 100) : 0;

    afeDisplay.textContent = `$${(afeBudget / 1000).toFixed(0)}K`;
    actualDisplay.textContent = `$${(actualCost / 1000).toFixed(0)}K`;
    varianceDisplay.textContent = `$${(variance / 1000).toFixed(0)}K`;
    percentDisplay.textContent = `${percent.toFixed(0)}%`;

    // Update NPT cost display
    const nptCost = window.calculateTotalNPTCost ? window.calculateTotalNPTCost() : 0;
    if (nptCostDisplay) {
        nptCostDisplay.textContent = `$${(nptCost / 1000).toFixed(0)}K`;
    }

    // Color coding
    if (variance < 0) {
        varianceDisplay.classList.add('text-red-400');
        varianceDisplay.classList.remove('text-green-400');
    } else {
        varianceDisplay.classList.add('text-green-400');
        varianceDisplay.classList.remove('text-red-400');
    }
}

function updateAnalyzerCostDisplay(totalCost) {
    const afeDisplay = document.getElementById('analyzer-afe-budget');
    const actualDisplay = document.getElementById('analyzer-actual-cost');
    const equipmentDisplay = document.getElementById('analyzer-equipment-cost');
    const personnelDisplay = document.getElementById('analyzer-personnel-cost');
    const toolsDisplay = document.getElementById('analyzer-tools-cost');
    const consumablesDisplay = document.getElementById('analyzer-consumables-cost');
    const nptCostDisplay = document.getElementById('analyzer-npt-cost');
    const nptPercentDisplay = document.getElementById('analyzer-npt-percent');
    const nptEventsListDisplay = document.getElementById('analyzer-npt-events-list');

    if (!afeDisplay) return;

    // Calculate breakdown
    const nptCost = window.calculateTotalNPTCost ? window.calculateTotalNPTCost() : 0;
    const baseCost = totalCost - nptCost;
    const equipment = Math.floor(baseCost * 0.40);
    const personnel = Math.floor(baseCost * 0.30);
    const tools = Math.floor(baseCost * 0.20);
    const consumables = Math.floor(baseCost * 0.10);

    const afeBudget = window.appState && window.appState.commercial ? window.appState.commercial.afe : totalCost;
    const nptPercent = totalCost > 0 ? (nptCost / totalCost * 100) : 0;

    afeDisplay.textContent = `$${(afeBudget / 1000).toFixed(0)}K`;
    actualDisplay.textContent = `$${(totalCost / 1000).toFixed(0)}K`;
    equipmentDisplay.textContent = `$${(equipment / 1000).toFixed(0)}K`;
    personnelDisplay.textContent = `$${(personnel / 1000).toFixed(0)}K`;
    toolsDisplay.textContent = `$${(tools / 1000).toFixed(0)}K`;
    consumablesDisplay.textContent = `$${(consumables / 1000).toFixed(0)}K`;

    // Update NPT displays
    if (nptCostDisplay) {
        nptCostDisplay.textContent = `$${(nptCost / 1000).toFixed(0)}K`;
    }
    if (nptPercentDisplay) {
        nptPercentDisplay.textContent = `${nptPercent.toFixed(1)}%`;
    }

    // Render NPT events list
    if (nptEventsListDisplay && window.appState && window.appState.commercial) {
        const events = window.appState.commercial.nptEvents || [];
        if (events.length === 0) {
            nptEventsListDisplay.innerHTML = '<p class="text-gray-500 text-center py-4">No NPT events recorded for this operation.</p>';
        } else {
            nptEventsListDisplay.innerHTML = events.map(event => {
                const severityColors = {
                    low: 'bg-yellow-100 dark:bg-yellow-900/30 border-yellow-400',
                    medium: 'bg-orange-100 dark:bg-orange-900/30 border-orange-400',
                    high: 'bg-red-100 dark:bg-red-900/30 border-red-400',
                    critical: 'bg-purple-100 dark:bg-purple-900/30 border-purple-400'
                };
                const colorClass = severityColors[event.severity] || 'bg-gray-100 dark:bg-gray-900/30 border-gray-400';

                return `
                    <div class="p-3 rounded-lg border-l-4 ${colorClass}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-bold text-sm">${event.type}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${event.description}</div>
                                <div class="text-xs text-gray-500 mt-1">${event.duration} hours</div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="font-bold text-red-600 dark:text-red-400">$${(event.cost / 1000).toFixed(0)}K</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    }
}

// Add NPT event from UI
function addNPTEventFromUI() {
    const typeSelect = document.getElementById('npt-type-select');
    const durationInput = document.getElementById('npt-duration-input');

    if (!typeSelect || !durationInput) return;

    const eventTypeId = typeSelect.value;
    const duration = parseFloat(durationInput.value);

    if (!eventTypeId || !duration || duration <= 0) {
        alert('Please select an NPT type and enter a valid duration.');
        return;
    }

    if (window.addNPTEvent) {
        window.addNPTEvent(eventTypeId, duration);
        // Clear inputs
        typeSelect.value = '';
        durationInput.value = '';
    }
}

// ========================= EQUIPMENT CATALOG & TOOL STRING BUILDER =========================
let equipmentCatalog = {};
let savedToolStrings = [];
let builderComponents = [];
let currentEquipmentFilter = 'all';

// Load equipment catalog from JSON
async function loadEquipmentCatalog() {
    try {
        const response = await fetch('equipment-catalog.json');
        equipmentCatalog = await response.json();
        console.log('Equipment catalog loaded:', Object.keys(equipmentCatalog).length, 'categories');
        renderEquipmentCatalog();
        populateEquipmentSelector();
    } catch (error) {
        console.error('Failed to load equipment catalog:', error);
        const grid = document.getElementById('equipment-catalog-grid');
        if (grid) {
            grid.innerHTML = '<p class="text-yellow-500">Equipment catalog will be loaded when equipment-catalog.json is available.</p>';
        }
    }
}

// Load saved tool strings from localStorage
function loadSavedToolStrings() {
    const saved = localStorage.getItem('welltegra_toolstrings');
    savedToolStrings = saved ? JSON.parse(saved) : [];
    renderSavedToolStrings();
}

// Save tool strings to localStorage
function saveToolStringsToStorage() {
    localStorage.setItem('welltegra_toolstrings', JSON.stringify(savedToolStrings));
}

// Switch between tabs
window.switchEquipmentTab = function(tabName) {
    document.querySelectorAll('.equipment-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
    });
    document.querySelectorAll('.equipment-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    const targetTab = document.getElementById(`tab-${tabName}`);
    if (targetTab) targetTab.classList.remove('hidden');

    if (tabName === 'toolstrings') renderSavedToolStrings();
    else if (tabName === 'templates') renderServiceTemplates();
};

// Render equipment catalog
function renderEquipmentCatalog() {
    const grid = document.getElementById('equipment-catalog-grid');
    if (!grid) return;
    grid.innerHTML = '';

    Object.keys(equipmentCatalog).forEach(categoryKey => {
        const category = equipmentCatalog[categoryKey];
        if (currentEquipmentFilter !== 'all') {
            const hasMatchingItems = category.items.some(item => item.category === currentEquipmentFilter);
            if (!hasMatchingItems) return;
        }

        const card = document.createElement('div');
        card.className = 'equipment-category-card';

        const itemsHTML = category.items
            .filter(item => currentEquipmentFilter === 'all' || item.category === currentEquipmentFilter)
            .map(item => `
                <div class="equipment-item">
                    <div>
                        <div class="equipment-item-name">
                            ${item.name}
                            ${item.manufacturer ? `<span class="manufacturer-badge">${item.manufacturer}</span>` : ''}
                        </div>
                        <div class="equipment-item-meta">
                            ${item.applications ? item.applications.slice(0, 2).map(app => `<span class="application-tag">${app}</span>`).join('') : ''}
                        </div>
                    </div>
                    <button class="btn-add-equipment" onclick='addEquipmentToBuilderDirect(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
                        Add
                    </button>
                </div>
            `).join('');

        card.innerHTML = `
            <h4 class="text-lg font-bold mb-4 text-cyan-400">${category.name}</h4>
            <p class="text-sm text-gray-400 mb-4">${category.description}</p>
            <div>${itemsHTML}</div>
        `;
        grid.appendChild(card);
    });
}

// Filter equipment by category
window.filterEquipmentCategory = function(category) {
    currentEquipmentFilter = category;
    renderEquipmentCatalog();
};

// Populate equipment selector dropdown
function populateEquipmentSelector() {
    const selector = document.getElementById('equipment-selector');
    if (!selector) return;
    selector.innerHTML = '<option value="">-- Choose equipment --</option>';

    Object.keys(equipmentCatalog).forEach(categoryKey => {
        const category = equipmentCatalog[categoryKey];
        const optgroup = document.createElement('optgroup');
        optgroup.label = category.name;

        category.items.forEach(item => {
            const option = document.createElement('option');
            option.value = JSON.stringify(item);
            option.textContent = `${item.name}${item.manufacturer ? ' (' + item.manufacturer + ')' : ''}`;
            optgroup.appendChild(option);
        });

        selector.appendChild(optgroup);
    });
}

// Add equipment to builder from dropdown
window.addEquipmentToBuilder = function() {
    const selector = document.getElementById('equipment-selector');
    if (!selector || !selector.value) {
        alert('Please select equipment from the dropdown');
        return;
    }

    const item = JSON.parse(selector.value);
    builderComponents.push(item);
    updateBuilderPreview();
    selector.value = '';
};

// Add equipment to builder directly (from catalog)
window.addEquipmentToBuilderDirect = function(item) {
    switchEquipmentTab('builder');
    builderComponents.push(item);
    updateBuilderPreview();
    showToast(`Added ${item.name} to builder`);
};

// Update builder preview
function updateBuilderPreview() {
    const nameInput = document.getElementById('new-toolstring-name');
    const previewName = document.getElementById('preview-name');
    const componentsList = document.getElementById('builder-components-list');
    if (!componentsList) return;

    if (previewName) previewName.textContent = (nameInput && nameInput.value) || 'Untitled Assembly';

    if (builderComponents.length === 0) {
        componentsList.innerHTML = '<li class="text-gray-500 italic">No components added yet</li>';
    } else {
        componentsList.innerHTML = builderComponents.map((item, index) => `
            <li class="tool-string-component">
                ${index + 1}. ${item.name}
                <button class="btn-danger ml-2" onclick="removeBuilderComponent(${index})" style="padding: 2px 8px; font-size: 0.7rem;">âœ•</button>
            </li>
        `).join('');
    }
}

// Remove component from builder
window.removeBuilderComponent = function(index) {
    builderComponents.splice(index, 1);
    updateBuilderPreview();
};

// Save tool string
window.saveToolString = function() {
    const nameInput = document.getElementById('new-toolstring-name');
    const serviceSelect = document.getElementById('new-toolstring-service');

    if (!nameInput || !nameInput.value.trim()) {
        alert('Please enter a name for the tool string');
        return;
    }

    if (builderComponents.length === 0) {
        alert('Please add at least one component to the tool string');
        return;
    }

    const newToolString = {
        id: Date.now().toString(),
        name: nameInput.value.trim(),
        serviceLine: serviceSelect ? serviceSelect.value : 'CT',
        components: builderComponents.map(item => ({...item})),
        createdAt: new Date().toISOString()
    };

    savedToolStrings.push(newToolString);
    saveToolStringsToStorage();

    nameInput.value = '';
    builderComponents = [];
    updateBuilderPreview();

    switchEquipmentTab('toolstrings');
    showToast(`Tool string "${newToolString.name}" saved successfully!`);
};

// Render saved tool strings
function renderSavedToolStrings() {
    const list = document.getElementById('saved-toolstrings-list');
    const empty = document.getElementById('empty-toolstrings');
    if (!list || !empty) return;

    if (savedToolStrings.length === 0) {
        list.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
    }

    list.classList.remove('hidden');
    empty.classList.add('hidden');

    list.innerHTML = savedToolStrings.map((toolString, index) => `
        <div class="tool-string-card">
            <div class="tool-string-header">
                <div>
                    <span class="tool-string-name">${toolString.name}</span>
                    <span class="service-line-badge">${toolString.serviceLine}</span>
                </div>
                <div>
                    <button class="btn-add-equipment" onclick="useToolString(${index})">Use This String</button>
                    <button class="btn-danger ml-2" onclick="deleteToolString(${index})">Delete</button>
                </div>
            </div>
            <ul class="tool-string-components">
                ${toolString.components.map((item, i) => `
                    <li class="tool-string-component">${i + 1}. ${item.name}</li>
                `).join('')}
            </ul>
            <div class="text-xs text-gray-500 mt-3">
                Created: ${new Date(toolString.createdAt).toLocaleDateString()}
            </div>
        </div>
    `).join('');
}

// Use a tool string (add to current plan)
window.useToolString = function(index) {
    const toolString = savedToolStrings[index];
    showToast(`Tool string "${toolString.name}" added to your plan!`);
};

// Delete a tool string
window.deleteToolString = function(index) {
    const toolString = savedToolStrings[index];
    if (confirm(`Are you sure you want to delete "${toolString.name}"?`)) {
        savedToolStrings.splice(index, 1);
        saveToolStringsToStorage();
        renderSavedToolStrings();
        showToast(`Tool string "${toolString.name}" deleted`);
    }
};

// Render service templates
function renderServiceTemplates() {
    const templates = {
        ct: {
            name: 'Coiled Tubing Standard Package',
            description: 'Standard CT package for wellbore cleanout and circulation',
            serviceLine: 'CT',
            components: ['CT Reel', 'Injector Head', 'BHA Assembly', 'Jetting Tools']
        },
        els_fishing: {
            name: 'E-Line Fishing Assembly',
            description: 'Complete fishing assembly for wireline operations',
            serviceLine: 'ELS',
            components: ['Rope Socket', 'Power Jar', 'Internal Spear', 'Pressure Gauge']
        },
        slk_gaslift: {
            name: 'Slickline Gas Lift Service',
            description: 'Standard slickline setup for gas lift valve operations',
            serviceLine: 'SLK',
            components: ['Running Tool', 'Gas Lift Valve', 'Lock Mandrel', 'Equalizing Prong']
        },
        whm_completion: {
            name: 'WHM Completion Assembly',
            description: 'Wireline completion tools package',
            serviceLine: 'WHM',
            components: ['Setting Tool', 'Plug Assembly', 'Bridge Plug', 'Tubing Cutter']
        }
    };

    const grid = document.getElementById('service-templates-grid');
    if (!grid) return;

    grid.innerHTML = Object.keys(templates).map(key => {
        const template = templates[key];
        return `
            <div class="tool-string-card cursor-pointer">
                <div class="tool-string-header">
                    <div>
                        <div class="tool-string-name">${template.name}</div>
                        <span class="service-line-badge">${template.serviceLine}</span>
                    </div>
                </div>
                <p class="text-sm text-gray-400 mb-3">${template.description}</p>
                <ul class="tool-string-components">
                    ${template.components.map((comp, i) => `
                        <li class="tool-string-component">${i + 1}. ${comp}</li>
                    `).join('')}
                </ul>
            </div>
        `;
    }).join('');
}

// Initialize equipment catalog
document.addEventListener('DOMContentLoaded', () => {
    loadEquipmentCatalog();
    loadSavedToolStrings();

    const nameInput = document.getElementById('new-toolstring-name');
    if (nameInput) nameInput.addEventListener('input', updateBuilderPreview);
});

</script>

<!-- Auto-load demo survey on first visit -->
<script>
(function(){
  try{
    if(localStorage.getItem('wt_demo_loaded')) return;
    function run(){
      var ensureShowView = function(callback, attempt){
        if(typeof window.showView === 'function'){
          callback(window.showView);
        } else if((attempt || 0) < 20){
          setTimeout(function(){ ensureShowView(callback, (attempt || 0) + 1); }, 150);
        } else {
          console.warn('Demo preload: showView not ready after waiting');
        }
      };

      ensureShowView(function(showViewFn){
        var activatePerformer = function(){
          showViewFn('performer');
        };

        if(typeof window.loadSampleSurvey === 'function'){
          setTimeout(function() {
            activatePerformer();
            setTimeout(function() {
              window.loadSampleSurvey();
            }, 500);
          }, 1000);
        } else {
          var btn = document.querySelector('button[onclick*="loadSampleSurvey"]');
          if(btn) {
            setTimeout(function() {
              activatePerformer();
              setTimeout(funct
