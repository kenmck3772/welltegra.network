<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WellTegra Diagnostic Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #0a0e1a;
      color: #e5e7eb;
      padding: 40px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2.5rem;
      color: #06b6d4;
      margin-bottom: 16px;
    }

    .subtitle {
      font-size: 1.2rem;
      color: #94a3b8;
      margin-bottom: 40px;
    }

    .test-section {
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(6, 182, 212, 0.3);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .test-section h2 {
      color: #06b6d4;
      margin-bottom: 16px;
      font-size: 1.5rem;
    }

    .test-item {
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #64748b;
      background: rgba(0, 0, 0, 0.3);
    }

    .test-item.pass {
      border-left-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }

    .test-item.fail {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .test-item.warn {
      border-left-color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: 700;
      margin-right: 12px;
    }

    .status.pass { background: #22c55e; color: #0a0e1a; }
    .status.fail { background: #ef4444; color: white; }
    .status.warn { background: #f59e0b; color: #0a0e1a; }
    .status.info { background: #06b6d4; color: white; }

    .code {
      background: #000;
      padding: 16px;
      border-radius: 8px;
      margin-top: 12px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      margin-right: 12px;
      margin-bottom: 12px;
      transition: transform 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    #console-output {
      background: #000;
      color: #22c55e;
      padding: 20px;
      border-radius: 8px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      margin-top: 16px;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .summary-card {
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(6, 182, 212, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .summary-value {
      font-size: 3rem;
      font-weight: 800;
      color: #06b6d4;
    }

    .summary-label {
      font-size: 0.9rem;
      color: #94a3b8;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç WellTegra Diagnostic Tool</h1>
    <p class="subtitle">System health check and debugging utilities</p>

    <!-- Summary -->
    <div class="summary">
      <div class="summary-card">
        <div class="summary-value" id="pass-count">0</div>
        <div class="summary-label">Tests Passed</div>
      </div>
      <div class="summary-card">
        <div class="summary-value" id="fail-count">0</div>
        <div class="summary-label">Tests Failed</div>
      </div>
      <div class="summary-card">
        <div class="summary-value" id="warn-count">0</div>
        <div class="summary-label">Warnings</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="test-section">
      <h2>‚ö° Quick Actions</h2>
      <button class="btn" onclick="runAllTests()">Run All Tests</button>
      <button class="btn" onclick="testPlannerButton()">Test Planner Button</button>
      <button class="btn" onclick="navigateToPlanner()">Force Navigate to Planner</button>
      <button class="btn" onclick="checkWellData()">Check Well Data</button>
      <button class="btn" onclick="clearConsole()">Clear Console</button>
    </div>

    <!-- DOM Tests -->
    <div class="test-section">
      <h2>üåê DOM Element Tests</h2>
      <div id="dom-tests"></div>
    </div>

    <!-- JavaScript Tests -->
    <div class="test-section">
      <h2>‚öôÔ∏è JavaScript Function Tests</h2>
      <div id="js-tests"></div>
    </div>

    <!-- CSP Tests -->
    <div class="test-section">
      <h2>üõ°Ô∏è Content Security Policy Tests</h2>
      <div id="csp-tests"></div>
    </div>

    <!-- Network Tests -->
    <div class="test-section">
      <h2>üåê Network Resource Tests</h2>
      <div id="network-tests"></div>
    </div>

    <!-- Console Output -->
    <div class="test-section">
      <h2>üíª Console Output</h2>
      <div id="console-output"></div>
    </div>
  </div>

  <script>
    let passCount = 0;
    let failCount = 0;
    let warnCount = 0;

    // HTML escape function to prevent XSS
    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') {
        unsafe = String(unsafe);
      }
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function log(message, type = 'info') {
      const output = document.getElementById('console-output');
      const time = new Date().toLocaleTimeString();
      const colors = {
        info: '#06b6d4',
        success: '#22c55e',
        error: '#ef4444',
        warn: '#f59e0b'
      };

      // Use DOM methods instead of innerHTML to prevent XSS
      const logEntry = document.createElement('div');
      logEntry.style.color = colors[type];
      logEntry.textContent = `[${time}] ${message}`;
      output.appendChild(logEntry);
      output.scrollTop = output.scrollHeight;
    }

    function clearConsole() {
      document.getElementById('console-output').textContent = '';
      log('Console cleared', 'info');
    }

    function addTest(containerId, testName, result, message, details = null) {
      const container = document.getElementById(containerId);
      const testItem = document.createElement('div');
      testItem.className = `test-item ${result}`;

      let statusClass = result;
      let statusText = result.toUpperCase();

      if (result === 'pass') passCount++;
      else if (result === 'fail') failCount++;
      else if (result === 'warn') warnCount++;

      // Create status badge
      const statusBadge = document.createElement('span');
      statusBadge.className = `status ${statusClass}`;
      statusBadge.textContent = statusText;

      // Create test name
      const testNameElement = document.createElement('strong');
      testNameElement.textContent = testName;

      // Create message text
      const messageText = document.createTextNode(`: ${message}`);

      // Append elements safely
      testItem.appendChild(statusBadge);
      testItem.appendChild(document.createTextNode(' '));
      testItem.appendChild(testNameElement);
      testItem.appendChild(messageText);

      // Add details if provided (escaped)
      if (details) {
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'code';
        detailsDiv.textContent = details;
        testItem.appendChild(detailsDiv);
      }

      container.appendChild(testItem);
      updateSummary();
    }

    function updateSummary() {
      document.getElementById('pass-count').textContent = passCount;
      document.getElementById('fail-count').textContent = failCount;
      document.getElementById('warn-count').textContent = warnCount;
    }

    // DOM Tests
    function runDOMTests() {
      log('Running DOM tests...', 'info');

      // Test hero planner button
      const heroPlannerBtn = document.getElementById('hero-planner-btn');
      if (heroPlannerBtn) {
        addTest('dom-tests', 'Hero Planner Button', 'pass', 'Button found in DOM');
        log('‚úì Hero planner button exists', 'success');
      } else {
        addTest('dom-tests', 'Hero Planner Button', 'fail', 'Button NOT found in DOM', 'Expected element with id="hero-planner-btn"');
        log('‚úó Hero planner button missing!', 'error');
      }

      // Test planner view
      const plannerView = document.getElementById('planner-view');
      if (plannerView) {
        addTest('dom-tests', 'Planner View', 'pass', 'View container found');
      } else {
        addTest('dom-tests', 'Planner View', 'fail', 'View container NOT found', 'Expected element with id="planner-view"');
      }

      // Test nav link
      const plannerNavLink = document.getElementById('planner-nav-link');
      if (plannerNavLink) {
        addTest('dom-tests', 'Planner Nav Link', 'pass', 'Navigation link found');
      } else {
        addTest('dom-tests', 'Planner Nav Link', 'warn', 'Navigation link NOT found');
      }

      // Test comprehensive data
      const comprehensiveData = document.getElementById('comprehensive-well-data');
      if (window.location.pathname.includes('index.html') || window.location.pathname === '/') {
        addTest('dom-tests', 'Main Page Detection', 'pass', 'Running on main index page');
      } else {
        addTest('dom-tests', 'Main Page Detection', 'warn', 'Not running on main index page', `Current path: ${window.location.pathname}`);
      }
    }

    // JavaScript Tests
    function runJSTests() {
      log('Running JavaScript tests...', 'info');

      // Check if appState exists
      if (typeof appState !== 'undefined') {
        addTest('js-tests', 'appState Object', 'pass', 'Global appState exists');
        log('‚úì appState found', 'success');

        // Check wells data
        if (appState.wells && appState.wells.length > 0) {
          addTest('js-tests', 'Wells Data', 'pass', `${appState.wells.length} wells loaded`);
          log(`‚úì Loaded ${appState.wells.length} wells`, 'success');
        } else {
          addTest('js-tests', 'Wells Data', 'fail', 'No wells loaded in appState');
          log('‚úó No wells data!', 'error');
        }
      } else {
        addTest('js-tests', 'appState Object', 'fail', 'appState not found', 'Main app.js may not be loaded');
        log('‚úó appState not found - app.js not loaded?', 'error');
      }

      // Check if switchView exists
      if (typeof switchView !== 'undefined') {
        addTest('js-tests', 'switchView Function', 'pass', 'Function exists and callable');
        log('‚úì switchView function found', 'success');
      } else {
        addTest('js-tests', 'switchView Function', 'fail', 'Function not found', 'Navigation will not work');
        log('‚úó switchView function missing!', 'error');
      }

      // Check Chart.js
      if (typeof Chart !== 'undefined') {
        addTest('js-tests', 'Chart.js Library', 'pass', `Version ${Chart.version}`);
      } else {
        addTest('js-tests', 'Chart.js Library', 'warn', 'Chart.js not loaded');
      }

      // Check jsPDF
      if (typeof jspdf !== 'undefined') {
        addTest('js-tests', 'jsPDF Library', 'pass', 'PDF export available');
      } else {
        addTest('js-tests', 'jsPDF Library', 'warn', 'jsPDF not loaded');
      }

      // Check A-Frame
      if (typeof AFRAME !== 'undefined') {
        addTest('js-tests', 'A-Frame Library', 'pass', `Version ${AFRAME.version}`);
      } else {
        addTest('js-tests', 'A-Frame Library', 'warn', 'A-Frame not loaded (ok if not needed)');
      }
    }

    // CSP Tests
    function runCSPTests() {
      log('Running CSP tests...', 'info');

      const csp = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
      if (csp) {
        const content = csp.getAttribute('content');

        // Check for cdn.aframe.io
        if (content.includes('cdn.aframe.io')) {
          addTest('csp-tests', 'A-Frame CDN Allowed', 'pass', 'cdn.aframe.io in CSP');
        } else {
          addTest('csp-tests', 'A-Frame CDN Allowed', 'fail', 'cdn.aframe.io NOT in CSP', 'A-Frame fonts will fail to load');
        }

        // Check for aframe.io
        if (content.includes('aframe.io')) {
          addTest('csp-tests', 'A-Frame Scripts Allowed', 'pass', 'aframe.io in CSP');
        } else {
          addTest('csp-tests', 'A-Frame Scripts Allowed', 'warn', 'aframe.io not in CSP');
        }

        addTest('csp-tests', 'CSP Meta Tag', 'pass', 'Content Security Policy defined');
      } else {
        addTest('csp-tests', 'CSP Meta Tag', 'warn', 'No CSP defined');
      }
    }

    // Network Tests
    function runNetworkTests() {
      log('Running network tests...', 'info');

      // Check if comprehensive-well-data.json is accessible
      fetch('comprehensive-well-data.json')
        .then(response => {
          if (response.ok) {
            addTest('network-tests', 'comprehensive-well-data.json', 'pass', `Status ${response.status}`);
            log('‚úì Well data JSON accessible', 'success');
          } else {
            addTest('network-tests', 'comprehensive-well-data.json', 'fail', `Status ${response.status}`, 'Well data will not load');
            log(`‚úó Well data JSON returned ${response.status}`, 'error');
          }
        })
        .catch(err => {
          addTest('network-tests', 'comprehensive-well-data.json', 'fail', 'Fetch failed', err.message);
          log(`‚úó Well data JSON error: ${err.message}`, 'error');
        });

      // Check models directory
      fetch('models/pce/placeholder.json')
        .then(response => {
          if (response.ok) {
            addTest('network-tests', 'Models Directory', 'pass', 'Directory accessible');
          } else {
            addTest('network-tests', 'Models Directory', 'warn', `Status ${response.status}`);
          }
        })
        .catch(err => {
          addTest('network-tests', 'Models Directory', 'warn', 'Directory not accessible');
        });
    }

    // Test Planner Button
    function testPlannerButton() {
      log('Testing planner button...', 'info');

      const btn = document.getElementById('hero-planner-btn');
      if (!btn) {
        log('‚úó Cannot test: Button not found on this page', 'error');
        alert('This page does not have the planner button. Open index.html to test.');
        return;
      }

      log('Button found. Attempting to click...', 'info');
      btn.click();

      setTimeout(() => {
        if (window.location.hash === '#planner-view') {
          log('‚úì Navigation successful! Hash changed to #planner-view', 'success');
          alert('‚úì Button works! Hash changed to #planner-view');
        } else {
          log(`‚úó Navigation failed. Current hash: ${window.location.hash}`, 'error');
          alert(`‚úó Button click did not change hash. Current: ${window.location.hash}`);
        }
      }, 500);
    }

    // Force navigate to planner
    function navigateToPlanner() {
      log('Force navigating to planner...', 'info');

      if (typeof switchView !== 'undefined') {
        switchView('planner');
        window.location.hash = '#planner-view';
        log('‚úì Called switchView("planner")', 'success');
      } else {
        window.location.hash = '#planner-view';
        log('‚ö† switchView not found, using hash only', 'warn');
      }
    }

    // Check well data
    function checkWellData() {
      log('Checking well data...', 'info');

      if (typeof appState === 'undefined' || !appState.wells) {
        log('‚úó appState.wells not available', 'error');
        alert('appState.wells not available. Check if app.js loaded.');
        return;
      }

      log(`Found ${appState.wells.length} wells:`, 'info');
      appState.wells.forEach(well => {
        log(`  - ${well.id}: ${well.name} (${well.field})`, 'info');
      });

      alert(`Found ${appState.wells.length} wells. Check console for details.`);
    }

    // Run all tests
    function runAllTests() {
      // Clear previous results
      passCount = 0;
      failCount = 0;
      warnCount = 0;
      document.getElementById('dom-tests').textContent = '';
      document.getElementById('js-tests').textContent = '';
      document.getElementById('csp-tests').textContent = '';
      document.getElementById('network-tests').textContent = '';

      log('========================================', 'info');
      log('Starting diagnostic tests...', 'info');
      log('========================================', 'info');

      runDOMTests();
      runJSTests();
      runCSPTests();
      runNetworkTests();

      setTimeout(() => {
        log('========================================', 'info');
        log(`Tests complete: ${passCount} passed, ${failCount} failed, ${warnCount} warnings`, 'info');
        log('========================================', 'info');
      }, 1000);
    }

    // Run tests on page load
    window.addEventListener('load', () => {
      log('Diagnostic tool loaded', 'success');
      log('Click "Run All Tests" to start diagnostics', 'info');
    });
  </script>
</body>
</html>
